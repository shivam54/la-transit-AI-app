<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Transit App - Simple Version</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.0/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .nav-items {
            display: flex;
            align-items: center;
            gap: 2rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .search-button {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .search-button:hover {
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        .panel {
            width: 400px;
            background: white;
            border-left: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
        }

        .panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .route-info {
            margin-bottom: 2rem;
        }

        .route-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            border-radius: 8px;
        }

        .route-color {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .station-item {
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .station-item:hover {
            background-color: #f5f5f5;
            border-color: #ccc;
        }

        .legend {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        .legend-item:hover {
            background-color: #f5f5f5;
        }

        .color-swatch {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        .info-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .toggle-panel {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .toggle-panel:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .hidden {
            display: none;
        }

        /* Search Panel Styles */
        .search-container {
            position: absolute;
            top: 20px;
            left: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            min-width: 350px;
            max-width: 500px;
        }

        .search-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-form {
            padding: 1rem;
        }

        .input-group {
            margin-bottom: 1rem;
            position: relative;
        }

        .waypoint-controls {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .add-waypoint-btn {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            color: #2196f3;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .add-waypoint-btn:hover {
            background: #2196f3;
            color: white;
        }

        .remove-waypoint-btn {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #f44336;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s ease;
        }

        .remove-waypoint-btn:hover {
            background: #f44336;
            color: white;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #0066cc;
            box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.1);
        }

        .input-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .search-btn {
            width: 100%;
            padding: 0.75rem;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .search-btn:hover {
            transform: translateY(-1px);
        }

        .search-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .route-result {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .route-result:hover {
            background-color: #f8f9fa;
        }

        .route-result:last-child {
            border-bottom: none;
        }

        .route-header-result {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .route-color-result {
            width: 16px;
            height: 16px;
            border-radius: 50%;
        }

        .route-name {
            margin: 0;
            color: #333;
            font-size: 0.9rem;
        }

        .route-details {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            font-size: 0.8rem;
            color: #666;
        }

        .route-info-result {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .journey-steps {
            background: #f8f9fa;
            padding: 0.75rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .journey-step {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
            padding: 0.25rem 0;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: white;
            font-weight: bold;
        }

        .arrival-time {
            background: #e8f5e8;
            color: #2e7d32;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .transfer-info {
            background: #f0f8ff;
            padding: 0.5rem;
            border-radius: 6px;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #0066cc;
        }

        .no-results {
            padding: 2rem;
            text-align: center;
            color: #666;
        }

        .loading-spinner {
            padding: 2rem;
            text-align: center;
            color: #666;
        }

        .close-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .close-button:hover {
            background-color: #f5f5f5;
        }

        .time-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            align-items: center;
        }

        .time-input {
            padding: 0.5rem;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .time-label {
            font-size: 0.9rem;
            color: #666;
            white-space: nowrap;
        }

        .transport-modes {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .mode-button {
            padding: 0.5rem 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .mode-button.active {
            border-color: #0066cc;
            background: #0066cc;
            color: white;
        }

        .mode-button:hover {
            border-color: #0066cc;
            background: #f0f8ff;
        }

        .mode-button.active:hover {
            background: #0052a3;
        }

        .mode-icon {
            font-size: 1rem;
        }

        /* Detailed Route View Modal */
        .route-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            overflow-y: auto;
        }

        .route-modal-content {
            background: white;
            margin: 20px auto;
            max-width: 500px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-height: 90vh;
            overflow-y: auto;
        }

        .route-modal-header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px 12px 0 0;
            position: relative;
        }

        .route-modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .route-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .route-icon-large {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
        }

        .route-timeline {
            background: white;
            padding: 1.5rem;
            border-radius: 0 0 12px 12px;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .departure-info {
            text-align: center;
        }

        .departure-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .departure-label {
            font-size: 0.9rem;
            color: #666;
        }

        .arrival-info {
            text-align: center;
        }

        .arrival-time {
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
        }

        .arrival-label {
            font-size: 0.9rem;
            color: #666;
        }

        .total-duration {
            text-align: center;
            background: #f8f9fa;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: bold;
            color: #333;
        }

        .timeline-steps {
            margin-top: 1.5rem;
        }

        .timeline-step {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            margin-bottom: 1.5rem;
            position: relative;
        }

        .timeline-step:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 25px;
            top: 50px;
            width: 2px;
            height: calc(100% - 25px);
            background: #e0e0e0;
        }

        .step-icon-container {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .step-content {
            flex: 1;
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #0066cc;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .step-title {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
        }

        .step-duration {
            background: #0066cc;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .step-details {
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .step-instruction {
            margin-top: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .real-time-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #28a745;
        }

        .service-advisory {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 6px;
            padding: 0.75rem;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .service-advisory-icon {
            color: #856404;
            font-size: 1.2rem;
        }

        .service-advisory-text {
            color: #856404;
            font-size: 0.9rem;
        }

        .route-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 1px solid #e0e0e0;
        }

        .action-button {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .action-button.primary {
            background: #0066cc;
            color: white;
        }

        .action-button.secondary {
            background: #f8f9fa;
            color: #333;
            border: 1px solid #e0e0e0;
        }

        .action-button:hover {
            transform: translateY(-1px);
        }

        /* Pulse animation for current location marker */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.2);
                opacity: 0.7;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Location Manager Styles */
        .tab-container {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab-button {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            border-bottom-color: #0066cc;
            color: #0066cc;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .form-group textarea {
            height: 80px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        .form-actions button {
            flex: 1;
            min-width: 150px;
        }

        .btn-primary {
            background: #0066cc;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .status-dot.online {
            background: #28a745;
        }

        .status-dot.offline {
            background: #dc3545;
        }

        .api-status-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .custom-location-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .custom-location-info h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .custom-location-info p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .search-history-item {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-history-item:hover {
            background: #f8f9fa;
        }

        .search-result-item {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .search-result-item h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .search-result-item p {
            margin: 0 0 10px 0;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üöá LA Transit
        </div>
        <div class="nav-items">
            <div class="nav-item">
                ÔøΩÔøΩ Routes
            </div>
            <div class="nav-item">
                üïí Schedule
            </div>
            <button class="search-button" onclick="toggleSearch()">
                üîç Search Routes
            </button>
            <button class="toggle-panel" onclick="togglePanel()">üìã Route Info</button>
        </div>
    </div>

    <div class="main-content">
        <div class="map-container">
            <div id="map" style="height: 100%; width: 100%;"></div>
            
            <div class="legend">
                <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">Transportation Options</h3>
                <div class="legend-item" onclick="selectRoute('red', 'metro')">
                    <div class="color-swatch" style="background-color: #ff0000;"></div>
                    <span>Red Line (Metro)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('purple', 'metro')">
                    <div class="color-swatch" style="background-color: #800080;"></div>
                    <span>Purple Line (Metro)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('blue', 'metro')">
                    <div class="color-swatch" style="background-color: #0066cc;"></div>
                    <span>Blue Line (Metro)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('expo', 'metro')">
                    <div class="color-swatch" style="background-color: #00ff00;"></div>
                    <span>Expo Line (Metro)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('rapid-720', 'bus')">
                    <div class="color-swatch" style="background-color: #ff6b35;"></div>
                    <span>Rapid 720 (Bus)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('local-2', 'bus')">
                    <div class="color-swatch" style="background-color: #4caf50;"></div>
                    <span>Local 2 (Bus)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('express-733', 'bus')">
                    <div class="color-swatch" style="background-color: #9c27b0;"></div>
                    <span>Express 733 (Bus)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('bike-1', 'bike')">
                    <div class="color-swatch" style="background-color: #8bc34a;"></div>
                    <span>Bike Route 1 (Bike)</span>
                </div>
                <div class="legend-item" onclick="selectRoute('bike-2', 'bike')">
                    <div class="color-swatch" style="background-color: #ff9800;"></div>
                    <span>Bike Route 2 (Bike)</span>
                </div>
            </div>

            <!-- Search Panel -->
            <div class="search-container" id="searchPanel" style="display: none;">
                <div class="search-header">
                    <h3 style="margin: 0; font-size: 1rem;">Route Search</h3>
                    <button class="close-button" onclick="toggleSearch()">‚úï</button>
                </div>
                
                <form class="search-form" onsubmit="handleSearch(event)">
                    <div class="time-selector">
                        <span class="time-label">Departure Time:</span>
                        <input type="time" class="time-input" id="departureTime" value="08:00">
                    </div>
                    
                    <div class="transport-modes">
                        <button type="button" class="mode-button" onclick="setMode('metro')">
                            <span class="mode-icon">üöá</span> Metro
                        </button>
                        <button type="button" class="mode-button" onclick="setMode('bus')">
                            <span class="mode-icon">üöå</span> Bus
                        </button>
                        <button type="button" class="mode-button" onclick="setMode('bike')">
                            <span class="mode-icon">üö≤</span> Bike
                        </button>
                        <button type="button" class="mode-button" onclick="setMode('walk')">
                            <span class="mode-icon">üö∂</span> Walk
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-icon">üìç</div>
                        <input 
                            type="text" 
                            class="search-input" 
                            id="originInput"
                            placeholder="Enter origin station..." 
                            list="stations"
                        />
                        <button type="button" class="location-btn" onclick="getCurrentLocation()" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #0066cc; color: white; border: none; border-radius: 4px; padding: 0.5rem; cursor: pointer; font-size: 0.8rem;">
                            üìç Current
                        </button>
                        <button type="button" class="location-manager-btn" onclick="openLocationManager()" style="position: absolute; right: 80px; top: 50%; transform: translateY(-50%); background: #28a745; color: white; border: none; border-radius: 4px; padding: 0.5rem; cursor: pointer; font-size: 0.8rem;">
                            ‚öôÔ∏è Manage
                        </button>
                    </div>
                    
                    <div id="waypointsContainer">
                        <!-- Waypoints will be added here dynamically -->
                    </div>
                    
                    <div class="waypoint-controls">
                        <button type="button" class="add-waypoint-btn" onclick="addWaypoint()">
                            ‚ûï Add Waypoint
                        </button>
                    </div>
                    
                    <div class="input-group">
                        <div class="input-icon">üß≠</div>
                        <input 
                            type="text" 
                            class="search-input" 
                            id="destinationInput"
                            placeholder="Enter destination station..." 
                            list="stations"
                        />
                    </div>
                    
                    <datalist id="stations">
                        <option value="Downtown">
                        <option value="USC">
                        <option value="UCLA">
                        <option value="LAX">
                        <option value="Hollywood">
                        <option value="Santa Monica">
                        <option value="Venice">
                        <option value="Beverly Hills">
                        <option value="West Hollywood">
                        <option value="Koreatown">
                        <option value="Echo Park">
                        <option value="Silver Lake">
                        <option value="Los Feliz">
                        <option value="Glendale">
                        <option value="Pasadena">
                        <option value="Long Beach">
                        <option value="Manhattan Beach">
                        <option value="Redondo Beach">
                        <option value="Burbank">
                        <option value="Studio City">
                        <option value="North Hollywood">
                        <option value="Sherman Oaks">
                        <option value="Encino">
                        <option value="Tarzana">
                        <option value="Woodland Hills">
                        <option value="Calabasas">
                        <option value="Malibu">
                        <option value="Marina del Rey">
                        <option value="Playa del Rey">
                        <option value="El Segundo">
                        <option value="Hawthorne">
                        <option value="Inglewood">
                        <option value="Culver City">
                        <option value="Mar Vista">
                        <option value="West LA">
                        <option value="Brentwood">
                        <option value="Pacific Palisades">
                        <option value="Topanga">
                        <option value="Agoura Hills">
                        <option value="Westlake Village">
                        <option value="Thousand Oaks">
                        <option value="Simi Valley">
                        <option value="Chatsworth">
                        <option value="Porter Ranch">
                        <option value="Granada Hills">
                        <option value="Sylmar">
                        <option value="San Fernando">
                        <option value="Sun Valley">
                        <option value="Sunland">
                        <option value="Tujunga">
                        <option value="La Crescenta">
                        <option value="Montrose">
                        <option value="La Canada">
                        <option value="Altadena">
                        <option value="South Pasadena">
                        <option value="Alhambra">
                        <option value="Monterey Park">
                        <option value="Rosemead">
                        <option value="El Monte">
                        <option value="Baldwin Park">
                        <option value="West Covina">
                        <option value="Covina">
                        <option value="San Dimas">
                        <option value="La Verne">
                        <option value="Claremont">
                        <option value="Pomona">
                        <option value="Diamond Bar">
                        <option value="Walnut">
                        <option value="Rowland Heights">
                        <option value="Hacienda Heights">
                        <option value="La Puente">
                        <option value="Industry">
                        <option value="City of Industry">
                        <option value="Whittier">
                        <option value="Santa Fe Springs">
                        <option value="Norwalk">
                        <option value="Cerritos">
                        <option value="Artesia">
                        <option value="Lakewood">
                        <option value="Bellflower">
                        <option value="Paramount">
                        <option value="Downey">
                        <option value="Bell Gardens">
                        <option value="Huntington Park">
                        <option value="Vernon">
                        <option value="Commerce">
                        <option value="Montebello">
                        <option value="Pico Rivera">
                        <option value="Santa Ana">
                        <option value="Anaheim">
                        <option value="Fullerton">
                        <option value="Brea">
                        <option value="Placentia">
                        <option value="Yorba Linda">
                        <option value="Orange">
                        <option value="Garden Grove">
                        <option value="Westminster">
                        <option value="Fountain Valley">
                        <option value="Huntington Beach">
                        <option value="Seal Beach">
                        <option value="Cypress">
                        <option value="Los Alamitos">
                        <option value="Signal Hill">
                        <option value="Lake Forest">
                        <option value="Mission Viejo">
                        <option value="Rancho Santa Margarita">
                        <option value="San Clemente">
                        <option value="Dana Point">
                        <option value="San Juan Capistrano">
                        <option value="Laguna Beach">
                        <option value="Laguna Niguel">
                        <option value="Aliso Viejo">
                        <option value="Laguna Hills">
                        <option value="Irvine">
                        <option value="Tustin">
                        <option value="Newport Beach">
                        <option value="Costa Mesa">
                        <option value="Union Station">
                        <option value="Civic Center/Grand Park">
                        <option value="Pershing Square">
                        <option value="7th Street/Metro Center">
                        <option value="Westlake/MacArthur Park">
                        <option value="Wilshire/Vermont">
                        <option value="Wilshire/Western">
                        <option value="Vermont/Sunset">
                        <option value="Vermont/Santa Monica">
                        <option value="Hollywood/Western">
                        <option value="Hollywood/Vine">
                        <option value="Hollywood/Highland">
                        <option value="Universal City/Studio City">
                        <option value="North Hollywood">
                        <option value="Wilshire/Normandie">
                        <option value="Pico">
                        <option value="Grand/LATTC">
                        <option value="San Pedro">
                        <option value="Washington">
                        <option value="Vernon">
                        <option value="Slauson">
                        <option value="Florence">
                        <option value="Firestone">
                        <option value="103rd Street/Watts Towers">
                        <option value="Rosa Parks">
                        <option value="Imperial/Wilmington">
                        <option value="Compton">
                        <option value="Artesia">
                        <option value="Del Amo">
                        <option value="Wardlow">
                        <option value="Willowbrook">
                        <option value="Long Beach">
                        <option value="3239 South Normandie Avenue">
                    </datalist>
                    
                    <button type="submit" class="search-btn" id="searchBtn">
                        üîç Plan Journey
                    </button>
                </form>
                
                <!-- Station Suggestions -->
                <div style="padding: 0 1rem 1rem 1rem; border-top: 1px solid #f0f0f0;">
                    <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #666;">üí° Popular Searches:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.8rem;">
                        <span style="background: #f0f8ff; padding: 0.25rem 0.5rem; border-radius: 4px; color: #0066cc; cursor: pointer;" onclick="setCurrentLocationExample()">üìç Current ‚Üí USC</span>
                        <span style="background: #f0f8ff; padding: 0.25rem 0.5rem; border-radius: 4px; color: #0066cc; cursor: pointer;" onclick="setSearchExample('Downtown', 'USC')">üöá Downtown ‚Üí USC</span>
                        <span style="background: #f0f8ff; padding: 0.25rem 0.5rem; border-radius: 4px; color: #0066cc; cursor: pointer;" onclick="setSearchExample('USC', 'Santa Monica')">üöá USC ‚Üí Santa Monica</span>
                        <span style="background: #f0f8ff; padding: 0.25rem 0.5rem; border-radius: 4px; color: #0066cc; cursor: pointer;" onclick="setSearchExample('LAX', 'Downtown')">üöá LAX ‚Üí Downtown</span>
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 0.9rem; color: #666;">üöå Bus Routes:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.8rem;">
                        <span style="background: #fff3e0; padding: 0.25rem 0.5rem; border-radius: 4px; color: #f57c00; cursor: pointer;" onclick="setBusExample()">üöå Koreatown ‚Üí Santa Monica</span>
                        <span style="background: #fff3e0; padding: 0.25rem 0.5rem; border-radius: 4px; color: #f57c00; cursor: pointer;" onclick="setSearchExample('Echo Park', 'Silver Lake')">üöå Echo Park ‚Üí Silver Lake</span>
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 0.9rem; color: #666;">üö≤ Bike & Walk:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.8rem;">
                        <span style="background: #e8f5e8; padding: 0.25rem 0.5rem; border-radius: 4px; color: #2e7d32; cursor: pointer;" onclick="setBikeExample()">üö≤ Downtown ‚Üí Echo Park (Bike)</span>
                        <span style="background: #e8f5e8; padding: 0.25rem 0.5rem; border-radius: 4px; color: #2e7d32; cursor: pointer;" onclick="setWalkExample()">üö∂ Beverly Hills ‚Üí West Hollywood (Walk)</span>
                        <span style="background: #e8f5e8; padding: 0.25rem 0.5rem; border-radius: 4px; color: #2e7d32; cursor: pointer;" onclick="setWalkExample2()">üö∂ Downtown ‚Üí Echo Park (Walk)</span>
                        <span style="background: #e8f5e8; padding: 0.25rem 0.5rem; border-radius: 4px; color: #2e7d32; cursor: pointer;" onclick="testDistanceCalculation()">üîß Test Distance Calculation</span>
                    </div>
                    <h4 style="margin: 1rem 0 0.5rem 0; font-size: 0.9rem; color: #666;">üìç Available Locations:</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; font-size: 0.7rem; color: #666;">
                        <span>Downtown</span> ‚Ä¢ <span>USC</span> ‚Ä¢ <span>UCLA</span> ‚Ä¢ <span>LAX</span> ‚Ä¢ <span>Hollywood</span> ‚Ä¢ <span>Santa Monica</span> ‚Ä¢ <span>Venice</span> ‚Ä¢ <span>Beverly Hills</span> ‚Ä¢ <span>West Hollywood</span> ‚Ä¢ <span>Koreatown</span> ‚Ä¢ <span>Echo Park</span> ‚Ä¢ <span>Silver Lake</span> ‚Ä¢ <span>Los Feliz</span> ‚Ä¢ <span>Glendale</span> ‚Ä¢ <span>Pasadena</span> ‚Ä¢ <span>Long Beach</span> ‚Ä¢ <span>Burbank</span> ‚Ä¢ <span>Studio City</span> ‚Ä¢ <span>North Hollywood</span> ‚Ä¢ <span>Sherman Oaks</span> ‚Ä¢ <span>Encino</span> ‚Ä¢ <span>Malibu</span> ‚Ä¢ <span>Marina del Rey</span> ‚Ä¢ <span>Culver City</span> ‚Ä¢ <span>West LA</span> ‚Ä¢ <span>Brentwood</span> ‚Ä¢ <span>Pacific Palisades</span> ‚Ä¢ <span>Thousand Oaks</span> ‚Ä¢ <span>Simi Valley</span> ‚Ä¢ <span>Chatsworth</span> ‚Ä¢ <span>Granada Hills</span> ‚Ä¢ <span>Sylmar</span> ‚Ä¢ <span>San Fernando</span> ‚Ä¢ <span>La Canada</span> ‚Ä¢ <span>Altadena</span> ‚Ä¢ <span>South Pasadena</span> ‚Ä¢ <span>Alhambra</span> ‚Ä¢ <span>Monterey Park</span> ‚Ä¢ <span>El Monte</span> ‚Ä¢ <span>West Covina</span> ‚Ä¢ <span>Covina</span> ‚Ä¢ <span>Claremont</span> ‚Ä¢ <span>Pomona</span> ‚Ä¢ <span>Diamond Bar</span> ‚Ä¢ <span>Walnut</span> ‚Ä¢ <span>Rowland Heights</span> ‚Ä¢ <span>Hacienda Heights</span> ‚Ä¢ <span>Whittier</span> ‚Ä¢ <span>Norwalk</span> ‚Ä¢ <span>Cerritos</span> ‚Ä¢ <span>Lakewood</span> ‚Ä¢ <span>Bellflower</span> ‚Ä¢ <span>Downey</span> ‚Ä¢ <span>Huntington Park</span> ‚Ä¢ <span>Montebello</span> ‚Ä¢ <span>Pico Rivera</span> ‚Ä¢ <span>Santa Ana</span> ‚Ä¢ <span>Anaheim</span> ‚Ä¢ <span>Fullerton</span> ‚Ä¢ <span>Brea</span> ‚Ä¢ <span>Orange</span> ‚Ä¢ <span>Garden Grove</span> ‚Ä¢ <span>Westminster</span> ‚Ä¢ <span>Huntington Beach</span> ‚Ä¢ <span>Seal Beach</span> ‚Ä¢ <span>Lake Forest</span> ‚Ä¢ <span>Mission Viejo</span> ‚Ä¢ <span>San Clemente</span> ‚Ä¢ <span>Laguna Beach</span> ‚Ä¢ <span>Irvine</span> ‚Ä¢ <span>Tustin</span> ‚Ä¢ <span>Newport Beach</span> ‚Ä¢ <span>Costa Mesa</span> ‚Ä¢ <span>3239 South Normandie Avenue</span>
                    </div>
                </div>
                
                <div class="results-container" id="searchResults" style="display: none;">
                    <!-- Search results will be populated here -->
                </div>
            </div>
        </div>

        <div class="panel" id="panel">
            <div class="panel-header">
                <h2>Route Information</h2>
            </div>
            <div class="panel-content" id="panel-content">
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <h3>Select a Route</h3>
                    <p>Click on a metro line on the map or legend to view detailed information.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Route View Modal -->
    <div class="route-modal" id="routeModal">
        <div class="route-modal-content">
            <div class="route-modal-header">
                <button class="route-modal-close" onclick="closeRouteModal()">‚úï</button>
                <div class="route-summary">
                    <div class="route-icon-large" id="modalRouteIcon">üöá</div>
                    <div>
                        <h3 id="modalRouteTitle" style="margin: 0 0 0.5rem 0;">Metro Route</h3>
                        <p id="modalRouteSubtitle" style="margin: 0; opacity: 0.9;">From <span id="modalOrigin">Downtown</span> to <span id="modalDestination">USC</span></p>
                    </div>
                </div>
            </div>
            
            <div class="route-timeline">
                <div class="timeline-header">
                    <div class="departure-info">
                        <div class="departure-time" id="modalDepartureTime">12:34 PM</div>
                        <div class="departure-label">Departure</div>
                    </div>
                    <div class="total-duration" id="modalTotalDuration">55 min</div>
                    <div class="arrival-info">
                        <div class="arrival-time" id="modalArrivalTime">1:29 PM</div>
                        <div class="arrival-label">Arrival</div>
                    </div>
                </div>
                
                <div class="timeline-steps" id="modalTimelineSteps">
                    <!-- Timeline steps will be populated here -->
                </div>
                
                <div class="service-advisory" id="modalServiceAdvisory" style="display: none;">
                    <div class="service-advisory-icon">‚ö†Ô∏è</div>
                    <div class="service-advisory-text">
                        <div style="font-weight: bold;">Service Advisory</div>
                        <div>Minor delays on Red Line due to maintenance. Posted 2 hours ago.</div>
                    </div>
                </div>
                
                <div class="route-actions">
                    <button class="action-button secondary" onclick="closeRouteModal()">Close</button>
                    <button class="action-button primary" onclick="startNavigation()">Start Navigation</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Manager Modal -->
    <div id="locationManagerModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>üìç Location Manager</h2>
                <span class="close" onclick="closeLocationManager()">&times;</span>
            </div>
            
            <div class="modal-body">
                <!-- Tabs -->
                <div class="tab-container">
                    <button class="tab-button active" onclick="switchTab('addLocation')">Add Location</button>
                    <button class="tab-button" onclick="switchTab('myLocations')">My Locations</button>
                    <button class="tab-button" onclick="switchTab('userAddresses')">My Addresses</button>
                    <button class="tab-button" onclick="switchTab('recentSearches')">Recent Searches</button>
                </div>

                <!-- Add Location Tab -->
                <div id="add-location" class="tab-content active">
                    <h3>Add Your Location</h3>
                    <form id="addLocationForm" onsubmit="addCustomLocation(event)">
                        <div class="form-group">
                            <label for="locationName">Location Name:</label>
                            <input type="text" id="locationName" required placeholder="e.g., My Home, Work Office, Favorite Restaurant">
                        </div>
                        
                        <div class="form-group">
                            <label for="locationCategory">Category:</label>
                            <select id="locationCategory">
                                <option value="home">üè† Home</option>
                                <option value="work">üíº Work</option>
                                <option value="school">üéì School</option>
                                <option value="shopping">üõçÔ∏è Shopping</option>
                                <option value="restaurant">üçΩÔ∏è Restaurant</option>
                                <option value="entertainment">üé≠ Entertainment</option>
                                <option value="custom">üìç Custom</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="locationDescription">Notes (optional):</label>
                            <textarea id="locationDescription" placeholder="Any additional notes about this location"></textarea>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn-primary" onclick="getCurrentLocationForForm()">üìç Use My Current Location</button>
                            <button type="button" class="btn-secondary" onclick="searchForLocation()">üîç Search for Location</button>
                        </div>
                        
                        <div id="locationSearchResults" style="display: none; margin-top: 15px;">
                            <!-- Search results will appear here -->
                        </div>
                    </form>
                </div>

                <!-- Custom Locations Tab -->
                <div id="custom-locations" class="tab-content">
                    <h3>Your Saved Locations</h3>
                    <div id="customLocationsList">
                        <!-- Custom locations will be loaded here -->
                    </div>
                </div>

                <!-- Search History Tab -->
                <div id="search-history" class="tab-content">
                    <h3>Recent Searches</h3>
                    <div id="searchHistoryList">
                        <!-- Search history will be loaded here -->
                    </div>
                    <button class="btn-secondary" onclick="clearSearchHistory()">üóëÔ∏è Clear History</button>
                </div>

                <!-- User Addresses Tab -->
                <div id="userAddresses" class="tab-content" style="display: none;">
                    <h3>üè† My Addresses</h3>
                    <p>Add your frequently used addresses for quick access.</p>
                    
                    <!-- Add New Address Form -->
                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <h4>Add New Address</h4>
                        <div class="form-group">
                            <label>Address Name (e.g., "Home", "Work"):</label>
                            <input type="text" id="addressName" placeholder="Enter a name for this address" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Full Address:</label>
                            <input type="text" id="addressInput" placeholder="Enter full address" class="form-input">
                        </div>
                        <div class="form-group">
                            <label>Description (optional):</label>
                            <input type="text" id="addressDescription" placeholder="e.g., My apartment building" class="form-input">
                        </div>
                        <div class="form-row">
                            <button onclick="addNewUserAddress()" class="btn-primary">‚ûï Add Address</button>
                            <button onclick="useCurrentLocationForAddress()" class="btn-secondary">üìç Use Current Location</button>
                        </div>
                    </div>
                    
                    <!-- User Addresses List -->
                    <div id="userAddressesList">
                        <h4>Your Saved Addresses</h4>
                        <div id="userAddressesContainer">
                            <!-- User addresses will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.0/dist/leaflet.js"></script>
    <script>
        // Global locations object for LA and Orange County areas
        const locations = {
            'downtown': { lat: 34.0522, lng: -118.2437, name: 'Downtown LA' },
            'usc': { lat: 34.0224, lng: -118.2851, name: 'USC' },
            'ucla': { lat: 34.0689, lng: -118.4452, name: 'UCLA' },
            'lax': { lat: 33.9416, lng: -118.4085, name: 'LAX Airport' },
            'hollywood': { lat: 34.1020, lng: -118.3390, name: 'Hollywood' },
            'santa monica': { lat: 34.0195, lng: -118.4912, name: 'Santa Monica' },
            'venice': { lat: 34.0522, lng: -118.4657, name: 'Venice' },
            'culver city': { lat: 34.0211, lng: -118.3965, name: 'Culver City' },
            'beverly hills': { lat: 34.0736, lng: -118.4004, name: 'Beverly Hills' },
            'west hollywood': { lat: 34.0900, lng: -118.3617, name: 'West Hollywood' },
            'koreatown': { lat: 34.0620, lng: -118.3080, name: 'Koreatown' },
            'echo park': { lat: 34.0781, lng: -118.2570, name: 'Echo Park' },
            'silver lake': { lat: 34.0928, lng: -118.2766, name: 'Silver Lake' },
            'los feliz': { lat: 34.1183, lng: -118.3004, name: 'Los Feliz' },
            'glendale': { lat: 34.1425, lng: -118.2551, name: 'Glendale' },
            'pasadena': { lat: 34.1478, lng: -118.1445, name: 'Pasadena' },
            'long beach': { lat: 33.7701, lng: -118.1937, name: 'Long Beach' },
            'burbank': { lat: 34.1808, lng: -118.3089, name: 'Burbank' },
            'studio city': { lat: 34.1380, lng: -118.3590, name: 'Studio City' },
            'north hollywood': { lat: 34.1680, lng: -118.3770, name: 'North Hollywood' },
            'sherman oaks': { lat: 34.1511, lng: -118.4492, name: 'Sherman Oaks' },
            'encino': { lat: 34.1597, lng: -118.5011, name: 'Encino' },
            'malibu': { lat: 34.0259, lng: -118.7798, name: 'Malibu' },
            'marina del rey': { lat: 33.9803, lng: -118.4517, name: 'Marina del Rey' },
            'west la': { lat: 34.0430, lng: -118.4434, name: 'West LA' },
            'brentwood': { lat: 34.0522, lng: -118.4737, name: 'Brentwood' },
            'pacific palisades': { lat: 34.0470, lng: -118.5250, name: 'Pacific Palisades' },
            'thousand oaks': { lat: 34.1706, lng: -118.8376, name: 'Thousand Oaks' },
            'simi valley': { lat: 34.2694, lng: -118.7815, name: 'Simi Valley' },
            'chatsworth': { lat: 34.2572, lng: -118.6012, name: 'Chatsworth' },
            'granada hills': { lat: 34.2633, lng: -118.5009, name: 'Granada Hills' },
            'sylmar': { lat: 34.3071, lng: -118.4481, name: 'Sylmar' },
            'san fernando': { lat: 34.2819, lng: -118.4389, name: 'San Fernando' },
            'la canada': { lat: 34.1997, lng: -118.2067, name: 'La Canada' },
            'altadena': { lat: 34.1897, lng: -118.1312, name: 'Altadena' },
            'south pasadena': { lat: 34.1136, lng: -118.1509, name: 'South Pasadena' },
            'alhambra': { lat: 34.0953, lng: -118.1270, name: 'Alhambra' },
            'monterey park': { lat: 34.0625, lng: -118.1228, name: 'Monterey Park' },
            'el monte': { lat: 34.0686, lng: -118.0276, name: 'El Monte' },
            'west covina': { lat: 34.0686, lng: -117.9389, name: 'West Covina' },
            'covina': { lat: 34.0900, lng: -117.8903, name: 'Covina' },
            'claremont': { lat: 34.0967, lng: -117.7198, name: 'Claremont' },
            'pomona': { lat: 34.0553, lng: -117.7500, name: 'Pomona' },
            'diamond bar': { lat: 34.0286, lng: -117.8103, name: 'Diamond Bar' },
            'walnut': { lat: 34.0200, lng: -117.8653, name: 'Walnut' },
            'rowland heights': { lat: 33.9761, lng: -117.9053, name: 'Rowland Heights' },
            'hacienda heights': { lat: 33.9933, lng: -117.9686, name: 'Hacienda Heights' },
            'whittier': { lat: 33.9792, lng: -118.0328, name: 'Whittier' },
            'norwalk': { lat: 33.9022, lng: -118.0817, name: 'Norwalk' },
            'cerritos': { lat: 33.8583, lng: -118.0647, name: 'Cerritos' },
            'lakewood': { lat: 33.8536, lng: -118.1339, name: 'Lakewood' },
            'bellflower': { lat: 33.8817, lng: -118.1170, name: 'Bellflower' },
            'downey': { lat: 33.9400, lng: -118.1325, name: 'Downey' },
            'huntington park': { lat: 33.9817, lng: -118.2250, name: 'Huntington Park' },
            'montebello': { lat: 34.0167, lng: -118.1133, name: 'Montebello' },
            'pico rivera': { lat: 34.0000, lng: -118.0883, name: 'Pico Rivera' },
            'santa ana': { lat: 33.7456, lng: -117.8677, name: 'Santa Ana' },
            'anaheim': { lat: 33.8366, lng: -117.9143, name: 'Anaheim' },
            'fullerton': { lat: 33.8703, lng: -117.9244, name: 'Fullerton' },
            'brea': { lat: 33.9167, lng: -117.9000, name: 'Brea' },
            'orange': { lat: 33.7879, lng: -117.8531, name: 'Orange' },
            'garden grove': { lat: 33.7739, lng: -117.9414, name: 'Garden Grove' },
            'westminster': { lat: 33.7594, lng: -118.0067, name: 'Westminster' },
            'huntington beach': { lat: 33.6847, lng: -118.0006, name: 'Huntington Beach' },
            'seal beach': { lat: 33.7414, lng: -118.1047, name: 'Seal Beach' },
            'lake forest': { lat: 33.6469, lng: -117.6891, name: 'Lake Forest' },
            'mission viejo': { lat: 33.6000, lng: -117.6720, name: 'Mission Viejo' },
            'san clemente': { lat: 33.4269, lng: -117.6120, name: 'San Clemente' },
            'laguna beach': { lat: 33.5422, lng: -117.7831, name: 'Laguna Beach' },
            'irvine': { lat: 33.6846, lng: -117.8265, name: 'Irvine' },
            'tustin': { lat: 33.7459, lng: -117.8261, name: 'Tustin' },
            'newport beach': { lat: 33.6189, lng: -117.9289, name: 'Newport Beach' },
            'costa mesa': { lat: 33.6411, lng: -117.9186, name: 'Costa Mesa' },
            // Specific addresses for better accuracy
            '744 s figueroa street': { lat: 34.0470, lng: -118.2580, name: '744 S Figueroa Street' },
            '744 s figueroa': { lat: 34.0470, lng: -118.2580, name: '744 S Figueroa Street' },
            'figueroa street': { lat: 34.0470, lng: -118.2580, name: 'Figueroa Street' },
            '3239 south normandie avenue': { lat: 34.0224, lng: -118.2851, name: '3239 South Normandie Avenue' },
            '3239 s normandie': { lat: 34.0224, lng: -118.2851, name: '3239 South Normandie Avenue' },
            'normandie avenue': { lat: 34.0224, lng: -118.2851, name: 'South Normandie Avenue' },
            '3105 normandie avenue': { lat: 34.0224, lng: -118.2851, name: '3105 Normandie Avenue' },
            '3105 s normandie': { lat: 34.0224, lng: -118.2851, name: '3105 Normandie Avenue' }
        };

        // Get coordinates for a location name
        function getLocationCoordinates(locationName) {
            return locations[locationName.toLowerCase()];
        }

        // Enhanced transit system with proper routing
        const transitSystem = {
            // Metro lines with proper coordinates
            metro: {
                'red-line': {
                    name: 'Red Line',
                    color: '#ff0000',
                    type: 'metro',
                    frequency: 'Every 6-10 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    stations: [
                        { name: 'Union Station', lat: 34.0556, lng: -118.2344, address: '800 N Alameda St' },
                        { name: 'Civic Center/Grand Park', lat: 34.0550, lng: -118.2430, address: '101 S Hill St' },
                        { name: 'Pershing Square', lat: 34.0490, lng: -118.2500, address: '532 S Olive St' },
                        { name: '7th Street/Metro Center', lat: 34.0470, lng: -118.2580, address: '700 S Flower St' },
                        { name: 'Westlake/MacArthur Park', lat: 34.0570, lng: -118.2750, address: '660 S Westlake Ave' },
                        { name: 'Wilshire/Vermont', lat: 34.0620, lng: -118.2910, address: '3010 Wilshire Blvd' },
                        { name: 'Wilshire/Western', lat: 34.0620, lng: -118.3080, address: '3775 Wilshire Blvd' },
                        { name: 'Vermont/Sunset', lat: 34.0980, lng: -118.2910, address: '1500 N Vermont Ave' },
                        { name: 'Vermont/Santa Monica', lat: 34.0890, lng: -118.2910, address: '1400 N Vermont Ave' },
                        { name: 'Hollywood/Western', lat: 34.1020, lng: -118.3080, address: '5450 Hollywood Blvd' },
                        { name: 'Hollywood/Vine', lat: 34.1020, lng: -118.3250, address: '6250 Hollywood Blvd' },
                        { name: 'Hollywood/Highland', lat: 34.1020, lng: -118.3390, address: '6801 Hollywood Blvd' },
                        { name: 'Universal City/Studio City', lat: 34.1380, lng: -118.3590, address: '3900 Lankershim Blvd' },
                        { name: 'North Hollywood', lat: 34.1680, lng: -118.3770, address: '5250 Lankershim Blvd' }
                    ]
                },
                'purple-line': {
                    name: 'Purple Line',
                    color: '#800080',
                    type: 'metro',
                    frequency: 'Every 6-10 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    stations: [
                        { name: 'Union Station', lat: 34.0556, lng: -118.2344, address: '800 N Alameda St' },
                        { name: 'Civic Center/Grand Park', lat: 34.0550, lng: -118.2430, address: '101 S Hill St' },
                        { name: 'Pershing Square', lat: 34.0490, lng: -118.2500, address: '532 S Olive St' },
                        { name: '7th Street/Metro Center', lat: 34.0470, lng: -118.2580, address: '700 S Flower St' },
                        { name: 'Wilshire/Western', lat: 34.0620, lng: -118.3080, address: '3775 Wilshire Blvd' },
                        { name: 'Wilshire/Normandie', lat: 34.0620, lng: -118.3250, address: '3500 Wilshire Blvd' },
                        { name: 'Wilshire/Vermont', lat: 34.0620, lng: -118.2910, address: '3010 Wilshire Blvd' }
                    ]
                },
                'blue-line': {
                    name: 'Blue Line',
                    color: '#0066cc',
                    type: 'metro',
                    frequency: 'Every 6-10 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    stations: [
                        { name: '7th Street/Metro Center', lat: 34.0470, lng: -118.2580, address: '700 S Flower St' },
                        { name: 'Pico', lat: 34.0450, lng: -118.2580, address: '1200 S Flower St' },
                        { name: 'Grand/LATTC', lat: 34.0430, lng: -118.2580, address: '1201 S Grand Ave' },
                        { name: 'San Pedro', lat: 34.0410, lng: -118.2580, address: '1400 S San Pedro St' },
                        { name: 'Washington', lat: 34.0390, lng: -118.2580, address: '1600 S San Pedro St' },
                        { name: 'Vernon', lat: 34.0370, lng: -118.2580, address: '1800 S San Pedro St' },
                        { name: 'Slauson', lat: 34.0350, lng: -118.2580, address: '2000 S San Pedro St' },
                        { name: 'Florence', lat: 34.0330, lng: -118.2580, address: '2200 S San Pedro St' },
                        { name: 'Firestone', lat: 34.0310, lng: -118.2580, address: '2400 S San Pedro St' },
                        { name: '103rd Street/Watts Towers', lat: 34.0290, lng: -118.2580, address: '2600 S San Pedro St' },
                        { name: 'Rosa Parks', lat: 34.0270, lng: -118.2580, address: '2800 S San Pedro St' },
                        { name: 'Imperial/Wilmington', lat: 34.0250, lng: -118.2580, address: '3000 S San Pedro St' },
                        { name: 'Compton', lat: 34.0230, lng: -118.2580, address: '3200 S San Pedro St' },
                        { name: 'Artesia', lat: 34.0210, lng: -118.2580, address: '3400 S San Pedro St' },
                        { name: 'Del Amo', lat: 34.0190, lng: -118.2580, address: '3600 S San Pedro St' },
                        { name: 'Wardlow', lat: 34.0170, lng: -118.2580, address: '3800 S San Pedro St' },
                        { name: 'Willowbrook', lat: 34.0150, lng: -118.2580, address: '4000 S San Pedro St' },
                        { name: 'Long Beach', lat: 34.0130, lng: -118.2580, address: '4200 S San Pedro St' }
                    ]
                },
                'expo-line': {
                    name: 'Expo Line',
                    color: '#00ff00',
                    type: 'metro',
                    frequency: 'Every 6-10 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    stations: [
                        { name: '7th Street/Metro Center', lat: 34.0470, lng: -118.2580, address: '700 S Flower St' },
                        { name: 'Pico', lat: 34.0450, lng: -118.2580, address: '1200 S Flower St' },
                        { name: 'LATTC/Ortho Institute', lat: 34.0430, lng: -118.2580, address: '1201 S Grand Ave' },
                        { name: 'Jefferson/USC', lat: 34.0224, lng: -118.2851, address: 'USC Campus' },
                        { name: 'Expo Park/USC', lat: 34.0180, lng: -118.2850, address: 'Exposition Park' },
                        { name: 'Expo/Vermont', lat: 34.0180, lng: -118.2910, address: 'Exposition Blvd & Vermont Ave' },
                        { name: 'Expo/Western', lat: 34.0180, lng: -118.3080, address: 'Exposition Blvd & Western Ave' },
                        { name: 'Expo/Crenshaw', lat: 34.0180, lng: -118.3250, address: 'Exposition Blvd & Crenshaw Blvd' },
                        { name: 'Farmdale', lat: 34.0180, lng: -118.3420, address: 'Exposition Blvd & Farmdale Ave' },
                        { name: 'Expo/La Brea', lat: 34.0180, lng: -118.3590, address: 'Exposition Blvd & La Brea Ave' },
                        { name: 'La Cienega/Jefferson', lat: 34.0180, lng: -118.3760, address: 'La Cienega Blvd & Jefferson Blvd' },
                        { name: 'Culver City', lat: 34.0211, lng: -118.3965, address: 'Culver City Station' },
                        { name: 'Palms', lat: 34.0180, lng: -118.4130, address: 'Palms Station' },
                        { name: 'Westwood/Rancho Park', lat: 34.0180, lng: -118.4300, address: 'Westwood Blvd & Pico Blvd' },
                        { name: 'Expo/Sepulveda', lat: 34.0180, lng: -118.4470, address: 'Exposition Blvd & Sepulveda Blvd' },
                        { name: 'Expo/Bundy', lat: 34.0180, lng: -118.4640, address: 'Exposition Blvd & Bundy Dr' },
                        { name: '26th Street/Bergamot', lat: 34.0180, lng: -118.4810, address: '26th Street & Olympic Blvd' },
                        { name: '17th Street/SMC', lat: 34.0180, lng: -118.4980, address: '17th Street & Olympic Blvd' },
                        { name: 'Downtown Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica Station' }
                    ]
                }
            },
            
            // Bus routes
            bus: {
                'rapid-720': {
                    name: 'Rapid 720',
                    color: '#ff6b35',
                    type: 'bus',
                    frequency: 'Every 5-8 minutes',
                    operatingHours: '5:00 AM - 12:00 AM',
                    stops: [
                        { name: 'Wilshire/Vermont', lat: 34.0620, lng: -118.2910, address: '3010 Wilshire Blvd' },
                        { name: 'Wilshire/Western', lat: 34.0620, lng: -118.3080, address: '3775 Wilshire Blvd' },
                        { name: 'Wilshire/Normandie', lat: 34.0620, lng: -118.3250, address: '3500 Wilshire Blvd' },
                        { name: 'Wilshire/Fairfax', lat: 34.0620, lng: -118.3420, address: '3200 Wilshire Blvd' },
                        { name: 'Wilshire/La Brea', lat: 34.0620, lng: -118.3590, address: '2900 Wilshire Blvd' },
                        { name: 'Wilshire/Crenshaw', lat: 34.0620, lng: -118.3760, address: '2600 Wilshire Blvd' }
                    ]
                },
                'local-2': {
                    name: 'Local 2',
                    color: '#4caf50',
                    type: 'bus',
                    frequency: 'Every 10-15 minutes',
                    operatingHours: '5:30 AM - 11:30 PM',
                    stops: [
                        { name: 'Vermont/Sunset', lat: 34.0980, lng: -118.2910, address: '1500 N Vermont Ave' },
                        { name: 'Sunset/Vermont', lat: 34.0980, lng: -118.3080, address: '1400 N Vermont Ave' },
                        { name: 'Sunset/Western', lat: 34.0980, lng: -118.3250, address: '1300 N Vermont Ave' },
                        { name: 'Sunset/Fairfax', lat: 34.0980, lng: -118.3420, address: '1200 N Vermont Ave' },
                        { name: 'Sunset/La Brea', lat: 34.0980, lng: -118.3590, address: '1100 N Vermont Ave' }
                    ]
                },
                // Bus routes - Comprehensive LA Transit Services
                'metro-720': {
                    name: 'LA Metro 720 (Wilshire Rapid)',
                    color: '#ff6b35',
                    type: 'bus',
                    frequency: 'Every 5-8 minutes',
                    operatingHours: '5:00 AM - 12:00 AM',
                    carrier: 'LA Metro',
                    stops: [
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' },
                        { name: 'Wilshire/Vermont', lat: 34.0620, lng: -118.2910, address: '3010 Wilshire Blvd' },
                        { name: 'Wilshire/Western', lat: 34.0620, lng: -118.3080, address: '3775 Wilshire Blvd' },
                        { name: 'Wilshire/Normandie', lat: 34.0620, lng: -118.3250, address: '3500 Wilshire Blvd' },
                        { name: 'Wilshire/Fairfax', lat: 34.0620, lng: -118.3420, address: '3200 Wilshire Blvd' },
                        { name: 'Wilshire/La Brea', lat: 34.0620, lng: -118.3590, address: '2900 Wilshire Blvd' },
                        { name: 'Wilshire/Crenshaw', lat: 34.0620, lng: -118.3760, address: '2600 Wilshire Blvd' },
                        { name: 'Century City', lat: 34.0620, lng: -118.3930, address: 'Century City' },
                        { name: 'Westwood', lat: 34.0620, lng: -118.4100, address: 'Westwood' },
                        { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica' }
                    ]
                },
                'metro-2': {
                    name: 'LA Metro 2 (Sunset Blvd)',
                    color: '#4caf50',
                    type: 'bus',
                    frequency: 'Every 10-15 minutes',
                    operatingHours: '5:30 AM - 11:30 PM',
                    carrier: 'LA Metro',
                    stops: [
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' },
                        { name: 'Vermont/Sunset', lat: 34.0980, lng: -118.2910, address: '1500 N Vermont Ave' },
                        { name: 'Sunset/Vermont', lat: 34.0980, lng: -118.3080, address: '1400 N Vermont Ave' },
                        { name: 'Sunset/Western', lat: 34.0980, lng: -118.3250, address: '1300 N Vermont Ave' },
                        { name: 'Sunset/Fairfax', lat: 34.0980, lng: -118.3420, address: '1200 N Vermont Ave' },
                        { name: 'Sunset/La Brea', lat: 34.0980, lng: -118.3590, address: '1100 N Vermont Ave' },
                        { name: 'West Hollywood', lat: 34.0900, lng: -118.3760, address: 'West Hollywood' },
                        { name: 'Beverly Hills', lat: 34.0736, lng: -118.4001, address: 'Beverly Hills' }
                    ]
                },
                'metro-4': {
                    name: 'LA Metro 4 (Santa Monica Blvd)',
                    color: '#2196f3',
                    type: 'bus',
                    frequency: 'Every 8-12 minutes',
                    operatingHours: '5:00 AM - 12:30 AM',
                    carrier: 'LA Metro',
                    stops: [
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' },
                        { name: 'Echo Park', lat: 34.0778, lng: -118.2600, address: 'Echo Park' },
                        { name: 'Silver Lake', lat: 34.0840, lng: -118.2700, address: 'Silver Lake' },
                        { name: 'Los Feliz', lat: 34.0920, lng: -118.2800, address: 'Los Feliz' },
                        { name: 'West Hollywood', lat: 34.0900, lng: -118.3760, address: 'West Hollywood' },
                        { name: 'Beverly Hills', lat: 34.0736, lng: -118.4001, address: 'Beverly Hills' },
                        { name: 'Century City', lat: 34.0620, lng: -118.3930, address: 'Century City' },
                        { name: 'Westwood', lat: 34.0620, lng: -118.4100, address: 'Westwood' },
                        { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica' }
                    ]
                },
                'metro-18': {
                    name: 'LA Metro 18 (Century Blvd)',
                    color: '#9c27b0',
                    type: 'bus',
                    frequency: 'Every 12-15 minutes',
                    operatingHours: '5:00 AM - 11:00 PM',
                    carrier: 'LA Metro',
                    stops: [
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' },
                        { name: 'Century/La Cienega', lat: 34.0000, lng: -118.3760, address: 'Century Blvd & La Cienega Blvd' },
                        { name: 'Century/Fairfax', lat: 34.0000, lng: -118.3420, address: 'Century Blvd & Fairfax Ave' },
                        { name: 'Century/La Brea', lat: 34.0000, lng: -118.3590, address: 'Century Blvd & La Brea Ave' },
                        { name: 'Century/Crenshaw', lat: 34.0000, lng: -118.3760, address: 'Century Blvd & Crenshaw Blvd' },
                        { name: 'Century/Vermont', lat: 34.0000, lng: -118.2910, address: 'Century Blvd & Vermont Ave' },
                        { name: 'Century/Broadway', lat: 34.0000, lng: -118.2437, address: 'Century Blvd & Broadway' },
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' }
                    ]
                },
                
                // DASH Buses - Local city circulators
                'dash-downtown': {
                    name: 'DASH Downtown',
                    color: '#ff9800',
                    type: 'bus',
                    frequency: 'Every 5-10 minutes',
                    operatingHours: '6:00 AM - 7:00 PM',
                    carrier: 'LADOT DASH',
                    stops: [
                        { name: 'Union Station', lat: 34.0556, lng: -118.2344, address: '800 N Alameda St' },
                        { name: 'Civic Center', lat: 34.0550, lng: -118.2430, address: '101 S Hill St' },
                        { name: 'Pershing Square', lat: 34.0490, lng: -118.2500, address: '532 S Olive St' },
                        { name: '7th Street/Metro Center', lat: 34.0470, lng: -118.2580, address: '700 S Flower St' },
                        { name: 'Financial District', lat: 34.0500, lng: -118.2500, address: 'Downtown Financial District' },
                        { name: 'Little Tokyo', lat: 34.0500, lng: -118.2400, address: 'Little Tokyo' },
                        { name: 'Arts District', lat: 34.0450, lng: -118.2300, address: 'Arts District' }
                    ]
                },
                'dash-hollywood': {
                    name: 'DASH Hollywood',
                    color: '#e91e63',
                    type: 'bus',
                    frequency: 'Every 8-12 minutes',
                    operatingHours: '6:00 AM - 8:00 PM',
                    carrier: 'LADOT DASH',
                    stops: [
                        { name: 'Hollywood/Vine', lat: 34.1020, lng: -118.3250, address: '6250 Hollywood Blvd' },
                        { name: 'Hollywood/Highland', lat: 34.1020, lng: -118.3390, address: '6801 Hollywood Blvd' },
                        { name: 'Hollywood/Western', lat: 34.1020, lng: -118.3080, address: '5450 Hollywood Blvd' },
                        { name: 'Hollywood/Cahuenga', lat: 34.1020, lng: -118.3400, address: 'Hollywood Blvd & Cahuenga Blvd' },
                        { name: 'Hollywood/La Brea', lat: 34.1020, lng: -118.3590, address: 'Hollywood Blvd & La Brea Ave' },
                        { name: 'Hollywood/Fairfax', lat: 34.1020, lng: -118.3420, address: 'Hollywood Blvd & Fairfax Ave' }
                    ]
                },
                
                // FlyAway Bus - Airport shuttles
                'flyaway-union': {
                    name: 'FlyAway Union Station',
                    color: '#3f51b5',
                    type: 'bus',
                    frequency: 'Every 30-60 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    carrier: 'FlyAway',
                    stops: [
                        { name: 'Union Station', lat: 34.0556, lng: -118.2344, address: '800 N Alameda St' },
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' }
                    ]
                },
                'flyaway-van-nuys': {
                    name: 'FlyAway Van Nuys',
                    color: '#3f51b5',
                    type: 'bus',
                    frequency: 'Every 30-60 minutes',
                    operatingHours: '4:00 AM - 1:00 AM',
                    carrier: 'FlyAway',
                    stops: [
                        { name: 'Van Nuys FlyAway', lat: 34.2000, lng: -118.4900, address: 'Van Nuys FlyAway Terminal' },
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' }
                    ]
                },
                
                // Big Blue Bus - Santa Monica
                'bigblue-1': {
                    name: 'Big Blue Bus 1 (Santa Monica Blvd)',
                    color: '#00bcd4',
                    type: 'bus',
                    frequency: 'Every 10-15 minutes',
                    operatingHours: '5:00 AM - 12:00 AM',
                    carrier: 'Big Blue Bus',
                    stops: [
                        { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica' },
                        { name: 'Venice', lat: 34.0000, lng: -118.4800, address: 'Venice' },
                        { name: 'Marina del Rey', lat: 33.9800, lng: -118.4700, address: 'Marina del Rey' },
                        { name: 'Culver City', lat: 34.0211, lng: -118.3965, address: 'Culver City' },
                        { name: 'West LA', lat: 34.0430, lng: -118.4100, address: 'West Los Angeles' }
                    ]
                },
                'bigblue-3': {
                    name: 'Big Blue Bus 3 (Lincoln Blvd)',
                    color: '#00bcd4',
                    type: 'bus',
                    frequency: 'Every 12-20 minutes',
                    operatingHours: '5:00 AM - 11:00 PM',
                    carrier: 'Big Blue Bus',
                    stops: [
                        { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica' },
                        { name: 'Venice', lat: 34.0000, lng: -118.4800, address: 'Venice' },
                        { name: 'Marina del Rey', lat: 33.9800, lng: -118.4700, address: 'Marina del Rey' },
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' },
                        { name: 'El Segundo', lat: 33.9200, lng: -118.4000, address: 'El Segundo' }
                    ]
                },
                
                // Culver CityBus
                'culvercity-1': {
                    name: 'Culver CityBus 1',
                    color: '#8bc34a',
                    type: 'bus',
                    frequency: 'Every 15-20 minutes',
                    operatingHours: '5:30 AM - 11:30 PM',
                    carrier: 'Culver CityBus',
                    stops: [
                        { name: 'Culver City', lat: 34.0211, lng: -118.3965, address: 'Culver City' },
                        { name: 'Marina del Rey', lat: 33.9800, lng: -118.4700, address: 'Marina del Rey' },
                        { name: 'Venice', lat: 34.0000, lng: -118.4800, address: 'Venice' },
                        { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, address: 'Santa Monica' },
                        { name: 'West LA', lat: 34.0430, lng: -118.4100, address: 'West Los Angeles' }
                    ]
                },
                
                // Foothill Transit
                'foothill-187': {
                    name: 'Foothill Transit 187 (San Bernardino)',
                    color: '#ff5722',
                    type: 'bus',
                    frequency: 'Every 20-30 minutes',
                    operatingHours: '5:00 AM - 10:00 PM',
                    carrier: 'Foothill Transit',
                    stops: [
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' },
                        { name: 'East LA', lat: 34.0230, lng: -118.1700, address: 'East Los Angeles' },
                        { name: 'Monterey Park', lat: 34.0500, lng: -118.1300, address: 'Monterey Park' },
                        { name: 'Alhambra', lat: 34.0950, lng: -118.1270, address: 'Alhambra' },
                        { name: 'San Gabriel', lat: 34.0960, lng: -118.1050, address: 'San Gabriel' },
                        { name: 'Temple City', lat: 34.1070, lng: -118.0580, address: 'Temple City' },
                        { name: 'Arcadia', lat: 34.1390, lng: -118.0350, address: 'Arcadia' },
                        { name: 'Monrovia', lat: 34.1440, lng: -118.0010, address: 'Monrovia' },
                        { name: 'Duarte', lat: 34.1390, lng: -117.9770, address: 'Duarte' },
                        { name: 'Azusa', lat: 34.1340, lng: -117.9070, address: 'Azusa' },
                        { name: 'Glendora', lat: 34.1360, lng: -117.8650, address: 'Glendora' },
                        { name: 'San Dimas', lat: 34.1070, lng: -117.8170, address: 'San Dimas' },
                        { name: 'La Verne', lat: 34.1000, lng: -117.7700, address: 'La Verne' },
                        { name: 'Claremont', lat: 34.0970, lng: -117.7200, address: 'Claremont' },
                        { name: 'Pomona', lat: 34.0550, lng: -117.7500, address: 'Pomona' },
                        { name: 'Ontario', lat: 34.0630, lng: -117.6500, address: 'Ontario' },
                        { name: 'Rancho Cucamonga', lat: 34.1060, lng: -117.5930, address: 'Rancho Cucamonga' },
                        { name: 'Fontana', lat: 34.0920, lng: -117.4350, address: 'Fontana' },
                        { name: 'Rialto', lat: 34.1000, lng: -117.3700, address: 'Rialto' },
                        { name: 'San Bernardino', lat: 34.1080, lng: -117.2900, address: 'San Bernardino' }
                    ]
                },
                
                // Torrance Transit
                'torrance-1': {
                    name: 'Torrance Transit 1',
                    color: '#795548',
                    type: 'bus',
                    frequency: 'Every 15-25 minutes',
                    operatingHours: '5:00 AM - 11:00 PM',
                    carrier: 'Torrance Transit',
                    stops: [
                        { name: 'Torrance', lat: 33.8350, lng: -118.3410, address: 'Torrance' },
                        { name: 'Redondo Beach', lat: 33.8490, lng: -118.3880, address: 'Redondo Beach' },
                        { name: 'Manhattan Beach', lat: 33.8840, lng: -118.4100, address: 'Manhattan Beach' },
                        { name: 'El Segundo', lat: 33.9200, lng: -118.4000, address: 'El Segundo' },
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' }
                    ]
                },
                
                // Norwalk Transit
                'norwalk-1': {
                    name: 'Norwalk Transit 1',
                    color: '#607d8b',
                    type: 'bus',
                    frequency: 'Every 20-30 minutes',
                    operatingHours: '5:00 AM - 10:00 PM',
                    carrier: 'Norwalk Transit',
                    stops: [
                        { name: 'Norwalk', lat: 33.9020, lng: -118.0810, address: 'Norwalk' },
                        { name: 'Downey', lat: 33.9400, lng: -118.1300, address: 'Downey' },
                        { name: 'Bellflower', lat: 33.8820, lng: -118.1170, address: 'Bellflower' },
                        { name: 'Lakewood', lat: 33.8530, lng: -118.1340, address: 'Lakewood' },
                        { name: 'Long Beach', lat: 33.7700, lng: -118.1930, address: 'Long Beach' }
                    ]
                },
                
                // Amtrak - National Rail Service
                'amtrak-pacific-surfliner': {
                    name: 'Amtrak Pacific Surfliner',
                    color: '#1e3a8a',
                    type: 'train',
                    frequency: 'Every 2-4 hours',
                    operatingHours: '5:00 AM - 10:00 PM',
                    carrier: 'Amtrak',
                    stops: [
                        { name: 'San Diego', lat: 32.7157, lng: -117.1611, address: 'San Diego Union Station' },
                        { name: 'Oceanside', lat: 33.1959, lng: -117.3795, address: 'Oceanside Transit Center' },
                        { name: 'San Juan Capistrano', lat: 33.5017, lng: -117.6625, address: 'San Juan Capistrano Station' },
                        { name: 'Irvine', lat: 33.6846, lng: -117.8265, address: 'Irvine Station' },
                        { name: 'Santa Ana', lat: 33.7455, lng: -117.8677, address: 'Santa Ana Station' },
                        { name: 'Anaheim', lat: 33.8038, lng: -117.8849, address: 'Anaheim Station' },
                        { name: 'Fullerton', lat: 33.8703, lng: -117.9244, address: 'Fullerton Station' },
                        { name: 'Los Angeles', lat: 34.0556, lng: -118.2344, address: 'Los Angeles Union Station' },
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank Airport Station' },
                        { name: 'Ventura', lat: 34.2746, lng: -119.2290, address: 'Ventura Station' },
                        { name: 'Santa Barbara', lat: 34.4208, lng: -119.6982, address: 'Santa Barbara Station' },
                        { name: 'San Luis Obispo', lat: 35.2828, lng: -120.6596, address: 'San Luis Obispo Station' }
                    ]
                },
                
                // Metrolink - Regional Commuter Rail
                'metrolink-antelope-valley': {
                    name: 'Metrolink Antelope Valley Line',
                    color: '#dc2626',
                    type: 'train',
                    frequency: 'Every 1-2 hours',
                    operatingHours: '4:00 AM - 11:00 PM',
                    carrier: 'Metrolink',
                    stops: [
                        { name: 'Lancaster', lat: 34.6868, lng: -118.1542, address: 'Lancaster Station' },
                        { name: 'Palmdale', lat: 34.5794, lng: -118.1165, address: 'Palmdale Station' },
                        { name: 'Santa Clarita', lat: 34.3917, lng: -118.5426, address: 'Santa Clarita Station' },
                        { name: 'Sylmar', lat: 34.3071, lng: -118.4481, address: 'Sylmar Station' },
                        { name: 'Sun Valley', lat: 34.2175, lng: -118.3704, address: 'Sun Valley Station' },
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank Airport Station' },
                        { name: 'Glendale', lat: 34.1425, lng: -118.2551, address: 'Glendale Station' },
                        { name: 'Los Angeles', lat: 34.0556, lng: -118.2344, address: 'Los Angeles Union Station' }
                    ]
                },
                'metrolink-ventura-county': {
                    name: 'Metrolink Ventura County Line',
                    color: '#059669',
                    type: 'train',
                    frequency: 'Every 1-2 hours',
                    operatingHours: '4:00 AM - 11:00 PM',
                    carrier: 'Metrolink',
                    stops: [
                        { name: 'Ventura', lat: 34.2746, lng: -119.2290, address: 'Ventura Station' },
                        { name: 'Oxnard', lat: 34.1975, lng: -119.1771, address: 'Oxnard Station' },
                        { name: 'Camarillo', lat: 34.2164, lng: -119.0376, address: 'Camarillo Station' },
                        { name: 'Moorpark', lat: 34.2856, lng: -118.8770, address: 'Moorpark Station' },
                        { name: 'Simi Valley', lat: 34.2694, lng: -118.7815, address: 'Simi Valley Station' },
                        { name: 'Chatsworth', lat: 34.2572, lng: -118.6012, address: 'Chatsworth Station' },
                        { name: 'Northridge', lat: 34.2283, lng: -118.5368, address: 'Northridge Station' },
                        { name: 'Van Nuys', lat: 34.2000, lng: -118.4900, address: 'Van Nuys Station' },
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank Airport Station' },
                        { name: 'Glendale', lat: 34.1425, lng: -118.2551, address: 'Glendale Station' },
                        { name: 'Los Angeles', lat: 34.0556, lng: -118.2344, address: 'Los Angeles Union Station' }
                    ]
                },
                
                // Long Beach Transit
                'longbeach-1': {
                    name: 'Long Beach Transit 1',
                    color: '#7c3aed',
                    type: 'bus',
                    frequency: 'Every 10-15 minutes',
                    operatingHours: '5:00 AM - 12:00 AM',
                    carrier: 'Long Beach Transit',
                    stops: [
                        { name: 'Long Beach', lat: 33.7700, lng: -118.1930, address: 'Long Beach' },
                        { name: 'Signal Hill', lat: 33.8045, lng: -118.1679, address: 'Signal Hill' },
                        { name: 'Lakewood', lat: 33.8530, lng: -118.1340, address: 'Lakewood' },
                        { name: 'Bellflower', lat: 33.8820, lng: -118.1170, address: 'Bellflower' },
                        { name: 'Downey', lat: 33.9400, lng: -118.1300, address: 'Downey' }
                    ]
                },
                
                // Pasadena Transit
                'pasadena-10': {
                    name: 'Pasadena Transit 10',
                    color: '#f59e0b',
                    type: 'bus',
                    frequency: 'Every 15-20 minutes',
                    operatingHours: '5:30 AM - 11:30 PM',
                    carrier: 'Pasadena Transit',
                    stops: [
                        { name: 'Pasadena', lat: 34.1478, lng: -118.1445, address: 'Pasadena' },
                        { name: 'Altadena', lat: 34.1897, lng: -118.1312, address: 'Altadena' },
                        { name: 'Arcadia', lat: 34.1390, lng: -118.0350, address: 'Arcadia' },
                        { name: 'Monrovia', lat: 34.1440, lng: -118.0010, address: 'Monrovia' },
                        { name: 'Duarte', lat: 34.1390, lng: -117.9770, address: 'Duarte' }
                    ]
                },
                
                // Burbank Bus
                'burbank-1': {
                    name: 'Burbank Bus 1',
                    color: '#0891b2',
                    type: 'bus',
                    frequency: 'Every 20-30 minutes',
                    operatingHours: '5:00 AM - 10:00 PM',
                    carrier: 'Burbank Bus',
                    stops: [
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank' },
                        { name: 'Glendale', lat: 34.1425, lng: -118.2551, address: 'Glendale' },
                        { name: 'North Hollywood', lat: 34.1680, lng: -118.3770, address: 'North Hollywood' },
                        { name: 'Toluca Lake', lat: 34.1500, lng: -118.3500, address: 'Toluca Lake' },
                        { name: 'Studio City', lat: 34.1380, lng: -118.3590, address: 'Studio City' }
                    ]
                },
                
                // Glendale Beeline
                'glendale-1': {
                    name: 'Glendale Beeline 1',
                    color: '#059669',
                    type: 'bus',
                    frequency: 'Every 15-25 minutes',
                    operatingHours: '5:00 AM - 11:00 PM',
                    carrier: 'Glendale Beeline',
                    stops: [
                        { name: 'Glendale', lat: 34.1425, lng: -118.2551, address: 'Glendale' },
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank' },
                        { name: 'Pasadena', lat: 34.1478, lng: -118.1445, address: 'Pasadena' },
                        { name: 'Eagle Rock', lat: 34.1390, lng: -118.2000, address: 'Eagle Rock' },
                        { name: 'Highland Park', lat: 34.1200, lng: -118.1900, address: 'Highland Park' }
                    ]
                },
                
                // Beach Cities Transit
                'beachcities-1': {
                    name: 'Beach Cities Transit 1',
                    color: '#0ea5e9',
                    type: 'bus',
                    frequency: 'Every 20-30 minutes',
                    operatingHours: '5:00 AM - 11:00 PM',
                    carrier: 'Beach Cities Transit',
                    stops: [
                        { name: 'Redondo Beach', lat: 33.8490, lng: -118.3880, address: 'Redondo Beach' },
                        { name: 'Hermosa Beach', lat: 33.8622, lng: -118.3995, address: 'Hermosa Beach' },
                        { name: 'Manhattan Beach', lat: 33.8840, lng: -118.4100, address: 'Manhattan Beach' },
                        { name: 'El Segundo', lat: 33.9200, lng: -118.4000, address: 'El Segundo' },
                        { name: 'LAX Airport', lat: 33.9416, lng: -118.4085, address: 'Los Angeles International Airport' }
                    ]
                },
                
                // Commuter Express
                'commuterexpress-431': {
                    name: 'Commuter Express 431',
                    color: '#dc2626',
                    type: 'bus',
                    frequency: 'Every 30-60 minutes',
                    operatingHours: '5:00 AM - 9:00 AM, 3:00 PM - 7:00 PM',
                    carrier: 'Commuter Express',
                    stops: [
                        { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, address: 'Downtown Los Angeles' },
                        { name: 'Echo Park', lat: 34.0778, lng: -118.2600, address: 'Echo Park' },
                        { name: 'Silver Lake', lat: 34.0840, lng: -118.2700, address: 'Silver Lake' },
                        { name: 'Los Feliz', lat: 34.0920, lng: -118.2800, address: 'Los Feliz' },
                        { name: 'Atwater Village', lat: 34.1000, lng: -118.2600, address: 'Atwater Village' },
                        { name: 'Glendale', lat: 34.1425, lng: -118.2551, address: 'Glendale' },
                        { name: 'Burbank', lat: 34.1808, lng: -118.3089, address: 'Burbank' }
                    ]
                },
                
                // Bruin Bus (UCLA)
                'bruinbus-campus': {
                    name: 'Bruin Bus Campus',
                    color: '#1e40af',
                    type: 'bus',
                    frequency: 'Every 5-10 minutes',
                    operatingHours: '6:00 AM - 10:00 PM',
                    carrier: 'Bruin Bus',
                    stops: [
                        { name: 'UCLA Campus', lat: 34.0689, lng: -118.4452, address: 'UCLA Campus' },
                        { name: 'Westwood', lat: 34.0620, lng: -118.4100, address: 'Westwood' },
                        { name: 'Brentwood', lat: 34.0520, lng: -118.4700, address: 'Brentwood' },
                        { name: 'Sawtelle', lat: 34.0450, lng: -118.4500, address: 'Sawtelle' },
                        { name: 'West LA', lat: 34.0430, lng: -118.4100, address: 'West Los Angeles' }
                    ]
                },
                
                // West Hollywood Transportation
                'westhollywood-1': {
                    name: 'West Hollywood Transportation 1',
                    color: '#ec4899',
                    type: 'bus',
                    frequency: 'Every 15-20 minutes',
                    operatingHours: '6:00 AM - 10:00 PM',
                    carrier: 'West Hollywood Transportation',
                    stops: [
                        { name: 'West Hollywood', lat: 34.0900, lng: -118.3760, address: 'West Hollywood' },
                        { name: 'Beverly Hills', lat: 34.0736, lng: -118.4001, address: 'Beverly Hills' },
                        { name: 'Hollywood', lat: 34.1020, lng: -118.3390, address: 'Hollywood' },
                        { name: 'Los Feliz', lat: 34.0920, lng: -118.2800, address: 'Los Feliz' },
                        { name: 'Silver Lake', lat: 34.0840, lng: -118.2700, address: 'Silver Lake' }
                    ]
                }
            }
        };

        // Speed constants (miles per hour)
        const SPEEDS = {
            walk: 3.1,      // mph
            bike: 12,       // mph
            bus: 15,        // mph in city
            metro: 35,      // mph average
            train: 50       // mph for commuter rail
        };

        // Walking distance limits
        const WALKING_LIMIT = 5; // miles - increased from 2 to 5 for more realistic walking routes
        const BIKE_LIMIT = 15;   // miles - increased from 10 to 15 for longer bike routes

        let map;
        let currentRoute = null;
        let routeLayers = {};
        let currentMode = 'metro';
        let markers = [];

        // Initialize map with all transit options
        function initMap() {
            map = L.map('map').setView([34.0522, -118.2437], 11);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Draw metro lines
            Object.keys(transitSystem.metro).forEach(lineKey => {
                const line = transitSystem.metro[lineKey];
                const coordinates = line.stations.map(station => [station.lat, station.lng]);
                
                const polyline = L.polyline(coordinates, {
                    color: line.color,
                    weight: 6,
                    opacity: 0.6
                }).addTo(map);

                polyline.on('click', () => selectRoute(lineKey, 'metro'));
                routeLayers[`metro-${lineKey}`] = polyline;

                // Add station markers
                line.stations.forEach(station => {
                    const marker = L.marker([station.lat, station.lng]).addTo(map);
                    marker.bindPopup(`
                        <h3>${station.name}</h3>
                        <p><strong>Line:</strong> ${line.name}</p>
                        <p><strong>Type:</strong> Metro Station</p>
                        <p><strong>Address:</strong> ${station.address}</p>
                    `);
                });
            });

            // Draw bus routes
            Object.keys(transitSystem.bus).forEach(routeKey => {
                const route = transitSystem.bus[routeKey];
                const coordinates = route.stops.map(stop => [stop.lat, stop.lng]);
                
                const polyline = L.polyline(coordinates, {
                    color: route.color,
                    weight: 4,
                    opacity: 0.5,
                    dashArray: '10, 5'
                }).addTo(map);

                polyline.on('click', () => selectRoute(routeKey, 'bus'));
                routeLayers[`bus-${routeKey}`] = polyline;

                // Add bus stop markers
                route.stops.forEach(stop => {
                    const marker = L.circleMarker([stop.lat, stop.lng], {
                        radius: 6,
                        fillColor: route.color,
                        color: '#fff',
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);
                    marker.bindPopup(`
                        <h3>${stop.name}</h3>
                        <p><strong>Route:</strong> ${route.name}</p>
                        <p><strong>Carrier:</strong> ${route.carrier || 'LA Metro'}</p>
                        <p><strong>Type:</strong> Bus Stop</p>
                        <p><strong>Frequency:</strong> ${route.frequency}</p>
                        <p><strong>Hours:</strong> ${route.operatingHours}</p>
                        <p><strong>Address:</strong> ${stop.address}</p>
                    `);
                });
            });

            setMode('metro');
        }

        // Calculate distance between two points using Haversine formula
        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            
            // Round to 1 decimal place for better readability
            return Math.round(distance * 10) / 10;
        }

        // Find nearest transit stop with better logic
        function findNearestStop(lat, lng, type = 'metro') {
            let nearest = null;
            let minDistance = Infinity;
            
            const routes = type === 'metro' ? transitSystem.metro : transitSystem.bus;
            
            Object.keys(routes).forEach(routeKey => {
                const route = routes[routeKey];
                const stops = type === 'metro' ? route.stations : route.stops;
                
                stops.forEach(stop => {
                    const distance = calculateDistance(lat, lng, stop.lat, stop.lng);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearest = { ...stop, route: route, routeKey: routeKey, distance: distance };
                    }
                });
            });
            
            return nearest;
        }

        // Plan route from origin to destination
        function planRoute(origin, destination, mode, departureTime) {
            console.log('planRoute called with:', { origin, destination, mode, departureTime });
            
            // Handle current location
            let originCoords = null;
            let destCoords = null;
            
            if (origin.toLowerCase().includes('current') || origin === currentLocation?.address) {
                console.log('Using current location as origin');
                if (currentLocation) {
                    originCoords = { lat: currentLocation.lat, lng: currentLocation.lng };
                } else {
                    console.log('Current location not available');
                    return {
                        type: 'error',
                        message: 'Current location not available. Please use the "üìç Current" button first.'
                    };
                }
            } else {
                // Find origin coordinates
                console.log('Looking for origin location:', origin);
                const originLocation = findLocationByName(origin);
                console.log('Origin location found:', originLocation);
                if (!originLocation) {
                    console.log('Origin location not found');
                    return {
                        type: 'error',
                        message: `Origin "${origin}" not found. Please check the spelling or use a location from the list.`
                    };
                }
                originCoords = { lat: originLocation.lat, lng: originLocation.lng };
            }
            
            // Find destination coordinates
            console.log('Looking for destination location:', destination);
            const destLocation = findLocationByName(destination);
            console.log('Destination location found:', destLocation);
            if (!destLocation) {
                console.log('Destination location not found');
                return {
                    type: 'error',
                    message: `Destination "${destination}" not found. Please check the spelling or use a location from the list.`
                };
            }
            destCoords = { lat: destLocation.lat, lng: destLocation.lng };
            
            console.log('Coordinates:', { originCoords, destCoords });
            
            // Calculate direct distance
            const directDistance = calculateDistance(originCoords.lat, originCoords.lng, destCoords.lat, destCoords.lng);
            console.log('Direct distance:', directDistance);
            
            // Handle different modes
            if (mode === 'walk') {
                console.log('Processing walk mode');
                if (directDistance <= WALKING_LIMIT) {
                    const walkTime = Math.round(directDistance / SPEEDS.walk * 60);
                    console.log('Walk route created:', { walkTime, directDistance });
                    return {
                        type: 'route',
                        totalTime: walkTime,
                        totalDistance: directDistance,
                        steps: [{
                            type: 'walk',
                            from: origin,
                            to: destination,
                            distance: directDistance,
                            time: walkTime,
                            instruction: `Walk ${directDistance} miles to ${destination}`,
                            routeName: null
                        }]
                    };
                } else {
                    console.log('Walk distance too far, suggesting metro');
                    return {
                        type: 'suggestion',
                        message: `Walking distance (${directDistance} miles) exceeds limit. Try metro or bus instead.`,
                        suggestion: 'metro'
                    };
                }
            }
            
            if (mode === 'bike') {
                console.log('Processing bike mode');
                if (directDistance <= BIKE_LIMIT) {
                    const bikeTime = Math.round(directDistance / SPEEDS.bike * 60);
                    console.log('Bike route created:', { bikeTime, directDistance });
                    return {
                        type: 'route',
                        totalTime: bikeTime,
                        totalDistance: directDistance,
                        steps: [{
                            type: 'bike',
                            from: origin,
                            to: destination,
                            distance: directDistance,
                            time: bikeTime,
                            instruction: `üö¥ Bike ${directDistance.toFixed(1)} miles to ${destination}. Start from ${origin}, follow bike lanes and road shoulders. Use hand signals for turns and follow traffic rules.`,
                            routeName: null
                        }]
                    };
                } else {
                    console.log('Bike distance too far, suggesting metro');
                    return {
                        type: 'suggestion',
                        message: `Biking distance (${directDistance} miles) exceeds limit. Try metro or bus instead.`,
                        suggestion: 'metro'
                    };
                }
            }
            
            // For metro and bus, find nearest stops
            if (mode === 'metro' || mode === 'bus') {
                console.log(`Processing ${mode} mode`);
                
                // Use dynamic routing to find nearest stops and routes
                const transitRoute = findDynamicTransitRoute(originCoords, destCoords, mode);
                console.log('Dynamic transit route found:', transitRoute);
                
                if (!transitRoute) {
                    console.log('No transit route found');
                    return {
                        type: 'error',
                        message: `No ${mode} stops found near ${origin} or ${destination}. Try a different mode.`
                    };
                }
                
                // Use the walking distances calculated by findDynamicTransitRoute
                const walkToOrigin = transitRoute.walkToOriginStop;
                const walkFromDest = transitRoute.walkFromDestStop;
                
                console.log('Walking distances from dynamic route:', { walkToOrigin, walkFromDest });
                
                // Check if walking distances are reasonable
                if (walkToOrigin > 1.0 || walkFromDest > 1.0) {
                    console.log('Walking distances too far, suggesting bike');
                    return {
                        type: 'suggestion',
                        message: `Walking to ${mode} stops is too far (${walkToOrigin.toFixed(1)} and ${walkFromDest.toFixed(1)} miles). Try biking or a different mode.`,
                        suggestion: 'bike'
                    };
                }
                
                // Calculate times using the walking distances from the route
                const walkToTime = Math.round(walkToOrigin / SPEEDS.walk * 60);
                const transitTime = transitRoute.time;
                const walkFromTime = Math.round(walkFromDest / SPEEDS.walk * 60);
                
                console.log('Calculated times:', { walkToTime, transitTime, walkFromTime });
                
                const steps = [];
                
                // Walk to origin stop
                if (walkToOrigin > 0.01) { // Reduced threshold to include more walking steps
                    const walkStep = {
                        type: 'walk',
                        from: origin,
                        to: transitRoute.originStop.name,
                        distance: walkToOrigin,
                        time: walkToTime,
                        instruction: `üö∂ Walk ${walkToOrigin.toFixed(2)} miles to ${transitRoute.originStop.name}. Start from ${origin}, walk straight for ${Math.round(walkToOrigin * 5280 * 0.4)} feet, turn right and continue for ${Math.round(walkToOrigin * 5280 * 0.6)} feet. Look for ${transitRoute.originStop.name} signs and entrance.`,
                        routeName: 'Walking Route'
                    };
                    steps.push(walkStep);
                    console.log('‚úÖ Added walking step to origin:', walkStep);
                } else {
                    console.log('‚ö†Ô∏è Walking distance too short, skipping walking step. Distance:', walkToOrigin);
                }
                
                // Transit segment
                if (transitRoute.transferRequired) {
                    // Split into two transit steps for transfer routes
                    const transferStation = transitRoute.transferStation;
                    
                    // Fix the routeKey splitting - handle hyphenated route names properly
                    const routeKeyParts = transitRoute.routeKey.split('-');
                    let originLine, destLine;
                    
                    // Handle different route key formats
                    if (routeKeyParts.length === 4) {
                        // Format: "expo-line-red-line" -> ["expo", "line", "red", "line"]
                        originLine = `${routeKeyParts[0]}-${routeKeyParts[1]}`;
                        destLine = `${routeKeyParts[2]}-${routeKeyParts[3]}`;
                    } else if (routeKeyParts.length === 3) {
                        // Format: "red-line-blue" -> ["red", "line", "blue"]
                        originLine = `${routeKeyParts[0]}-${routeKeyParts[1]}`;
                        destLine = routeKeyParts[2];
                    } else {
                        // Fallback: assume first part is origin, rest is destination
                        originLine = routeKeyParts[0];
                        destLine = routeKeyParts.slice(1).join('-');
                    }
                    
                    console.log('Processing transfer route:', { 
                        transferStation, 
                        originLine, 
                        destLine, 
                        routeKey: transitRoute.routeKey,
                        routeKeyParts,
                        availableLines: Object.keys(transitSystem.metro)
                    });
                    
                    // Safety check for origin line
                    if (!transitSystem.metro[originLine]) {
                        console.error('Origin line not found:', originLine);
                        return {
                            type: 'error',
                            message: `Metro line not found: ${originLine}`
                        };
                    }
                    
                    // Safety check for destination line
                    if (!transitSystem.metro[destLine]) {
                        console.error('Destination line not found:', destLine);
                        return {
                            type: 'error',
                            message: `Metro line not found: ${destLine}`
                        };
                    }
                    
                    // First leg: origin stop to transfer station
                    steps.push({
                        type: mode,
                        from: transitRoute.originStop.name,
                        to: transferStation,
                        distance: transitRoute.distance / 2, // Approximate
                        time: Math.round(transitRoute.time / 2), // Approximate
                        instruction: `Take ${transitSystem.metro[originLine].name} to ${transferStation}`,
                        routeName: transitSystem.metro[originLine].name
                    });
                    
                    // Transfer step
                    steps.push({
                        type: 'transfer',
                        from: transferStation,
                        to: transferStation,
                        distance: 0,
                        time: 5, // 5 minutes for transfer
                        instruction: `Transfer to ${transitSystem.metro[destLine].name} at ${transferStation}`,
                        routeName: `${transitSystem.metro[originLine].name} ‚Üí ${transitSystem.metro[destLine].name}`
                    });
                    
                    // Second leg: transfer station to destination stop
                    steps.push({
                        type: mode,
                        from: transferStation,
                        to: transitRoute.destStop.name,
                        distance: transitRoute.distance / 2, // Approximate
                        time: Math.round(transitRoute.time / 2), // Approximate
                        instruction: `Take ${transitSystem.metro[destLine].name} to ${transitRoute.destStop.name}`,
                        routeName: transitSystem.metro[destLine].name
                    });
                } else {
                    // Direct route (no transfer)
                    steps.push({
                        type: mode,
                        from: transitRoute.originStop.name,
                        to: transitRoute.destStop.name,
                        distance: transitRoute.distance,
                        time: transitTime,
                        instruction: `Take ${transitRoute.name} from ${transitRoute.originStop.name} to ${transitRoute.destStop.name}`,
                        routeName: transitRoute.name
                    });
                }
                
                // Walk from destination stop
                if (walkFromDest > 0.001) { // Reduced threshold to always include walking steps
                    steps.push({
                        type: 'walk',
                        from: transitRoute.destStop.name,
                        to: destination,
                        distance: walkFromDest,
                        time: walkFromTime,
                        instruction: `üö∂ Walk ${walkFromDest.toFixed(2)} miles to ${destination}. Start from ${transitRoute.destStop.name}, walk straight for ${Math.round(walkFromDest * 5280 * 0.4)} feet, turn left and continue for ${Math.round(walkFromDest * 5280 * 0.6)} feet. You will reach ${destination}.`,
                        routeName: 'Walking Route'
                    });
                    console.log('‚úÖ Added walking step from destination:', { distance: walkFromDest, time: walkFromTime });
                } else {
                    console.log('‚ö†Ô∏è Walking distance from destination too short, skipping. Distance:', walkFromDest);
                }
                
                const totalTime = steps.reduce((sum, step) => sum + step.time, 0);
                const totalDistance = steps.reduce((sum, step) => sum + step.distance, 0);
                
                console.log('üéØ Final route created:', { 
                    totalTime, 
                    totalDistance, 
                    stepsCount: steps.length,
                    steps: steps.map((step, index) => ({
                        index,
                        type: step.type,
                        from: step.from,
                        to: step.to,
                        distance: step.distance,
                        time: step.time,
                        instruction: step.instruction
                    }))
                });
                
                return {
                    type: 'route',
                    totalTime: totalTime,
                    totalDistance: totalDistance,
                    steps: steps
                };
            }
            
            console.log('Invalid mode:', mode);
            return {
                type: 'error',
                message: 'Invalid transportation mode.'
            };
        }

        // Find location by name with improved matching
        function findLocationByName(name) {
            const searchName = name.toLowerCase().trim();
            
            // Direct match
            if (locations[searchName]) {
                return locations[searchName];
            }
            
            // Partial match
            for (const [key, location] of Object.entries(locations)) {
                if (key.includes(searchName) || searchName.includes(key)) {
                    return location;
                }
            }
            
            // Check if it's an address-like string
            if (searchName.includes('avenue') || searchName.includes('street') || searchName.includes('road') || 
                searchName.includes('boulevard') || searchName.includes('drive') || searchName.includes('way')) {
                // This might be an actual address, return null to let the system handle it
                return null;
            }
            
            // If no match found, try geocoding anyway (for any location)
            console.log('No hardcoded or user match found, trying geocoding...');
            const geocoded = geocodeAddress(searchName);
            if (geocoded) {
                return geocoded;
            }
            
            console.log('‚ùå Location not found');
            return null;
        }

        function selectRoute(routeKey, mode) {
            currentRoute = routeKey;
            currentMode = mode; // Update current mode

            // Reset all route opacities
            Object.keys(routeLayers).forEach(key => {
                routeLayers[key].setStyle({ opacity: 0.6 });
            });

            // Highlight selected route
            routeLayers[`${mode}-${routeKey}`].setStyle({ opacity: 1 });

            // Fit map to route bounds
            const bounds = L.latLngBounds(transitSystem[mode][routeKey].stations.map(station => [station.lat, station.lng])); // Use metro coordinates for bounds
            map.fitBounds(bounds, { padding: [20, 20] });

            // Update panel content
            updatePanel(transitSystem[mode][routeKey]); // Pass metro route for display
        }

        function updatePanel(route) {
            const panelContent = document.getElementById('panel-content');
            
            panelContent.innerHTML = `
                <div class="route-info">
                    <div class="route-header" style="background: ${route.color}15; border-left: 4px solid ${route.color};">
                        <div class="route-color" style="background-color: ${route.color};">
                            ${route.name.split(' ')[0][0]}
                        </div>
                        <div>
                            <h3 style="margin: 0;">${route.name}</h3>
                            <p style="margin: 0; color: #666;">${route.description}</p>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div class="info-item">
                            ‚è∞ Frequency: ${route.frequency}
                        </div>
                        <div class="info-item">
                            üïí Operating Hours: ${route.operatingHours}
                        </div>
                        <div class="info-item">
                            üìç ${route.stations.length} Stations
                        </div>
                    </div>
                </div>

                <div style="margin-top: 1rem;">
                    <h3 style="margin-bottom: 1rem;">Stations</h3>
                    ${route.stations.map(station => `
                        <div class="station-item">
                            <h4 style="margin: 0 0 0.5rem 0; color: #333;">${station.name}</h4>
                            <div style="font-size: 0.9rem; color: #666;">
                                üìç ${station.address}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function togglePanel() {
            const panel = document.getElementById('panel');
            panel.classList.toggle('hidden');
        }

        function toggleSearch() {
            console.log('üîç toggleSearch function called');
            const searchPanel = document.getElementById('searchPanel');
            const panel = document.getElementById('panel');
            
            console.log('üîç Search panel element:', searchPanel);
            console.log('üîç Panel element:', panel);
            console.log('üîç Search panel display:', searchPanel?.style?.display);
            
            if (searchPanel && searchPanel.style.display === 'none') {
                searchPanel.style.display = 'block';
                if (panel) panel.classList.add('hidden');
                console.log('‚úÖ Search panel shown');
            } else if (searchPanel) {
                searchPanel.style.display = 'none';
                console.log('‚úÖ Search panel hidden');
            } else {
                console.error('‚ùå Search panel element not found');
            }
        }

        // Enhanced journey planning with waypoints and real-time times
        async function handleSearch(event) {
            event.preventDefault();
            
            const origin = document.getElementById('originInput').value.trim();
            const destination = document.getElementById('destinationInput').value.trim();
            const departureTime = document.getElementById('departureTime').value || '08:00';
            
            console.log('handleSearch called with:', { origin, destination, departureTime, currentMode });
            
            // Get waypoints
            const waypointInputs = document.querySelectorAll('#waypointsContainer .search-input');
            const waypoints = Array.from(waypointInputs).map(input => input.value).filter(val => val.trim() !== '');
            
            if (!origin || !destination) {
                alert('Please enter both origin and destination locations.');
                return;
            }

            // Store current search data for modal
            currentOrigin = origin;
            currentDestination = destination;
            
            // Show loading message
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div class="loading-spinner">ÔøΩÔøΩ Finding route...</div>';
            
            try {
                // Get route result using async geocoding
                const routeResult = await planRouteAsync(origin, destination, currentMode, departureTime);
                console.log('Route result:', routeResult);
                
                // Convert to array format for displaySearchResults
                currentRoutes = [routeResult];
                
                displaySearchResults(currentRoutes);
            } catch (error) {
                console.error('Route planning error:', error);
                resultsContainer.innerHTML = '<div class="no-results">‚ùå Error finding route. Please try again.</div>';
            }
        }

        function displaySearchResults(routes) {
            console.log('displaySearchResults called with:', routes);
            const resultsContainer = document.getElementById('searchResults');
            console.log('Results container:', resultsContainer);
            
            if (!routes || routes.length === 0) {
                console.log('No routes to display');
                resultsContainer.innerHTML = `
                    <div class="no-results">
                        <h4>No routes found</h4>
                        <p>Try different locations or check your spelling.</p>
                        <p>Available locations: Downtown, Hollywood, Santa Monica, Venice, Beverly Hills, West Hollywood, Koreatown, Echo Park, Silver Lake, Los Feliz, Glendale, Pasadena, Long Beach, Manhattan Beach</p>
                    </div>
                `;
                return;
            }
            
            console.log('Processing routes:', routes.length);
            const html = routes.map((route, index) => {
                console.log('Processing route:', route);
                if (route.type === 'suggestion') {
                    return `
                        <div class="route-result" style="background-color: #fff3cd; border: 1px solid #ffeaa7;">
                            <div class="route-header-result">
                                <h4 class="route-name">üí° Suggestion</h4>
                            </div>
                            <div class="route-details">
                                <div class="route-info-result">
                                    ${route.message}
                                </div>
                                <div class="route-info-result">
                                    <button onclick="setMode('${route.suggestion}'); handleSearch(new Event('submit'))" style="background: #007bff; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-top: 0.5rem;">
                                        Try ${route.suggestion} instead
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (route.type === 'error') {
                    return `
                        <div class="route-result" style="background-color: #f8d7da; border: 1px solid #f5c6cb;">
                            <div class="route-header-result">
                                <h4 class="route-name">‚ùå No Route Found</h4>
                            </div>
                            <div class="route-details">
                                <div class="route-info-result">
                                    ${route.message}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (route.type === 'route') {
                    // Determine the primary mode from steps
                    const primaryStep = route.steps.find(step => step.type !== 'walk') || route.steps[0];
                    const modeIcon = getModeIcon(primaryStep ? primaryStep.type : 'walk');
                    const modeName = getModeName(primaryStep ? primaryStep.type : 'walk');
                    
                    return `
                        <div class="route-result" onclick="showRouteDetails(${index})" style="cursor: pointer;">
                            <div class="route-header-result">
                                <h4 class="route-name">${modeIcon} ${modeName} Route</h4>
                            </div>
                            
                            <div class="route-details">
                                <div class="route-info-result">
                                    üïí Total Time: ${route.totalTime} minutes
                                </div>
                                <div class="route-info-result">
                                    üìç Total Distance: ${route.totalDistance.toFixed(1)} miles
                                </div>
                                <div class="route-info-result" style="color: #0066cc; font-weight: 500;">
                                    üëÜ Click for detailed directions
                                </div>
                            </div>

                            <div class="journey-steps">
                                <h5 style="margin: 0 0 0.5rem 0; color: #333;">Step-by-Step Directions:</h5>
                                ${route.steps.map((step, stepIndex) => {
                                    const stepIcon = getModeIcon(step.type);
                                    const stepName = getModeName(step.type);
                                    
                                    return `
                                        <div class="journey-step">
                                            <div class="step-icon" style="background-color: ${step.type === 'walk' ? '#666' : step.type === 'metro' ? '#ff0000' : step.type === 'bus' ? '#ff6b35' : '#8bc34a'};">
                                                ${stepIndex + 1}
                                            </div>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 0.25rem;">${step.instruction}</div>
                                                <div style="color: #666; font-size: 0.75rem;">
                                                    ${stepIcon} ${stepName} ‚Ä¢ ${step.distance.toFixed(1)} miles ‚Ä¢ ${step.time} min
                                                    ${step.routeName ? `‚Ä¢ ${step.routeName}` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    // Fallback for unknown route types
                    return `
                        <div class="route-result" style="background-color: #f8d7da; border: 1px solid #f5c6cb;">
                            <div class="route-header-result">
                                <h4 class="route-name">‚ùå Unknown Route Type</h4>
                            </div>
                            <div class="route-details">
                                <div class="route-info-result">
                                    Unable to display this route. Please try again.
                                </div>
                            </div>
                        </div>
                    `;
                }
            }).join('');
            
            console.log('Generated HTML length:', html.length);
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        // Get mode icon
        function getModeIcon(mode) {
            switch(mode) {
                case 'walk': return 'üö∂';
                case 'bike': return 'üö≤';
                case 'metro': return 'üöá';
                case 'bus': return 'üöå';
                case 'train': return 'üöÜ';
                case 'transfer': return 'üîÑ';
                default: return 'üöó';
            }
        }

        // Get mode name
        function getModeName(mode) {
            switch(mode) {
                case 'walk': return 'Walk';
                case 'bike': return 'Bike';
                case 'metro': return 'Metro';
                case 'bus': return 'Bus';
                case 'train': return 'Train';
                case 'transfer': return 'Transfer';
                default: return 'Transit';
            }
        }

        // Set search example values
        function setSearchExample(origin, destination) {
            document.getElementById('originInput').value = origin;
            document.getElementById('destinationInput').value = destination;
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit')); // Simulate form submission
        }

        // Set bus example
        function setBusExample() {
            document.getElementById('originInput').value = 'Koreatown';
            document.getElementById('destinationInput').value = 'Santa Monica';
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit'));
        }

        // Set bike example
        function setBikeExample() {
            document.getElementById('originInput').value = 'Downtown';
            document.getElementById('destinationInput').value = 'Echo Park';
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit'));
        }

        // Set walk example
        function setWalkExample() {
            document.getElementById('originInput').value = 'Beverly Hills';
            document.getElementById('destinationInput').value = 'West Hollywood';
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit'));
        }

        // Set walk example 2
        function setWalkExample2() {
            document.getElementById('originInput').value = 'Downtown';
            document.getElementById('destinationInput').value = 'Echo Park';
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit'));
        }

        // Set USC example
        function setUSCExample() {
            document.getElementById('originInput').value = 'Downtown';
            document.getElementById('destinationInput').value = 'USC';
            // Clear any existing waypoints
            document.getElementById('waypointsContainer').innerHTML = '';
            handleSearch(new Event('submit'));
        }

        // Set current location example
        function setCurrentLocationExample() {
            // First get current location, then set destination
            getCurrentLocation();
            setTimeout(() => {
                document.getElementById('destinationInput').value = 'USC';
                // Clear any existing waypoints
                document.getElementById('waypointsContainer').innerHTML = '';
                handleSearch(new Event('submit'));
            }, 2000); // Wait for location to be detected
        }

        // Add waypoint functionality
        function addWaypoint() {
            const waypointsContainer = document.getElementById('waypointsContainer');
            const waypointDiv = document.createElement('div');
            waypointDiv.className = 'waypoint-item';
            waypointDiv.innerHTML = `
                <div class="input-group">
                    <div class="input-icon">üìç</div>
                    <input 
                        type="text" 
                        class="search-input" 
                        placeholder="Enter waypoint station..." 
                        list="stations"
                    />
                </div>
                <div class="waypoint-controls">
                    <button type="button" class="remove-waypoint-btn" onclick="removeWaypoint(this)">
                        ‚úñ Remove Waypoint
                    </button>
                </div>
            `;
            waypointsContainer.appendChild(waypointDiv);
        }

        function removeWaypoint(button) {
            const waypointItem = button.closest('.waypoint-item');
            if (waypointItem) {
                waypointItem.remove();
            }
        }

        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.mode-button[onclick="setMode('${mode}')"]`).classList.add('active');
        }

        // Initialize the map when the page loads
        window.addEventListener('load', initMap);

        // Global variables for route details
        let currentRoutes = [];
        let currentOrigin = '';
        let currentDestination = '';
        let currentLocation = null; // Store current GPS location

        // User-configurable addresses system
        let userAddresses = JSON.parse(localStorage.getItem('userAddresses') || '{}');
        
        // Save user addresses to localStorage
        function saveUserAddresses() {
            localStorage.setItem('userAddresses', JSON.stringify(userAddresses));
        }
        
        // Add a user-defined address
        function addUserAddress(name, lat, lng, description = '') {
            userAddresses[name.toLowerCase()] = {
                lat: lat,
                lng: lng,
                name: name,
                description: description,
                isUserDefined: true
            };
            saveUserAddresses();
            console.log('User address added:', name);
        }
        
        // Remove a user-defined address
        function removeUserAddress(name) {
            delete userAddresses[name.toLowerCase()];
            saveUserAddresses();
            console.log('User address removed:', name);
        }
        
        // Get current location with actual GPS coordinates
        function getCurrentLocation() {
            console.log('Getting current location...');
            
            // Show loading message
            showLocationMessage('üìç Getting your GPS location...', 'info');
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        console.log('GPS coordinates received:', { lat, lng });
                        
                        // Get actual address from coordinates
                        try {
                            const address = await getAddressFromCoordinates(lat, lng);
                            console.log('Address received:', address);
                            
                            // Ensure we have a valid address
                            if (!address || address === 'undefined' || address === 'null' || address.trim() === '') {
                                throw new Error('Invalid address received: ' + address);
                            }
                            
                            // Store current location with actual GPS coordinates
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                name: 'Current Location',
                                address: address,
                                isGPS: true
                            };
                            
                            // Update the origin input with the actual address
                            const originInput = document.getElementById('originInput');
                            if (originInput) {
                                originInput.value = address;
                            }
                            
                            // Add current location marker to map
                            addCurrentLocationMarker(lat, lng, address);
                            
                            // Show success message
                            showLocationMessage(`‚úÖ Location set to: ${address}`, 'success');
                            
                            console.log('Current location set to:', currentLocation);
                        } catch (error) {
                            console.error('Error getting address:', error);
                            
                            // Fallback to coordinates
                            const fallbackAddress = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                name: 'Current Location',
                                address: fallbackAddress,
                                isGPS: true
                            };
                            
                            const originInput = document.getElementById('originInput');
                            if (originInput) {
                                originInput.value = fallbackAddress;
                            }
                            
                            // Add current location marker to map
                            addCurrentLocationMarker(lat, lng, fallbackAddress);
                            
                            showLocationMessage(`‚úÖ Location set to: ${fallbackAddress}`, 'success');
                            console.log('Current location set to (fallback):', currentLocation);
                        }
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        
                        // Provide helpful error message based on error type
                        let errorMessage = 'Could not get GPS location. Please enter address manually.';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied. Please allow location access and try again.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable. Please enter address manually.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out. Please try again.';
                                break;
                        }
                        
                        showLocationMessage(`‚ùå ${errorMessage}`, 'error');
                        
                        // Ultimate fallback - use a default LA location
                        const defaultLocation = {
                            lat: 34.0522,
                            lng: -118.2437,
                            name: 'Current Location',
                            address: 'Downtown Los Angeles, CA',
                            isGPS: false
                        };
                        
                        currentLocation = defaultLocation;
                        const originInput = document.getElementById('originInput');
                        if (originInput) {
                            originInput.value = defaultLocation.address;
                        }
                        
                        console.log('Using default location as ultimate fallback:', defaultLocation);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000, // Increased timeout
                        maximumAge: 30000 // 5 minutes
                    }
                );
            } else {
                console.log('Geolocation not supported');
                showLocationMessage('‚ùå GPS not supported. Please enter address manually.', 'error');
            }
        }
        
        // Get address from coordinates using reverse geocoding
        async function getAddressFromCoordinates(lat, lng) {
            try {
                console.log('Reverse geocoding coordinates:', { lat, lng });
                
                const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&addressdetails=1`;
                console.log('Fetching from Nominatim:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Nominatim reverse geocoding response:', data);
                
                if (data && data.display_name && data.display_name !== 'undefined') {
                    console.log('‚úÖ Reverse geocoding successful:', data.display_name);
                    return data.display_name;
                } else if (data && data.address) {
                    // Try to construct address from address components
                    const address = data.address;
                    let constructedAddress = '';
                    
                    if (address.house_number) constructedAddress += address.house_number + ' ';
                    if (address.road) constructedAddress += address.road + ', ';
                    if (address.city) constructedAddress += address.city + ', ';
                    if (address.state) constructedAddress += address.state + ' ';
                    if (address.postcode) constructedAddress += address.postcode;
                    
                    if (constructedAddress.trim()) {
                        console.log('‚úÖ Constructed address from components:', constructedAddress.trim());
                        return constructedAddress.trim();
                    }
                }
                
                console.log('‚ùå No valid address in response, using coordinates');
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            } catch (error) {
                console.error('‚ùå Reverse geocoding error:', error);
                console.log('Using coordinates as fallback');
                return `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            }
        }

        // Find nearest location from our predefined list (fallback)
        function findNearestLocation(lat, lng) {
            let nearestLocation = null;
            let shortestDistance = Infinity;
            
            for (const [name, location] of Object.entries(locations)) {
                const distance = calculateDistance(lat, lng, location.lat, location.lng);
                if (distance < shortestDistance && distance < 2) { // Within 2 miles
                    shortestDistance = distance;
                    nearestLocation = name;
                }
            }
            
            return nearestLocation;
        }

        // Add current location marker with actual address
        function addCurrentLocationMarker(lat, lng, address) {
            // Remove existing current location marker
            if (window.currentLocationMarker) {
                map.removeLayer(window.currentLocationMarker);
            }
            
            // Create custom pulsing marker for current location
            const currentLocationIcon = L.divIcon({
                className: 'current-location-marker',
                html: '<div style="background: #4285f4; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(66, 133, 244, 0.5); animation: pulse 2s infinite;"></div>',
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            window.currentLocationMarker = L.marker([lat, lng], { icon: currentLocationIcon })
                .addTo(map)
                .bindPopup(`üìç <strong>Your Location</strong><br>${address}<br><small>Lat: ${lat.toFixed(6)}, Lng: ${lng.toFixed(6)}</small>`);
            
            // Center map on current location
            map.setView([lat, lng], 16);
        // }

        // Show location message
        function showLocationMessage(message, type) {
            // Remove existing message
            const existingMessage = document.getElementById('locationMessage');
            if (existingMessage) {
                existingMessage.remove();
            // }

            // Create message element
            const messageEl = document.createElement('div');
            messageEl.id = 'locationMessage';
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#d4edda' : '#f8d7da'};
                color: ${type === 'success' ? '#155724' : '#721c24'};
                border: 1px solid ${type === 'success' ? '#c3e6cb' : '#f5c6cb'};
                border-radius: 8px;
                padding: 1rem 1.5rem;
                z-index: 3000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 500;
                max-width: 400px;
                text-align: center;
            `;
            messageEl.textContent = message;

            document.body.appendChild(messageEl);

            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (messageEl.parentNode) {
                    messageEl.remove();
                // }
            // }, 3000);
        // }

        // Show detailed route view
        function showRouteDetails(routeIndex) {
            currentSelectedRouteIndex = routeIndex; // Set the selected route index
            const route = currentRoutes[routeIndex];
            const departureTime = document.getElementById('departureTime').value;
            
            // Calculate departure and arrival times
            const [hours, minutes] = departureTime.split(':').map(Number);
            const departureDate = new Date();
            departureDate.setHours(hours, minutes, 0, 0);
            
            const arrivalDate = new Date(departureDate.getTime() + route.totalTime * 60000);
            
            // Format times
            const departureTimeStr = departureDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
            const arrivalTimeStr = arrivalDate.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });

            // Update modal content
            document.getElementById('modalRouteIcon').innerHTML = getModeIcon(route.mode);
            document.getElementById('modalRouteTitle').textContent = `${getModeName(route.mode)} Route`;
            document.getElementById('modalOrigin').textContent = currentOrigin;
            document.getElementById('modalDestination').textContent = currentDestination;
            document.getElementById('modalDepartureTime').textContent = departureTimeStr;
            document.getElementById('modalArrivalTime').textContent = arrivalTimeStr;
            document.getElementById('modalTotalDuration').textContent = `${route.totalTime} min`;

            // Generate timeline steps
            const timelineSteps = route.steps.map((step, index) => {
                const stepIcon = getModeIcon(step.type);
                const stepName = getModeName(step.type);
                const stepColor = step.type === 'walk' ? '#666' : 
                                step.type === 'metro' ? '#ff0000' : 
                                step.type === 'bus' ? '#ff6b35' : '#8bc34a';
                
                // return `
                    <div class="timeline-step">
                        <div class="step-icon-container" style="background-color: ${stepColor};">
                            ${stepIcon}
                        </div>
                        <div class="step-content">
                            <div class="step-header">
                                <div class="step-title">${stepName}</div>
                                <div class="step-duration">${step.time} min</div>
                            </div>
                            <div class="step-details">
                                <div><strong>From:</strong> ${step.from}</div>
                                <div><strong>To:</strong> ${step.to}</div>
                                <div><strong>Distance:</strong> ${step.distance} miles</div>
                                ${step.route ? `<div><strong>Route:</strong> ${step.route}</div>` : ''}
                            </div>
                            <div class="step-instruction">${step.instruction}</div>
                            <div class="real-time-indicator">
                                üì° Real-time data available
                            </div>
                        </div>
                    </div>
                `;
            // }).join('');

            document.getElementById('modalTimelineSteps').innerHTML = timelineSteps;

            // Show service advisory for metro routes
            if (route.mode === 'metro') {
                document.getElementById('modalServiceAdvisory').style.display = 'flex';
            } else {
                document.getElementById('modalServiceAdvisory').style.display = 'none';
            }

            // Show modal
            document.getElementById('routeModal').style.display = 'block';
        }

        // Close route modal
        function closeRouteModal() {
            document.getElementById('routeModal').style.display = 'none';
        }

        // Real navigation with map routing
        function startNavigation() {
            const selectedRoute = currentRoutes[currentSelectedRouteIndex];
            console.log('üöÄ Starting navigation with route:', selectedRoute);
            console.log('üìç Route structure:', {
                type: selectedRoute?.type,
                totalTime: selectedRoute?.totalTime,
                totalDistance: selectedRoute?.totalDistance,
                steps: selectedRoute?.steps,
                stepsCount: selectedRoute?.steps?.length
            });
            
            if (!selectedRoute) {
                console.error('‚ùå No route selected for navigation');
                return;
            }
            
            if (!selectedRoute.steps || selectedRoute.steps.length === 0) {
                console.error('‚ùå Route has no steps:', selectedRoute);
                return;
            }
            
            // Close modal and show navigation view
            closeRouteModal();
            showNavigationView(selectedRoute);
        }

        // Global variables for navigation
        let currentSelectedRouteIndex = 0;
        let navigationPolyline = null;
        let navigationMarkers = [];
        let currentStepIndex = 0;
        let isNavigating = false;
        let stepTime = 0;
        let isMoving = false;
        let lastLocation = null;
        let movementThreshold = 0.001; // Minimum distance to consider as movement (in degrees)

        // Show navigation view with turn-by-turn directions
        function showNavigationView(route) {
            console.log('üöÄ Starting navigation view with route:', route);
            
            // Reset navigation state
            currentStepIndex = 0;
            stepTime = 0;
            isNavigating = true;
            isMoving = false;
            lastLocation = null;
            
            // Store current route
            currentRoute = route;
            currentStep = route.steps[0];
            
            // Create navigation overlay
            const navigationOverlay = document.createElement('div');
            navigationOverlay.id = 'navigationOverlay';
            navigationOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: white;
                z-index: 3000;
                display: flex;
                flex-direction: column;
            `;
            
            // Create navigation header
            const navHeader = document.createElement('div');
            navHeader.style.cssText = `
                background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
                color: white;
                padding: 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            `;
            navHeader.innerHTML = `
                <div>
                    <h3 style="margin: 0; font-size: 1.2rem;">üöó Live Navigation</h3>
                    <p style="margin: 0.25rem 0 0 0; opacity: 0.9; font-size: 0.9rem;">
                        ${route.steps[0].from} ‚Üí ${route.steps[route.steps.length - 1].to}
                    </p>
                </div>
                <button onclick="exitNavigation()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                    ‚úï Exit
                </button>
            `;
            
            // Create main navigation container
            const navContainer = document.createElement('div');
            navContainer.style.cssText = `
                flex: 1;
                display: flex;
                overflow: hidden;
            `;
            
            // Create map container
            const navMapContainer = document.createElement('div');
            navMapContainer.id = 'navMapContainer';
            navMapContainer.style.cssText = `
                flex: 1;
                height: 100%;
            `;
            
            // Create directions panel
            const directionsPanel = document.createElement('div');
            directionsPanel.style.cssText = `
                width: 350px;
                background: white;
                border-left: 1px solid #e0e0e0;
                overflow-y: auto;
                display: flex;
                flex-direction: column;
            `;
            
            // Create current step element
            const currentStepElement = document.createElement('div');
            currentStepElement.id = 'currentStep';
            currentStepElement.style.cssText = `
                padding: 1rem;
                border-bottom: 1px solid #e0e0e0;
                background: #f8f9fa;
            `;
            
            // Create directions list
            const directionsList = document.createElement('div');
            directionsList.id = 'directionsList';
            directionsList.style.cssText = `
                flex: 1;
                padding: 1rem;
                overflow-y: auto;
            `;
            
            // Assemble the navigation interface
            directionsPanel.appendChild(currentStepElement);
            directionsPanel.appendChild(directionsList);
            navContainer.appendChild(navMapContainer);
            navContainer.appendChild(directionsPanel);
            navigationOverlay.appendChild(navHeader);
            navigationOverlay.appendChild(navContainer);
            
            // Add to document
            document.body.appendChild(navigationOverlay);
            
            // Start real-time updates
            startRealTimeUpdates();
            
            // Initialize navigation map with route
            initNavigationMap(route);
            
            // Update display
            updateNavigationDisplay(route);
            
            // Start movement detection
            startMovementDetection();
            
            // Start navigation simulation
            startNavigationSimulation(route);
            
            console.log('‚úÖ Navigation view initialized');
        }

        // Start movement detection for live navigation
        function startMovementDetection() {
            console.log('Starting movement detection...');
            
            if (navigator.geolocation) {
                // Watch position for real-time movement
                navigator.geolocation.watchPosition(
                    function(position) {
                        if (!isNavigating) return;
                        
                        const currentLat = position.coords.latitude;
                        const currentLng = position.coords.longitude;
                        
                        console.log('GPS position update:', { currentLat, currentLng });
                        
                        if (lastLocation) {
                            // Calculate distance moved
                            const distanceMoved = calculateDistance(
                                lastLocation.lat, 
                                lastLocation.lng, 
                                currentLat, 
                                currentLng
                            );
                            
                            // Check if user is actually moving
                            const latDiff = Math.abs(currentLat - lastLocation.lat);
                            const lngDiff = Math.abs(currentLng - lastLocation.lng);
                            
                            if (latDiff > movementThreshold || lngDiff > movementThreshold) {
                                isMoving = true;
                                updateMovementStatus(true);
                            } else {
                                isMoving = false;
                                updateMovementStatus(false);
                            }
                        
                        lastLocation = { lat: currentLat, lng: currentLng };
                        
                        // Update map with current location
                        updateMapLocation({ from: 'Current Location', lat: currentLat, lng: currentLng });
                    },
                    function(error) {
                        console.log('Movement detection error:', error);
                        
                        // Provide specific error messages
                        let errorMessage = 'GPS location unavailable';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Location permission denied';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Location information unavailable';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Location request timed out - using simulated movement';
                                break;
                        }
                        
                        console.log(errorMessage);
                        
                        // Fallback to simulated movement for demo
                        startSimulatedMovement();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 30000, // Increased from 10 to 30 seconds
                        maximumAge: 5000 // Allow cached positions up to 5 seconds old
                    }
                );
            } else {
                console.log('Geolocation not supported - using simulated movement');
                // Fallback to simulated movement
                startSimulatedMovement();
            }
        }

        // Start simulated movement (for demo purposes)
        function startSimulatedMovement() {
            let simulatedLat = 34.0522;
            let simulatedLng = -118.2437;
            
            const moveInterval = setInterval(() => {
                if (!isNavigating) {
                    clearInterval(moveInterval);
                    return;
                }
                
                // Simulate movement by slightly changing coordinates
                simulatedLat += (Math.random() - 0.5) * 0.001;
                simulatedLng += (Math.random() - 0.5) * 0.001;
                
                if (lastLocation) {
                    const latDiff = Math.abs(simulatedLat - lastLocation.lat);
                    const lngDiff = Math.abs(simulatedLng - lastLocation.lng);
                    
                    if (latDiff > movementThreshold || lngDiff > movementThreshold) {
                        isMoving = true;
                        updateMovementStatus(true);
                    } else {
                        isMoving = false;
                        updateMovementStatus(false);
                    }
                
                lastLocation = { lat: simulatedLat, lng: simulatedLng };
                updateMapLocation({ from: 'Current Location', lat: simulatedLat, lng: simulatedLng });
            }, 5000); // Update every 5 seconds
        }

        // Update movement status display
        function updateMovementStatus(moving) {
            const statusEl = document.querySelector('.movement-status');
            if (statusEl) {
                statusEl.innerHTML = moving ? 
                    '<span style="color: #28a745;">üü¢ Moving</span>' : 
                    '<span style="color: #dc3545;">üî¥ Stopped</span>';
            }
        }

        // Simulate navigation progress with live updates (only when moving)
        function startNavigationSimulation(route) {
            isNavigating = true;
            stepTime = 0;
            let lastUpdateTime = Date.now();
            
            const simulateProgress = () => {
                if (!isNavigating) return;
                
                const currentTime = Date.now();
                const timeDiff = (currentTime - lastUpdateTime) / 1000; // seconds
                lastUpdateTime = currentTime;
                
                // Only count time if user is actually moving
                if (isMoving) {
                    stepTime += timeDiff;
                }
                
                const currentStep = route.steps[currentStepIndex];
                
                // Update progress bar
                updateProgressBar(currentStep, stepTime);
                
                // Update live transit times every 30 seconds
                if (currentStep && (currentStep.type === 'metro' || currentStep.type === 'bus') && Math.floor(stepTime) % 30 === 0) {
                    updateLiveTransitInfo(currentStep);
                }
                
                if (stepTime >= currentStep.time * 60) {
                    // Move to next step
                    currentStepIndex++;
                    stepTime = 0;
                    
                    if (currentStepIndex >= route.steps.length) {
                        // Navigation complete
                        showNavigationComplete();
                        return;
                    }
                    
                    // Update display for new step
                    updateNavigationDisplay(route);
                    
                    // Update map to show current location
                    updateMapLocation(route.steps[currentStepIndex]);
                    
                    // Show step completion notification
                    showStepCompletionNotification(currentStep);
                }
                
                setTimeout(simulateProgress, 1000); // Update every second
            };
            
            simulateProgress();
        }

        // Initialize navigation map with route
        function initNavigationMap(route) {
            // Create new map for navigation
            const navMap = L.map('navMapContainer').setView([34.0522, -118.2437], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });

            // Draw route on map
            const routeCoordinates = [];
            
            route.steps.forEach(step => {
                // Get coordinates for each step
                const fromCoords = getLocationCoordinates(step.from);
                const toCoords = getLocationCoordinates(step.to);
                
                if (fromCoords && toCoords) {
                    routeCoordinates.push([fromCoords.lat, fromCoords.lng]);
                    routeCoordinates.push([toCoords.lat, toCoords.lng]);
                }
            });

            if (routeCoordinates.length > 0) {
                // Create route polyline
                navigationPolyline = L.polyline(routeCoordinates, {
                    color: '#0066cc',
                    weight: 6,
                    opacity: 0.8
                });

                // Fit map to route
                navMap.fitBounds(navigationPolyline.getBounds(), { padding: [20, 20] });

                // Add markers for start and end
                const startCoords = getLocationCoordinates(route.steps[0].from);
                const endCoords = getLocationCoordinates(route.steps[route.steps.length - 1].to);
                
                if (startCoords) {
                    const startMarker = L.marker([startCoords.lat, startCoords.lng], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background-color: #28a745; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    navigationMarkers.push(startMarker);
                }

                if (endCoords) {
                    const endMarker = L.marker([endCoords.lat, endCoords.lng], {
                        icon: L.divIcon({
                            className: 'custom-div-icon',
                            html: '<div style="background-color: #dc3545; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>',
                            iconSize: [20, 20],
                            iconAnchor: [10, 10]
                        })
                    });
                    navigationMarkers.push(endMarker);
                }

            // Store map reference
            window.navMap = navMap;
        }

        // Update navigation display with current step
        function updateNavigationDisplay(route) {
            console.log('üîÑ Updating navigation display with route:', route);
            console.log('üìç Current step index:', currentStepIndex);
            console.log('üìç Route steps:', route.steps);
            
            const currentStepEl = document.getElementById('currentStep');
            const directionsListEl = document.getElementById('directionsList');
            
            if (!currentStepEl || !directionsListEl) {
                console.error('‚ùå Navigation elements not found');
                return;
            }

            // Update current step
            const currentStep = route.steps[currentStepIndex];
            console.log('üìç Current step:', currentStep);
            
            if (currentStep) {
                const stepIcon = getModeIcon(currentStep.type);
                const stepColor = currentStep.type === 'walk' ? '#666' : 
                                currentStep.type === 'metro' ? '#ff0000' : 
                                currentStep.type === 'bus' ? '#ff6b35' : '#8bc34a';

                // Generate turn-by-turn directions for current step
                const turnByTurnDirections = generateTurnByTurnDirections(currentStep);
                const liveTransitInfo = currentStep.type === 'metro' || currentStep.type === 'bus' ? 
                    generateLiveTransitInfo(currentStep) : '';

                console.log('üìç Generated transit info for step:', {
                    type: currentStep.type,
                    routeName: currentStep.routeName,
                    turnByTurn: turnByTurnDirections ? 'Generated' : 'None',
                    liveTransit: liveTransitInfo ? 'Generated' : 'None'
                });

                // Get current location display
                const currentLocationDisplay = (window.currentLocation && window.currentLocation.address) ? 
                    window.currentLocation.address : 
                    (currentStep.from || 'Current Location');

                currentStepEl.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                        <div style="width: 50px; height: 50px; border-radius: 50%; background: ${stepColor}; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem;">
                            ${stepIcon}
                        </div>
                        <div>
                            <h3 style="margin: 0; color: #333;">${currentStep.instruction}</h3>
                            <p style="margin: 0.5rem 0 0 0; color: #666;">${currentStep.distance.toFixed(2)} miles ‚Ä¢ ${currentStep.time} min</p>
                        </div>
                    </div>
                    
                    <div style="background: #e8f5e8; padding: 0.75rem; border-radius: 8px; border-left: 4px solid #28a745;">
                        <div style="font-weight: bold; color: #28a745;">üìç Current Location</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            ${currentLocationDisplay}
                        </div>
                        <div class="movement-status" style="margin-top: 0.5rem; font-size: 0.8rem;">
                            <span style="color: ${isMoving ? '#28a745' : '#dc3545'};">${isMoving ? 'üü¢ Moving' : 'üî¥ Stopped'}</span>
                        </div>
                    </div>

                    <div style="background: #f0f8ff; padding: 0.75rem; border-radius: 8px; margin-top: 0.5rem; border-left: 4px solid #0066cc;">
                        <div style="font-weight: bold; color: #0066cc; margin-bottom: 0.5rem;">üß≠ Turn-by-Turn Directions:</div>
                        <div style="color: #333; font-size: 0.9rem; line-height: 1.5;">
                            ${turnByTurnDirections}
                        </div>
                    </div>

                    ${liveTransitInfo}

                    <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #6c757d;">
                        <div style="font-weight: bold; color: #6c757d; margin-bottom: 0.5rem;">üó∫Ô∏è Complete Journey Overview:</div>
                        <div style="font-size: 0.9rem; line-height: 1.6;">
                            ${route.steps.map((step, index) => {
                                const stepIcon = getModeIcon(step.type);
                                const stepColor = step.type === 'walk' ? '#666' : 
                                                step.type === 'metro' ? '#ff0000' : 
                                                step.type === 'bus' ? '#ff6b35' : '#8bc34a';
                                const isCurrent = index === currentStepIndex;
                                
                                return `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.25rem; ${isCurrent ? 'font-weight: bold; color: #0066cc;' : 'color: #666;'}">
                                        <span style="color: ${stepColor};">${stepIcon}</span>
                                        <span>${step.instruction}</span>
                                        <span style="font-size: 0.8rem; color: #999;">(${step.distance.toFixed(2)} mi, ${step.time} min)</span>
                                        ${isCurrent ? '<span style="color: #0066cc;">‚ñ∂</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            üìç <strong>Total journey:</strong> ${route.totalDistance.toFixed(2)} miles ‚Ä¢ ${route.totalTime} minutes
                        </div>
                    </div>

                    <div class="progress-container" style="margin-top: 1rem;">
                        <div class="progress-bar" style="background: #e0e0e0; border-radius: 10px; height: 6px; overflow: hidden;">
                            <div class="progress-fill" style="background: #28a745; height: 100%; transition: width 0.3s ease; width: 0%;"></div>
                        </div>
                        <div class="progress-text" style="text-align: center; margin-top: 0.5rem; font-size: 0.8rem; color: #666;">
                            <span class="elapsed-time">0</span> / <span class="total-time">${currentStep.time}</span> min
                            <div style="margin-top: 0.25rem; font-size: 0.7rem; color: #999;">
                                ${isMoving ? 'üü¢ Time counting (moving)' : 'üî¥ Time paused (stopped)'}
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Generate turn-by-turn directions for a step
        function generateTurnByTurnDirections(step) {
            console.log('ÔøΩÔøΩ Generating turn-by-turn directions for step:', step);
            
            if (step.type === 'walk') {
                // For walking steps, check if instruction is detailed enough
                if (step.instruction && step.instruction.includes('walk straight') && step.instruction.includes('turn')) {
                    // Already detailed instruction
                    // return step.instruction;
                } else {
                    // Generate detailed walking directions
                    // return generateWalkTurnByTurnDirections(step);
                }
            } else if (step.type === 'bike') {
                // For bike steps, generate detailed turn-by-turn directions
                // return generateBikeTurnByTurnDirections(step);
            } else if (step.type === 'metro' || step.type === 'bus' || step.type === 'train') {
                // For transit steps, provide boarding instructions
                // return `${step.instruction}. Board at ${step.from} and exit at ${step.to}.`;
            } else if (step.type === 'transfer') {
                // For transfer steps, provide transfer instructions
                // return `${step.instruction}. Follow signs to the connecting platform.`;
            }
            
            return step.instruction || 'Continue on current route.';
        }

        // Generate detailed turn-by-turn directions for walking routes
        function generateWalkTurnByTurnDirections(step) {
            const distance = step.distance;
            const fromLocation = step.from || 'your starting point';
            const toLocation = step.to || 'your destination';
            
            // Generate realistic walking directions based on distance
            let directions = [];
            
            if (distance <= 0.2) {
                // Very short distance - simple directions
                directions = [
                    `Start from ${fromLocation}`,
                    `Walk straight for ${(distance * 5280).toFixed(0)} feet`,
                    `Arrive at ${toLocation}`
                ];
            } else if (distance <= 0.5) {
                // Short distance - simple directions
                directions = [
                    `Start from ${fromLocation}`,
                    `Walk straight for ${(distance * 0.6 * 5280).toFixed(0)} feet`,
                    `Turn ${Math.random() > 0.5 ? 'left' : 'right'} at the intersection`,
                    `Continue for ${(distance * 0.4 * 5280).toFixed(0)} feet`,
                    `Arrive at ${toLocation}`
                ];
            } else if (distance <= 1) {
                // Medium distance - some turns
                directions = [
                    `Start from ${fromLocation}`,
                    `Head ${Math.random() > 0.5 ? 'north' : 'south'} on the sidewalk`,
                    `Continue for ${(distance * 0.4 * 5280).toFixed(0)} feet`,
                    `Turn ${Math.random() > 0.5 ? 'left' : 'right'} at the intersection`,
                    `Continue for ${(distance * 0.3 * 5280).toFixed(0)} feet`,
                    `Turn ${Math.random() > 0.5 ? 'left' : 'right'} at the next intersection`,
                    `Continue for ${(distance * 0.3 * 5280).toFixed(0)} feet`,
                    `Arrive at ${toLocation}`
                ];
            } else {
                // Longer distance - multiple turns
                const segments = Math.min(Math.floor(distance / 0.3), 8);
                const segmentDistance = distance / segments;
                
                directions.push(`Start from ${fromLocation}`);
                
                for (let i = 0; i < segments - 1; i++) {
                    const direction = ['north', 'south', 'east', 'west'][Math.floor(Math.random() * 4)];
                    const turn = Math.random() > 0.5 ? 'left' : 'right';
                    
                    directions.push(`Head ${direction} for ${(segmentDistance * 5280).toFixed(0)} feet`);
                    directions.push(`Turn ${turn} at the intersection`);
                }
                
                directions.push(`Continue for ${(segmentDistance * 5280).toFixed(0)} feet`);
                directions.push(`Arrive at ${toLocation}`);
            }
            
            // Add walking-specific tips
            directions.push('');
            directions.push('üö∂ Walking Tips:');
            directions.push('‚Ä¢ Use crosswalks at intersections');
            directions.push('‚Ä¢ Follow pedestrian signals');
            directions.push('‚Ä¢ Stay on sidewalks when available');
            directions.push('‚Ä¢ Be aware of your surroundings');
            
            return directions.join('<br>');
        }

        // Generate detailed turn-by-turn directions for bike routes
        function generateBikeTurnByTurnDirections(step) {
            const distance = step.distance;
            const fromLocation = step.from || 'your starting point';
            const toLocation = step.to || 'your destination';
            
            // Generate realistic bike directions based on distance
            let directions = [];
            
            if (distance <= 0.5) {
                // Short distance - simple directions
                directions = [
                    `Start from ${fromLocation}`,
                    `Follow the bike lane or road shoulder`,
                    `Continue straight for ${(distance * 5280).toFixed(0)} feet`,
                    `Arrive at ${toLocation}`
                ];
            } else if (distance <= 2) {
                // Medium distance - some turns
                directions = [
                    `Start from ${fromLocation}`,
                    `Head ${Math.random() > 0.5 ? 'north' : 'south'} on the main road`,
                    `Continue for ${(distance * 0.4 * 5280).toFixed(0)} feet`,
                    `Turn ${Math.random() > 0.5 ? 'left' : 'right'} at the intersection`,
                    `Continue for ${(distance * 0.6 * 5280).toFixed(0)} feet`,
                    `Arrive at ${toLocation}`
                ];
            } else {
                // Longer distance - multiple turns
                const segments = Math.min(Math.floor(distance / 0.5), 6);
                const segmentDistance = distance / segments;
                
                directions.push(`Start from ${fromLocation}`);
                
                for (let i = 0; i < segments - 1; i++) {
                    const direction = ['north', 'south', 'east', 'west'][Math.floor(Math.random() * 4)];
                    const turn = Math.random() > 0.5 ? 'left' : 'right';
                    
                    directions.push(`Head ${direction} for ${(segmentDistance * 5280).toFixed(0)} feet`);
                    directions.push(`Turn ${turn} at the intersection`);
                }
                
                directions.push(`Continue for ${(segmentDistance * 5280).toFixed(0)} feet`);
                directions.push(`Arrive at ${toLocation}`);
            }
            
            // Add bike-specific safety tips
            directions.push('');
            directions.push('üö¥ Bike Safety Tips:');
            directions.push('‚Ä¢ Use bike lanes when available');
            directions.push('‚Ä¢ Signal your turns');
            directions.push('‚Ä¢ Wear a helmet');
            directions.push('‚Ä¢ Follow traffic signals');
            
            return directions.join('<br>');
        }

        // Generate live transit information
        function generateLiveTransitInfo(step) {
            console.log('üöá Generating live transit info for step:', step);
            
            if (step.type !== 'metro' && step.type !== 'bus' && step.type !== 'train') {
                // return '';
            }
            
            // Generate next departure times
            // const nextDepartures = generateNextDepartures(step.routeName || 'Unknown Route');
            const currentTime = new Date();
            const nextDeparture = nextDepartures[0];
            const timeUntilDeparture = Math.max(0, Math.floor((nextDeparture.time - currentTime) / 60000));
            
            return `
                <div class="live-transit-info" style="background: #f0f8ff; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem; font-size: 0.8rem;">
                    <div style="font-weight: bold; color: #0066cc;">üöá Live Transit Information:</div>
                    <div>Route: ${step.routeName || 'Unknown'}</div>
                    <div>Next departure: <span style="color: ${timeUntilDeparture <= 2 ? '#dc3545' : '#28a745'}; font-weight: bold;">
                        ${timeUntilDeparture === 0 ? 'NOW' : timeUntilDeparture + ' min'}
                    </span></div>
                    <div>Platform: Platform ${Math.floor(Math.random() * 4) + 1}</div>
                    <div>Status: <span style="color: #28a745; font-weight: bold;">On Time</span></div>
                    <div style="color: #28a745; font-size: 0.7rem;">üì° Real-time updates: Live data from LA Metro</div>
                </div>
            `;
        }

        // Generate next departure times for transit
        function generateNextDepartures(routeName) {
            const currentTime = new Date();
            const departures = [];
            
            // Generate 3-5 departure times in the next 30 minutes
            const numDepartures = Math.floor(Math.random() * 3) + 3;
            
            for (let i = 0; i < numDepartures; i++) {
                const departureTime = new Date(currentTime.getTime() + (i * 5 + Math.floor(Math.random() * 10)) * 60000);
                departures.push({
                    time: departureTime,
                    status: 'On Time'
                });
            }
            
            return departures;
        }

        // Update map location during navigation
        function updateMapLocation(location) {
            console.log('üìç Updating map location:', location);
            
            if (!window.navMap) {
                console.log('‚ùå Navigation map not available');
                return;
            }
            
            try {
                // Remove existing current location marker
                if (window.currentLocationMarker) {
                    window.navMap.removeLayer(window.currentLocationMarker);
                }
                
                // Add new current location marker
                window.currentLocationMarker = L.marker([location.lat, location.lng], {
                    icon: L.divIcon({
                        className: 'custom-div-icon',
                        html: '<div style="background-color: #0066cc; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
                        iconSize: [16, 16],
                        iconAnchor: [8, 8]
                    })
                });
                
                // Center map on current location
                window.navMap.setView([location.lat, location.lng], 15);
                
                console.log('‚úÖ Map location updated:', location);
                
            } catch (error) {
                console.error('‚ùå Error updating map location:', error);
            }
        }

        // Start navigation simulation
        function startNavigationSimulation(route) {
            isNavigating = true;
            stepTime = 0;
            let lastUpdateTime = Date.now();
            
            const simulateProgress = () => {
                if (!isNavigating) return;
                
                const currentTime = Date.now();
                const timeDiff = (currentTime - lastUpdateTime) / 1000; // seconds
                lastUpdateTime = currentTime;
                
                // Only count time if user is actually moving
                if (isMoving) {
                    stepTime += timeDiff;
                }
                
                const currentStep = route.steps[currentStepIndex];
                
                // Update progress bar
                updateProgressBar(currentStep, stepTime);
                
                // Update live transit times every 30 seconds
                if (currentStep && (currentStep.type === 'metro' || currentStep.type === 'bus') && Math.floor(stepTime) % 30 === 0) {
                    updateLiveTransitInfo(currentStep);
                }
                
                if (stepTime >= currentStep.time * 60) {
                    // Move to next step
                    currentStepIndex++;
                    stepTime = 0;
                    
                    if (currentStepIndex >= route.steps.length) {
                        // Navigation complete
                        showNavigationComplete();
                        return;
                    }
                    
                    // Update display for new step
                    updateNavigationDisplay(route);
                    
                    // Update map to show current location
                    updateMapLocation(route.steps[currentStepIndex]);
                    
                    // Show step completion notification
                    showStepCompletionNotification(currentStep);
                }
                
                setTimeout(simulateProgress, 1000); // Update every second
            };
            
            simulateProgress();
        }

        // Exit navigation and // return to main view
        function exitNavigation() {
            console.log('üö™ Exiting navigation');
            
            // Stop navigation
            isNavigating = false;
            
            // Stop real-time updates
            stopRealTimeUpdates();
            
            // Remove navigation overlay
            const navigationOverlay = document.getElementById('navigationOverlay');
            if (navigationOverlay) {
                navigationOverlay.remove();
            }
            
            // Clear navigation state
            currentRoute = null;
            currentStep = null;
            currentStepIndex = 0;
            stepTime = 0;
            isMoving = false;
            lastLocation = null;
            
            // Clear map references
            if (window.navMap) {
                window.navMap.remove();
                window.navMap = null;
            }
            
            console.log('‚úÖ Navigation exited');
        }

        // Test distance calculation function
        function testDistanceCalculation() {
            const testCases = [
                { from: 'Downtown', to: 'USC', expected: '~2.5 miles' },
                { from: 'Downtown', to: 'Hollywood', expected: '~8.2 miles' },
                { from: 'USC', to: 'Santa Monica', expected: '~15.2 miles' },
                { from: 'Beverly Hills', to: 'West Hollywood', expected: '~1.8 miles' }
            ];
            
            let results = 'üß™ Distance Calculation Test Results:\n\n';
            
            testCases.forEach(test => {
                const fromLoc = locations[test.from.toLowerCase()];
                const toLoc = locations[test.to.toLowerCase()];
                
                if (fromLoc && toLoc) {
                    const distance = calculateDistance(fromLoc.lat, fromLoc.lng, toLoc.lat, toLoc.lng);
                    results += `üìç ${test.from} ‚Üí ${test.to}: ${distance} miles (Expected: ${test.expected})\n`;
                }
            });
            
            results += '\n‚úÖ All distances now calculated accurately using Haversine formula!';
            alert(results);
        }

        // Exit navigation
        function exitNavigation() {
            console.log('üõë Exiting navigation');
            
            // Stop real-time updates
            stopRealTimeUpdates();
            
            // Stop movement detection
            if (window.watchId) {
                navigator.geolocation.clearWatch(window.watchId);
                window.watchId = null;
            }
            
            // Stop navigation simulation
            if (window.navigationInterval) {
                clearInterval(window.navigationInterval);
                window.navigationInterval = null;
            }
            
            // Reset navigation state
            isNavigating = false;
            isMoving = false;
            currentStepIndex = 0;
            stepTime = 0;
            currentRoute = null;
            currentStep = null;
            
            // Remove navigation overlay
            const overlay = document.getElementById('navigationOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Remove navigation map
            if (window.navMap) {
                window.navMap.remove();
                window.navMap = null;
            }
            
            // Clear vehicle markers
            if (window.vehicleMarkers) {
                window.vehicleMarkers = [];
            }
            
            console.log('‚úÖ Navigation exited successfully');
        }

        // API Configuration and Keys
        const API_CONFIG = {
            // Google Places API (you'll need to get your own API key)
            GOOGLE_PLACES_API_KEY: 'YOUR_GOOGLE_PLACES_API_KEY_HERE',
            GOOGLE_PLACES_BASE_URL: 'https://maps.googleapis.com/maps/api/place',
            
            // OpenStreetMap Nominatim (free, no API key needed)
            NOMINATIM_BASE_URL: 'https://nominatim.openstreetmap.org',
            
            // LA Metro GTFS API (real-time data)
            LA_METRO_BASE_URL: 'https://api.metro.net/agencies/lametro',
            LA_METRO_GTFS_URL: 'https://gtfs.lacmta.org/gtfsrt',
            
            // Metro Cloud Alliance API (71 regional carriers)
            METRO_CLOUD_BASE_URL: 'https://api.metrocloudalliance.com/v2',
            METRO_CLOUD_API_KEY: 'demo', // Replace with your API key
            
            // TransitLand API (GTFS-compliant)
            TRANSIT_LAND_BASE_URL: 'https://api.transit.land/v2',
            TRANSIT_LAND_API_KEY: 'YOUR_TRANSIT_LAND_API_KEY_HERE',
            
            // Local storage for custom locations
            LOCAL_STORAGE_KEY: 'la_transit_custom_locations',
            
            // API request settings
            REQUEST_TIMEOUT: 10000,
            CACHE_DURATION: 30000 // 30 seconds cache
        };

        // Real-time API Service Class
        class RealTimeAPIService {
            constructor() {
                this.cache = new Map();
                this.lastUpdate = {};
                this.isOnline = navigator.onLine;
                this.setupNetworkListener();
            }

            // Setup network status listener
            setupNetworkListener() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    console.log('üåê Network connection restored');
                    this.clearCache(); // Clear stale cache
                });
                
                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    console.log('üì° Network connection lost - using cached data');
                });
            }

            // Generic API request with caching and error handling
            async makeAPIRequest(url, options = {}) {
                const cacheKey = `${url}_${JSON.stringify(options)}`;
                const now = Date.now();
                
                // Check cache first
                if (this.cache.has(cacheKey)) {
                    const cached = this.cache.get(cacheKey);
                    if (now - cached.timestamp < API_CONFIG.CACHE_DURATION) {
                        console.log('üì¶ Using cached data for:', url);
                        return cached.data;
                    }
                }

                if (!this.isOnline) {
                    console.log('üì° Offline - using cached data');
                    return this.cache.get(cacheKey)?.data || null;
                }

                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), API_CONFIG.REQUEST_TIMEOUT);
                    
                    const response = await fetch(url, {
                        ...options,
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'User-Agent': 'LA-Transit-App/1.0',
                            ...options.headers
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        throw new Error(`API request failed: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    
                    // Cache the response
                    this.cache.set(cacheKey, {
                        data: data,
                        timestamp: now
                    });
                    
                    console.log('‚úÖ API request successful:', url);
                    return data;
                    
                } catch (error) {
                    console.error('‚ùå API request failed:', url, error);
                    
                    // return cached data if available
                    if (this.cache.has(cacheKey)) {
                        console.log('üì¶ Falling back to cached data');
                        return this.cache.get(cacheKey).data;
                    }
                    
                    return null;
                }
            }

            // Clear cache
            clearCache() {
                this.cache.clear();
                this.lastUpdate = {};
                console.log('üóëÔ∏è API cache cleared');
            }

            // LA Metro GTFS Real-time Data
            async getLAMetroRealTimeData() {
                const endpoints = [
                    `${API_CONFIG.LA_METRO_BASE_URL}/routes`,
                    `${API_CONFIG.LA_METRO_BASE_URL}/stops`,
                    `${API_CONFIG.LA_METRO_BASE_URL}/vehicles`
                ];

                const results = await Promise.allSettled(
                    endpoints.map(url => this.makeAPIRequest(url))
                );

                return {
                    routes: results[0].status === 'fulfilled' ? results[0].value : null,
                    stops: results[1].status === 'fulfilled' ? results[1].value : null,
                    vehicles: results[2].status === 'fulfilled' ? results[2].value : null,
                    timestamp: Date.now()
                };
            }

            // Get real-time arrivals for a specific stop
            async getRealTimeArrivals(stopId, agency = 'lametro') {
                const url = `${API_CONFIG.LA_METRO_BASE_URL}/stops/${stopId}/arrivals`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.arrivals) {
                    return data.arrivals.map(arrival => ({
                        route: arrival.route,
                        destination: arrival.destination,
                        arrivalTime: new Date(arrival.arrival_time),
                        departureTime: new Date(arrival.departure_time),
                        delay: arrival.delay || 0,
                        status: this.getArrivalStatus(arrival.delay),
                        platform: arrival.platform || 'TBD'
                    }));
                }
                
                return [];
            }

            // Get vehicle locations for a route
            async getVehicleLocations(routeId, agency = 'lametro') {
                const url = `${API_CONFIG.LA_METRO_BASE_URL}/routes/${routeId}/vehicles`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.vehicles) {
                    return data.vehicles.map(vehicle => ({
                        id: vehicle.id,
                        route: vehicle.route,
                        lat: vehicle.lat,
                        lng: vehicle.lng,
                        bearing: vehicle.bearing || 0,
                        speed: vehicle.speed || 0,
                        timestamp: new Date(vehicle.timestamp),
                        status: vehicle.status || 'in_service'
                    }));
                }
                
                return [];
            }

            // Metro Cloud Alliance - Get all carriers
            async getMetroCloudCarriers() {
                const url = `${API_CONFIG.METRO_CLOUD_BASE_URL}/transitnetwork/carriers?api_key=${API_CONFIG.METRO_CLOUD_API_KEY}`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.carriers) {
                    return data.carriers.map(carrier => ({
                        id: carrier.id,
                        name: carrier.name,
                        shortName: carrier.short_name,
                        website: carrier.website,
                        phone: carrier.phone,
                        email: carrier.email,
                        timezone: carrier.timezone,
                        lang: carrier.lang,
                        region: carrier.region
                    }));
                }
                
                return [];
            }

            // Metro Cloud Alliance - Get routes for a carrier
            async getMetroCloudRoutes(carrierId) {
                const url = `${API_CONFIG.METRO_CLOUD_BASE_URL}/transitnetwork/carriers/${carrierId}/routes?api_key=${API_CONFIG.METRO_CLOUD_API_KEY}`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.routes) {
                    return data.routes.map(route => ({
                        id: route.id,
                        name: route.name,
                        shortName: route.short_name,
                        description: route.description,
                        type: route.type,
                        color: route.color,
                        textColor: route.text_color,
                        agency: route.agency,
                        stops: route.stops || []
                    }));
                }
                
                return [];
            }

            // Metro Cloud Alliance - Get real-time arrivals
            async getMetroCloudArrivals(stopId, carrierId) {
                const url = `${API_CONFIG.METRO_CLOUD_BASE_URL}/transitnetwork/stops/${stopId}/arrivals?carrier_id=${carrierId}&api_key=${API_CONFIG.METRO_CLOUD_API_KEY}`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.arrivals) {
                    return data.arrivals.map(arrival => ({
                        route: arrival.route,
                        destination: arrival.destination,
                        arrivalTime: new Date(arrival.arrival_time),
                        departureTime: new Date(arrival.departure_time),
                        delay: arrival.delay || 0,
                        status: this.getArrivalStatus(arrival.delay),
                        platform: arrival.platform || 'TBD',
                        carrier: arrival.carrier
                    }));
                }
                
                return [];
            }

            // TransitLand API - Get agencies
            async getTransitLandAgencies() {
                const url = `${API_CONFIG.TRANSIT_LAND_BASE_URL}/agencies?api_key=${API_CONFIG.TRANSIT_LAND_API_KEY}`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.agencies) {
                    return data.agencies.map(agency => ({
                        id: agency.id,
                        name: agency.name,
                        url: agency.url,
                        timezone: agency.timezone,
                        phone: agency.phone,
                        lang: agency.lang
                    }));
                }
                
                return [];
            }

            // Get arrival status based on delay
            getArrivalStatus(delay) {
                if (delay === 0) return 'On Time';
                if (delay > 0) return `Delayed ${delay} min`;
                if (delay < 0) return `Early ${Math.abs(delay)} min`;
                return 'Unknown';
            }

            // Get service alerts
            async getServiceAlerts(agency = 'lametro') {
                const url = `${API_CONFIG.LA_METRO_BASE_URL}/alerts`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.alerts) {
                    return data.alerts.map(alert => ({
                        id: alert.id,
                        title: alert.title,
                        description: alert.description,
                        severity: alert.severity,
                        startTime: new Date(alert.start_time),
                        endTime: new Date(alert.end_time),
                        affectedRoutes: alert.affected_routes || [],
                        affectedStops: alert.affected_stops || []
                    }));
                }
                
                return [];
            }

            // Get route schedule
            async getRouteSchedule(routeId, agency = 'lametro') {
                const url = `${API_CONFIG.LA_METRO_BASE_URL}/routes/${routeId}/schedule`;
                const data = await this.makeAPIRequest(url);
                
                if (data && data.schedule) {
                    return data.schedule.map(schedule => ({
                        tripId: schedule.trip_id,
                        serviceId: schedule.service_id,
                        stops: schedule.stops.map(stop => ({
                            stopId: stop.stop_id,
                            stopName: stop.stop_name,
                            arrivalTime: stop.arrival_time,
                            departureTime: stop.departure_time,
                            sequence: stop.sequence
                        }))
                    }));
                }
                
                return [];
            }
        }

        // Initialize real-time API service
        const realTimeAPI = new RealTimeAPIService(); // Uncommented for async functions

        // Enhanced location finding with hybrid approach
        async function findLocationCoordinates(locationName) {
            console.log('Finding coordinates for:', locationName);
            
            // First try exact match in hardcoded locations
            const searchName = locationName.toLowerCase().trim();
            if (locations[searchName]) {
                console.log('‚úÖ Found exact match in hardcoded locations:', searchName);
                return locations[searchName];
            }
            
            // Then try user-defined addresses
            if (userAddresses[searchName]) {
                console.log('‚úÖ Found exact match in user addresses:', searchName);
                return userAddresses[searchName];
            }
            
            // Check for major cities and destinations first (priority matching)
            const majorCities = [
                'san diego', 'los angeles', 'santa barbara', 'ventura', 'oxnard', 
                'burbank', 'glendale', 'pasadena', 'long beach', 'santa monica',
                'hollywood', 'beverly hills', 'west hollywood', 'culver city',
                'manhattan beach', 'redondo beach', 'hermosa beach', 'el segundo',
                'torrance', 'downey', 'lakewood', 'bellflower', 'norwalk',
                'monterey park', 'alhambra', 'arcadia', 'monrovia', 'duarte',
                'azusa', 'glendora', 'san dimas', 'la verne', 'claremont',
                'pomona', 'ontario', 'rancho cucamonga', 'fontana', 'rialto',
                'san bernardino', 'lancaster', 'palmdale', 'santa clarita',
                'simi valley', 'moorpark', 'camarillo', 'thousand oaks'
            ];
            
            for (const city of majorCities) {
                if (searchName.includes(city) || city.includes(searchName)) {
                    const cityKey = Object.keys(locations).find(key => 
                        key.toLowerCase().includes(city) || city.includes(key.toLowerCase())
                    );
                    if (cityKey && locations[cityKey]) {
                        console.log('‚úÖ Found major city match:', cityKey);
                        return locations[cityKey];
                    }
                }
            }
            
            // Try partial matches in hardcoded locations (but with better logic)
            for (const [key, location] of Object.entries(locations)) {
                // Only match if the search term is a significant part of the location name
                if ((key.includes(searchName) && searchName.length >= 3) || 
                    (searchName.includes(key) && key.length >= 3)) {
                    console.log('‚ö†Ô∏è Found partial match in hardcoded locations:', key);
                    return location;
                }
            }
            
            // Try partial matches in user addresses
            for (const [key, location] of Object.entries(userAddresses)) {
                if ((key.includes(searchName) && searchName.length >= 3) || 
                    (searchName.includes(key) && key.length >= 3)) {
                    console.log('‚ö†Ô∏è Found partial match in user addresses:', key);
                    return location;
                }
            }
            
            // If it looks like an address (contains street, avenue, etc.), geocode it
            if (locationName.toLowerCase().includes('street') || 
                locationName.toLowerCase().includes('avenue') || 
                locationName.toLowerCase().includes('road') || 
                locationName.toLowerCase().includes('boulevard') || 
                locationName.toLowerCase().includes('drive') || 
                locationName.toLowerCase().includes('way') ||
                locationName.toLowerCase().includes('place') ||
                locationName.toLowerCase().includes('lane') ||
                locationName.toLowerCase().includes('normandie') ||
                /\d/.test(locationName)) { // Contains numbers
                
                console.log('Address detected, geocoding...');
                const geocoded = await geocodeAddress(locationName);
                if (geocoded) {
                    return geocoded;
                }
            }
            
            // If no match found, try geocoding anyway (for any location)
            console.log('No hardcoded or user match found, trying geocoding...');
            const geocoded = await geocodeAddress(locationName);
            if (geocoded) {
                return geocoded;
            }
            
            console.log('‚ùå Location not found');
            return null;
        }

        // Enhanced planRoute function with async geocoding
        async function planRouteAsync(origin, destination, mode, departureTime) {
            console.log('planRouteAsync called with:', { origin, destination, mode, departureTime });
            
            // Handle current location
            if (origin.toLowerCase() === 'current location' || origin.toLowerCase() === 'current') {
                if (currentLocation) {
                    originCoords = currentLocation;
                    console.log('‚úÖ Using current location as origin:', originCoords);
                    console.log('üìç Current location details:', {
                        lat: originCoords.lat,
                        lng: originCoords.lng,
                        name: originCoords.name,
                        address: originCoords.address,
                        isGPS: originCoords.isGPS
                    });
                } else {
                    console.log('‚ùå Current location not available');
                    return {
                        type: 'error',
                        message: 'Current location not available. Please enable location services or enter a specific address.'
                    };
                }
            } else if (origin.toLowerCase().includes('current') || origin.toLowerCase().includes('üìç')) {
                // Handle any current location reference
                if (currentLocation) {
                    originCoords = currentLocation;
                    console.log('‚úÖ Using current location as origin (alternative):', originCoords);
                } else {
                    // Fallback to home address
                    const homeAddress = '3105 Normandie Avenue';
                    originCoords = { lat: 34.0224, lng: -118.2851, name: homeAddress };
                    console.log('‚ö†Ô∏è Using home address as fallback:', originCoords);
                }
            } else {
                // Geocode origin
                const originResult = await findLocationCoordinates(origin);
                if (!originResult) {
                    return {
                        type: 'error',
                        message: `Origin "${origin}" not found. Please check the spelling or use a location from the list.`
                    };
                }
                originCoords = originResult;
                console.log('‚úÖ Geocoded origin:', originCoords);
            }
            
            // Geocode destination
            const destResult = await findLocationCoordinates(destination);
            if (!destResult) {
                return {
                    type: 'error',
                    message: `Destination "${destination}" not found. Please check the spelling or use a location from the list.`
                };
            }
            const destCoords = destResult;
            
            console.log('Coordinates resolved:', { originCoords, destCoords });
            
            // Calculate direct distance
            const directDistance = calculateDistance(
                originCoords.lat, originCoords.lng,
                destCoords.lat, destCoords.lng
            );
            
            console.log('Direct distance:', directDistance);
            
            // Handle different modes
            if (mode === 'walk') {
                if (directDistance > WALKING_LIMIT) {
                    return {
                        type: 'suggestion',
                        message: `Walking distance (${directDistance.toFixed(1)} miles) exceeds the recommended limit of ${WALKING_LIMIT} miles. Try biking or transit.`,
                        suggestion: 'bike'
                    };
                }
                
                const walkTime = Math.round(directDistance / SPEEDS.walk * 60);
                return {
                    type: 'route',
                    totalTime: walkTime,
                    totalDistance: directDistance,
                    steps: [{
                        type: 'walk',
                        from: origin,
                        to: destination,
                        distance: directDistance,
                        time: walkTime,
                        instruction: `Walk ${directDistance.toFixed(1)} miles to ${destination}`,
                        routeName: null
                    }]
                };
            } else if (mode === 'bike') {
                if (directDistance > BIKE_LIMIT) {
                    return {
                        type: 'suggestion',
                        message: `Biking distance (${directDistance.toFixed(1)} miles) exceeds the recommended limit of ${BIKE_LIMIT} miles. Try transit.`,
                        suggestion: 'metro'
                    };
                }
                
                const bikeTime = Math.round(directDistance / SPEEDS.bike * 60);
                return {
                    type: 'route',
                    totalTime: bikeTime,
                    totalDistance: directDistance,
                    steps: [{
                        type: 'bike',
                        from: origin,
                        to: destination,
                        distance: directDistance,
                        time: bikeTime,
                        instruction: `üö¥ Bike ${directDistance.toFixed(1)} miles to ${destination}. Start from ${origin}, follow bike lanes and road shoulders. Use hand signals for turns and follow traffic rules.`,
                        routeName: null
                    }]
                };
            } else if (mode === 'metro' || mode === 'bus' || mode === 'train') {
                console.log(`Processing ${mode} mode`);
                
                // Use dynamic routing to find nearest stops and routes
                const transitRoute = findDynamicTransitRoute(originCoords, destCoords, mode);
                console.log('Dynamic transit route found:', transitRoute);
                
                if (!transitRoute) {
                    return {
                        type: 'error',
                        message: `No ${mode} stops found near ${origin} or ${destination}. Try a different mode.`
                    };
                }
                
                // Use the walking distances calculated by findDynamicTransitRoute
                const walkToOrigin = transitRoute.walkToOriginStop;
                const walkFromDest = transitRoute.walkFromDestStop;
                
                console.log('Walking distances from dynamic route:', { walkToOrigin, walkFromDest });
                
                // Check if walking distances are reasonable
                if (walkToOrigin > 1.0 || walkFromDest > 1.0) {
                    return {
                        type: 'suggestion',
                        message: `Walking to ${mode} stops is too far (${walkToOrigin.toFixed(1)} and ${walkFromDest.toFixed(1)} miles). Try biking or a different mode.`,
                        suggestion: 'bike'
                    };
                }
                
                // Calculate times using the walking distances from the route
                const walkToTime = Math.round(walkToOrigin / SPEEDS.walk * 60);
                const transitTime = transitRoute.time;
                const walkFromTime = Math.round(walkFromDest / SPEEDS.walk * 60);
                
                console.log('Calculated times:', { walkToTime, transitTime, walkFromTime });
                
                const steps = [];
                
                // Walk to origin stop
                if (walkToOrigin > 0.01) { // Reduced threshold to include more walking steps
                    const walkStep = {
                        type: 'walk',
                        from: origin,
                        to: transitRoute.originStop.name,
                        distance: walkToOrigin,
                        time: walkToTime,
                        instruction: `üö∂ Walk ${walkToOrigin.toFixed(2)} miles to ${transitRoute.originStop.name}. Start from ${origin}, walk straight for ${Math.round(walkToOrigin * 5280 * 0.4)} feet, turn right and continue for ${Math.round(walkToOrigin * 5280 * 0.6)} feet. Look for ${transitRoute.originStop.name} signs and entrance.`,
                        routeName: 'Walking Route'
                    };
                    steps.push(walkStep);
                    console.log('‚úÖ Added walking step to origin:', walkStep);
                } else {
                    console.log('‚ö†Ô∏è Walking distance too short, skipping walking step. Distance:', walkToOrigin);
                }
                
                // Transit segment
                if (transitRoute.transferRequired) {
                    // Split into two transit steps for transfer routes
                    const transferStation = transitRoute.transferStation;
                    
                    // Fix the routeKey splitting - handle hyphenated route names properly
                    const routeKeyParts = transitRoute.routeKey.split('-');
                    let originLine, destLine;
                    
                    // Handle different route key formats
                    if (routeKeyParts.length === 4) {
                        // Format: "expo-line-red-line" -> ["expo", "line", "red", "line"]
                        originLine = `${routeKeyParts[0]}-${routeKeyParts[1]}`;
                        destLine = `${routeKeyParts[2]}-${routeKeyParts[3]}`;
                    } else if (routeKeyParts.length === 3) {
                        // Format: "red-line-blue" -> ["red", "line", "blue"]
                        originLine = `${routeKeyParts[0]}-${routeKeyParts[1]}`;
                        destLine = routeKeyParts[2];
                    } else {
                        // Fallback: assume first part is origin, rest is destination
                        originLine = routeKeyParts[0];
                        destLine = routeKeyParts.slice(1).join('-');
                    }
                    
                    console.log('Processing transfer route:', { 
                        transferStation, 
                        originLine, 
                        destLine, 
                        routeKey: transitRoute.routeKey,
                        routeKeyParts,
                        availableLines: Object.keys(transitSystem.metro)
                    });
                    
                    // Safety check for origin line
                    if (!transitSystem.metro[originLine]) {
                        return {
                            type: 'error',
                            message: `Metro line not found: ${originLine}`
                        };
                    }
                    
                    // Safety check for destination line
                    if (!transitSystem.metro[destLine]) {
                        return {
                            type: 'error',
                            message: `Metro line not found: ${destLine}`
                        };
                    }
                    
                    // First leg: origin stop to transfer station
                    steps.push({
                        type: mode,
                        from: transitRoute.originStop.name,
                        to: transferStation,
                        distance: transitRoute.distance / 2, // Approximate
                        time: Math.round(transitRoute.time / 2), // Approximate
                        instruction: `Take ${transitSystem.metro[originLine].name} to ${transferStation}`,
                        routeName: transitSystem.metro[originLine].name
                    });
                    
                    // Transfer step
                    steps.push({
                        type: 'transfer',
                        from: transferStation,
                        to: transferStation,
                        distance: 0,
                        time: 5, // 5 minutes for transfer
                        instruction: `Transfer to ${transitSystem.metro[destLine].name} at ${transferStation}`,
                        routeName: `${transitSystem.metro[originLine].name} ‚Üí ${transitSystem.metro[destLine].name}`
                    });
                    
                    // Second leg: transfer station to destination stop
                    steps.push({
                        type: mode,
                        from: transferStation,
                        to: transitRoute.destStop.name,
                        distance: transitRoute.distance / 2, // Approximate
                        time: Math.round(transitRoute.time / 2), // Approximate
                        instruction: `Take ${transitSystem.metro[destLine].name} to ${transitRoute.destStop.name}`,
                        routeName: transitSystem.metro[destLine].name
                    });
                } else {
                    // Direct route (no transfer)
                    steps.push({
                        type: mode,
                        from: transitRoute.originStop.name,
                        to: transitRoute.destStop.name,
                        distance: transitRoute.distance,
                        time: transitTime,
                        instruction: `Take ${transitRoute.name} from ${transitRoute.originStop.name} to ${transitRoute.destStop.name}`,
                        routeName: transitRoute.name
                    });
                }
                
                // Walk from destination stop
                if (walkFromDest > 0.001) { // Reduced threshold to always include walking steps
                    steps.push({
                        type: 'walk',
                        from: transitRoute.destStop.name,
                        to: destination,
                        distance: walkFromDest,
                        time: walkFromTime,
                        instruction: `üö∂ Walk ${walkFromDest.toFixed(2)} miles to ${destination}. Start from ${transitRoute.destStop.name}, walk straight for ${Math.round(walkFromDest * 5280 * 0.4)} feet, turn left and continue for ${Math.round(walkFromDest * 5280 * 0.6)} feet. You will reach ${destination}.`,
                        routeName: 'Walking Route'
                    });
                    console.log('‚úÖ Added walking step from destination:', { distance: walkFromDest, time: walkFromTime });
                } else {
                    console.log('‚ö†Ô∏è Walking distance from destination too short, skipping. Distance:', walkFromDest);
                }
                
                const totalTime = steps.reduce((sum, step) => sum + step.time, 0);
                const totalDistance = steps.reduce((sum, step) => sum + step.distance, 0);
                
                console.log('üéØ Final route created:', { 
                    totalTime, 
                    totalDistance, 
                    stepsCount: steps.length,
                    steps: steps.map((step, index) => ({
                        index,
                        type: step.type,
                        from: step.from,
                        to: step.to,
                        distance: step.distance,
                        time: step.time,
                        instruction: step.instruction
                    }))
                });
                
                return {
                    type: 'route',
                    totalTime: totalTime,
                    totalDistance: totalDistance,
                    steps: steps
                };
            }
            
            console.log('Invalid mode:', mode);
            return {
                type: 'error',
                message: 'Invalid transportation mode.'
            };
        }

        // Add new user address
        async function addNewUserAddress() {
            const name = document.getElementById('addressName').value.trim();
            const address = document.getElementById('addressInput').value.trim();
            const description = document.getElementById('addressDescription').value.trim();
            
            if (!name || !address) {
                alert('Please enter both a name and address.');
                return;
            }
            
            // Geocode the address
            const geocoded = await geocodeAddress(address);
            if (!geocoded) {
                alert('Could not find this address. Please check the spelling and try again.');
                return;
            }
            
            // Add to user addresses
            addUserAddress(name, geocoded.lat, geocoded.lng, description);
            
            // Clear form
            document.getElementById('addressName').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('addressDescription').value = '';
            
            // Reload user addresses list
            loadUserAddressesList();
            
            showLocationMessage(`‚úÖ Address "${name}" added successfully!`, 'success');
        }
        
        // Use current location for address
        async function useCurrentLocationForAddress() {
            const name = document.getElementById('addressName').value.trim();
            const description = document.getElementById('addressDescription').value.trim();
            
            if (!name) {
                alert('Please enter a name for this address.');
                return;
            }
            
            if (!currentLocation) {
                alert('Current location not available. Please get your location first.');
                return;
            }
            
            // Add current location as user address
            addUserAddress(name, currentLocation.lat, currentLocation.lng, description);
            
            // Clear form
            document.getElementById('addressName').value = '';
            document.getElementById('addressInput').value = '';
            document.getElementById('addressDescription').value = '';
            
            // Reload user addresses list
            loadUserAddressesList();
            
            showLocationMessage(`‚úÖ Address "${name}" added from current location!`, 'success');
        }
        
        // Load user addresses list
        function loadUserAddressesList() {
            const container = document.getElementById('userAddressesContainer');
            
            if (Object.keys(userAddresses).length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center;">No saved addresses yet. Add your first address above!</p>';
                return;
            }
            
            let html = '';
            for (const [key, address] of Object.entries(userAddresses)) {
                html += `
                    <div class="custom-location-item" style="background: white; border: 1px solid #e0e0e0; border-radius: 8px; padding: 1rem; margin-bottom: 0.5rem;">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #333;">${address.name}</h4>
                                <p style="margin: 0 0 0.5rem 0; color: #666; font-size: 0.9rem;">${address.description || 'No description'}</p>
                                <p style="margin: 0; color: #888; font-size: 0.8rem;">üìç ${address.lat.toFixed(6)}, ${address.lng.toFixed(6)}</p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="useUserAddress('${key}')" class="btn-primary" style="font-size: 0.8rem;">Use</button>
                                <button onclick="removeUserAddress('${key}')" class="btn-danger" style="font-size: 0.8rem;">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }
        
        // Use a user address
        function useUserAddress(key) {
            const address = userAddresses[key];
            if (address) {
                document.getElementById('originInput').value = address.name;
                closeLocationManager();
                showLocationMessage(`‚úÖ Using address: ${address.name}`, 'success');
            }
        }
        
        // Update tab switching to include user addresses
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.style.display = 'none');
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => button.classList.remove('active'));
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            // Load data for specific tabs
            if (tabName === 'userAddresses') {
                loadUserAddressesList();
            } else if (tabName === 'myLocations') {
                loadCustomLocationsList();
            } else if (tabName === 'recentSearches') {
                loadSearchHistoryList();
            }
        }

        // Update map location during navigation
        function updateMapLocation(step) {
            if (!window.navMap) return;
            
            let lat, lng;
            
            if (step.lat && step.lng) {
                // Direct coordinates provided
                lat = step.lat;
                lng = step.lng;
            } else if (step.from && step.from.toLowerCase().includes('current')) {
                // Current location step - use actual GPS coordinates
                if (currentLocation) {
                    lat = currentLocation.lat;
                    lng = currentLocation.lng;
                } else {
                    // Fallback to Downtown LA
                    lat = 34.0522;
                    lng = -118.2437;
                }
            } else if (currentLocation && currentStepIndex === 0) {
                // If this is the first step and we have current location, use GPS coordinates
                lat = currentLocation.lat;
                lng = currentLocation.lng;
            } else {
                // Try to find coordinates for the step location
                const location = findLocationByName(step.from);
                if (location) {
                    lat = location.lat;
                    lng = location.lng;
                } else {
                    // Fallback to Downtown LA
                    lat = 34.0522;
                    lng = -118.2437;
                }
            }
            
            // Update map center
            window.navMap.setView([lat, lng], 15);
            
            // Update current location marker
            if (currentLocationMarker) {
                window.navMap.removeLayer(currentLocationMarker);
            }
            
            currentLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'current-location-marker',
                    html: '<div style="background: #0066cc; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 10px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            });
            
            // Add popup with current location info
            const popupContent = currentLocation && currentLocation.address ? 
                currentLocation.address : (step.from || 'Current Location');
            currentLocationMarker.bindPopup(popupContent);
        }

        // Get carrier information for a route
        function getCarrierInfo(routeKey, type) {
            if (type === 'metro') {
                return 'LA Metro';
            } else if (type === 'bus') {
                const route = transitSystem.bus[routeKey];
                return route ? route.carrier : 'LA Metro';
            }
            return 'Unknown';
        }

        // Get route frequency information
        function getRouteFrequency(routeKey, type) {
            if (type === 'metro') {
                const route = transitSystem.metro[routeKey];
                return route ? route.frequency : 'Every 6-10 minutes';
            } else if (type === 'bus') {
                const route = transitSystem.bus[routeKey];
                return route ? route.frequency : 'Every 10-15 minutes';
            }
            return 'Unknown';
        }

        // Generate live transit information with REAL-TIME DATA
        // COMMENTED OUT ASYNC FUNCTION - using synchronous version instead
        /*
        async function generateLiveTransitInfo(step) {
            // This function has been disabled to prevent Promise issues
            // Using the synchronous version at line 4027 instead
        }
        */

        // Initialize real-time API service
        // const realTimeAPI = new RealTimeAPIService(); // Duplicate declaration - commented out

        // Enhanced function to get real-time transit data
        async function getRealTimeTransitData() {
            try {
                console.log('üîÑ Fetching real-time transit data...');
                
                // Get LA Metro real-time data
                const laMetroData = await realTimeAPI.getLAMetroRealTimeData();
                
                // Get Metro Cloud Alliance carriers
                const carriers = await realTimeAPI.getMetroCloudCarriers();
                
                // Get service alerts
                const alerts = await realTimeAPI.getServiceAlerts();
                
                console.log('‚úÖ Real-time data fetched successfully:', {
                    laMetroRoutes: laMetroData.routes?.length || 0,
                    laMetroStops: laMetroData.stops?.length || 0,
                    laMetroVehicles: laMetroData.vehicles?.length || 0,
                    carriers: carriers.length,
                    alerts: alerts.length
                });
                
                return {
                    laMetro: laMetroData,
                    carriers: carriers,
                    alerts: alerts,
                    timestamp: Date.now()
                };
                
            } catch (error) {
                console.error('‚ùå Error fetching real-time data:', error);
                return null;
            }
        }

        // Function to update transit data periodically
        let realTimeUpdateInterval;
        
        function startRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
            }
            
            // Update every 30 seconds
            realTimeUpdateInterval = setInterval(async () => {
                if (isNavigating) {
                    await updateNavigationWithRealTimeData();
                }
            }, 30000);
            
            console.log('üîÑ Real-time updates started (30s interval)');
        }
        
        function stopRealTimeUpdates() {
            if (realTimeUpdateInterval) {
                clearInterval(realTimeUpdateInterval);
                realTimeUpdateInterval = null;
                console.log('‚èπÔ∏è Real-time updates stopped');
            }
        }

        // Update navigation with real-time data
        async function updateNavigationWithRealTimeData() {
            if (!currentRoute || !currentStep) return;
            
            try {
                // Update live transit info if current step is transit
                if (currentStep.type === 'metro' || currentStep.type === 'bus' || currentStep.type === 'train') {
                    const newTransitInfo = generateLiveTransitInfo(currentStep);
                    const transitInfoEl = document.querySelector('.live-transit-info');
                    if (transitInfoEl) {
                        transitInfoEl.innerHTML = newTransitInfo;
                    }
                }
                
                // Update vehicle locations on map if available
                if (currentStep.routeKey) {
                    await updateVehicleLocationsOnMap(currentStep.routeKey);
                }
                
            } catch (error) {
                console.log('Real-time navigation update failed:', error);
            }
        }

        // Update vehicle locations on the map
        async function updateVehicleLocationsOnMap(routeKey) {
            try {
                const vehicles = await realTimeAPI.getVehicleLocations(routeKey);
                
                if (vehicles && vehicles.length > 0 && window.navMap) {
                    // Remove existing vehicle markers
                    if (window.vehicleMarkers) {
                        window.vehicleMarkers.forEach(marker => {
                            window.navMap.removeLayer(marker);
                        });
                    }
                    
                    window.vehicleMarkers = [];
                    
                    // Add new vehicle markers
                    vehicles.forEach(vehicle => {
                        const vehicleIcon = L.divIcon({
                            className: 'vehicle-marker',
                            html: `<div style="background: #0066cc; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 8px rgba(0,0,0,0.3); transform: rotate(${vehicle.bearing}deg);"></div>`,
                            iconSize: [12, 12],
                            iconAnchor: [6, 6]
                        });
                        
                        const marker = L.marker([vehicle.lat, vehicle.lng], { icon: vehicleIcon })
                            .addTo(window.navMap)
                            .bindPopup(`
                                <strong>Vehicle ${vehicle.id}</strong><br>
                                Route: ${vehicle.route}<br>
                                Speed: ${vehicle.speed} mph<br>
                                Status: ${vehicle.status}<br>
                                Updated: ${vehicle.timestamp.toLocaleTimeString()}
                            `);
                        
                        window.vehicleMarkers.push(marker);
                    });
                }
                
            } catch (error) {
                console.log('Vehicle location update failed:', error);
            }
        }

        // Add real-time data status indicator to the UI
        function addRealTimeStatusIndicator() {
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'realTimeStatusIndicator';
            statusIndicator.style.cssText = `
                position: fixed;
                top: 10px;
                right: 10px;
                background: rgba(0,0,0,0.8);
                color: white;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 0.8rem;
                z-index: 2000;
                display: flex;
                align-items: center;
                gap: 6px;
                transition: all 0.3s ease;
            `;
            
            statusIndicator.innerHTML = `
                <span id="statusIcon">üì°</span>
                <span id="statusText">Real-time data available</span>
            `;
            
            document.body.appendChild(statusIndicator);
            
            // Update status periodically
            updateRealTimeStatus();
        }
        
        // Update real-time status
        async function updateRealTimeStatus() {
            const statusIcon = document.getElementById('statusIcon');
            const statusText = document.getElementById('statusText');
            const indicator = document.getElementById('realTimeStatusIndicator');
            
            if (!statusIcon || !statusText || !indicator) return;
            
            try {
                // Test real-time API connection
                const testData = await realTimeAPI.getLAMetroRealTimeData();
                
                if (testData && (testData.routes || testData.stops || testData.vehicles)) {
                    // Real-time data available
                    statusIcon.textContent = 'üì°';
                    statusText.textContent = 'Live data connected';
                    indicator.style.background = 'rgba(40, 167, 69, 0.9)';
                    indicator.style.color = 'white';
                } else {
                    // Fallback to simulated data
                    statusIcon.textContent = 'üîÑ';
                    statusText.textContent = 'Simulated data';
                    indicator.style.background = 'rgba(255, 193, 7, 0.9)';
                    indicator.style.color = 'black';
                }
            } catch (error) {
                // API not available
                statusIcon.textContent = '‚ö†Ô∏è';
                statusText.textContent = 'Offline mode';
                indicator.style.background = 'rgba(220, 53, 69, 0.9)';
                indicator.style.color = 'white';
            }
            
            // Update every 30 seconds
            setTimeout(updateRealTimeStatus, 30000);
        }

        // Find dynamic transit route between any two coordinates
        function findDynamicTransitRoute(originCoords, destCoords, mode) {
            console.log('üîç Finding dynamic transit route:', { originCoords, destCoords, mode });
            
            // Find nearest stops to origin and destination
            const originStop = findNearestStop(originCoords.lat, originCoords.lng, mode);
            const destStop = findNearestStop(destCoords.lat, destCoords.lng, mode);
            
            if (!originStop || !destStop) {
                console.log('‚ùå No stops found near origin or destination');
                return null;
            }
            
            console.log('üìç Found nearest stops:', { 
                origin: originStop.name, 
                destination: destStop.name 
            });
            
            // Calculate walking distances to/from stops
            const walkToOriginStop = calculateDistance(
                originCoords.lat, originCoords.lng,
                originStop.lat, originStop.lng
            );
            
            const walkFromDestStop = calculateDistance(
                destCoords.lat, destCoords.lng,
                destStop.lat, destStop.lng
            );
            
            console.log('üö∂ Walking distances calculated:', {
                walkToOriginStop: walkToOriginStop.toFixed(3) + ' miles',
                walkFromDestStop: walkFromDestStop.toFixed(3) + ' miles',
                originLocation: originCoords.name || 'Current Location',
                originStop: originStop.name,
                destStop: destStop.name,
                destLocation: destCoords.name || 'Destination'
            });
            
            // Find transit route between the stops
            const transitRoute = findTransitRoute(originStop, destStop, mode);
            
            if (!transitRoute) {
                console.log('‚ùå No transit route found between stops');
                return null;
            }
            
            // return complete route with walking segments
            return {
                originStop: originStop,
                destStop: destStop,
                walkToOriginStop: walkToOriginStop,
                walkFromDestStop: walkFromDestStop,
                distance: transitRoute.distance,
                time: transitRoute.time,
                name: transitRoute.name,
                routeKey: transitRoute.routeKey,
                transferRequired: transitRoute.transferRequired,
                transferStation: transitRoute.transferStation,
                totalDistance: walkToOriginStop + transitRoute.distance + walkFromDestStop,
                totalTime: Math.round(walkToOriginStop / SPEEDS.walk * 60) + transitRoute.time + Math.round(walkFromDestStop / SPEEDS.walk * 60)
            };
        }

        // Find transit route between two stops
        function findTransitRoute(originStop, destStop, mode) {
            console.log('üöá Finding transit route between stops:', { 
                origin: originStop.name, 
                destination: destStop.name, 
                mode 
            });
            
            // Check if both stops are on the same route
            if (originStop.routeKey === destStop.routeKey) {
                console.log('‚úÖ Direct route found on same line');
                
                // Calculate distance between stops on the same line
                const routeDistance = calculateDistance(
                    originStop.lat, originStop.lng,
                    destStop.lat, destStop.lng
                );
                
                const routeTime = Math.round(routeDistance / SPEEDS[mode] * 60);
                
                console.log('üìè Route calculation:', {
                    distance: routeDistance.toFixed(2) + ' miles',
                    time: routeTime + ' minutes',
                    speed: SPEEDS[mode] + ' mph'
                });
                
                return {
                    name: originStop.route.name,
                    routeKey: originStop.routeKey,
                    distance: routeDistance,
                    time: routeTime,
                    transferRequired: false
                };
            }
            
            // Look for transfer routes
            console.log('üîÑ Looking for transfer routes...');
            const transferRoute = findTransferStations(originStop, destStop);
            
            if (transferRoute) {
                console.log('‚úÖ Transfer route found:', transferRoute);
                return transferRoute;
            }
            
            console.log('‚ùå No route found between stops');
            return null;
        }

        // Find transfer stations between two stops
        function findTransferStations(originStop, destStop) {
            console.log('üîÑ Finding transfer stations between:', originStop.name, 'and', destStop.name);
            
            // Get all routes for the mode
            const routes = transitSystem.metro;
            const routeKeys = Object.keys(routes);
            
            // Find common transfer stations
            const commonStations = findCommonStations(originStop, destStop);
            
            if (commonStations.length > 0) {
                // Find the best transfer option
                let bestTransfer = null;
                let minTotalDistance = Infinity;
                
                commonStations.forEach(station => {
                    const distance1 = calculateDistance(originStop.lat, originStop.lng, station.lat, station.lng);
                    const distance2 = calculateDistance(station.lat, station.lng, destStop.lat, destStop.lng);
                    const totalDistance = distance1 + distance2;
                    
                    if (totalDistance < minTotalDistance) {
                        minTotalDistance = totalDistance;
                        bestTransfer = {
                            transferStation: station.name,
                            distance: totalDistance,
                            time: Math.round(totalDistance / SPEEDS.metro * 60),
                            name: `${originStop.route.name} ‚Üí ${destStop.route.name}`,
                            routeKey: `${originStop.routeKey}-${destStop.routeKey}`,
                            transferRequired: true
                        };
                    }
                });
                
                return bestTransfer;
            }
            
            return null;
        }

        // Find common stations between two stops
        function findCommonStations(originStop, destStop) {
            const commonStations = [];
            
            // Get all stations from origin route
            const originRoute = transitSystem.metro[originStop.routeKey];
            const destRoute = transitSystem.metro[destStop.routeKey];
            
            if (!originRoute || !destRoute) return commonStations;
            
            const originStations = originRoute.stations;
            const destStations = destRoute.stations;
            
            // Find stations that exist in both routes
            originStations.forEach(originStation => {
                destStations.forEach(destStation => {
                    if (originStation.name === destStation.name) {
                        commonStations.push(originStation);
                    }
                });
            });
            
            console.log('üîÑ Common stations found:', commonStations.map(s => s.name));
            return commonStations;
        }

        // Geocode address using OpenStreetMap Nominatim API
        async function geocodeAddress(address) {
            console.log('üåç Geocoding address:', address);
            
            try {
                // Add LA context to improve search results
                const searchQuery = address.includes('Los Angeles') || address.includes('LA') 
                    ? address 
                    : `${address}, Los Angeles, CA`;
                
                // Use viewbox to limit search to LA area
                const viewbox = '-118.6682,33.7037,-118.1553,34.3373'; // LA County bounds
                
                const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&limit=5&viewbox=${viewbox}&bounded=1&addressdetails=1`;
                
                console.log('üåç Fetching from Nominatim:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('üåç Nominatim response:', data);
                
                if (data && data.length > 0) {
                    // Find the best match (prefer LA area results)
                    let bestMatch = data[0];
                    
                    for (const result of data) {
                        const address = result.address;
                        if (address && (address.city === 'Los Angeles' || address.county === 'Los Angeles County')) {
                            bestMatch = result;
                            break;
                        }
                    }
                    
                    const coords = {
                        lat: parseFloat(bestMatch.lat),
                        lng: parseFloat(bestMatch.lon),
                        name: bestMatch.display_name,
                        address: bestMatch.display_name
                    };
                    
                    console.log('‚úÖ Geocoding successful:', coords);
                    return coords;
                } else {
                    console.log('‚ùå No geocoding results found');
                    return null;
                }
                
            } catch (error) {
                console.error('‚ùå Geocoding error:', error);
                return null;
            }
        }

        // Enhanced location finding with hybrid approach

        // Update progress bar during navigation
        function updateProgressBar(step, elapsedTime) {
            const progressFill = document.querySelector('.progress-fill');
            const elapsedTimeEl = document.querySelector('.elapsed-time');
            
            if (progressFill && elapsedTimeEl) {
                const progress = (elapsedTime / (step.time * 60)) * 100;
                progressFill.style.width = `${Math.min(progress, 100)}%`;
                elapsedTimeEl.textContent = Math.floor(elapsedTime / 60);
            }
        }

        // Update live transit information
        function updateLiveTransitInfo(step) {
            const transitInfoEl = document.querySelector('.live-transit-info');
            if (transitInfoEl) {
                const newTransitInfo = generateLiveTransitInfo(step);
                transitInfoEl.innerHTML = newTransitInfo;
            }
        }

        // Show step completion notification
        function showStepCompletionNotification(step) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #28a745;
                color: white;
                padding: 1rem 2rem;
                border-radius: 8px;
                z-index: 4000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                font-weight: bold;
                text-align: center;
            `;
            notification.innerHTML = `
                <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚úÖ</div>
                <div>Step Complete!</div>
                <div style="font-size: 0.9rem; opacity: 0.9;">${step.instruction}</div>
            `;
            
            document.body.appendChild(notification);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // Show navigation complete
        function showNavigationComplete() {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: #28a745;
                color: white;
                padding: 2rem;
                border-radius: 12px;
                z-index: 4000;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
                text-align: center;
                max-width: 400px;
            `;
            notification.innerHTML = `
                <div style="font-size: 3rem; margin-bottom: 1rem;">üéâ</div>
                <div style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem;">Navigation Complete!</div>
                <div style="font-size: 1rem; opacity: 0.9;">You have reached your destination.</div>
                <button onclick="exitNavigation()" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 0.75rem 1.5rem; border-radius: 6px; margin-top: 1rem; cursor: pointer;">
                    Close Navigation
                </button>
            `;
            
            document.body.appendChild(notification);
        }

        // Get mode icon for display
        function getModeIcon(mode) {
            const icons = {
                walk: 'üö∂',
                bike: 'üö≤',
                metro: 'üöá',
                bus: 'üöå',
                train: 'üöÜ',
                transfer: 'üîÑ'
            };
            return icons[mode] || 'üöó';
        }

        // Get mode name for display
        function getModeName(mode) {
            const names = {
                walk: 'Walk',
                bike: 'Bike',
                metro: 'Metro',
                bus: 'Bus',
                train: 'Train',
                transfer: 'Transfer'
            };
            return names[mode] || 'Travel';
        }

        // Initialize real-time API service
    </script>
</body>
</html>
