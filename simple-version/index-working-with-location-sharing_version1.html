<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Transit App - Route Planner with Location Sharing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-items {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #666;
            font-weight: 500;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .search-button, .location-share-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-button:hover, .location-share-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .location-share-button.active {
            background: linear-gradient(135deg, #4caf50, #45a049);
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }

        @keyframes pulse {
            0% { box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(76, 175, 80, 0.6); }
            100% { box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4); }
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 0;
            height: calc(100vh - 80px);
        }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 0;
            border-radius: 20px;
            margin: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Location Sharing Panel Styles */
        .location-share-panel {
            position: fixed;
            top: 0;
            right: -450px;
            width: 450px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            box-shadow: -5px 0 30px rgba(0, 0, 0, 0.2);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            border-left: 1px solid rgba(255, 255, 255, 0.3);
        }

        .location-share-panel.open {
            right: 0;
        }

        .location-share-header {
            padding: 25px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: relative;
            overflow: hidden;
        }

        .location-share-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .location-share-title {
            margin: 0;
            font-size: 20px;
            font-weight: 700;
            position: relative;
            z-index: 1;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .location-share-content {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .section {
            margin-bottom: 30px;
            background: white;
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .section:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        }

        .section-title {
            margin: 0 0 15px 0;
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-card {
            padding: 20px;
            border-radius: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            margin-bottom: 20px;
            transition: all 0.3s ease;
        }

        .status-card.sharing {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.2);
        }

        .status-text {
            font-size: 15px;
            color: #64748b;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 700;
            color: #64748b;
            font-size: 16px;
        }

        .status-indicator.sharing {
            color: #10b981;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #cbd5e1;
            transition: all 0.3s ease;
        }

        .status-dot.sharing {
            background: #10b981;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .location-info {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #64748b;
            border: 1px solid #e2e8f0;
        }

        .button {
            padding: 14px 24px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 12px;
            position: relative;
            overflow: hidden;
        }

        .button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s;
        }

        .button:hover::before {
            left: 100%;
        }

        .button.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .button.secondary {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            border: 2px solid #e2e8f0;
        }

        .button.secondary:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .button.danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
        }

        .button.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(239, 68, 68, 0.4);
        }

        .contacts-list {
            margin-bottom: 20px;
        }

        .contact-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            margin-bottom: 12px;
            background: white;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .contact-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 4px;
            font-size: 16px;
        }

        .contact-details {
            font-size: 13px;
            color: #64748b;
        }

        .contact-actions {
            display: flex;
            gap: 8px;
        }

        .action-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .add-contact-form {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            margin-bottom: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 0;
            border-bottom: 1px solid #f1f5f9;
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 15px;
            color: #475569;
            font-weight: 600;
        }

        .settings-value {
            font-size: 15px;
            color: #1e293b;
            font-weight: 600;
        }

        /* User Location Marker Styles */
        .user-location-marker {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 4px solid white;
            border-radius: 50%;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            animation: pulse 2s infinite;
        }

        .user-location-marker::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
        }

        /* Overlay for when location sharing is active */
        .location-sharing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 1500;
            display: none;
            transition: all 0.3s ease;
        }

        .location-sharing-overlay.active {
            display: block;
        }

        /* Duration Options Styles */
        .duration-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 15px;
        }

        .duration-btn {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            text-align: center;
        }

        .duration-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .duration-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .duration-time {
            font-size: 20px;
            font-weight: 800;
        }

        .duration-desc {
            font-size: 11px;
            color: #64748b;
            font-weight: 500;
        }

        .duration-btn.active .duration-desc {
            color: rgba(255, 255, 255, 0.8);
        }

        /* Session Info Styles */
        .session-details {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .session-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .session-row:last-child {
            margin-bottom: 0;
        }

        .session-label {
            font-size: 14px;
            color: #475569;
            font-weight: 600;
        }

        .session-value {
            font-size: 14px;
            color: #1e293b;
            font-weight: 600;
        }

        /* Custom Duration Styles */
        .custom-duration {
            margin-top: 15px;
            padding: 16px;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .custom-duration label {
            font-size: 14px;
            color: #475569;
            margin-bottom: 8px;
            display: block;
            font-weight: 600;
        }

        /* Share Options Styles */
        .share-options {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .share-options p {
            margin: 0 0 15px 0;
            font-size: 14px;
            color: #64748b;
            line-height: 1.5;
        }

        .share-checkboxes {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .share-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .share-checkbox:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .share-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            accent-color: #667eea;
        }

        /* Search Modal Popup */
        .search-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
        }

        .search-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 0;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .search-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .search-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .search-form {
            padding: 2.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .current-location-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .current-location-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3rem;
            color: #64748b;
        }

        .transport-modes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .mode-button {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            color: #475569;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .mode-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .mode-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1.25rem 2.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 800;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .results-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            margin: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Route Results Styles */
        .route-result {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .route-result:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .route-header-result {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .route-name {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 800;
            color: #1e293b;
        }

        .route-details {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
        }

        .journey-steps {
            margin-top: 1.5rem;
        }

        .journey-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .journey-step:hover {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin: 0 -1rem;
        }

        .journey-step:last-child {
            border-bottom: none;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Navigation Overlay Styles */
        .navigation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            z-index: 3000;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.4s ease;
        }

        .nav-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #60a5fa 100%);
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        .nav-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .nav-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .nav-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1rem;
            position: relative;
            z-index: 1;
        }

        .exit-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .nav-map-container {
            flex: 2;
            position: relative;
        }

        .directions-panel {
            flex: 1;
            background: white;
            border-left: 2px solid #e2e8f0;
            overflow-y: auto;
            padding: 2rem;
            max-width: 450px;
        }

        .current-step {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .step-progress {
            margin-bottom: 1.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 0.75rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.4s ease;
            border-radius: 6px;
        }

        .step-counter {
            text-align: center;
            font-size: 1rem;
            color: #64748b;
            font-weight: 700;
        }

        .current-instruction {
            margin-bottom: 1.5rem;
        }

        .current-instruction h4 {
            margin: 0 0 0.75rem 0;
            color: #1e293b;
            font-size: 1.3rem;
            font-weight: 800;
        }

        .current-instruction p {
            margin: 0;
            color: #64748b;
            font-size: 1rem;
            font-weight: 600;
        }

        .live-info {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 12px;
            padding: 1.5rem;
            border-left: 4px solid #10b981;
        }

        .movement-status {
            font-size: 1rem;
            color: #065f46;
            font-weight: 700;
        }

        .directions-list {
            margin-bottom: 2rem;
        }

        .directions-list h5 {
            margin: 0 0 1.5rem 0;
            color: #1e293b;
            font-size: 1.2rem;
            font-weight: 800;
        }

        .step-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .step-item.active {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.15);
        }

        .step-item.completed {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #10b981;
            opacity: 0.8;
        }

        .step-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .step-content {
            flex: 1;
        }

        .step-instruction {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .step-details {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
        }

        .nav-controls {
            display: flex;
            gap: 1rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e2e8f0;
        }

        .nav-btn {
            flex: 1;
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .nav-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .nav-btn:not(:disabled):hover {
            transform: translateY(-2px);
        }

        .nav-btn:first-child {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #475569;
            border: 2px solid #e2e8f0;
        }

        .nav-btn:last-child {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        /* Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 1000;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .chatbot-toggle {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
        }

        .chatbot-toggle.active {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .chatbot-window {
            position: absolute;
            bottom: 100px;
            right: 0;
            width: 400px;
            height: 600px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: slideUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chatbot-window.open {
            display: flex;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            overflow: hidden;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 800;
            position: relative;
            z-index: 1;
        }

        .chatbot-status {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        .chatbot-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
        }

        .chatbot-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .chatbot-messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .message-content {
            max-width: 75%;
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.5;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.bot .message-content {
            background: white;
            color: #1e293b;
            border: 2px solid #e2e8f0;
            border-bottom-left-radius: 6px;
        }

        .message.bot .message-content.typing {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: #64748b;
            font-style: italic;
        }

        .chatbot-input {
            padding: 25px;
            border-top: 2px solid #e2e8f0;
            background: white;
        }

        .chatbot-input-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chatbot-input-field {
            flex: 1;
            padding: 16px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .chatbot-input-field:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        .chatbot-send {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .chatbot-send:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .chatbot-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            padding: 8px 16px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #475569;
            font-weight: 600;
        }

        .quick-action-btn:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .route-suggestion {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #667eea;
            border-radius: 16px;
            padding: 16px;
            margin-top: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .route-suggestion:hover {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .route-suggestion h4 {
            margin: 0 0 10px 0;
            color: #1e40af;
            font-size: 15px;
            font-weight: 700;
        }

        .route-suggestion p {
            margin: 0;
            color: #64748b;
            font-size: 13px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            🚇 LA Transit
        </div>
        <div class="nav-items">
            <div class="nav-item">
                🗺️ Routes
            </div>
            <div class="nav-item">
                📍 Locations
            </div>
            <button class="search-button" onclick="toggleSearch()">
                🔍 Search Routes
            </button>
            <button class="location-share-button" id="locationShareBtn" onclick="toggleLocationShare()">
                📍 Share Location
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Location Sharing Panel -->
    <div class="location-share-panel" id="locationSharePanel">
        <div class="location-share-header">
            <h2 class="location-share-title">Share Location</h2>
            <button class="close-button" onclick="toggleLocationShare()">×</button>
        </div>
        <div class="location-share-content">
            <div class="section">
                <h3 class="section-title">
                    📍 Current Status
                </h3>
                <div class="status-card" id="statusCard">
                    <div class="status-text" id="statusText">
                        Location sharing is inactive
                    </div>
                    <div class="status-indicator" id="statusIndicator">
                        <div class="status-dot" id="statusDot"></div>
                        Inactive
                    </div>
                </div>

                <div class="location-info" id="locationInfo" style="display: none;">
                    <div><strong>Current Location:</strong></div>
                    <div id="currentLocationText"></div>
                    <div style="font-size: 12px; margin-top: 4px; color: #999;" id="locationTimestamp"></div>
                    <button class="button secondary" onclick="refreshLocation()" style="margin-top: 8px; font-size: 12px; padding: 6px 12px;">
                        🔄 Refresh Location
                    </button>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">
                    👥 Share With
                </h3>
                <div class="contacts-list" id="contactsList">
                    <!-- Contacts will be populated here -->
                </div>

                <button class="button secondary" onclick="showAddContactForm()" id="addContactBtn">
                    ➕ Add Contact
                </button>

                <div class="add-contact-form" id="addContactForm" style="display: none;">
                    <input type="text" class="input" placeholder="Name" id="contactName">
                    <input type="tel" class="input" placeholder="Phone (optional)" id="contactPhone">
                    <input type="email" class="input" placeholder="Email (optional)" id="contactEmail">
                    <div style="display: flex; gap: 8px;">
                        <button class="button primary" onclick="addContact()" style="flex: 1;">
                            Add
                        </button>
                        <button class="button secondary" onclick="hideAddContactForm()" style="flex: 1;">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">
                    ⚙️ Settings
                </h3>
                <div class="settings-row">
                    <div class="settings-label">Update Interval</div>
                    <div class="settings-value">30 seconds</div>
                </div>
                <div class="settings-row">
                    <div class="settings-label">Share Duration</div>
                    <div class="settings-value" id="currentDurationDisplay">
                        <span id="durationValue">60 minutes</span>
                        <span id="durationStatus" style="color: #4caf50; font-size: 12px;">● Active</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">
                    ⏰ Share Duration
                </h3>
                <div class="duration-options">
                    <button class="duration-btn active" onclick="setDuration(15)" data-duration="15">
                        <span class="duration-time">15 min</span>
                        <span class="duration-desc">Quick share</span>
                    </button>
                    <button class="duration-btn" onclick="setDuration(30)" data-duration="30">
                        <span class="duration-time">30 min</span>
                        <span class="duration-desc">Short trip</span>
                    </button>
                    <button class="duration-btn" onclick="setDuration(60)" data-duration="60">
                        <span class="duration-time">1 hour</span>
                        <span class="duration-desc">Standard</span>
                    </button>
                    <button class="duration-btn" onclick="setDuration(120)" data-duration="120">
                        <span class="duration-time">2 hours</span>
                        <span class="duration-desc">Long trip</span>
                    </button>
                    <button class="duration-btn" onclick="setDuration(240)" data-duration="240">
                        <span class="duration-time">4 hours</span>
                        <span class="duration-desc">Extended</span>
                    </button>
                    <button class="duration-btn" onclick="setDuration(0)" data-duration="0">
                        <span class="duration-time">∞</span>
                        <span class="duration-desc">Until stopped</span>
                    </button>
                </div>
                
                <div class="custom-duration" style="margin-top: 12px;">
                    <label style="font-size: 14px; color: #333; margin-bottom: 8px; display: block;">Custom Duration (minutes):</label>
                    <input type="number" id="customDuration" class="input" placeholder="Enter minutes" min="1" max="1440" style="margin-bottom: 8px;">
                    <button class="button secondary" onclick="setCustomDuration()" style="font-size: 12px; padding: 8px 16px;">
                        Set Custom Duration
                    </button>
                </div>
            </div>

            <div class="section" id="sessionInfo" style="display: none;">
                <h3 class="section-title">
                    📊 Session Info
                </h3>
                <div class="session-details">
                    <div class="session-row">
                        <span class="session-label">Started:</span>
                        <span class="session-value" id="sessionStartTime"></span>
                    </div>
                    <div class="session-row">
                        <span class="session-label">Duration:</span>
                        <span class="session-value" id="sessionDuration"></span>
                    </div>
                    <div class="session-row">
                        <span class="session-label">Time Remaining:</span>
                        <span class="session-value" id="sessionRemaining"></span>
                    </div>
                    <div class="session-row">
                        <span class="session-label">Updates Sent:</span>
                        <span class="session-value" id="sessionUpdates"></span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title">
                    📤 Share Live Location
                </h3>
                <div class="share-options">
                    <p>
                        Share your live location with selected contacts. They'll receive a link to track your location in real-time.
                    </p>
                    <div class="share-checkboxes">
                        <label class="share-checkbox">
                            <input type="checkbox" id="shareViaEmail" checked>
                            📧 Email
                        </label>
                        <label class="share-checkbox">
                            <input type="checkbox" id="shareViaSMS" checked>
                            📱 SMS
                        </label>
                        <label class="share-checkbox">
                            <input type="checkbox" id="shareViaWhatsApp" checked>
                            💬 WhatsApp
                        </label>
                    </div>
                    <button class="button primary" onclick="shareLiveLocationSimple()">
                        🎯 Share Live Location
                    </button>
                    <button class="button secondary" onclick="copyTrackingInfoToClipboard()">
                        📋 Copy Tracking Info
                    </button>
                    <button class="button secondary" onclick="copySMSText()">
                        📱 Copy SMS Text
                    </button>
                </div>
            </div>

            <div class="section">
                <button class="button primary" id="startSharingBtn" onclick="startLocationSharing()">
                    📍 Start Sharing Location
                </button>
                <button class="button danger" id="stopSharingBtn" onclick="stopLocationSharing()" style="display: none;">
                    ✋ Stop Sharing Location
                </button>
            </div>
        </div>
    </div>

    <!-- Location Sharing Overlay -->
    <div class="location-sharing-overlay" id="locationOverlay"></div>

    <!-- Search Panel -->
    <div class="search-container" id="searchPanel" style="display: none;">
        <div class="search-panel">
            <div class="search-header">
                <h3>🔍 Plan Your Journey</h3>
                <button class="close-button" onclick="toggleSearch()">✕</button>
            </div>
            <form class="search-form" onsubmit="handleSearch(event)">
                <button type="button" class="current-location-btn" onclick="getCurrentLocation()">
                    📍 Use Current Location
                </button>
                
                <div class="input-group">
                    <input type="text" id="originInput" class="search-input" placeholder="From (e.g., Downtown, USC, Beverly Hills)" required>
                    <span class="input-icon">📍</span>
                </div>
                
                <div class="input-group">
                    <input type="text" id="destinationInput" class="search-input" placeholder="To (e.g., Santa Monica, LAX, Hollywood)" required>
                    <span class="input-icon">🎯</span>
                </div>
                
                <div class="transport-modes">
                    <button type="button" class="mode-button active" onclick="setMode('metro')">🚇 Rail</button>
                    <button type="button" class="mode-button" onclick="setMode('bus')">🚌 Bus</button>
                    <button type="button" class="mode-button" onclick="setMode('walk')">🚶 Walk</button>
                    <button type="button" class="mode-button" onclick="setMode('bike')">🚲 Bike</button>
                </div>
                
                <button type="submit" class="search-btn">🔍 Find Routes</button>
            </form>
            
            <div class="results-container" id="searchResults" style="display: none;"></div>
        </div>
    </div>

    <!-- AI Chatbot -->
    <div class="chatbot-container">
        <button class="chatbot-toggle" id="chatbotToggle" onclick="toggleChatbot()">
            🤖
        </button>
        <div class="chatbot-window" id="chatbotWindow">
            <div class="chatbot-header">
                <div>
                    <h3>🚇 LA Transit Assistant</h3>
                    <div class="chatbot-status">
                        <div class="status-dot"></div>
                        AI Assistant Online
                    </div>
                </div>
                <button class="chatbot-close" onclick="toggleChatbot()">✕</button>
            </div>
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be added here -->
            </div>
            <div class="chatbot-input">
                <div class="chatbot-input-container">
                    <input type="text" class="chatbot-input-field" id="chatbotInput" placeholder="Ask me about routes, locations, or anything..." onkeypress="handleChatbotKeyPress(event)">
                    <button class="chatbot-send" onclick="sendChatbotMessage()" id="chatbotSend">
                        ➤
                    </button>
                </div>
                <div class="quick-actions" id="quickActions">
                    <button class="quick-action-btn" onclick="quickAction('route')">🗺️ Find Route</button>
                    <button class="quick-action-btn" onclick="quickAction('location')">📍 Current Location</button>
                    <button class="quick-action-btn" onclick="quickAction('metro')">🚇 Rail Info</button>
                    <button class="quick-action-btn" onclick="quickAction('help')">❓ Help</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Location Sharing Variables
        let currentLocation = null;
        let isSharing = false;
        let watchId = null;
        let contacts = []; // Empty contacts list - users will add their own

        // Live Tracking Variables
        let trackingSessionId = null;
        let trackingUrl = null;
        let locationHistory = [];
        let trackingInterval = null;

        // Search functionality variables
        let currentMode = 'metro';
        let currentRoutes = [];
        let isNavigating = false;
        let currentStepIndex = 0;
        let navigationInterval = null;
        let isMoving = false;
        let stepStartTime = null;
        let currentRoute = null;

        // Location data for search
        const locations = {
            'downtown': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'downtown la': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'downtown los angeles': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'usc': { lat: 34.0224, lng: -118.2851, name: 'University of Southern California' },
            'university of southern california': { lat: 34.0224, lng: -118.2851, name: 'University of Southern California' },
            'ucla': { lat: 34.0689, lng: -118.4452, name: 'University of California Los Angeles' },
            'beverly hills': { lat: 34.0736, lng: -118.4001, name: 'Beverly Hills' },
            'hollywood': { lat: 34.0928, lng: -118.3287, name: 'Hollywood' },
            'santa monica': { lat: 34.0195, lng: -118.4912, name: 'Santa Monica' },
            'venice': { lat: 34.0195, lng: -118.4912, name: 'Venice Beach' },
            'lax': { lat: 33.9425, lng: -118.4081, name: 'Los Angeles International Airport' },
            'koreatown': { lat: 34.0579, lng: -118.3009, name: 'Koreatown' },
            'pasadena': { lat: 34.1478, lng: -118.1445, name: 'Pasadena' },
            'long beach': { lat: 33.7701, lng: -118.1937, name: 'Long Beach' }
        };

        // Speed constants (mph)
        const SPEEDS = {
            walk: 3,
            bike: 12,
            metro: 35,
            bus: 25
        };

        // Initialize map and location sharing
        let map;
        let userLocationMarker = null;
        let accuracyCircle = null;

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeLocationSharing();
            renderContacts();
            checkForTrackingSession(); // Check for tracking session on page load
            initializeChatbot(); // Initialize chatbot
        });

        // Map initialization
        function initializeMap() {
            map = L.map('map').setView([34.0522, -118.2437], 11);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Transit system data
            const transitSystem = {
                metro: {
                    red: {
                        name: 'Red Line',
                        color: '#ff0000',
                        stations: [
                            { name: 'North Hollywood', lat: 34.1680, lng: -118.3780 },
                            { name: 'Universal City', lat: 34.1380, lng: -118.3600 },
                            { name: 'Hollywood/Highland', lat: 34.1016, lng: -118.3267 },
                            { name: 'Hollywood/Vine', lat: 34.1016, lng: -118.3267 },
                            { name: 'Hollywood/Western', lat: 34.1016, lng: -118.3267 },
                            { name: 'Vermont/Sunset', lat: 34.1016, lng: -118.3267 },
                            { name: 'Vermont/Santa Monica', lat: 34.1016, lng: -118.3267 },
                            { name: 'Vermont/Beverly', lat: 34.1016, lng: -118.3267 },
                            { name: 'Westlake/MacArthur Park', lat: 34.1016, lng: -118.3267 },
                            { name: 'Pershing Square', lat: 34.1016, lng: -118.3267 },
                            { name: 'Civic Center/Grand Park', lat: 34.1016, lng: -118.3267 },
                            { name: 'Union Station', lat: 34.1016, lng: -118.3267 },
                            { name: 'Chinatown', lat: 34.1016, lng: -118.3267 },
                            { name: 'Lincoln Heights', lat: 34.1016, lng: -118.3267 },
                            { name: 'Heritage Square', lat: 34.1016, lng: -118.3267 },
                            { name: 'Southwest Museum', lat: 34.1016, lng: -118.3267 },
                            { name: 'Highland Park', lat: 34.1016, lng: -118.3267 },
                            { name: 'South Pasadena', lat: 34.1016, lng: -118.3267 },
                            { name: 'Fillmore', lat: 34.1016, lng: -118.3267 },
                            { name: 'Del Mar', lat: 34.1016, lng: -118.3267 },
                            { name: 'Memorial Park', lat: 34.1016, lng: -118.3267 },
                            { name: 'Lake', lat: 34.1016, lng: -118.3267 },
                            { name: 'Allen', lat: 34.1016, lng: -118.3267 },
                            { name: 'Sierra Madre Villa', lat: 34.1016, lng: -118.3267 },
                            { name: 'Arcadia', lat: 34.1016, lng: -118.3267 },
                            { name: 'Monrovia', lat: 34.1016, lng: -118.3267 },
                            { name: 'Duarte/City of Hope', lat: 34.1016, lng: -118.3267 },
                            { name: 'Irwindale', lat: 34.1016, lng: -118.3267 },
                            { name: 'Azusa Downtown', lat: 34.1016, lng: -118.3267 },
                            { name: 'APU/Citrus College', lat: 34.1016, lng: -118.3267 },
                            { name: 'Covina', lat: 34.1016, lng: -118.3267 },
                            { name: 'West Covina', lat: 34.1016, lng: -118.3267 },
                            { name: 'Baldwin Park', lat: 34.1016, lng: -118.3267 },
                            { name: 'El Monte', lat: 34.1016, lng: -118.3267 },
                            { name: 'Cal State LA', lat: 34.1016, lng: -118.3267 },
                            { name: 'Mariachi Plaza', lat: 34.1016, lng: -118.3267 },
                            { name: 'Soto', lat: 34.1016, lng: -118.3267 },
                            { name: 'Indiana', lat: 34.1016, lng: -118.3267 },
                            { name: 'Atlantic', lat: 34.1016, lng: -118.3267 },
                            { name: 'East LA Civic Center', lat: 34.1016, lng: -118.3267 }
                        ]
                    },
                    blue: {
                        name: 'Blue Line',
                        color: '#0066cc',
                        stations: [
                            { name: '7th Street/Metro Center', lat: 34.0486, lng: -118.2588 },
                            { name: 'Pico', lat: 34.0486, lng: -118.2588 },
                            { name: 'Grand/LATTC', lat: 34.0486, lng: -118.2588 },
                            { name: 'San Pedro', lat: 34.0486, lng: -118.2588 },
                            { name: 'Washington', lat: 34.0486, lng: -118.2588 },
                            { name: 'Vernon', lat: 34.0486, lng: -118.2588 },
                            { name: 'Slauson', lat: 34.0486, lng: -118.2588 },
                            { name: 'Florence', lat: 34.0486, lng: -118.2588 },
                            { name: 'Firestone', lat: 34.0486, lng: -118.2588 },
                            { name: '103rd Street', lat: 34.0486, lng: -118.2588 },
                            { name: 'Wardlow', lat: 34.0486, lng: -118.2588 },
                            { name: 'Del Amo', lat: 34.0486, lng: -118.2588 },
                            { name: 'Artesia', lat: 34.0486, lng: -118.2588 },
                            { name: 'Compton', lat: 34.0486, lng: -118.2588 },
                            { name: 'Willowbrook', lat: 34.0486, lng: -118.2588 },
                            { name: 'Long Beach Boulevard', lat: 34.0486, lng: -118.2588 },
                            { name: 'Anaheim Street', lat: 34.0486, lng: -118.2588 },
                            { name: '5th Street', lat: 34.0486, lng: -118.2588 },
                            { name: '1st Street', lat: 34.0486, lng: -118.2588 },
                            { name: 'Pacific Coast Highway', lat: 34.0486, lng: -118.2588 },
                            { name: 'Downtown Long Beach', lat: 34.0486, lng: -118.2588 }
                        ]
                    },
                    green: {
                        name: 'Green Line',
                        color: '#00cc00',
                        stations: [
                            { name: 'Redondo Beach', lat: 33.8492, lng: -118.3884 },
                            { name: 'Douglas', lat: 33.8492, lng: -118.3884 },
                            { name: 'El Segundo', lat: 33.8492, lng: -118.3884 },
                            { name: 'Mariposa', lat: 33.8492, lng: -118.3884 },
                            { name: 'Aviation/LAX', lat: 33.8492, lng: -118.3884 },
                            { name: 'Hawthorne/Lennox', lat: 33.8492, lng: -118.3884 },
                            { name: 'Crenshaw', lat: 33.8492, lng: -118.3884 },
                            { name: 'Vermont/Athens', lat: 33.8492, lng: -118.3884 },
                            { name: 'Harbor Freeway', lat: 33.8492, lng: -118.3884 },
                            { name: 'Avalon', lat: 33.8492, lng: -118.3884 },
                            { name: 'Willowbrook/Rosa Parks', lat: 33.8492, lng: -118.3884 },
                            { name: 'Long Beach Boulevard', lat: 33.8492, lng: -118.3884 },
                            { name: 'Lakewood Boulevard', lat: 33.8492, lng: -118.3884 },
                            { name: 'Norwalk', lat: 33.8492, lng: -118.3884 }
                        ]
                    },
                    purple: {
                        name: 'Purple Line',
                        color: '#660099',
                        stations: [
                            { name: 'Union Station', lat: 34.0556, lng: -118.2340 },
                            { name: 'Civic Center/Grand Park', lat: 34.0556, lng: -118.2340 },
                            { name: 'Pershing Square', lat: 34.0556, lng: -118.2340 },
                            { name: '7th Street/Metro Center', lat: 34.0556, lng: -118.2340 },
                            { name: 'Westlake/MacArthur Park', lat: 34.0556, lng: -118.2340 },
                            { name: 'Wilshire/Vermont', lat: 34.0556, lng: -118.2340 },
                            { name: 'Wilshire/Normandie', lat: 34.0556, lng: -118.2340 },
                            { name: 'Wilshire/Western', lat: 34.0556, lng: -118.2340 }
                        ]
                    },
                    expo: {
                        name: 'Expo Line',
                        color: '#ff6600',
                        stations: [
                            { name: '7th Street/Metro Center', lat: 34.0486, lng: -118.2588 },
                            { name: 'Pico', lat: 34.0486, lng: -118.2588 },
                            { name: 'LATTC/Ortho Institute', lat: 34.0486, lng: -118.2588 },
                            { name: 'Jefferson/USC', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo Park/USC', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/Vermont', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/Western', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/Crenshaw', lat: 34.0486, lng: -118.2588 },
                            { name: 'Farmdale', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/La Brea', lat: 34.0486, lng: -118.2588 },
                            { name: 'La Cienega/Jefferson', lat: 34.0486, lng: -118.2588 },
                            { name: 'Culver City', lat: 34.0486, lng: -118.2588 },
                            { name: 'Palms', lat: 34.0486, lng: -118.2588 },
                            { name: 'Westwood/Rancho Park', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/Sepulveda', lat: 34.0486, lng: -118.2588 },
                            { name: 'Expo/Bundy', lat: 34.0486, lng: -118.2588 },
                            { name: '26th Street/Bergamot', lat: 34.0486, lng: -118.2588 },
                            { name: '17th Street/SMC', lat: 34.0486, lng: -118.2588 },
                            { name: 'Downtown Santa Monica', lat: 34.0486, lng: -118.2588 }
                        ]
                    },
                    gold: {
                        name: 'Gold Line',
                        color: '#ffcc00',
                        stations: [
                            { name: 'APU/Citrus College', lat: 34.1361, lng: -117.8900 },
                            { name: 'Azusa Downtown', lat: 34.1361, lng: -117.8900 },
                            { name: 'Irwindale', lat: 34.1361, lng: -117.8900 },
                            { name: 'Duarte/City of Hope', lat: 34.1361, lng: -117.8900 },
                            { name: 'Monrovia', lat: 34.1361, lng: -117.8900 },
                            { name: 'Arcadia', lat: 34.1361, lng: -117.8900 },
                            { name: 'Sierra Madre Villa', lat: 34.1361, lng: -117.8900 },
                            { name: 'Allen', lat: 34.1361, lng: -117.8900 },
                            { name: 'Lake', lat: 34.1361, lng: -117.8900 },
                            { name: 'Memorial Park', lat: 34.1361, lng: -117.8900 },
                            { name: 'Del Mar', lat: 34.1361, lng: -117.8900 },
                            { name: 'Fillmore', lat: 34.1361, lng: -117.8900 },
                            { name: 'South Pasadena', lat: 34.1361, lng: -117.8900 },
                            { name: 'Highland Park', lat: 34.1361, lng: -117.8900 },
                            { name: 'Southwest Museum', lat: 34.1361, lng: -117.8900 },
                            { name: 'Heritage Square', lat: 34.1361, lng: -117.8900 },
                            { name: 'Lincoln Heights', lat: 34.1361, lng: -117.8900 },
                            { name: 'Chinatown', lat: 34.1361, lng: -117.8900 },
                            { name: 'Union Station', lat: 34.1361, lng: -117.8900 },
                            { name: 'Little Tokyo/Arts District', lat: 34.1361, lng: -117.8900 },
                            { name: 'Pico/Aliso', lat: 34.1361, lng: -117.8900 },
                            { name: 'Mariachi Plaza', lat: 34.1361, lng: -117.8900 },
                            { name: 'Soto', lat: 34.1361, lng: -117.8900 },
                            { name: 'Indiana', lat: 34.1361, lng: -117.8900 },
                            { name: 'Atlantic', lat: 34.1361, lng: -117.8900 },
                            { name: 'East LA Civic Center', lat: 34.1361, lng: -117.8900 }
                        ]
                    }
                }
            };

            // Draw metro routes
            Object.entries(transitSystem.metro).forEach(([lineKey, line]) => {
                const coordinates = line.stations.map(station => [station.lat, station.lng]);
                
                const polyline = L.polyline(coordinates, {
                    color: line.color,
                    weight: 6,
                    opacity: 0.8
                }).addTo(map);

                // Add station markers
                line.stations.forEach(station => {
                    L.circleMarker([station.lat, station.lng], {
                        color: line.color,
                        fillColor: line.color,
                        fillOpacity: 0.8,
                        radius: 6
                    }).addTo(map).bindPopup(`
                        <h3>${station.name}</h3>
                        <p><strong>Line:</strong> ${line.name}</p>
                    `);
                });
            });
        }

        // Location Sharing Functions
        function initializeLocationSharing() {
            // Request location permission on page load
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        updateCurrentLocation(position);
                    },
                    (error) => {
                        console.log('Location permission denied or error:', error);
                    }
                );
            }
        }

        function updateCurrentLocation(position) {
            currentLocation = {
                latitude: position.coords.latitude,
                longitude: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: position.timestamp
            };

            console.log('Location updated:', currentLocation);

            // Get address from coordinates
            getAddressFromCoordinates(currentLocation.latitude, currentLocation.longitude)
                .then(address => {
                    currentLocation.address = address;
                    console.log('Address resolved:', address);
                    updateLocationDisplay();
                    updateUserLocationMarker();
                })
                .catch((error) => {
                    console.warn('Failed to get address, using coordinates:', error);
                    currentLocation.address = `${currentLocation.latitude.toFixed(6)}, ${currentLocation.longitude.toFixed(6)}`;
                    updateLocationDisplay();
                    updateUserLocationMarker();
                });
        }

        function updateLocationDisplay() {
            const locationInfo = document.getElementById('locationInfo');
            const currentLocationText = document.getElementById('currentLocationText');
            const locationTimestamp = document.getElementById('locationTimestamp');

            if (currentLocation) {
                locationInfo.style.display = 'block';
                currentLocationText.textContent = currentLocation.address;
                locationTimestamp.textContent = `Last updated: ${new Date(currentLocation.timestamp).toLocaleTimeString()}`;
            }
        }

        function updateUserLocationMarker() {
            if (!currentLocation) return;

            // Remove existing marker
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            if (accuracyCircle) {
                map.removeLayer(accuracyCircle);
            }

            // Create custom icon for user location
            const userIcon = L.divIcon({
                className: 'user-location-marker',
                html: `
                    <div style="
                        width: 20px;
                        height: 20px;
                        background: #667eea;
                        border: 3px solid white;
                        border-radius: 50%;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <div style="
                            position: absolute;
                            top: 50%;
                            left: 50%;
                            transform: translate(-50%, -50%);
                            width: 8px;
                            height: 8px;
                            background: white;
                            border-radius: 50%;
                        "></div>
                    </div>
                `,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });

            // Add user location marker
            userLocationMarker = L.marker([currentLocation.latitude, currentLocation.longitude], { icon: userIcon })
                .addTo(map)
                .bindPopup(`
                    <div>
                        <h3>Your Location</h3>
                        <p>${currentLocation.address}</p>
                        <p style="font-size: 12px; color: #666;">
                            Accuracy: ${currentLocation.accuracy ? Math.round(currentLocation.accuracy) + 'm' : 'Unknown'}
                        </p>
                        <p style="font-size: 12px; color: #666;">
                            Updated: ${new Date(currentLocation.timestamp).toLocaleTimeString()}
                        </p>
                    </div>
                `);

            // Add accuracy circle
            if (currentLocation.accuracy) {
                accuracyCircle = L.circle([currentLocation.latitude, currentLocation.longitude], {
                    radius: currentLocation.accuracy,
                    color: '#667eea',
                    fillColor: '#667eea',
                    fillOpacity: 0.1,
                    weight: 1
                }).addTo(map);
            }
        }

        async function getAddressFromCoordinates(latitude, longitude) {
            try {
                const response = await fetch(
                    `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`
                );
                
                if (!response.ok) {
                    throw new Error('Geocoding request failed');
                }

                const data = await response.json();
                return data.display_name || `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            } catch (error) {
                console.warn('Failed to get address from coordinates:', error);
                return `${latitude.toFixed(6)}, ${longitude.toFixed(6)}`;
            }
        }

        function toggleLocationShare() {
            const panel = document.getElementById('locationSharePanel');
            const overlay = document.getElementById('locationOverlay');
            const button = document.getElementById('locationShareBtn');

            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                overlay.classList.remove('active');
                button.classList.remove('active');
            } else {
                panel.classList.add('open');
                overlay.classList.add('active');
                if (isSharing) {
                    button.classList.add('active');
                }
            }
        }

        function startLocationSharing() {
            const activeContacts = contacts.filter(contact => contact.isActive);
            if (activeContacts.length === 0) {
                if (contacts.length === 0) {
                    alert('Please add at least one contact first. Click "Add Contact" to add family or friends.');
                } else {
                    alert('Please select at least one contact to share with. Click the circle next to a contact name to select them.');
                }
                return;
            }

            if (!navigator.geolocation) {
                alert('Geolocation is not supported by this browser.');
                return;
            }

            // Initialize session
            sessionStartTime = new Date();
            sessionUpdatesCount = 0;

            // Generate tracking session for live sharing
            generateTrackingSession();

            // Start watching location
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    updateCurrentLocation(position);
                    sessionUpdatesCount++;
                    
                    // Add to tracking history for live sharing
                    if (trackingSessionId) {
                        addLocationToHistory(currentLocation);
                    }
                    
                    if (!isSharing) {
                        isSharing = true;
                        updateSharingStatus();
                    }
                },
                (error) => {
                    alert('Error watching location: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 30000 // 30 seconds
                }
            );

            // Auto-stop after specified duration (if not 0)
            if (currentDuration > 0) {
                setTimeout(() => {
                    if (isSharing) {
                        alert(`Location sharing session has ended after ${currentDuration} minutes.`);
                        stopLocationSharing();
                    }
                }, currentDuration * 60 * 1000);
            }
        }

        function stopLocationSharing() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            isSharing = false;
            sessionStartTime = null;
            sessionUpdatesCount = 0;
            updateSharingStatus();
            
            // Hide session info
            document.getElementById('sessionInfo').style.display = 'none';
        }

        function updateSharingStatus() {
            const statusCard = document.getElementById('statusCard');
            const statusText = document.getElementById('statusText');
            const statusIndicator = document.getElementById('statusIndicator');
            const statusDot = document.getElementById('statusDot');
            const startBtn = document.getElementById('startSharingBtn');
            const stopBtn = document.getElementById('stopSharingBtn');
            const shareBtn = document.getElementById('locationShareBtn');
            const durationStatus = document.getElementById('durationStatus');

            if (isSharing) {
                statusCard.classList.add('sharing');
                statusText.textContent = 'Sharing location with selected contacts';
                statusIndicator.classList.add('sharing');
                statusIndicator.textContent = 'Active';
                statusDot.classList.add('sharing');
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                shareBtn.classList.add('active');
                durationStatus.textContent = '● Sharing';
                durationStatus.style.color = '#4caf50';
            } else {
                statusCard.classList.remove('sharing');
                statusText.textContent = 'Location sharing is inactive';
                statusIndicator.classList.remove('sharing');
                statusIndicator.textContent = 'Inactive';
                statusDot.classList.remove('sharing');
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                shareBtn.classList.remove('active');
                durationStatus.textContent = '● Active';
                durationStatus.style.color = '#666';
            }
        }

        function renderContacts() {
            const contactsList = document.getElementById('contactsList');
            contactsList.innerHTML = '';

            if (contacts.length === 0) {
                // Show helpful message when no contacts
                const emptyMessage = document.createElement('div');
                emptyMessage.className = 'contact-item';
                emptyMessage.style.textAlign = 'center';
                emptyMessage.style.padding = '20px';
                emptyMessage.style.color = '#666';
                emptyMessage.innerHTML = `
                    <div style="margin-bottom: 8px;">👥 No contacts added yet</div>
                    <div style="font-size: 12px;">Click "Add Contact" below to add family or friends</div>
                `;
                contactsList.appendChild(emptyMessage);
                return;
            }

            contacts.forEach(contact => {
                const contactItem = document.createElement('div');
                contactItem.className = 'contact-item';
                contactItem.innerHTML = `
                    <div class="contact-info">
                        <div class="contact-name">${contact.name}</div>
                        <div class="contact-details">
                            ${contact.phone ? contact.phone + ' ' : ''}
                            ${contact.email ? '• ' + contact.email : ''}
                        </div>
                    </div>
                    <div class="contact-actions">
                        <button class="action-button" onclick="toggleContact('${contact.id}')">
                            ${contact.isActive ? '✓' : '○'}
                        </button>
                    </div>
                `;
                contactsList.appendChild(contactItem);
            });
        }

        function toggleContact(contactId) {
            contacts = contacts.map(contact =>
                contact.id === contactId
                    ? { ...contact, isActive: !contact.isActive }
                    : contact
            );
            renderContacts();
        }

        function showAddContactForm() {
            document.getElementById('addContactForm').style.display = 'block';
            document.getElementById('addContactBtn').style.display = 'none';
        }

        function hideAddContactForm() {
            document.getElementById('addContactForm').style.display = 'none';
            document.getElementById('addContactBtn').style.display = 'block';
            // Clear form
            document.getElementById('contactName').value = '';
            document.getElementById('contactPhone').value = '';
            document.getElementById('contactEmail').value = '';
        }

        function addContact() {
            const name = document.getElementById('contactName').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const email = document.getElementById('contactEmail').value.trim();

            if (name) {
                const newContact = {
                    id: Date.now().toString(),
                    name: name,
                    phone: phone || undefined,
                    email: email || undefined,
                    isActive: true
                };
                contacts.push(newContact);
                renderContacts();
                hideAddContactForm();
            }
        }

        function refreshLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        updateCurrentLocation(position);
                    },
                    (error) => {
                        alert('Error refreshing location: ' + error.message);
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        // Placeholder function for existing search functionality
        function toggleSearch() {
            const searchPanel = document.getElementById('searchPanel');
            if (searchPanel.style.display === 'none' || !searchPanel.style.display) {
                searchPanel.style.display = 'flex';
            } else {
                searchPanel.style.display = 'none';
            }
        }

        // Set transportation mode
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.mode-button[onclick="setMode('${mode}')"]`).classList.add('active');
        }

        // Get current location for search
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            
                            const address = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                name: 'Current Location',
                                address: address
                            };
                            
                            document.getElementById('originInput').value = 'Current Location';
                            alert(`✅ Current location set: ${address}`);
                            
                        } catch (error) {
                            console.error('Error getting address:', error);
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                name: 'Current Location',
                                address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`
                            };
                            document.getElementById('originInput').value = 'Current Location';
                            alert('✅ Current location set (coordinates only)');
                        }
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        alert('❌ Could not get your location. Please enter address manually.');
                    }
                );
            } else {
                alert('❌ GPS not supported. Please enter address manually.');
            }
        }

        // Handle search form submission
        async function handleSearch(event) {
            event.preventDefault();
            
            const origin = document.getElementById('originInput').value.trim();
            const destination = document.getElementById('destinationInput').value.trim();
            
            if (!origin || !destination) {
                alert('Please enter both origin and destination.');
                return;
            }
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">🔍 Finding routes...</div>';
            resultsContainer.style.display = 'block';
            
            try {
                const route = await planRoute(origin, destination, currentMode);
                currentRoutes = [route];
                displaySearchResults(currentRoutes);
            } catch (error) {
                console.error('Route planning error:', error);
                resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">❌ Error finding route. Please try again.</div>';
            }
        }

        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            const R = 3959; // Earth's radius in miles
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLng = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get coordinates for a location
        async function getCoordinates(location) {
            // Check if it's a known location
            const knownLocation = locations[location.toLowerCase()];
            if (knownLocation) {
                return { lat: knownLocation.lat, lng: knownLocation.lng };
            }
            
            // Check if it's current location
            if (location.toLowerCase() === 'current location' && currentLocation) {
                return { lat: currentLocation.lat, lng: currentLocation.lng };
            }
            
            // Try to geocode the location with LA area bias
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Los Angeles, CA')}&limit=1&viewbox=-118.6682,34.0522,-118.1553,34.3373&bounded=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                }
                
                // If not found in LA, try broader search
                const broadResponse = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location)}&limit=1`);
                const broadData = await broadResponse.json();
                
                if (broadData.length > 0) {
                    return { lat: parseFloat(broadData[0].lat), lng: parseFloat(broadData[0].lon) };
                }
            } catch (error) {
                console.error('Geocoding error:', error);
            }
            
            return null;
        }

        // Enhanced route planning with multiple options
        async function planRoute(origin, destination, mode) {
            // Get coordinates for origin and destination
            const originCoords = await getCoordinates(origin);
            const destCoords = await getCoordinates(destination);
            
            if (!originCoords || !destCoords) {
                throw new Error('Could not find coordinates for one or both locations');
            }
            
            // Calculate direct distance first
            const directDistance = calculateDistance(originCoords, destCoords);
            
            // Always respect user's mode selection - don't auto-switch
            // Use proper routing API for realistic routes
            const route = await getRealisticRoute(originCoords, destCoords, mode);
            
            // If transit route has too much walking, suggest alternatives
            if (mode === 'metro' && route.totalWalkingDistance > 1.5) {
                const alternatives = await getRouteAlternatives(originCoords, destCoords);
                route.alternatives = alternatives;
            }
            
            return route;
        }

        // Get alternative routes when walking distance is too high
        async function getRouteAlternatives(origin, destination) {
            const alternatives = [];
            
            // Try different transit combinations
            const transitOptions = [
                { mode: 'bus', name: 'Bus Route' },
                { mode: 'walk', name: 'Walking Route' },
                { mode: 'bike', name: 'Bike Route' }
            ];
            
            for (const option of transitOptions) {
                try {
                    const route = await getRealisticRoute(origin, destination, option.mode);
                    if (route && route.totalWalkingDistance <= 1.5) {
                        alternatives.push({
                            ...route,
                            name: option.name,
                            reason: `Less walking (${route.totalWalkingDistance.toFixed(1)} miles)`
                        });
                    }
                } catch (error) {
                    console.error(`Alternative route error for ${option.mode}:`, error);
                }
            }
            
            return alternatives.slice(0, 3); // Return top 3 alternatives
        }

        // Get realistic route using OpenStreetMap routing
        async function getRealisticRoute(origin, destination, mode) {
            // For metro/bus, always create transit route with walking segments
            if (mode === 'metro' || mode === 'bus') {
                return await getTransitRoute(origin, destination, mode);
            }
            
            try {
                // Use OSRM (Open Source Routing Machine) for realistic routing
                const profile = mode === 'walk' ? 'foot' : mode === 'bike' ? 'bike' : 'driving';
                const url = `https://router.project-osrm.org/route/v1/${profile}/${origin.lng},${origin.lat};${destination.lng},${destination.lat}?overview=full&steps=true&annotations=true`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const route = data.routes[0];
                    const steps = parseOSRMSteps(route.legs[0].steps, mode);
                    
                    return {
                        type: 'route',
                        mode: mode,
                        origin: await getLocationName(origin),
                        destination: await getLocationName(destination),
                        totalDistance: route.distance / 1609.34, // Convert meters to miles
                        totalTime: Math.round(route.duration / 60), // Convert seconds to minutes
                        steps: steps,
                        coordinates: route.geometry.coordinates,
                        totalWalkingDistance: mode === 'walk' ? route.distance / 1609.34 : 0
                    };
                }
            } catch (error) {
                console.error('OSRM routing error:', error);
            }
            
            // Fallback to simple calculation
            return getSimpleRoute(origin, destination, mode);
        }

        // Get transit route with minimal walking
        async function getTransitRoute(origin, destination, mode) {
            // Find nearest transit stations
            const originStations = await findNearbyStations(origin, mode);
            const destStations = await findNearbyStations(destination, mode);
            
            if (originStations.length === 0 || destStations.length === 0) {
                // If no stations found, create a simple transit route with walking
                return createSimpleTransitRoute(origin, destination, mode);
            }
            
            // Find the best combination with minimal walking
            let bestRoute = null;
            let minTotalWalking = Infinity;
            
            for (const originStation of originStations.slice(0, 3)) { // Check top 3 nearest
                for (const destStation of destStations.slice(0, 3)) {
                    const route = await calculateTransitRoute(origin, destination, originStation, destStation, mode);
                    if (route && route.totalWalkingDistance < minTotalWalking) {
                        bestRoute = route;
                        minTotalWalking = route.totalWalkingDistance;
                    }
                }
            }
            
            if (!bestRoute) {
                // If no good transit route found, create a simple one
                return createSimpleTransitRoute(origin, destination, mode);
            }
            
            return bestRoute;
        }

        // Create a simple transit route when no stations are nearby
        function createSimpleTransitRoute(origin, destination, mode) {
            const totalDistance = calculateDistance(origin, destination);
            const totalTime = Math.round(totalDistance / SPEEDS[mode] * 60);
            
            // Create a route with walking segments to simulate transit
            const walkDistance = totalDistance * 0.1; // 10% walking to/from
            const transitDistance = totalDistance * 0.8; // 80% transit
            const walkTime = Math.round(walkDistance / SPEEDS.walk * 60);
            const transitTime = Math.round(transitDistance / SPEEDS[mode] * 60);
            
            return {
                type: 'route',
                mode: mode,
                origin: `${origin.lat.toFixed(4)}, ${origin.lng.toFixed(4)}`,
                destination: `${destination.lat.toFixed(4)}, ${destination.lng.toFixed(4)}`,
                totalDistance: totalDistance,
                totalTime: totalTime,
                totalWalkingDistance: walkDistance * 2, // Walking to and from
                steps: [
                    {
                        type: 'walk',
                        from: `${origin.lat.toFixed(4)}, ${origin.lng.toFixed(4)}`,
                        to: `${mode === 'metro' ? 'Metro' : 'Bus'} Station`,
                        instruction: `Walk to ${mode === 'metro' ? 'metro' : 'bus'} station`,
                        distance: walkDistance,
                        time: walkTime
                    },
                    {
                        type: mode,
                        from: `${mode === 'metro' ? 'Metro' : 'Bus'} Station`,
                        to: `${mode === 'metro' ? 'Metro' : 'Bus'} Station`,
                        instruction: `Take ${mode === 'metro' ? 'metro' : 'bus'} to destination`,
                        distance: transitDistance,
                        time: transitTime
                    },
                    {
                        type: 'walk',
                        from: `${mode === 'metro' ? 'Metro' : 'Bus'} Station`,
                        to: `${destination.lat.toFixed(4)}, ${destination.lng.toFixed(4)}`,
                        instruction: `Walk from ${mode === 'metro' ? 'metro' : 'bus'} station to destination`,
                        distance: walkDistance,
                        time: walkTime
                    }
                ]
            };
        }

        // Find nearby transit stations
        async function findNearbyStations(location, mode) {
            const stations = [];
            
            // Get LA Metro stations data
            const metroStations = getMetroStations();
            
            for (const station of metroStations) {
                const distance = calculateDistance(location, station);
                if (distance <= 2) { // Within 2 miles
                    stations.push({
                        ...station,
                        distance: distance,
                        walkingTime: Math.round(distance / SPEEDS.walk * 60)
                    });
                }
            }
            
            // Sort by distance and return closest stations
            return stations.sort((a, b) => a.distance - b.distance);
        }

        // Get LA Metro stations data
        function getMetroStations() {
            return [
                // Red Line Stations
                { name: 'North Hollywood', lat: 34.1680, lng: -118.3780, line: 'red' },
                { name: 'Universal City', lat: 34.1380, lng: -118.3600, line: 'red' },
                { name: 'Hollywood/Highland', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Hollywood/Vine', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Hollywood/Western', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Vermont/Sunset', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Vermont/Santa Monica', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Vermont/Beverly', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Westlake/MacArthur Park', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Pershing Square', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Civic Center/Grand Park', lat: 34.1016, lng: -118.3267, line: 'red' },
                { name: 'Union Station', lat: 34.1016, lng: -118.3267, line: 'red' },
                
                // Blue Line Stations
                { name: '7th Street/Metro Center', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Pico', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Grand/LATTC', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'San Pedro', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Washington', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Vernon', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Slauson', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Florence', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Firestone', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: '103rd Street', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Wardlow', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Del Amo', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Artesia', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Compton', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Willowbrook', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Long Beach Boulevard', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Anaheim Street', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: '5th Street', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: '1st Street', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Pacific Coast Highway', lat: 34.0486, lng: -118.2588, line: 'blue' },
                { name: 'Downtown Long Beach', lat: 34.0486, lng: -118.2588, line: 'blue' },
                
                // Expo Line Stations
                { name: '7th Street/Metro Center', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Pico', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'LATTC/Ortho Institute', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Jefferson/USC', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo Park/USC', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/Vermont', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/Western', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/Crenshaw', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Farmdale', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/La Brea', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'La Cienega/Jefferson', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Culver City', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Palms', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Westwood/Rancho Park', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/Sepulveda', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Expo/Bundy', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: '26th Street/Bergamot', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: '17th Street/SMC', lat: 34.0486, lng: -118.2588, line: 'expo' },
                { name: 'Downtown Santa Monica', lat: 34.0486, lng: -118.2588, line: 'expo' },
                
                // Purple Line Stations
                { name: 'Union Station', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Civic Center/Grand Park', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Pershing Square', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: '7th Street/Metro Center', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Westlake/MacArthur Park', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Wilshire/Vermont', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Wilshire/Normandie', lat: 34.0556, lng: -118.2340, line: 'purple' },
                { name: 'Wilshire/Western', lat: 34.0556, lng: -118.2340, line: 'purple' },
                
                // Gold Line Stations
                { name: 'APU/Citrus College', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Azusa Downtown', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Irwindale', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Duarte/City of Hope', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Monrovia', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Arcadia', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Sierra Madre Villa', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Allen', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Lake', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Memorial Park', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Del Mar', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Fillmore', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'South Pasadena', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Highland Park', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Southwest Museum', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Heritage Square', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Lincoln Heights', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Chinatown', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Union Station', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Little Tokyo/Arts District', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Pico/Aliso', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Mariachi Plaza', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Soto', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Indiana', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'Atlantic', lat: 34.1361, lng: -117.8900, line: 'gold' },
                { name: 'East LA Civic Center', lat: 34.1361, lng: -117.8900, line: 'gold' }
            ];
        }

        // Calculate transit route with walking segments
        async function calculateTransitRoute(origin, destination, originStation, destStation, mode) {
            try {
                // Calculate walking to origin station
                const walkToStation = await getWalkingRoute(origin, originStation);
                
                // Calculate transit between stations
                const transitRoute = await getTransitBetweenStations(originStation, destStation, mode);
                
                // Calculate walking from destination station
                const walkFromStation = await getWalkingRoute(destStation, destination);
                
                if (!walkToStation || !transitRoute || !walkFromStation) {
                    return null;
                }
                
                const totalWalkingDistance = walkToStation.distance + walkFromStation.distance;
                
                // Only accept routes with reasonable walking distances
                if (totalWalkingDistance > 1.5) { // Max 1.5 miles total walking
                    return null;
                }
                
                const steps = [
                    {
                        type: 'walk',
                        from: await getLocationName(origin),
                        to: originStation.name,
                        instruction: `Walk to ${originStation.name} ${mode === 'metro' ? 'metro' : 'bus'} station`,
                        distance: walkToStation.distance,
                        time: walkToStation.time,
                        coordinates: walkToStation.coordinates
                    },
                    {
                        type: mode,
                        from: originStation.name,
                        to: destStation.name,
                        instruction: `Take ${mode === 'metro' ? 'metro' : 'bus'} from ${originStation.name} to ${destStation.name}`,
                        distance: transitRoute.distance,
                        time: transitRoute.time,
                        line: originStation.line
                    },
                    {
                        type: 'walk',
                        from: destStation.name,
                        to: await getLocationName(destination),
                        instruction: `Walk from ${destStation.name} ${mode === 'metro' ? 'metro' : 'bus'} station to destination`,
                        distance: walkFromStation.distance,
                        time: walkFromStation.time,
                        coordinates: walkFromStation.coordinates
                    }
                ];
                
                return {
                    type: 'route',
                    mode: mode,
                    origin: await getLocationName(origin),
                    destination: await getLocationName(destination),
                    totalDistance: walkToStation.distance + transitRoute.distance + walkFromStation.distance,
                    totalTime: walkToStation.time + transitRoute.time + walkFromStation.time,
                    totalWalkingDistance: totalWalkingDistance,
                    steps: steps
                };
            } catch (error) {
                console.error('Transit route calculation error:', error);
                return null;
            }
        }

        // Get walking route using OSRM
        async function getWalkingRoute(origin, destination) {
            try {
                const url = `https://router.project-osrm.org/route/v1/foot/${origin.lng},${origin.lat};${destination.lng},${destination.lat}?overview=full&steps=true`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const route = data.routes[0];
                    return {
                        distance: route.distance / 1609.34, // Convert to miles
                        time: Math.round(route.duration / 60), // Convert to minutes
                        coordinates: route.geometry.coordinates
                    };
                }
            } catch (error) {
                console.error('Walking route error:', error);
            }
            return null;
        }

        // Get transit route between stations
        async function getTransitBetweenStations(originStation, destStation, mode) {
            // Calculate direct distance between stations
            const distance = calculateDistance(originStation, destStation);
            const time = Math.round(distance / SPEEDS[mode] * 60);
            
            return {
                distance: distance,
                time: time
            };
        }

        // Parse OSRM steps for detailed routing
        function parseOSRMSteps(osrmSteps, mode) {
            if (!osrmSteps || osrmSteps.length === 0) {
                // Return a simple step if no OSRM data
                return [{
                    type: mode,
                    from: 'Origin',
                    to: 'Destination',
                    instruction: `Travel from origin to destination by ${mode}`,
                    distance: 0,
                    time: 0
                }];
            }
            
            return osrmSteps.map((step, index) => {
                const distance = step.distance / 1609.34; // Convert to miles
                const time = Math.round(step.duration / 60); // Convert to minutes
                
                let instruction = '';
                
                // Generate meaningful instructions based on step type and index
                if (index === 0) {
                    instruction = `Start your ${mode === 'walk' ? 'walk' : mode === 'bike' ? 'bike ride' : 'journey'}`;
                } else if (step.maneuver && step.maneuver.instruction) {
                    // Use OSRM instruction if available
                    instruction = step.maneuver.instruction.replace(/<[^>]*>/g, ''); // Remove HTML tags
                } else {
                    // Generate more specific fallback instructions
                    instruction = generateSpecificInstruction(step, mode, index, distance);
                }
                
                // Clean up instruction text
                instruction = instruction.replace(/^Continue /, '').replace(/^Head /, '');
                
                // Enhance instructions to be more specific
                if (instruction.includes('along the route')) {
                    // Replace generic "along the route" with more specific instructions
                    if (step.distance < 0.1) {
                        instruction = `Continue ${step.type === 'walk' ? 'walking' : 
                                       step.type === 'bike' ? 'biking' : 
                                       step.type === 'metro' ? 'on metro' : 
                                       step.type === 'bus' ? 'on bus' : 'traveling'} briefly`;
                    } else if (step.distance >= 0.1 && step.distance < 0.5) {
                        instruction = `${step.type === 'walk' ? 'Walk' : 
                                      step.type === 'bike' ? 'Bike' : 
                                      step.type === 'metro' ? 'Travel on metro' : 
                                      step.type === 'bus' ? 'Travel on bus' : 'Continue'} ${step.distance.toFixed(1)} miles`;
                    } else {
                        instruction = `${step.type === 'walk' ? 'Walk' : 
                                      step.type === 'bike' ? 'Bike' : 
                                      step.type === 'metro' ? 'Travel on metro' : 
                                      step.type === 'bus' ? 'Travel on bus' : 'Continue'} ${step.distance.toFixed(1)} miles to next point`;
                    }
                }
                
                // Add context for very short segments
                if (step.distance < 0.1 && step.time === 0) {
                    if (instruction.includes('briefly')) {
                        instruction = instruction.replace('briefly', 'for a short distance');
                    }
                }
                
                return {
                    type: mode,
                    from: step.maneuver && step.maneuver.location ? 
                        `${step.maneuver.location[1].toFixed(4)}, ${step.maneuver.location[0].toFixed(4)}` : 
                        'Route point',
                    to: step.maneuver && step.maneuver.location ? 
                        `${step.maneuver.location[1].toFixed(4)}, ${step.maneuver.location[0].toFixed(4)}` : 
                        'Route point',
                    instruction: instruction,
                    distance: distance,
                    time: time
                };
            });
        }

        // Generate specific instructions based on context
        function generateSpecificInstruction(step, mode, index, distance) {
            // For very short segments, provide context-aware instructions
            if (distance < 0.1) {
                if (mode === 'walk') {
                    return 'Continue walking';
                } else if (mode === 'bike') {
                    return 'Continue biking';
                } else if (mode === 'metro') {
                    return 'Stay on metro';
                } else if (mode === 'bus') {
                    return 'Stay on bus';
                }
            }
            
            // For longer segments, provide more descriptive instructions
            if (distance >= 0.1 && distance < 0.5) {
                if (mode === 'walk') {
                    return `Walk ${distance.toFixed(1)} miles`;
                } else if (mode === 'bike') {
                    return `Bike ${distance.toFixed(1)} miles`;
                } else if (mode === 'metro') {
                    return `Travel ${distance.toFixed(1)} miles on metro`;
                } else if (mode === 'bus') {
                    return `Travel ${distance.toFixed(1)} miles on bus`;
                }
            }
            
            // For longer segments, provide even more specific instructions
            if (distance >= 0.5) {
                if (mode === 'walk') {
                    return `Walk ${distance.toFixed(1)} miles to next point`;
                } else if (mode === 'bike') {
                    return `Bike ${distance.toFixed(1)} miles to next point`;
                } else if (mode === 'metro') {
                    return `Travel ${distance.toFixed(1)} miles on metro line`;
                } else if (mode === 'bus') {
                    return `Travel ${distance.toFixed(1)} miles on bus route`;
                }
            }
            
            // Default fallback
            const action = mode === 'walk' ? 'Walk' : mode === 'bike' ? 'Bike' : 'Continue';
            return `${action} along the route`;
        }

        // Get location name from coordinates
        async function getLocationName(coordinates) {
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${coordinates.lat}&lon=${coordinates.lng}&zoom=18`);
                const data = await response.json();
                return data.display_name || `${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}`;
            } catch (error) {
                return `${coordinates.lat.toFixed(4)}, ${coordinates.lng.toFixed(4)}`;
            }
        }

        // Fallback simple route calculation
        function getSimpleRoute(origin, destination, mode) {
            const distance = calculateDistance(origin, destination);
            const time = Math.round(distance / SPEEDS[mode] * 60);
            
            return {
                type: 'route',
                mode: mode,
                origin: `${origin.lat.toFixed(4)}, ${origin.lng.toFixed(4)}`,
                destination: `${destination.lat.toFixed(4)}, ${destination.lng.toFixed(4)}`,
                totalDistance: distance,
                totalTime: time,
                totalWalkingDistance: mode === 'walk' ? distance : 0,
                steps: [{
                    type: mode,
                    from: `${origin.lat.toFixed(4)}, ${origin.lng.toFixed(4)}`,
                    to: `${destination.lat.toFixed(4)}, ${destination.lng.toFixed(4)}`,
                    instruction: `${mode === 'walk' ? 'Walk' : mode === 'bike' ? 'Bike' : 'Travel'} from origin to destination`,
                    distance: distance,
                    time: time
                }]
            };
        }

        // Enhanced display with alternatives
        function displaySearchResults(routes) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!routes || routes.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results">No routes found. Please try different locations or modes.</div>';
                return;
            }
            
            const html = routes.map((route, index) => {
                if (route.type === 'error') {
                    return `
                        <div class="route-result" style="background-color: #f8d7da; border: 1px solid #f5c6cb;">
                            <div class="route-header-result">
                                <span style="color: #721c24;">❌ ${route.message}</span>
                            </div>
                        </div>
                    `;
                } else if (route.type === 'route') {
                    const modeIcon = getModeIcon(route.mode);
                    const modeName = getModeName(route.mode);
                    const walkingWarning = route.totalWalkingDistance > 1.5 ? 
                        `<div style="background: #fff3cd; border: 1px solid #ffeaa7; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 12px; color: #856404;">
                            ⚠️ High walking distance: ${route.totalWalkingDistance.toFixed(1)} miles total
                        </div>` : '';
                    
                    // Add info for short metro routes
                    const shortMetroInfo = route.mode === 'metro' && route.totalDistance < 2 ? 
                        `<div style="background: #e3f2fd; border: 1px solid #2196f3; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 12px; color: #1976d2;">
                            💡 Short distance detected: Consider walking (${route.totalDistance.toFixed(1)} miles) or biking for this route. Rail shown as requested.
                        </div>` : '';
                    
                    // Simplify route steps for better display
                    const simplifiedSteps = simplifyRouteSteps(route.steps, route.mode);
                    
                    return `
                        <div class="route-result">
                            <div class="route-header-result">
                                <span style="font-size: 1.2rem;">${modeIcon}</span>
                                <h3 class="route-name">${modeName} Route</h3>
                            </div>
                            ${walkingWarning}
                            ${shortMetroInfo}
                            <div class="route-details">
                                <span>🕒 ${route.totalTime} min</span>
                                <span>📍 ${route.totalDistance.toFixed(1)} miles</span>
                                ${route.mode === 'metro' || route.mode === 'bus' ? `<span>🚶 ${(route.totalDistance * 0.2).toFixed(1)} mi walking (to/from stations)</span>` : ''}
                            </div>
                            <div class="journey-steps">
                                ${simplifiedSteps.map((step, stepIndex) => `
                                    <div class="journey-step" style="padding: 12px; border-bottom: 1px solid #f0f0f0;">
                                        <div style="display: flex; align-items: flex-start; gap: 12px;">
                                            <span style="font-size: 1.2rem;">${getModeIcon(step.type)}</span>
                                            <div style="flex: 1;">
                                                <div style="font-weight: 600; margin-bottom: 4px; color: #333;">${step.instruction}</div>
                                                <div style="font-size: 12px; color: #666; margin-bottom: 4px;">
                                                    ${step.distance.toFixed(1)} mi • ${step.time} min
                                                </div>
                                                ${step.landmarks ? `
                                                    <div style="font-size: 11px; color: #888; background: #f8f9fa; padding: 6px; border-radius: 4px; margin-top: 4px;">
                                                        <strong>📍 Landmarks:</strong> ${step.landmarks.join(' • ')}
                                                    </div>
                                                ` : ''}
                                                ${step.visualCues ? `
                                                    <div style="font-size: 11px; color: #888; margin-top: 2px;">
                                                        <strong>👁️ Look for:</strong> ${step.visualCues.join(' • ')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            ${route.alternatives && route.alternatives.length > 0 ? `
                                <div style="margin-top: 12px; padding: 12px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #17a2b8;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 14px; color: #17a2b8;">💡 Better Alternatives:</h4>
                                    ${route.alternatives.map(alt => `
                                        <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <div>
                                                    <strong>${alt.name}</strong>
                                                    <div style="font-size: 12px; color: #666;">${alt.reason}</div>
                                                </div>
                                                <div style="text-align: right; font-size: 12px;">
                                                    <div>${alt.totalTime} min</div>
                                                    <div>${alt.totalWalkingDistance.toFixed(1)} mi walking</div>
                                                </div>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            <button class="button primary" onclick="startNavigation(${index})" style="width: 100%; margin-top: 1rem; padding: 12px; font-size: 16px;">
                                🚀 Start Real-Time Navigation
                            </button>
                        </div>
                    `;
                }
                return '';
            }).join('');
            
            resultsContainer.innerHTML = html;
        }

        // Simplify route steps for better display
        function simplifyRouteSteps(steps, mode) {
            if (mode === 'walk' || mode === 'bike') {
                // For walking/biking, keep it simple
                return steps.map((step, index) => ({
                    type: step.type,
                    instruction: step.instruction,
                    distance: step.distance,
                    time: step.time,
                    landmarks: getStepLandmarks(step, index),
                    visualCues: getStepVisualCues(step, index)
                }));
            }
            
            // For metro/bus, always create 3-step structure
            const simplifiedSteps = [];
            const totalDistance = steps.reduce((sum, s) => sum + s.distance, 0);
            const totalTime = steps.reduce((sum, s) => sum + s.time, 0);
            
            // Step 1: Walk to station (always include)
            const walkToDistance = totalDistance * 0.1; // Assume 10% walking to station
            const walkToTime = Math.round(walkToDistance / SPEEDS.walk * 60);
            simplifiedSteps.push({
                type: 'walk',
                instruction: `Walk to ${mode === 'metro' ? 'metro' : 'bus'} station`,
                distance: walkToDistance,
                time: walkToTime,
                landmarks: getStationApproachLandmarks(mode),
                visualCues: getStationApproachVisualCues(mode)
            });
            
            // Step 2: Take transit (combine all transit segments)
            const transitSteps = steps.filter(s => s.type === mode);
            const totalTransitDistance = transitSteps.length > 0 ? 
                transitSteps.reduce((sum, s) => sum + s.distance, 0) : 
                totalDistance * 0.8; // Assume 80% transit if no transit steps found
            const totalTransitTime = transitSteps.length > 0 ? 
                transitSteps.reduce((sum, s) => sum + s.time, 0) : 
                Math.round(totalTransitDistance / SPEEDS[mode] * 60);
            
            simplifiedSteps.push({
                type: mode,
                instruction: `Take ${mode === 'metro' ? 'metro' : 'bus'} to destination`,
                distance: totalTransitDistance,
                time: totalTransitTime,
                landmarks: getTransitLandmarks(mode),
                visualCues: getTransitVisualCues(mode)
            });
            
            // Step 3: Walk from station (always include)
            const walkFromDistance = totalDistance * 0.1; // Assume 10% walking from station
            const walkFromTime = Math.round(walkFromDistance / SPEEDS.walk * 60);
            simplifiedSteps.push({
                type: 'walk',
                instruction: `Walk from ${mode === 'metro' ? 'metro' : 'bus'} station to destination`,
                distance: walkFromDistance,
                time: walkFromTime,
                landmarks: getStationExitLandmarks(mode),
                visualCues: getStationExitVisualCues(mode)
            });
            
            return simplifiedSteps;
        }

        // Get landmarks for approaching station
        function getStationApproachLandmarks(mode) {
            if (mode === 'metro') {
                return ['🚇 Look for metro station entrance', '🎫 Have TAP card ready', '📱 Check train arrival times'];
            } else {
                return ['🚌 Look for bus stop sign', '📋 Check route number', '⏰ Verify bus schedule'];
            }
        }

        // Get visual cues for approaching station
        function getStationApproachVisualCues(mode) {
            if (mode === 'metro') {
                return ['🚇 Station entrance signs', '🎫 TAP card reader', '🚪 Platform doors'];
            } else {
                return ['🚌 Bus stop sign', '📱 Real-time arrival info', '💳 Fare payment system'];
            }
        }

        // Get landmarks for transit journey
        function getTransitLandmarks(mode) {
            if (mode === 'metro') {
                return ['🚇 Check station name on platform', '🎨 Verify line color', '📱 Monitor train progress'];
            } else {
                return ['🚌 Confirm bus route number', '📱 Check next stop', '⏰ Monitor travel time'];
            }
        }

        // Get visual cues for transit journey
        function getTransitVisualCues(mode) {
            if (mode === 'metro') {
                return ['🚇 Platform signage', '🎨 Line color indicators', '🚪 Door opening signals'];
            } else {
                return ['🚌 Route number display', '📱 Stop announcements', '🚪 Bus door signals'];
            }
        }

        // Get landmarks for exiting station
        function getStationExitLandmarks(mode) {
            if (mode === 'metro') {
                return ['🚪 Exit through station doors', '🗺️ Check street signs', '📍 Confirm destination'];
            } else {
                return ['🚌 Exit bus at correct stop', '🗺️ Check street signs', '📍 Confirm destination'];
            }
        }

        // Get visual cues for exiting station
        function getStationExitVisualCues(mode) {
            if (mode === 'metro') {
                return ['🚪 Exit signs', '🗺️ Street name signs', '📍 GPS confirmation'];
            } else {
                return ['🚌 Stop request button', '🗺️ Street name signs', '📍 GPS confirmation'];
            }
        }

        // Duration and Session Management
        let currentDuration = 60; // Default to 60 minutes
        let sessionStartTime = null;
        let sessionUpdatesCount = 0;

        function setDuration(minutes) {
            currentDuration = minutes;
            document.querySelectorAll('.duration-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.dataset.duration) === currentDuration) {
                    btn.classList.add('active');
                }
            });
            document.getElementById('customDuration').value = ''; // Clear custom input
            document.getElementById('sessionInfo').style.display = 'none'; // Hide session info
            document.getElementById('durationValue').textContent = `${currentDuration} minutes`;
            document.getElementById('durationStatus').textContent = `● Active`;
        }

        function setCustomDuration() {
            const customMinutes = parseInt(document.getElementById('customDuration').value);
            if (!isNaN(customMinutes) && customMinutes > 0) {
                currentDuration = customMinutes;
                document.querySelectorAll('.duration-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.getElementById('sessionInfo').style.display = 'none'; // Hide session info
                document.getElementById('durationValue').textContent = `${currentDuration} minutes`;
                document.getElementById('durationStatus').textContent = `● Active`;
            } else {
                alert('Please enter a valid positive number of minutes for custom duration.');
            }
        }

        function updateSessionInfo() {
            const sessionInfoDiv = document.getElementById('sessionInfo');
            const sessionStartTimeSpan = document.getElementById('sessionStartTime');
            const sessionDurationSpan = document.getElementById('sessionDuration');
            const sessionRemainingSpan = document.getElementById('sessionRemaining');
            const sessionUpdatesSpan = document.getElementById('sessionUpdates');

            if (sessionStartTime) {
                sessionInfoDiv.style.display = 'block';
                sessionStartTimeSpan.textContent = new Date(sessionStartTime).toLocaleTimeString();
                sessionDurationSpan.textContent = `${currentDuration} min`;
                
                const now = new Date();
                const durationMs = currentDuration * 60 * 1000;
                const remainingMs = durationMs - (now - sessionStartTime);

                if (remainingMs <= 0) {
                    sessionRemainingSpan.textContent = '0 min';
                    sessionUpdatesSpan.textContent = sessionUpdatesCount;
                    stopLocationSharing(); // Auto-stop if duration is 0
                } else {
                    const minutes = Math.floor(remainingMs / 60000);
                    const seconds = Math.floor((remainingMs % 60000) / 1000);
                    sessionRemainingSpan.textContent = `${minutes} min ${seconds} sec`;
                    sessionUpdatesSpan.textContent = sessionUpdatesCount;
                }
            }
        }

        // Update session info every second
        setInterval(updateSessionInfo, 1000);

        // Close location sharing panel when clicking overlay
        document.getElementById('locationOverlay').addEventListener('click', function() {
            toggleLocationShare();
        });

        // Live Tracking Functions
        function generateTrackingSession() {
            trackingSessionId = 'track_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            trackingUrl = `${window.location.origin}${window.location.pathname}?track=${trackingSessionId}`;
            locationHistory = [];
            return trackingSessionId;
        }

        function addLocationToHistory(location) {
            const locationEntry = {
                timestamp: Date.now(),
                latitude: location.latitude,
                longitude: location.longitude,
                accuracy: location.accuracy,
                address: location.address
            };
            
            locationHistory.push(locationEntry);
            
            // Keep only last 100 locations to prevent memory issues
            if (locationHistory.length > 100) {
                locationHistory.shift();
            }
            
            // Store in localStorage for persistence
            localStorage.setItem(`tracking_${trackingSessionId}`, JSON.stringify(locationHistory));
        }

        function getLocationHistory(sessionId) {
            const stored = localStorage.getItem(`tracking_${sessionId}`);
            return stored ? JSON.parse(stored) : [];
        }

        function shareLiveLocationSimple() {
            if (!currentLocation) {
                alert('No current location available. Please wait for location to load.');
                return;
            }

            const activeContacts = contacts.filter(contact => contact.isActive);
            if (activeContacts.length === 0) {
                if (contacts.length === 0) {
                    alert('Please add at least one contact first. Click "Add Contact" to add family or friends.');
                } else {
                    alert('Please select at least one contact to share with. Click the circle next to a contact name to select them.');
                }
                return;
            }

            // Check which sharing methods are selected
            const shareEmail = document.getElementById('shareViaEmail').checked;
            const shareSMS = document.getElementById('shareViaSMS').checked;
            const shareWhatsApp = document.getElementById('shareViaWhatsApp').checked;

            if (!shareEmail && !shareSMS && !shareWhatsApp) {
                alert('Please select at least one sharing method (Email, SMS, or WhatsApp).');
                return;
            }

            // Generate tracking session
            const sessionId = generateTrackingSession();
            addLocationToHistory(currentLocation);

            const emails = activeContacts.filter(contact => contact.email).map(contact => contact.email);
            const phones = activeContacts.filter(contact => contact.phone).map(contact => contact.phone);
            
            const subject = 'Live Location Share';
            const body = `I'm sharing my live location with you!\n\n` +
                        `📍 Click here to track my location in real-time:\n${trackingUrl}\n\n` +
                        `⏰ Duration: ${currentDuration > 0 ? `${currentDuration} minutes` : 'Until I stop sharing'}\n` +
                        `🔄 Updates every 30 seconds\n\n` +
                        `Current location: ${currentLocation.address}\n` +
                        `Started: ${new Date().toLocaleString()}`;

            let sharingMethods = [];
            let openedWindows = 0;

            // Share via Email - Try multiple methods
            if (shareEmail && emails.length > 0) {
                // First try Gmail directly (most reliable)
                const gmailUrl = `https://mail.google.com/mail/?view=cm&fs=1&to=${emails.join(',')}&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                window.open(gmailUrl, '_blank');
                sharingMethods.push('Gmail');
                openedWindows++;
                
                // Also try regular mailto as backup
                setTimeout(() => {
                    const mailtoUrl = `mailto:${emails.join(',')}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
                    window.open(mailtoUrl, '_blank');
                }, 500);
            }

            // Share via SMS - Try multiple methods
            if (shareSMS && phones.length > 0) {
                // Try web-based SMS services that work on desktop
                const smsBody = `Live location tracking: ${trackingUrl}`;
                
                // Try Google Messages for Web (if available)
                const googleMessagesUrl = `https://messages.google.com/web/conversations/new?number=${phones[0].replace(/\D/g, '')}&text=${encodeURIComponent(smsBody)}`;
                window.open(googleMessagesUrl, '_blank');
                
                // Also try regular SMS as backup
                setTimeout(() => {
                    const smsUrl = `sms:${phones.join(',')}?body=${encodeURIComponent(smsBody)}`;
                    window.open(smsUrl, '_blank');
                }, 500);
                
                sharingMethods.push('SMS');
                openedWindows++;
            }

            // Share via WhatsApp - Try multiple methods
            if (shareWhatsApp && phones.length > 0) {
                // Try WhatsApp Web (most reliable for mobile messaging)
                const whatsappBody = `Live location tracking: ${trackingUrl}`;
                const whatsappUrl = `https://wa.me/${phones[0].replace(/\D/g, '')}?text=${encodeURIComponent(whatsappBody)}`;
                window.open(whatsappUrl, '_blank');
                sharingMethods.push('WhatsApp');
                openedWindows++;
            }

            // Show tracking info
            showTrackingInfo();
            
            // Show comprehensive success message with manual options
            setTimeout(() => {
                const methodsText = sharingMethods.join(' and ');
                const manualEmailText = emails.length > 0 ? 
                    `\n📧 Manual Email:\nTo: ${emails.join(', ')}\nSubject: ${subject}\nBody: ${body}` : '';
                const manualSMSText = phones.length > 0 ? 
                    `\n📱 Manual SMS/WhatsApp:\nTo: ${phones.join(', ')}\nMessage: Live location tracking: ${trackingUrl}` : '';
                
                alert(`✅ Live location shared successfully!\n\n` +
                      `📤 Sent via: ${methodsText}\n` +
                      `👥 Recipients: ${activeContacts.length} contact(s)\n\n` +
                      `🔗 Tracking URL:\n${trackingUrl}\n\n` +
                      `📝 If email/SMS/WhatsApp didn't open automatically, copy this info manually:${manualEmailText}${manualSMSText}\n\n` +
                      `💡 Tips:\n` +
                      `• If Gmail opened, just click "Send" to share the tracking link\n` +
                      `• If WhatsApp opened, click "Send" to share the tracking link\n` +
                      `• For SMS: Use "Copy SMS Text" button, then paste in your phone's SMS app\n` +
                      `• For SMS on desktop: Try Google Messages for Web or your carrier's web SMS\n` +
                      `• Use "Copy Tracking Info" button for complete sharing template`);
            }, 1000);
        }

        function showTrackingInfo() {
            const trackingInfo = `
                <div class="tracking-info" style="background: #e8f5e8; padding: 16px; border-radius: 8px; margin: 16px 0; border: 2px solid #4caf50;">
                    <h4 style="margin: 0 0 12px 0; color: #2e7d32;">🎯 Live Tracking Active</h4>
                    <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>Tracking URL:</strong></p>
                    <div style="background: white; padding: 8px; border-radius: 4px; border: 1px solid #ddd; margin-bottom: 12px; word-break: break-all; font-family: monospace; font-size: 12px;">
                        ${trackingUrl}
                    </div>
                    <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>Session ID:</strong> ${trackingSessionId}</p>
                    <p style="margin: 0 0 8px 0; font-size: 14px;"><strong>Duration:</strong> ${currentDuration > 0 ? `${currentDuration} minutes` : 'Until stopped'}</p>
                    <p style="margin: 0 0 12px 0; font-size: 14px;"><strong>Updates:</strong> Every 30 seconds</p>
                    <button class="button secondary" onclick="copyTrackingUrl()" style="font-size: 12px; padding: 6px 12px; margin-right: 8px;">
                        📋 Copy URL
                    </button>
                    <button class="button secondary" onclick="shareTrackingUrl()" style="font-size: 12px; padding: 6px 12px;">
                        📤 Share Again
                    </button>
                </div>
            `;
            
            // Insert tracking info after the session info section
            const sessionInfoSection = document.getElementById('sessionInfo');
            if (sessionInfoSection) {
                sessionInfoSection.insertAdjacentHTML('afterend', trackingInfo);
            }
        }

        function copyTrackingUrl() {
            navigator.clipboard.writeText(trackingUrl).then(() => {
                alert('Tracking URL copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = trackingUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Tracking URL copied to clipboard!');
            });
        }

        function shareTrackingUrl() {
            shareLiveLocationSimple();
        }

        function copyTrackingInfoToClipboard() {
            if (!trackingUrl) {
                alert('No tracking session active. Please start sharing location first.');
                return;
            }

            const activeContacts = contacts.filter(contact => contact.isActive);
            const emails = activeContacts.filter(contact => contact.email).map(contact => contact.email);
            const phones = activeContacts.filter(contact => contact.phone).map(contact => contact.phone);
            
            const trackingInfo = `🎯 LIVE LOCATION TRACKING

📍 Tracking URL:
${trackingUrl}

📧 Email Recipients: ${emails.length > 0 ? emails.join(', ') : 'None'}
📱 SMS Recipients: ${phones.length > 0 ? phones.join(', ') : 'None'}

⏰ Duration: ${currentDuration > 0 ? `${currentDuration} minutes` : 'Until stopped'}
🔄 Updates: Every 30 seconds
📍 Current Location: ${currentLocation ? currentLocation.address : 'Loading...'}
🕐 Started: ${sessionStartTime ? new Date(sessionStartTime).toLocaleString() : 'Not started'}
📊 Updates Sent: ${sessionUpdatesCount}

📝 EMAIL TEMPLATE:
To: ${emails.join(', ')}
Subject: Live Location Share
Body: I'm sharing my live location with you!

📍 Click here to track my location in real-time:
${trackingUrl}

⏰ Duration: ${currentDuration > 0 ? `${currentDuration} minutes` : 'Until I stop sharing'}
🔄 Updates every 30 seconds

Current location: ${currentLocation ? currentLocation.address : 'Loading...'}
Started: ${new Date().toLocaleString()}

📱 SMS TEMPLATE:
Live location tracking: ${trackingUrl}`;

            try {
                navigator.clipboard.writeText(trackingInfo).then(() => {
                    alert('✅ Tracking information copied to clipboard!\n\nYou can now paste this into any email or messaging app.');
                }).catch(() => {
                    // Fallback for older browsers
                    const textArea = document.createElement('textarea');
                    textArea.value = trackingInfo;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    alert('✅ Tracking information copied to clipboard!\n\nYou can now paste this into any email or messaging app.');
                });
            } catch (error) {
                alert('Could not copy to clipboard. Please manually copy the tracking URL:\n\n' + trackingUrl);
            }
        }

        function copySMSText() {
            if (!trackingUrl) {
                alert('No tracking session active. Please start sharing location first.');
                return;
            }

            const smsBody = `Live location tracking: ${trackingUrl}`;
            navigator.clipboard.writeText(smsBody).then(() => {
                alert('SMS text copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = smsBody;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('SMS text copied to clipboard!');
            });
        }

        // Check if this is a tracking session
        function checkForTrackingSession() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackId = urlParams.get('track');
            
            if (trackId) {
                // This is a tracking session - show tracking interface
                showTrackingInterface(trackId);
            }
        }

        function showTrackingInterface(trackId) {
            // Hide the main app interface
            document.querySelector('.header').style.display = 'none';
            document.querySelector('.location-share-panel').style.display = 'none';
            
            // Create tracking interface
            const trackingInterface = `
                <div class="tracking-interface" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 3000; display: flex; flex-direction: column;">
                    <div class="tracking-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h2 style="margin: 0; font-size: 20px;">📍 Live Location Tracking</h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9;">Session: ${trackId}</p>
                        </div>
                        <button onclick="closeTrackingInterface()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">×</button>
                    </div>
                    
                    <div class="tracking-map" style="flex: 1; position: relative;">
                        <div id="trackingMap" style="height: 100%; width: 100%;"></div>
                    </div>
                    
                    <div class="tracking-info-panel" style="background: white; padding: 20px; border-top: 1px solid #e0e0e0; max-height: 200px; overflow-y: auto;">
                        <h3 style="margin: 0 0 12px 0;">📊 Tracking Information</h3>
                        <div id="trackingDetails">
                            <p>Loading location data...</p>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', trackingInterface);
            
            // Initialize tracking map
            initializeTrackingMap(trackId);
        }

        function initializeTrackingMap(trackId) {
            const trackingMap = L.map('trackingMap').setView([34.0522, -118.2437], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(trackingMap);

            // Load location history
            const history = getLocationHistory(trackId);
            
            if (history.length > 0) {
                // Create path from location history
                const pathCoordinates = history.map(loc => [loc.latitude, loc.longitude]);
                const path = L.polyline(pathCoordinates, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.7
                }).addTo(trackingMap);

                // Add markers for start and current location
                const startLocation = history[0];
                const currentLocation = history[history.length - 1];

                // Start marker
                L.marker([startLocation.latitude, startLocation.longitude], {
                    icon: L.divIcon({
                        className: 'start-marker',
                        html: '<div style="background: #4caf50; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">S</div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(trackingMap).bindPopup('Start Location');

                // Current location marker
                const currentMarker = L.marker([currentLocation.latitude, currentLocation.longitude], {
                    icon: L.divIcon({
                        className: 'current-marker',
                        html: '<div style="background: #ff5722; color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold;">C</div>',
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(trackingMap).bindPopup(`
                    <div>
                        <h3>Current Location</h3>
                        <p>${currentLocation.address}</p>
                        <p style="font-size: 12px; color: #666;">
                            Last updated: ${new Date(currentLocation.timestamp).toLocaleString()}
                        </p>
                    </div>
                `);

                // Fit map to show the entire path
                trackingMap.fitBounds(path.getBounds(), { padding: [20, 20] });

                // Update tracking details
                updateTrackingDetails(history);
            }

            // Set up periodic updates
            setInterval(() => {
                const updatedHistory = getLocationHistory(trackId);
                if (updatedHistory.length > 0) {
                    updateTrackingDetails(updatedHistory);
                }
            }, 5000); // Update every 5 seconds
        }

        function updateTrackingDetails(history) {
            const detailsDiv = document.getElementById('trackingDetails');
            if (!detailsDiv) return;

            const currentLocation = history[history.length - 1];
            const startTime = new Date(history[0].timestamp);
            const currentTime = new Date(currentLocation.timestamp);
            const duration = Math.floor((currentTime - startTime) / 1000 / 60); // minutes

            detailsDiv.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <strong>Current Location:</strong><br>
                        <span style="font-size: 14px; color: #666;">${currentLocation.address}</span>
                    </div>
                    <div>
                        <strong>Last Updated:</strong><br>
                        <span style="font-size: 14px; color: #666;">${currentTime.toLocaleTimeString()}</span>
                    </div>
                    <div>
                        <strong>Started:</strong><br>
                        <span style="font-size: 14px; color: #666;">${startTime.toLocaleTimeString()}</span>
                    </div>
                    <div>
                        <strong>Duration:</strong><br>
                        <span style="font-size: 14px; color: #666;">${duration} minutes</span>
                    </div>
                    <div>
                        <strong>Updates:</strong><br>
                        <span style="font-size: 14px; color: #666;">${history.length} locations</span>
                    </div>
                    <div>
                        <strong>Accuracy:</strong><br>
                        <span style="font-size: 14px; color: #666;">${Math.round(currentLocation.accuracy)}m</span>
                    </div>
                </div>
            `;
        }

        function closeTrackingInterface() {
            const trackingInterface = document.querySelector('.tracking-interface');
            if (trackingInterface) {
                trackingInterface.remove();
            }
            
            // Show main app interface
            document.querySelector('.header').style.display = 'flex';
            document.querySelector('.location-share-panel').style.display = 'flex';
        }

        // Get mode name
        function getModeName(mode) {
            const names = {
                walk: 'Walk',
                bike: 'Bike',
                metro: 'Rail',
                bus: 'Bus'
            };
            return names[mode] || 'Transit';
        }

        // Start navigation
        function startNavigation(routeIndex) {
            const route = currentRoutes[routeIndex];
            if (!route || route.type !== 'route') {
                alert('Invalid route selected');
                return;
            }
            
            isNavigating = true;
            showNavigationView(route);
        }

        // Show navigation view
        function showNavigationView(route) {
            currentRoute = route;
            currentStepIndex = 0;
            stepStartTime = Date.now();
            isNavigating = true;
            
            // Create navigation overlay
            const overlay = document.createElement('div');
            overlay.className = 'navigation-overlay';
            overlay.id = 'navigationOverlay';
            
            overlay.innerHTML = `
                <div class="nav-header">
                    <div>
                        <h3>🚗 Live Navigation</h3>
                        <p>${route.steps[0].from} → ${route.steps[route.steps.length - 1].to}</p>
                        <div style="font-size: 0.8rem; opacity: 0.8; margin-top: 0.25rem;">
                            📍 ${route.totalDistance.toFixed(1)} miles • 🕒 ${route.totalTime} min • ${getModeName(route.mode)}
                        </div>
                    </div>
                    <button class="exit-btn" onclick="exitNavigation()">✕ Exit</button>
                </div>
                <div class="nav-content">
                    <div class="nav-map-container" id="navMapContainer"></div>
                    <div class="directions-panel">
                        <div class="current-step" id="currentStep">
                            <div class="step-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                                </div>
                                <div class="step-counter">Step <span id="stepNumber">1</span> of ${route.steps.length}</div>
                            </div>
                            <div class="current-instruction" id="currentInstruction">
                                <h4>🚀 Starting Navigation...</h4>
                                <p>Preparing your route...</p>
                            </div>
                            <div class="live-info" id="liveInfo">
                                <div class="movement-status" id="movementStatus">
                                    <span style="color: #666;">📍 Getting location...</span>
                                </div>
                            </div>
                        </div>
                        <div class="directions-list" id="directionsList">
                            <h5>📋 Complete Journey</h5>
                            ${route.steps.map((step, index) => `
                                <div class="step-item ${index === 0 ? 'active' : ''}" id="step-${index}">
                                    <div class="step-icon" style="background-color: ${getStepColor(step.type)};">
                                        ${getModeIcon(step.type)}
                                    </div>
                                    <div class="step-content">
                                        <div class="step-instruction">${step.instruction}</div>
                                        <div class="step-details">
                                            ${step.distance.toFixed(2)} miles • ${step.time} min
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        <div class="nav-controls">
                            <button onclick="previousStep()" id="prevBtn" class="nav-btn" disabled>⬅️ Previous</button>
                            <button onclick="nextStep()" id="nextBtn" class="nav-btn">Next ➡️</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Initialize navigation map and start live tracking
            setTimeout(() => {
                initNavigationMap(route);
                startLiveNavigation();
                updateNavigationDisplay();
            }, 100);
            
            // Close search panel
            toggleSearch();
        }

        // Initialize navigation map
        function initNavigationMap(route) {
            const navMap = L.map('navMapContainer').setView([34.0522, -118.2437], 12);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(navMap);
            
            // Add route markers
            route.steps.forEach((step, index) => {
                const coords = getStepCoordinates(step);
                if (coords) {
                    L.marker([coords.lat, coords.lng])
                        .addTo(navMap)
                        .bindPopup(`
                            <div>
                                <h4>Step ${index + 1}</h4>
                                <p>${step.instruction}</p>
                                <p><strong>Distance:</strong> ${step.distance.toFixed(2)} miles</p>
                                <p><strong>Time:</strong> ${step.time} minutes</p>
                            </div>
                        `);
                }
            });
            
            window.navMap = navMap;
        }

        // Get coordinates for a step
        function getStepCoordinates(step) {
            // Try to get coordinates from known locations
            const fromLocation = locations[step.from.toLowerCase()];
            if (fromLocation) {
                return { lat: fromLocation.lat, lng: fromLocation.lng };
            }
            
            // For current location
            if (step.from.toLowerCase() === 'current location' && currentLocation) {
                return { lat: currentLocation.lat, lng: currentLocation.lng };
            }
            
            // Default to LA center if not found
            return { lat: 34.0522, lng: -118.2437 };
        }

        // Get step color
        function getStepColor(type) {
            const colors = {
                walk: '#666',
                bike: '#28a745',
                metro: '#ee0000',
                bus: '#ff6b35'
            };
            return colors[type] || '#666';
        }

        // Start live navigation tracking
        function startLiveNavigation() {
            if (navigator.geolocation) {
                watchId = navigator.geolocation.watchPosition(
                    (position) => {
                        updateNavigationPosition(position);
                    },
                    (error) => {
                        console.error('Navigation tracking error:', error);
                        document.getElementById('movementStatus').innerHTML = 
                            '<span style="color: #dc3545;">❌ Location tracking error</span>';
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 30000
                    }
                );
            }
            
            // Update navigation display every 2 seconds
            navigationInterval = setInterval(() => {
                updateNavigationDisplay();
            }, 2000);
        }

        // Update navigation position
        function updateNavigationPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            // Update movement status
            const movementStatus = document.getElementById('movementStatus');
            movementStatus.innerHTML = `
                <span style="color: #065f46;">✅ Location updated</span><br>
                <span style="font-size: 0.8rem; color: #666;">
                    Accuracy: ${Math.round(accuracy)}m • ${new Date().toLocaleTimeString()}
                </span>
            `;
            
            // Update navigation map with current position
            if (window.navMap) {
                // Remove existing user marker
                if (window.currentLocationMarker) {
                    window.navMap.removeLayer(window.currentLocationMarker);
                }
                
                // Add new user marker
                window.currentLocationMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'user-location-marker',
                        html: `
                            <div style="
                                width: 20px;
                                height: 20px;
                                background: #3b82f6;
                                border: 3px solid white;
                                border-radius: 50%;
                                box-shadow: 0 2px 6px rgba(0,0,0,0.3);
                                position: relative;
                            ">
                                <div style="
                                    position: absolute;
                                    top: 50%;
                                    left: 50%;
                                    transform: translate(-50%, -50%);
                                    width: 8px;
                                    height: 8px;
                                    background: white;
                                    border-radius: 50%;
                                "></div>
                            </div>
                        `,
                        iconSize: [20, 20],
                        iconAnchor: [10, 10]
                    })
                }).addTo(window.navMap);
                
                // Center map on user location
                window.navMap.setView([lat, lng], 15);
            }
        }

        // Update navigation display
        function updateNavigationDisplay() {
            if (!currentRoute || !isNavigating) return;
            
            const currentStep = currentRoute.steps[currentStepIndex];
            if (!currentStep) return;
            
            // Update progress bar
            const progress = ((currentStepIndex + 1) / currentRoute.steps.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            
            // Update step counter
            document.getElementById('stepNumber').textContent = currentStepIndex + 1;
            
            // Update current instruction
            const currentInstruction = document.getElementById('currentInstruction');
            currentInstruction.innerHTML = `
                <h4>${getModeIcon(currentStep.type)} ${currentStep.instruction}</h4>
                <p>Distance: ${currentStep.distance.toFixed(2)} miles • Time: ${currentStep.time} min</p>
            `;
            
            // Update step items
            currentRoute.steps.forEach((step, index) => {
                const stepElement = document.getElementById(`step-${index}`);
                if (stepElement) {
                    stepElement.className = 'step-item';
                    if (index < currentStepIndex) {
                        stepElement.classList.add('completed');
                    } else if (index === currentStepIndex) {
                        stepElement.classList.add('active');
                    }
                }
            });
            
            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            prevBtn.disabled = currentStepIndex === 0;
            nextBtn.disabled = currentStepIndex === currentRoute.steps.length - 1;
            
            // Check if journey is complete
            if (currentStepIndex === currentRoute.steps.length - 1) {
                const movementStatus = document.getElementById('movementStatus');
                movementStatus.innerHTML = `
                    <span style="color: #10b981;">🎉 Journey Complete!</span><br>
                    <span style="font-size: 0.8rem; color: #666;">
                        You have reached your destination
                    </span>
                `;
            }
        }

        // Navigate to previous step
        function previousStep() {
            if (currentStepIndex > 0) {
                currentStepIndex--;
                updateNavigationDisplay();
            }
        }

        // Navigate to next step
        function nextStep() {
            if (currentStepIndex < currentRoute.steps.length - 1) {
                currentStepIndex++;
                updateNavigationDisplay();
            }
        }

        // Exit navigation
        function exitNavigation() {
            console.log('🛑 Exiting navigation...');
            
            // Stop all navigation tracking
            isNavigating = false;
            currentRoute = null;
            currentStepIndex = 0;
            
            // Clear GPS tracking
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            // Clear intervals
            if (navigationInterval) {
                clearInterval(navigationInterval);
                navigationInterval = null;
            }
            
            // Remove navigation overlay
            const overlay = document.getElementById('navigationOverlay');
            if (overlay) {
                overlay.remove();
            }
            
            // Clean up navigation map
            if (window.navMap) {
                window.navMap.remove();
                window.navMap = null;
            }
            
            if (window.currentLocationMarker) {
                window.currentLocationMarker = null;
            }
            
            console.log('✅ Navigation cleaned up successfully');
        }

        // Chatbot functionality
        let chatbotOpen = false;
        let conversationHistory = [];

        function initializeChatbot() {
            // Add welcome message
            setTimeout(() => {
                addBotMessage(`👋 Hi! I'm your LA Transit AI Assistant. I can help you with:

🗺️ **Route Planning** - Find the best way to get anywhere in LA
📍 **Location Services** - Get your current location and nearby places
🚇 **Rail Info**: "Tell me about the Red Line" or "Rail hours"
❓ **General Help** - Ask me anything about transportation

Try asking: "How do I get from Downtown to Santa Monica?" or click the quick action buttons below!`);
            }, 1000);
        }

        function toggleChatbot() {
            const chatbotWindow = document.getElementById('chatbotWindow');
            const chatbotToggle = document.getElementById('chatbotToggle');
            
            chatbotOpen = !chatbotOpen;
            
            if (chatbotOpen) {
                chatbotWindow.classList.add('open');
                chatbotToggle.classList.add('active');
                chatbotToggle.innerHTML = '✕';
                document.getElementById('chatbotInput').focus();
            } else {
                chatbotWindow.classList.remove('open');
                chatbotToggle.classList.remove('active');
                chatbotToggle.innerHTML = '🤖';
            }
        }

        function handleChatbotKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        function sendChatbotMessage() {
            const input = document.getElementById('chatbotInput');
            const message = input.value.trim();
            
            if (message) {
                addUserMessage(message);
                input.value = '';
                processUserMessage(message);
            }
        }

        function addUserMessage(message) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">👤</div>
                <div class="message-content">${message}</div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            conversationHistory.push({ role: 'user', content: message });
        }

        function addBotMessage(message, isTyping = false) {
            const messagesContainer = document.getElementById('chatbotMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            if (isTyping) {
                messageDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content typing">Typing...</div>
                `;
            } else {
                messageDiv.innerHTML = `
                    <div class="message-avatar">🤖</div>
                    <div class="message-content">${message}</div>
                `;
            }
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            if (!isTyping) {
                conversationHistory.push({ role: 'assistant', content: message });
            }
        }

        function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Show typing indicator
            addBotMessage('', true);
            
            // Simulate AI processing time
            setTimeout(() => {
                // Remove typing indicator
                const messagesContainer = document.getElementById('chatbotMessages');
                const typingMessage = messagesContainer.lastElementChild;
                if (typingMessage && typingMessage.querySelector('.typing')) {
                    messagesContainer.removeChild(typingMessage);
                }
                
                // Process the message
                const response = generateAIResponse(lowerMessage, message);
                addBotMessage(response);
            }, 1000 + Math.random() * 2000); // Random delay for realistic feel
        }

        function generateAIResponse(lowerMessage, originalMessage) {
            // Route planning queries
            if (lowerMessage.includes('route') || lowerMessage.includes('how do i get') || lowerMessage.includes('from') && lowerMessage.includes('to')) {
                return handleRouteQuery(originalMessage);
            }
            
            // Location queries
            if (lowerMessage.includes('location') || lowerMessage.includes('where am i') || lowerMessage.includes('current location')) {
                return handleLocationQuery();
            }
            
            // Rail information
            if (lowerMessage.includes('metro') || lowerMessage.includes('train') || lowerMessage.includes('subway')) {
                return handleMetroQuery(lowerMessage);
            }
            
            // Greeting
            if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                return `👋 Hello! How can I help you with your LA transit needs today?`;
            }
            
            // Help
            if (lowerMessage.includes('help') || lowerMessage.includes('what can you do')) {
                return `🤖 I'm your LA Transit AI Assistant! Here's what I can help you with:

🗺️ **Route Planning**: "How do I get from Downtown to Santa Monica?"
📍 **Location Services**: "Where am I?" or "What's near me?"
🚇 **Rail Info**: "Tell me about the Red Line" or "Rail hours"
⏰ **Schedule Info**: "When does the last train run?"
🎫 **Fare Info**: "How much does a rail ticket cost?"

Just ask me anything about getting around LA!`;
            }
            
            // Fare information
            if (lowerMessage.includes('fare') || lowerMessage.includes('cost') || lowerMessage.includes('price') || lowerMessage.includes('ticket')) {
                return `💰 **LA Rail Fares:**

🎫 **Single Ride**: $1.75
📅 **Day Pass**: $7.00
📅 **7-Day Pass**: $25.00
📅 **30-Day Pass**: $100.00

💡 **Tips:**
• TAP card required for all rides
• Transfers are free within 2 hours
• Reduced fares available for seniors, students, and disabled riders
• Purchase at rail stations, online, or retail locations`;
            }
            
            // Schedule information
            if (lowerMessage.includes('schedule') || lowerMessage.includes('time') || lowerMessage.includes('hours') || lowerMessage.includes('when')) {
                return `⏰ **LA Rail Operating Hours:**

🚇 **Rail**: 4:00 AM - 1:00 AM (Daily)
🚌 **Bus**: 4:00 AM - 2:00 AM (Daily)
🚇 **Night Service**: Limited bus service 2:00 AM - 4:00 AM

💡 **Frequency:**
• Peak hours: Every 6-10 minutes
• Off-peak: Every 10-15 minutes
• Late night: Every 20-30 minutes

📱 **Real-time updates** available on the LA Rail app!`;
            }
            
            // Default response
            return `🤖 I understand you're asking about "${originalMessage}". Let me help you with that!

For route planning, try: "How do I get from [origin] to [destination]?"
For location help: "Where am I?" or "What's near me?"
For rail info: "Tell me about the rail" or "Rail hours"

Or use the quick action buttons below for common tasks!`;
        }

        function handleRouteQuery(message) {
            // Extract origin and destination using AI-like pattern matching
            const routePattern = /(?:from|get from|go from)\s+([^to]+?)\s+(?:to|to go to|to get to)\s+(.+)/i;
            const match = message.match(routePattern);
            
            if (match) {
                const origin = match[1].trim();
                const destination = match[2].trim();
                
                // Auto-fill search form and open search panel
                setTimeout(() => {
                    document.getElementById('originInput').value = origin;
                    document.getElementById('destinationInput').value = destination;
                    toggleSearch();
                    
                    // Auto-search after a short delay
                    setTimeout(() => {
                        const searchEvent = new Event('submit');
                        handleSearch(searchEvent);
                    }, 500);
                }, 500);
                
                return `🗺️ **Route Planning**: I'll help you find the best route from **${origin}** to **${destination}**!

Opening the route planner for you... 🚀

💡 **Pro tip**: You can also specify your preferred mode of transport like "by rail" or "walking" for more specific results!`;
            } else {
                return `🗺️ **Route Planning**: I'd be happy to help you plan a route!

Please tell me where you want to go, for example:
• "How do I get from Downtown to Santa Monica?"
• "Route from USC to Hollywood"
• "From Beverly Hills to LAX"

Or you can use the "🗺️ Find Route" button below to open the route planner!`;
            }
        }

        function handleLocationQuery() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        
                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                            const data = await response.json();
                            const address = data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                            
                            addBotMessage(`📍 **Your Current Location:**

🏠 **Address**: ${address}
🌍 **Coordinates**: ${lat.toFixed(6)}, ${lng.toFixed(6)}
🎯 **Accuracy**: ${Math.round(position.coords.accuracy)} meters

💡 **Nearby Transit Options:**
• Rail stations within walking distance
• Bus stops in the area
• Bike share locations

Would you like me to help you plan a route from here?`);
                        } catch (error) {
                            addBotMessage(`📍 **Your Current Location:**

🌍 **Coordinates**: ${lat.toFixed(6)}, ${lng.toFixed(6)}
🎯 **Accuracy**: ${Math.round(position.coords.accuracy)} meters

💡 **Note**: I couldn't get the full address, but I can still help you plan routes from these coordinates!`);
                        }
                    },
                    (error) => {
                        addBotMessage(`❌ **Location Error**: I couldn't get your current location.

🔧 **Troubleshooting:**
• Make sure location services are enabled
• Allow location access when prompted
• Try refreshing the page

💡 **Alternative**: You can manually enter your location in the route planner!`);
                    }
                );
                
                return `📍 **Getting your location...** Please wait while I find where you are!`;
            } else {
                return `❌ **Location Not Supported**: Your browser doesn't support location services.

💡 **Alternative**: You can manually enter your location in the route planner!`;
            }
        }

        function handleMetroQuery(message) {
            if (message.includes('red line') || message.includes('red')) {
                return `🚇 **Red Line Information:**

📍 **Route**: North Hollywood ↔ Union Station
⏰ **Operating Hours**: 4:00 AM - 1:00 AM
🕒 **Frequency**: Every 6-10 minutes (peak), 10-15 minutes (off-peak)
💰 **Fare**: $1.75 (TAP card required)

🏛️ **Major Stations:**
• North Hollywood
• Universal City
• Hollywood/Highland
• Hollywood/Vine
• Pershing Square
• Union Station

💡 **Connections**: Connects to Blue, Purple, and Gold lines at Union Station`;
            } else if (message.includes('blue line') || message.includes('blue')) {
                return `🚇 **Blue Line Information:**

📍 **Route**: Downtown LA ↔ Long Beach
⏰ **Operating Hours**: 4:00 AM - 1:00 AM
🕒 **Frequency**: Every 6-10 minutes (peak), 10-15 minutes (off-peak)
💰 **Fare**: $1.75 (TAP card required)

🏛️ **Major Stations:**
• 7th Street/Metro Center
• Pico
• San Pedro
• Long Beach Boulevard
• Downtown Long Beach

💡 **Connections**: Connects to Red, Purple, and Expo lines at 7th Street/Metro Center`;
            } else if (message.includes('expo line') || message.includes('expo')) {
                return `🚇 **Expo Line Information:**

📍 **Route**: Downtown LA ↔ Santa Monica
⏰ **Operating Hours**: 4:00 AM - 1:00 AM
🕒 **Frequency**: Every 6-10 minutes (peak), 10-15 minutes (off-peak)
💰 **Fare**: $1.75 (TAP card required)

🏛️ **Major Stations:**
• 7th Street/Metro Center
• USC
• Culver City
• Santa Monica

💡 **Beach Access**: Perfect for getting to Santa Monica Beach and Venice Beach!`;
            } else {
                return `🚇 **LA Rail System Overview:**

**Rail Lines:**
• 🚇 **Red Line**: North Hollywood ↔ Union Station
• 🚇 **Blue Line**: Downtown LA ↔ Long Beach  
• 🚇 **Purple Line**: Union Station ↔ Wilshire/Western
• 🚇 **Expo Line**: Downtown LA ↔ Santa Monica
• 🚇 **Gold Line**: APU/Citrus College ↔ East LA

**Key Information:**
⏰ **Hours**: 4:00 AM - 1:00 AM (Daily)
💰 **Fare**: $1.75 per ride
🎫 **TAP Card**: Required for all rides
🔄 **Transfers**: Free within 2 hours

💡 **Ask me about specific lines** like "Tell me about the Red Line" for detailed information!`;
            }
        }

        function quickAction(action) {
            switch (action) {
                case 'route':
                    addUserMessage('I want to find a route');
                    processUserMessage('I want to find a route');
                    break;
                case 'location':
                    addUserMessage('Where am I?');
                    processUserMessage('Where am I?');
                    break;
                case 'metro':
                    addUserMessage('Tell me about the rail');
                    processUserMessage('Tell me about the rail');
                    break;
                case 'help':
                    addUserMessage('Help');
                    processUserMessage('Help');
                    break;
            }
        }

        // Get mode icon
        function getModeIcon(mode) {
            const icons = {
                walk: '🚶',
                bike: '🚲',
                metro: '🚇',
                bus: '🚌'
            };
            return icons[mode] || '🚗';
        }

        // Get mode name
        function getModeName(mode) {
            const names = {
                walk: 'Walk',
                bike: 'Bike',
                metro: 'Rail',
                bus: 'Bus'
            };
            return names[mode] || 'Transit';
        }

        // Get step color
        function getStepColor(type) {
            const colors = {
                walk: '#666',
                bike: '#28a745',
                metro: '#ee0000',
                bus: '#ff6b35'
            };
            return colors[type] || '#666';
        }
    </script>
</body>
</html>