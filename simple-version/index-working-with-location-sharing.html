<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LA Transit App - Route Planner with Location Sharing</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="ai-features.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            color: #333;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-items {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            border-radius: 12px;
            transition: all 0.3s ease;
            color: #666;
            font-weight: 500;
        }

        .nav-item:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .search-button, .location-share-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-button:hover, .location-share-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
            min-height: 0;
            height: calc(100vh - 80px);
        }

        .map-container {
            flex: 1;
            position: relative;
            min-height: 0;
            border-radius: 20px;
            margin: 1rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        /* Search Modal Popup */
        .search-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
        }

        .search-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 0;
            width: 90%;
            max-width: 550px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .search-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .close-button {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            padding: 10px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            transition: all 0.3s ease;
        }

        .close-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .search-form {
            padding: 2.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .current-location-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 2rem;
            transition: all 0.3s ease;
            width: 100%;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .current-location-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .input-group {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 1.25rem 1.25rem 1.25rem 3.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        .input-icon {
            position: absolute;
            left: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1.3rem;
            color: #64748b;
        }

        .transport-modes {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin: 2rem 0;
        }

        .mode-button {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            padding: 1rem 1.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            color: #475569;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .mode-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .mode-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .search-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 1.25rem 2.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 800;
            width: 100%;
            transition: all 0.3s ease;
            margin-top: 1.5rem;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .search-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .results-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            margin: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* Route Results Styles */
        .route-result {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .route-result:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .route-header-result {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .route-name {
            margin: 0;
            font-size: 1.4rem;
            font-weight: 800;
            color: #1e293b;
        }

        .route-details {
            display: flex;
            gap: 2rem;
            margin-bottom: 1.5rem;
            font-size: 1rem;
            color: #64748b;
            font-weight: 600;
        }

        .journey-steps {
            margin-top: 1.5rem;
        }

        .journey-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid #f1f5f9;
            transition: all 0.3s ease;
        }

        .journey-step:hover {
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            padding: 1rem;
            margin: 0 -1rem;
        }

        .journey-step:last-child {
            border-bottom: none;
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-30px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Google Maps Style Route Cards */
        .route-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .route-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-color: #667eea;
        }

        .route-time {
            font-size: 18px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .route-cost {
            font-size: 16px;
            font-weight: 600;
            color: #059669;
            margin-bottom: 8px;
        }

        .route-segments {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 8px;
        }

        .segment {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            color: #475569;
        }

        .departure-info {
            font-size: 14px;
            color: #64748b;
            font-weight: 500;
        }

        /* Navigation Overlay Styles - COMPLETELY REDESIGNED */
        .navigation-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.4s ease;
        }

        .nav-content {
            background: white;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px 20px 0 0;
        }

        .nav-header h3 {
            margin: 0;
            font-size: 1.6rem;
            font-weight: 800;
        }

        .nav-header p {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.9);
            margin: 0.25rem 0 0 0;
        }

        .nav-main-content {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: #f8fafc;
        }

        .current-step-card {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .step-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .step-progress-circle {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            font-weight: 800;
            flex-shrink: 0;
        }

        .step-info {
            flex: 1;
        }

        .step-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #1e293b;
            margin: 0 0 0.5rem 0;
        }

        .step-status {
            font-size: 1rem;
            color: #059669;
            font-weight: 600;
        }

        .step-description {
            font-size: 1.1rem;
            color: #475569;
            line-height: 1.5;
            margin-bottom: 1.5rem;
        }

        .step-details-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .detail-item {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
        }

        .detail-label {
            font-size: 0.9rem;
            color: #64748b;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .detail-value {
            font-size: 1.1rem;
            color: #1e293b;
            font-weight: 700;
        }

        .landmark-info {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .landmark-title {
            font-size: 1rem;
            color: #1e40af;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .landmark-text {
            font-size: 1rem;
            color: #1e40af;
            line-height: 1.4;
        }

        .departure-info {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 1rem;
        }

        .departure-title {
            font-size: 1rem;
            color: #92400e;
            font-weight: 700;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .departure-text {
            font-size: 1rem;
            color: #92400e;
            line-height: 1.4;
        }

        .journey-steps {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid #e2e8f0;
        }

        .journey-title {
            font-size: 1.3rem;
            font-weight: 800;
            color: #1e293b;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .step-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .journey-step {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 12px;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .journey-step.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        .journey-step.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
        }

        .journey-step-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #667eea;
            color: white;
            flex-shrink: 0;
        }

        .journey-step.active .journey-step-icon,
        .journey-step.completed .journey-step-icon {
            background: white;
            color: #667eea;
        }

        .journey-step-content {
            flex: 1;
        }

        .journey-step-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .journey-step-details {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .nav-controls {
            display: flex;
            justify-content: space-between;
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 1rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s ease;
            min-width: 120px;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .nav-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .exit-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .exit-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        /* Location Sharing Modal Styles */
        .location-share-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.4s ease;
        }

        .location-share-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 0;
            width: 90%;
            max-width: 500px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .location-share-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 24px 24px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .location-share-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 800;
        }

        .location-share-content {
            padding: 2.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
        }

        .share-options {
            margin-bottom: 2rem;
        }

        .share-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .share-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #10b981;
        }

        .share-option.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .share-option-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }

        .share-option-icon {
            font-size: 1.5rem;
        }

        .share-option-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .share-option-desc {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .duration-selector {
            margin-bottom: 2rem;
        }

        .duration-selector label {
            display: block;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .duration-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }

        .duration-option {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .duration-option:hover {
            border-color: #10b981;
            transform: translateY(-2px);
        }

        .duration-option.selected {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-color: #10b981;
            color: white;
        }

        .contact-input {
            margin-bottom: 2rem;
        }

        .contact-input label {
            display: block;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1e293b;
        }

        .contact-input input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .contact-input input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 4px rgba(16, 185, 129, 0.1);
        }

        .share-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            padding: 1.25rem 2.5rem;
            border-radius: 16px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 800;
            width: 100%;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.4);
        }

        .share-btn:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .location-status {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .location-status.success {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
        }

        .location-status.error {
            background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
            border-color: #ef4444;
        }

        /* AI Chatbot Styles */
        .chatbot-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .chatbot-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-button:hover {
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.5);
        }

        .chatbot-panel {
            position: fixed;
            bottom: 5rem;
            right: 2rem;
            width: 400px;
            height: 500px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            animation: slideInUp 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .chatbot-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chatbot-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .chatbot-status {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .chatbot-messages {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #f8fafc;
        }

        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.bot .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .message-content {
            background: white;
            padding: 0.75rem 1rem;
            border-radius: 16px;
            max-width: 280px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.bot .message-content {
            background: white;
            color: #1e293b;
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .quick-action {
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #667eea;
        }

        .quick-action:hover {
            background: rgba(102, 126, 234, 0.2);
            transform: translateY(-1px);
        }

        .chatbot-input {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 0.5rem;
        }

        .chatbot-input input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .chatbot-input input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .chatbot-input button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .chatbot-input button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .chatbot-input button:disabled {
            background: #e2e8f0;
            color: #a0aec0;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem;
            color: #64748b;
            font-size: 0.8rem;
        }

        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #64748b;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* AI-Enhanced Features Styles */
        .ai-features-container {
            margin-top: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 16px;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .ai-route-suggestions, .ai-predictions, .ai-personalization {
            margin-bottom: 1.5rem;
        }

        .ai-route-suggestions h3, .ai-predictions h3, .ai-personalization h3 {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .ai-route-card, .prediction-item, .personalization-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .ai-route-card:hover, .prediction-item:hover, .personalization-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .ai-confidence {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            display: inline-block;
            margin-bottom: 0.5rem;
        }

        .ai-reasoning {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .prediction-item span, .personalization-item span {
            display: block;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f1f5f9;
            color: #475569;
            font-weight: 500;
        }

        .prediction-item span:last-child, .personalization-item span:last-child {
            border-bottom: none;
        }

        /* AI Chatbot Enhancement */
        .ai-chatbot-enhancement {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            text-align: center;
        }

        .ai-chatbot-enhancement h4 {
            margin: 0 0 0.5rem 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .ai-chatbot-enhancement p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Voice Command Button */
        .voice-command-btn {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin: 1rem 0;
        }

        .voice-command-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.3);
        }

        .voice-command-btn.recording {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            üöá LA Transit
        </div>
        <div class="nav-items">
            <div class="nav-item">
                üó∫Ô∏è Routes
            </div>
            <div class="nav-item">
                üìç Locations
            </div>
            <button class="search-button" onclick="toggleSearch()">
                üîç Search Routes
            </button>
            <button class="location-share-button" onclick="toggleLocationShare()">
                üìç Share Location
            </button>
        </div>
    </div>

    <div class="main-content">
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Search Panel -->
    <div class="search-container" id="searchPanel" style="display: none;">
        <div class="search-panel">
            <div class="search-header">
                <h3>üîç Plan Your Journey</h3>
                <button class="close-button" onclick="toggleSearch()">‚úï</button>
            </div>
            <form class="search-form" onsubmit="handleSearch(event)">
                <button type="button" class="current-location-btn" onclick="getCurrentLocation()">
                    üìç Use Current Location
                </button>
                
                <div class="input-group">
                    <input type="text" id="originInput" class="search-input" placeholder="From (e.g., Downtown, USC, Beverly Hills)" required>
                    <span class="input-icon">üìç</span>
                </div>
                
                <div class="input-group">
                    <input type="text" id="destinationInput" class="search-input" placeholder="To (e.g., Santa Monica, LAX, Hollywood)" required>
                    <span class="input-icon">üéØ</span>
                </div>
                
                <div class="transport-modes">
                    <button type="button" class="mode-button active" onclick="setMode('metro')">üöá Rail (All Options)</button>
                    <button type="button" class="mode-button" onclick="setMode('bus')">üöå Bus (All Options)</button>
                    <button type="button" class="mode-button" onclick="setMode('walk')">üö∂ Walk</button>
                    <button type="button" class="mode-button" onclick="setMode('rideshare')">üöó Ride-Share</button>
                </div>
                
                <button type="submit" class="search-btn">üîç Find Routes</button>
                
                <!-- AI Voice Command -->
                <button type="button" class="voice-command-btn" onclick="startVoiceCommand()">
                    üé§ Voice Command
                </button>
            </form>
            
            <div class="results-container" id="searchResults" style="display: none;"></div>
            
            <!-- AI-Enhanced Features -->
            <div class="ai-features-container" id="aiFeatures" style="display: none;">
                <div class="ai-route-suggestions">
                    <h3>ü§ñ AI Smart Suggestions</h3>
                    <div class="ai-route-card" id="aiRouteCard">
                        <div class="ai-confidence">95% confidence</div>
                        <div class="ai-reasoning">Based on current traffic and your preferences</div>
                    </div>
                </div>
                
                <div class="ai-predictions">
                    <h3>üîÆ AI Predictions</h3>
                    <div class="prediction-item" id="aiPredictions">
                        <span>Delay Probability: 25%</span>
                        <span>Crowd Level: Medium</span>
                        <span>Optimal Time: 10:30 AM</span>
                    </div>
                </div>
                
                <div class="ai-personalization">
                    <h3>üéØ Personalized for You</h3>
                    <div class="personalization-item" id="aiPersonalization">
                        <span>Based on your travel patterns</span>
                        <span>Preferred routes: Metro Red Line</span>
                        <span>Best times: 10 AM - 2 PM</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Location Sharing Panel -->
    <div class="location-share-container" id="locationSharePanel" style="display: none;">
        <div class="location-share-panel">
            <div class="location-share-header">
                <h3>üìç Share Live Location</h3>
                <button class="close-button" onclick="toggleLocationShare()">‚úï</button>
            </div>
            <div class="location-share-content">
                <div class="location-status" id="locationStatus">
                    <div>üìç Getting your location...</div>
                </div>
                
                <div class="share-options">
                    <div class="share-option" onclick="selectShareOption('email')">
                        <div class="share-option-header">
                            <div class="share-option-icon">üìß</div>
                            <div class="share-option-title">Email</div>
                        </div>
                        <div class="share-option-desc">Send location via email</div>
                    </div>
                    
                    <div class="share-option" onclick="selectShareOption('sms')">
                        <div class="share-option-header">
                            <div class="share-option-icon">üí¨</div>
                            <div class="share-option-title">SMS</div>
                        </div>
                        <div class="share-option-desc">Send location via text message</div>
                    </div>
                    
                    <div class="share-option" onclick="selectShareOption('whatsapp')">
                        <div class="share-option-header">
                            <div class="share-option-icon">üì±</div>
                            <div class="share-option-title">WhatsApp</div>
                        </div>
                        <div class="share-option-desc">Share location on WhatsApp</div>
                    </div>
                    
                    <div class="share-option" onclick="selectShareOption('link')">
                        <div class="share-option-header">
                            <div class="share-option-icon">üîó</div>
                            <div class="share-option-title">Share Link</div>
                        </div>
                        <div class="share-option-desc">Copy tracking link to clipboard</div>
                    </div>
                </div>
                
                <div class="duration-selector">
                    <label>Share Duration:</label>
                    <div class="duration-options">
                        <div class="duration-option" onclick="selectDuration(15)">15 min</div>
                        <div class="duration-option" onclick="selectDuration(30)">30 min</div>
                        <div class="duration-option" onclick="selectDuration(60)">1 hour</div>
                        <div class="duration-option" onclick="selectDuration(120)">2 hours</div>
                        <div class="duration-option" onclick="selectDuration(240)">4 hours</div>
                        <div class="duration-option" onclick="selectDuration(480)">8 hours</div>
                    </div>
                </div>
                
                <div class="contact-input">
                    <label for="contactInput">Contact (Email/Phone/Name):</label>
                    <input type="text" id="contactInput" placeholder="Enter email, phone number, or name">
                </div>
                
                <button class="share-btn" onclick="shareLocation()" id="shareBtn" disabled>
                    üìç Share Location
                </button>
            </div>
        </div>
    </div>

    <!-- AI Chatbot -->
    <div class="chatbot-container">
        <div class="chatbot-panel" id="chatbotPanel" style="display: none;">
            <div class="chatbot-header">
                <h3>ü§ñ LA Transit AI</h3>
                <div class="chatbot-status" id="chatbotStatus">AI-Powered</div>
            </div>
            
            <!-- AI Enhancement Banner -->
            <div class="ai-chatbot-enhancement">
                <h4>üß† Intelligent Assistant</h4>
                <p>Powered by AI - Understands context, learns preferences, provides smart suggestions</p>
            </div>
            
            <div class="chatbot-messages" id="chatbotMessages">
                <!-- Messages will be added here -->
            </div>
            <div class="chatbot-input">
                <input type="text" id="chatbotInput" placeholder="Ask me about routes, locations, or anything..." onkeypress="handleChatbotKeyPress(event)">
                <button onclick="sendChatbotMessage()" id="chatbotSendBtn">Send</button>
            </div>
        </div>
        <button class="chatbot-button" onclick="toggleChatbot()" id="chatbotButton">
            ü§ñ
        </button>
    </div>

    <script>
        // Initialize map and variables
        let map;
        let currentMode = 'metro';
        let currentRoutes = [];

        // Speed constants (mph)
        const SPEEDS = {
            walk: 3,
            bike: 12,
            metro: 35,
            bus: 25,
            metrolink: 50,
            amtrak: 60,
            rideshare: 30, // Average city speed for ride-sharing
            uber: 30,
            lyft: 30,
            waymo: 30
        };

        // Ride-Sharing Configuration
        const RIDESHARE_CONFIG = {
            // Uber API (you'll need to get real API keys)
            uber: {
                clientId: 'your_uber_client_id',
                serverToken: 'your_uber_server_token',
                apiUrl: 'https://api.uber.com/v1.2',
                endpoints: {
                    products: '/products',
                    estimates: '/estimates/price',
                    requests: '/requests'
                }
            },
            // Lyft API (you'll need to get real API keys)
            lyft: {
                clientId: 'your_lyft_client_id',
                clientSecret: 'your_lyft_client_secret',
                apiUrl: 'https://api.lyft.com/v1',
                endpoints: {
                    rideTypes: '/ridetypes',
                    costEstimates: '/cost',
                    rideStatus: '/rides'
                }
            },
            // Waymo API (you'll need to get real API keys)
            waymo: {
                apiKey: 'your_waymo_api_key',
                apiUrl: 'https://api.waymo.com/v1',
                endpoints: {
                    availability: '/availability',
                    booking: '/booking',
                    status: '/status'
                }
            }
        };

        // Location data for search
        const locations = {
            'downtown': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'downtown la': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'downtown los angeles': { lat: 34.0522, lng: -118.2437, name: 'Downtown Los Angeles' },
            'usc': { lat: 34.0224, lng: -118.2851, name: 'University of Southern California' },
            'university of southern california': { lat: 34.0224, lng: -118.2851, name: 'University of Southern California' },
            'ucla': { lat: 34.0689, lng: -118.4452, name: 'University of California Los Angeles' },
            'beverly hills': { lat: 34.0736, lng: -118.4001, name: 'Beverly Hills' },
            'hollywood': { lat: 34.0928, lng: -118.3287, name: 'Hollywood' },
            'santa monica': { lat: 34.0195, lng: -118.4912, name: 'Santa Monica' },
            'venice': { lat: 34.0195, lng: -118.4912, name: 'Venice Beach' },
            'lax': { lat: 33.9425, lng: -118.4081, name: 'Los Angeles International Airport' },
            'koreatown': { lat: 34.0579, lng: -118.3009, name: 'Koreatown' },
            'pasadena': { lat: 34.1478, lng: -118.1445, name: 'Pasadena' },
            'long beach': { lat: 33.7701, lng: -118.1937, name: 'Long Beach' }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            if (!map) {
                initializeMap();
            }
            checkForTracking();
            initializeChatbot();
            initializeAI(); // Initialize AI features
        });

        // Initialize AI features
        function initializeAI() {
            // Initialize AI Assistant
            window.aiAssistant = new AITransitAssistant();
            console.log('ü§ñ AI Assistant initialized');
            
            // Show AI features if user has used the app before
            const hasUsedApp = localStorage.getItem('hasUsedApp');
            if (hasUsedApp) {
                showAIEnhancement();
            }
        }

        // Show AI enhancement features
        function showAIEnhancement() {
            const aiFeatures = document.getElementById('aiFeatures');
            if (aiFeatures) {
                aiFeatures.style.display = 'block';
                updateAIPredictions();
            }
        }

        // Update AI predictions
        async function updateAIPredictions() {
            try {
                const predictions = await window.aiAssistant.predictTransitConditions('Red Line', new Date());
                
                const predictionsElement = document.getElementById('aiPredictions');
                if (predictionsElement) {
                    predictionsElement.innerHTML = `
                        <span>Delay Probability: ${Math.round(predictions.delayProbability * 100)}%</span>
                        <span>Crowd Level: ${predictions.crowdLevel}</span>
                        <span>Optimal Time: ${new Date(predictions.optimalTime).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    `;
                }
                
                // Update personalization
                const patterns = window.aiAssistant.analyzeUserPatterns();
                const personalizationElement = document.getElementById('aiPersonalization');
                if (personalizationElement && Object.keys(patterns.preferredRoutes).length > 0) {
                    const topRoute = Object.keys(patterns.preferredRoutes)[0];
                    personalizationElement.innerHTML = `
                        <span>Based on your travel patterns</span>
                        <span>Preferred routes: ${topRoute}</span>
                        <span>Best times: ${Object.keys(patterns.preferredTimes).slice(0, 2).join(', ')} AM</span>
                    `;
                }
                
            } catch (error) {
                console.error('AI Prediction Error:', error);
            }
        }

        // Map initialization
        function initializeMap() {
            // Check if map already exists
            if (map) {
                console.log('Map already initialized, skipping...');
                return;
            }
            
            try {
                map = L.map('map').setView([34.0522, -118.2437], 11);
                
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // Add some basic metro stations
                const metroStations = [
                    { name: 'North Hollywood', lat: 34.1680, lng: -118.3780 },
                    { name: 'Universal City', lat: 34.1380, lng: -118.3600 },
                    { name: 'Hollywood/Highland', lat: 34.1016, lng: -118.3267 },
                    { name: 'Union Station', lat: 34.0556, lng: -118.2340 },
                    { name: '7th Street/Metro Center', lat: 34.0486, lng: -118.2588 },
                    { name: 'Santa Monica', lat: 34.0195, lng: -118.4912 }
                ];

                metroStations.forEach(station => {
                    L.circleMarker([station.lat, station.lng], {
                        color: '#ff0000',
                        fillColor: '#ff0000',
                        fillOpacity: 0.8,
                        radius: 6
                    }).addTo(map).bindPopup(`<h3>${station.name}</h3><p>Metro Station</p>`);
                });
                
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Map initialization error:', error);
            }
        }

        // Toggle search panel
        function toggleSearch() {
            const searchPanel = document.getElementById('searchPanel');
            if (searchPanel.style.display === 'none' || !searchPanel.style.display) {
                searchPanel.style.display = 'flex';
            } else {
                searchPanel.style.display = 'none';
            }
        }

        // Set transportation mode
        function setMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.mode-button').forEach(button => {
                button.classList.remove('active');
            });
            document.querySelector(`.mode-button[onclick="setMode('${mode}')"]`).classList.add('active');
        }

        // Get current location for route planning with real-time geocoding
        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async function(position) {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        // Set coordinates immediately
                        document.getElementById('originInput').value = 'Current Location';
                        
                        try {
                            // Use the same robust geocoding as everywhere else
                            const address = await getBetterAddress(lat, lng, accuracy);
                            const displayText = formatLocationDisplay(address, lat, lng, accuracy);
                            alert(`‚úÖ Current location set:\n\n${displayText}`);
                        } catch (error) {
                            console.log('Geocoding failed, using coordinates');
                            const displayText = formatLocationDisplay(`${lat.toFixed(4)}, ${lng.toFixed(4)}`, lat, lng, accuracy);
                            alert(`‚úÖ Current location set:\n\n${displayText}`);
                        }
                    },
                    function(error) {
                        console.error('Geolocation error:', error);
                        alert('‚ùå Could not get your location. Please enter address manually.');
                    },
                    {
                        timeout: 15000, // 15 second timeout for GPS
                        enableHighAccuracy: true, // Request high accuracy to trigger permissions
                        maximumAge: 0 // Don't use cached location
                    }
                );
            } else {
                alert('‚ùå GPS not supported. Please enter address manually.');
            }
        }

        // Calculate distance between two points
        function calculateDistance(point1, point2) {
            if (!point1 || !point2 || 
                typeof point1.lat === 'undefined' || typeof point1.lng === 'undefined' ||
                typeof point2.lat === 'undefined' || typeof point2.lng === 'undefined') {
                return Infinity;
            }
            
            const R = 3959; // Earth's radius in miles
            const dLat = (point2.lat - point1.lat) * Math.PI / 180;
            const dLng = (point2.lng - point1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(point1.lat * Math.PI / 180) * Math.cos(point2.lat * Math.PI / 180) *
                     Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get coordinates for a location
        async function getCoordinates(location) {
            const knownLocation = locations[location.toLowerCase()];
            if (knownLocation) {
                return { lat: knownLocation.lat, lng: knownLocation.lng };
            }
            
            if (location.toLowerCase() === 'current location') {
                return new Promise((resolve) => {
                    navigator.geolocation.getCurrentPosition(
                        (position) => resolve({ lat: position.coords.latitude, lng: position.coords.longitude }),
                        () => resolve(null),
                        {
                            timeout: 15000, // 15 second timeout
                            enableHighAccuracy: true, // Request high accuracy to trigger permissions
                            maximumAge: 0 // Don't use cached location
                        }
                    );
                });
            }
            
            try {
                // Add timeout protection for geocoding
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('Geocoding timeout')), 5000); // 5 second timeout
                });

                const geocodingPromise = fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ', Los Angeles, CA')}&limit=1`);
                const response = await Promise.race([geocodingPromise, timeoutPromise]);
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.length > 0) {
                        return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    }
                }
            } catch (error) {
                console.log('Geocoding error or timeout:', error);
            }
            
            return null;
        }

        // Generate realistic departure times
        function generateRealisticDepartureTimes() {
            const now = new Date();
            const times = [];
            
            for (let i = 0; i < 3; i++) {
                const departureTime = new Date(now.getTime() + (i * 15 * 60000));
                times.push(departureTime);
            }
            
            return times;
        }

        // Generate multiple Metro routes - OPTIMIZED for speed
        async function generateMultipleMetroRoutes(origin, destination) {
            const routes = [];
            
            try {
                // Get coordinates once and reuse
                const originCoords = await getCoordinates(origin);
                const destCoords = await getCoordinates(destination);
                
                if (!originCoords || !destCoords) return routes;
                
                const distance = calculateDistance(originCoords, destCoords);
                const baseTime = Math.round(distance / SPEEDS.metro * 60);
                const baseCost = 1.75;
                
                // Route 1: Fastest route
                routes.push({
                    type: 'route',
                    mode: 'metro',
                    system: 'laMetro',
                    systemName: 'LA Metro (Fastest)',
                    systemIcon: 'üöá',
                    systemColor: '#ff0000',
                    origin: origin,
                    destination: destination,
                    totalDistance: distance,
                    totalTime: baseTime,
                    totalCost: baseCost,
                    departureTimes: generateRealisticDepartureTimes(),
                    steps: [
                        {
                            type: 'walk',
                            instruction: `Walk to nearest metro station`,
                            distance: distance * 0.1,
                            time: Math.round(distance * 0.1 / SPEEDS.walk * 60)
                        },
                        {
                            type: 'metro',
                            instruction: `Take metro to destination`,
                            distance: distance * 0.8,
                            time: Math.round(distance * 0.8 / SPEEDS.metro * 60)
                        },
                        {
                            type: 'walk',
                            instruction: `Walk from metro station to destination`,
                            distance: distance * 0.1,
                            time: Math.round(distance * 0.1 / SPEEDS.walk * 60)
                        }
                    ]
                });
                
                // Route 2: Alternative route (only if distance > 2 miles)
                if (distance > 2) {
                    routes.push({
                        type: 'route',
                        mode: 'metro',
                        system: 'laMetro',
                        systemName: 'LA Metro (Alternative)',
                        systemIcon: 'üöá',
                        systemColor: '#ff0000',
                        origin: origin,
                        destination: destination,
                        totalDistance: distance,
                        totalTime: Math.round(baseTime * 1.2), // 20% longer
                        totalCost: baseCost,
                        departureTimes: generateRealisticDepartureTimes(),
                        steps: [
                            {
                                type: 'walk',
                                instruction: `Walk to alternative metro station`,
                                distance: distance * 0.15,
                                time: Math.round(distance * 0.15 / SPEEDS.walk * 60)
                            },
                            {
                                type: 'metro',
                                instruction: `Take metro with transfers`,
                                distance: distance * 0.75,
                                time: Math.round(distance * 0.75 / SPEEDS.metro * 60)
                            },
                            {
                                type: 'walk',
                                instruction: `Walk from metro station to destination`,
                                distance: distance * 0.1,
                                time: Math.round(distance * 0.1 / SPEEDS.walk * 60)
                            }
                        ]
                    });
                }
                
                // Route 3: Express route (only if distance > 5 miles)
                if (distance > 5) {
                    routes.push({
                        type: 'route',
                        mode: 'metro',
                        system: 'laMetro',
                        systemName: 'LA Metro (Express)',
                        systemIcon: 'üöá',
                        systemColor: '#ff0000',
                        origin: origin,
                        destination: destination,
                        totalDistance: distance,
                        totalTime: Math.round(baseTime * 0.8), // 20% faster
                        totalCost: baseCost,
                        departureTimes: generateRealisticDepartureTimes(),
                        steps: [
                            {
                                type: 'walk',
                                instruction: `Walk to express metro station`,
                                distance: distance * 0.08,
                                time: Math.round(distance * 0.08 / SPEEDS.walk * 60)
                            },
                            {
                                type: 'metro',
                                instruction: `Take express metro to destination`,
                                distance: distance * 0.84,
                                time: Math.round(distance * 0.84 / SPEEDS.metro * 60)
                            },
                            {
                                type: 'walk',
                                instruction: `Walk from metro station to destination`,
                                distance: distance * 0.08,
                                time: Math.round(distance * 0.08 / SPEEDS.walk * 60)
                            }
                        ]
                    });
                }
                
            } catch (error) {
                console.error('Generate multiple metro routes error:', error);
            }
            
            return routes;
        }

        // Generate multiple Bus routes - OPTIMIZED for speed
        async function generateMultipleBusRoutes(origin, destination) {
            const routes = [];
            
            try {
                // Get coordinates once and reuse
                const originCoords = await getCoordinates(origin);
                const destCoords = await getCoordinates(destination);
                
                if (!originCoords || !destCoords) return routes;
                
                const distance = calculateDistance(originCoords, destCoords);
                const baseTime = Math.round(distance / SPEEDS.bus * 60);
                const baseCost = 1.75;
                
                // Route 1: Fastest bus route
                routes.push({
                    type: 'route',
                    mode: 'bus',
                    system: 'laMetro',
                    systemName: 'LA Metro Bus (Fastest)',
                    systemIcon: 'üöå',
                    systemColor: '#ff6b35',
                    origin: origin,
                    destination: destination,
                    totalDistance: distance,
                    totalTime: baseTime,
                    totalCost: baseCost,
                    departureTimes: generateRealisticDepartureTimes(),
                    steps: [
                        {
                            type: 'walk',
                            instruction: `Walk to nearest bus stop`,
                            distance: distance * 0.1,
                            time: Math.round(distance * 0.1 / SPEEDS.walk * 60)
                        },
                        {
                            type: 'bus',
                            instruction: `Take bus to destination`,
                            distance: distance * 0.8,
                            time: Math.round(distance * 0.8 / SPEEDS.bus * 60)
                        },
                        {
                            type: 'walk',
                            instruction: `Walk from bus stop to destination`,
                            distance: distance * 0.1,
                            time: Math.round(distance * 0.1 / SPEEDS.walk * 60)
                        }
                    ]
                });
                
                // Route 2: Local bus route (only if distance > 3 miles)
                if (distance > 3) {
                    routes.push({
                        type: 'route',
                        mode: 'bus',
                        system: 'laMetro',
                        systemName: 'LA Metro Bus (Local)',
                        systemIcon: 'üöå',
                        systemColor: '#ff6b35',
                        origin: origin,
                        destination: destination,
                        totalDistance: distance,
                        totalTime: Math.round(baseTime * 1.3), // 30% longer
                        totalCost: baseCost,
                        departureTimes: generateRealisticDepartureTimes(),
                        steps: [
                            {
                                type: 'walk',
                                instruction: `Walk to local bus stop`,
                                distance: distance * 0.12,
                                time: Math.round(distance * 0.12 / SPEEDS.walk * 60)
                            },
                            {
                                type: 'bus',
                                instruction: `Take local bus with more stops`,
                                distance: distance * 0.76,
                                time: Math.round(distance * 0.76 / SPEEDS.bus * 60)
                            },
                            {
                                type: 'walk',
                                instruction: `Walk from bus stop to destination`,
                                distance: distance * 0.12,
                                time: Math.round(distance * 0.12 / SPEEDS.walk * 60)
                            }
                        ]
                    });
                }
                
                // Route 3: Express bus route (only if distance > 4 miles)
                if (distance > 4) {
                    routes.push({
                        type: 'route',
                        mode: 'bus',
                        system: 'laMetro',
                        systemName: 'LA Metro Bus (Express)',
                        systemIcon: 'üöå',
                        systemColor: '#ff6b35',
                        origin: origin,
                        destination: destination,
                        totalDistance: distance,
                        totalTime: Math.round(baseTime * 0.9), // 10% faster
                        totalCost: baseCost,
                        departureTimes: generateRealisticDepartureTimes(),
                        steps: [
                            {
                                type: 'walk',
                                instruction: `Walk to express bus stop`,
                                distance: distance * 0.08,
                                time: Math.round(distance * 0.08 / SPEEDS.walk * 60)
                            },
                            {
                                type: 'bus',
                                instruction: `Take express bus to destination`,
                                distance: distance * 0.84,
                                time: Math.round(distance * 0.84 / SPEEDS.bus * 60)
                            },
                            {
                                type: 'walk',
                                instruction: `Walk from bus stop to destination`,
                                distance: distance * 0.08,
                                time: Math.round(distance * 0.08 / SPEEDS.walk * 60)
                            }
                        ]
                    });
                }
                
            } catch (error) {
                console.error('Generate multiple bus routes error:', error);
            }
            
            return routes;
        }

        // Create a Walking route - OPTIMIZED for speed
        async function createWalkingRoute(origin, destination) {
            try {
                const originCoords = await getCoordinates(origin);
                const destCoords = await getCoordinates(destination);
                
                if (!originCoords || !destCoords) return null;
                
                const distance = calculateDistance(originCoords, destCoords);
                const totalTime = Math.round(distance / SPEEDS.walk * 60);
                
                return {
                    type: 'route',
                    mode: 'walk',
                    system: 'walking',
                    systemName: 'Walking Route',
                    systemIcon: 'üö∂',
                    systemColor: '#10b981',
                    origin: origin,
                    destination: destination,
                    totalDistance: distance,
                    totalTime: totalTime,
                    totalCost: 0, // Walking is free
                    departureTimes: [new Date()], // Leave now
                    steps: [
                        {
                            type: 'walk',
                            instruction: `Walk to destination`,
                            distance: distance,
                            time: totalTime
                        }
                    ]
                };
            } catch (error) {
                console.error('Create walking route error:', error);
                return null;
            }
        }

        // Handle search form submission - ENHANCED with AI
        async function handleSearch(event) {
            event.preventDefault();
            
            const origin = document.getElementById('originInput').value.trim();
            const destination = document.getElementById('destinationInput').value.trim();
            
            if (!origin || !destination) {
                alert('Please enter both origin and destination.');
                return;
            }
            
            // Mark that user has used the app
            localStorage.setItem('hasUsedApp', 'true');
            
            const resultsContainer = document.getElementById('searchResults');
            resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">üîç Finding routes... <br><small>AI is analyzing the best options for you</small></div>';
            resultsContainer.style.display = 'block';
            
            // Show AI features
            showAIEnhancement();
            
            try {
                let routes = [];
                
                // Use setTimeout to show loading state briefly
                setTimeout(async () => {
                    try {
                        // Get AI-powered intelligent route suggestions
                        if (window.aiAssistant) {
                            const aiSuggestions = await window.aiAssistant.getIntelligentRoute(origin, destination, {
                                preferSpeed: true,
                                avoidCrowds: false,
                                accessibility: false
                            });
                            console.log('ü§ñ AI Route Suggestions:', aiSuggestions);
                        }
                        
                        if (currentMode === 'metro') {
                            routes = await generateMultipleMetroRoutes(origin, destination);
                        } else if (currentMode === 'bus') {
                            routes = await generateMultipleBusRoutes(origin, destination);
                        } else if (currentMode === 'walk') {
                            const walkRoute = await createWalkingRoute(origin, destination);
                            routes = walkRoute ? [walkRoute] : [];
                        } else if (currentMode === 'rideshare') {
                            routes = await generateRideSharingRoutes(origin, destination);
                        }
                        
                        currentRoutes = routes;
                        displaySearchResults(routes);
                        
                        // Learn user preferences
                        if (window.aiAssistant) {
                            await window.aiAssistant.learnUserPreferences('route_search', {
                                origin: origin,
                                destination: destination,
                                mode: currentMode,
                                route: routes[0]?.systemName || 'unknown'
                            });
                        }
                        
                    } catch (error) {
                        console.error('Route planning error:', error);
                        resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">‚ùå Error finding route. Please try again.</div>';
                    }
                }, 500); // Show loading for 500ms minimum
                
            } catch (error) {
                console.error('Search error:', error);
                resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">‚ùå Error finding route. Please try again.</div>';
            }
        }

        // Display search results in Google Maps style
        function displaySearchResults(routes) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (!routes || routes.length === 0) {
                resultsContainer.innerHTML = '<div style="padding: 2rem; text-align: center; color: #666;">‚ùå No routes found. Please try different locations or modes.</div>';
                return;
            }
            
            // Sort routes by time
            routes.sort((a, b) => a.totalTime - b.totalTime);
            
            let html = `
                <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <h3 style="margin: 0 0 8px 0; color: #1e293b;">${currentMode === 'rideshare' ? 'Ride-sharing services' : 'Public transport'}</h3>
                    <div style="display: flex; gap: 16px; font-size: 14px; color: #64748b;">
                        <span>üöó ${Math.round(routes[0].totalTime * 0.7)} min</span>
                        <span>üèçÔ∏è ${Math.round(routes[0].totalTime * 0.8)} min</span>
                        <span>üöå ${routes[0].totalTime} min</span>
                        <span>üö∂ ${Math.round(routes[0].totalTime * 2)} min</span>
                        <span>üö≤ ${Math.round(routes[0].totalTime * 0.6)} min</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 16px; padding: 12px; background: #f8f9fa; border-radius: 8px; font-size: 14px; color: #64748b;">
                    <span>Leave ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
                    <span style="margin-left: 16px;">Modes</span>
                    <span style="margin-left: 16px;">Filter by</span>
                </div>
            `;
            
            routes.forEach((route, index) => {
                // Don't show cost for ride-sharing options since pricing is not available
                const cost = route.mode === 'rideshare' ? '' : (route.totalCost > 0 ? `$${route.totalCost.toFixed(2)}` : 'Free');
                const departureTimes = route.departureTimes || [new Date()];
                const nextDeparture = departureTimes[0];
                const departureText = route.mode === 'walk' ? 'Leave now' : 
                    `In ${Math.max(1, Math.round((nextDeparture - new Date()) / 60000))} min from ${route.origin}`;
                
                const routeSegments = generateRouteSegments(route);
                
                // Add service-specific styling and navigation for ride-sharing
                let serviceBadge = '';
                let navigationButton = '';
                
                if (route.mode === 'rideshare') {
                    const serviceColors = {
                        'uber': '#000000',
                        'lyft': '#FF00BF', 
                        'waymo': '#4285F4'
                    };
                    
                    const serviceNames = {
                        'uber': 'Uber',
                        'lyft': 'Lyft',
                        'waymo': 'Waymo'
                    };
                    
                    const appUrls = {
                        'uber': 'https://m.uber.com',
                        'lyft': 'https://www.lyft.com',
                        'waymo': 'https://waymo.com/waymo-one/'
                    };
                    
                    serviceBadge = `
                        <div style="background: ${serviceColors[route.system]}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-bottom: 8px; display: inline-block;">
                            ${serviceNames[route.system]} ${route.systemName.replace(serviceNames[route.system], '')}
                        </div>
                    `;
                    
                    navigationButton = `
                        <button onclick="openRideSharingApp('${route.system}', '${route.origin}', '${route.destination}')" 
                                style="background: ${serviceColors[route.system]}; color: white; border: none; padding: 8px 16px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; margin-top: 8px; width: 100%;">
                            üöó Book with ${serviceNames[route.system]}
                        </button>
                    `;
                }
                
                html += `
                    <div class="route-card" onclick="startNavigation(${index})">
                        ${serviceBadge}
                        <div class="route-time">${route.totalTime} min</div>
                        ${cost ? `<div class="route-cost">${cost}</div>` : ''}
                        <div class="route-segments">${routeSegments}</div>
                        <div class="departure-info">${departureText}</div>
                        ${navigationButton}
                    </div>
                `;
            });
            
            html += `
                <div style="margin-top: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0 0 8px 0; color: #1e293b;">Ride service</h4>
                    <p style="margin: 0; font-size: 14px; color: #64748b;">Uber, Lyft, and other ride-sharing options available</p>
                </div>
            `;
            
            resultsContainer.innerHTML = html;
        }

        // Generate route segments for display
        function generateRouteSegments(route) {
            if (!route.steps) return '';
            
            const segments = [];
            route.steps.forEach((step, index) => {
                let icon = 'üö∂';
                let serviceName = '';
                
                if (step.type === 'metro') {
                    icon = 'üöá';
                    serviceName = 'Metro';
                } else if (step.type === 'bus') {
                    icon = 'üöå';
                    serviceName = 'Bus';
                } else if (step.type === 'walk') {
                    icon = 'üö∂';
                    serviceName = 'Walk';
                } else if (step.type === 'rideshare') {
                    if (route.system === 'uber') {
                        icon = 'üöó';
                        serviceName = 'Uber';
                    } else if (route.system === 'lyft') {
                        icon = 'üöó';
                        serviceName = 'Lyft';
                    } else if (route.system === 'waymo') {
                        icon = 'ü§ñ';
                        serviceName = 'Waymo';
                    }
                }
                
                const segmentText = serviceName ? `${icon} ${serviceName} ${Math.round(step.distance * 10) / 10} mi` : `${icon} ${Math.round(step.distance * 10) / 10} mi`;
                segments.push(segmentText);
                
                if (index < route.steps.length - 1) {
                    segments.push('‚Üí');
                }
            });
            
            return segments.join(' ');
        }

        // Start navigation with detailed real-time information
        function startNavigation(routeIndex) {
            const route = currentRoutes[routeIndex];
            if (route) {
                // Hide search panel
                document.getElementById('searchPanel').style.display = 'none';
                
                // Show navigation overlay
                showNavigationOverlay(route);
            }
        }

        // Show comprehensive navigation overlay
        function showNavigationOverlay(route) {
            // Create navigation overlay
            const overlay = document.createElement('div');
            overlay.className = 'navigation-overlay';
            overlay.id = 'navigationOverlay';
            
            overlay.innerHTML = `
                <div class="nav-content">
                    <div class="nav-header">
                        <div>
                            <h3>üöá Live Navigation</h3>
                            <p>${route.origin} ‚Üí ${route.destination}</p>
                        </div>
                        <button class="exit-btn" onclick="exitNavigation()">Exit Navigation</button>
                    </div>
                    
                    <div class="nav-main-content">
                        <div class="current-step-card">
                            <div class="step-header">
                                <div class="step-progress-circle">1</div>
                                <div class="step-info">
                                    <h4 class="step-title">Step 1</h4>
                                    <p class="step-status">Starting your journey...</p>
                                </div>
                            </div>
                            <p class="step-description">Preparing your route</p>
                            <div class="step-details-grid">
                                <div class="detail-item">
                                    <div class="detail-label">‚è±Ô∏è Time</div>
                                    <div class="detail-value">0 min</div>
                                </div>
                                <div class="detail-item">
                                    <div class="detail-label">üìè Distance</div>
                                    <div class="detail-value">0.0 mi</div>
                                </div>
                            </div>
                            <div class="landmark-info">
                                <div class="landmark-title">üèõÔ∏è Landmark</div>
                                <p class="landmark-text">Getting ready to start</p>
                            </div>
                            <div class="departure-info">
                                <div class="departure-title">üïí Departure</div>
                                <p class="departure-text">Preparing route information</p>
                            </div>
                        </div>
                        
                        <div class="journey-steps">
                            <h4 class="journey-title">üìã Complete Journey</h4>
                            <div class="step-list">
                                ${route.steps.map((step, index) => `
                                    <div class="journey-step" id="step-${index}" onclick="updateCurrentStep(currentRoute, ${index})">
                                        <div class="journey-step-icon" style="background: ${getStepColor(step.type)}">${getStepIcon(step.type)}</div>
                                        <div class="journey-step-content">
                                            <div class="journey-step-title">Step ${index + 1}: ${step.instruction}</div>
                                            <div class="journey-step-details">
                                                <span>‚è±Ô∏è Time: ${step.time} min</span><br>
                                                <span>üìè Distance: ${step.distance.toFixed(1)} mi</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    
                    <div class="nav-controls">
                        <button class="nav-btn" id="prevBtn" onclick="previousStep()" disabled>‚Üê Previous</button>
                        <button class="nav-btn" id="nextBtn" onclick="nextStep()">Next ‚Üí</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(overlay);
            
            // Initialize navigation
            initializeNavigation(route);
        }

        // Initialize navigation with detailed information
        function initializeNavigation(route) {
            // Store current route globally
            window.currentRoute = route;
            window.currentStepIndex = 0;
            
            // Start with first step (not completion)
            updateCurrentStep(route, 0);
            
            // Remove auto-progression - let user control with buttons only
            // startLiveUpdates(route);
        }

        // Update current step with detailed information - USER CONTROLLED ONLY
        async function updateCurrentStep(route, stepIndex) {
            const step = route.steps[stepIndex];
            window.currentStepIndex = stepIndex;
            
            // Update step progress circle
            document.querySelector('.step-progress-circle').textContent = stepIndex + 1;
            
            // Check if this is the final step
            const isFinalStep = stepIndex >= route.steps.length - 1;
            
            // Show normal step information (never show completion automatically)
            document.querySelector('.step-title').textContent = `Step ${stepIndex + 1}`;
            document.querySelector('.step-status').textContent = step.instruction;
            
            // Update step description
            const detailedDesc = getDetailedStepDescription(step, stepIndex);
            document.querySelector('.step-description').textContent = detailedDesc;
            
            // Update step details
            document.querySelector('.detail-value').textContent = `${step.time} min`;
            document.querySelectorAll('.detail-value')[1].textContent = `${step.distance.toFixed(1)} mi`;
            
            // Update landmark info
            const landmarks = getLandmarksForStep(step, stepIndex);
            document.querySelector('.landmark-text').textContent = landmarks;
            
            // Update departure info (async)
            const departureInfo = await getDepartureInfo(step, stepIndex);
            document.querySelector('.departure-text').textContent = departureInfo;
            
            // Update step highlighting
            document.querySelectorAll('.journey-step').forEach((item, index) => {
                item.classList.remove('active', 'completed');
                if (index < stepIndex) {
                    item.classList.add('completed');
                } else if (index === stepIndex) {
                    item.classList.add('active');
                }
            });
            
            // Update navigation buttons
            document.getElementById('prevBtn').disabled = stepIndex === 0;
            
            // Show Finish Journey button on final step, otherwise show Next button
            const nextBtn = document.getElementById('nextBtn');
            if (isFinalStep) {
                nextBtn.textContent = 'üéâ Finish Journey';
                nextBtn.onclick = finishJourney;
                nextBtn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            } else {
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = nextStep;
                nextBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            }
        }

        // Navigation control functions - USER CONTROLLED ONLY
        async function previousStep() {
            if (window.currentStepIndex > 0) {
                await updateCurrentStep(window.currentRoute, window.currentStepIndex - 1);
            }
        }

        async function nextStep() {
            if (window.currentStepIndex < window.currentRoute.steps.length - 1) {
                await updateCurrentStep(window.currentRoute, window.currentStepIndex + 1);
            }
        }

        // Finish Journey function
        function finishJourney() {
            const route = window.currentRoute;
            
            // Show completion message
            document.querySelector('.step-title').textContent = 'üéâ Journey Complete!';
            document.querySelector('.step-status').textContent = `You have arrived at ${route.destination}`;
            document.querySelector('.step-description').textContent = 'Congratulations! You have successfully completed your journey.';
            
            // Update landmark and departure info for completion
            document.querySelector('.landmark-title').textContent = '‚úÖ Destination';
            document.querySelector('.landmark-text').textContent = `Welcome to ${route.destination}!`;
            document.querySelector('.departure-title').textContent = 'üèÅ Arrival';
            document.querySelector('.departure-text').textContent = `Arrived at ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
            
            // Update the Finish Journey button to show completion
            const nextBtn = document.getElementById('nextBtn');
            nextBtn.textContent = '‚úÖ Completed';
            nextBtn.disabled = true;
            nextBtn.style.background = '#e2e8f0';
            nextBtn.style.color = '#a0aec0';
            
            // Disable Previous button as well
            document.getElementById('prevBtn').disabled = true;
            
            // Show a success message
            setTimeout(() => {
                alert('üéâ Congratulations! You have successfully completed your journey to ' + route.destination);
            }, 500);
        }

        // Get step icon
        function getStepIcon(stepType) {
            switch(stepType) {
                case 'walk': return 'üö∂';
                case 'metro': return 'üöá';
                case 'bus': return 'üöå';
                case 'rideshare': return 'üöó';
                default: return 'üìç';
            }
        }

        // Get step color
        function getStepColor(stepType) {
            switch(stepType) {
                case 'walk': return '#10b981';
                case 'metro': return '#ff0000';
                case 'bus': return '#ff6b35';
                case 'rideshare': return '#667eea';
                default: return '#667eea';
            }
        }

        // Get specific LA landmarks based on location and step type - FIXED for user-friendly navigation
        function getSpecificLandmarks(step, stepIndex, route) {
            const laLandmarks = {
                downtown: [
                    'Walk towards the main intersection with traffic lights',
                    'Cross at the marked pedestrian crossing - wait for walk signal',
                    'Continue straight on the sidewalk - keep to the right',
                    'Look for the Metro station entrance with red Metro sign',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station - cross safely',
                    'Walk past the library building - large brick structure',
                    'Cross the street at the marked crosswalk'
                ],
                hollywood: [
                    'Walk towards the main intersection ahead',
                    'Cross at the pedestrian crossing - wait for signal',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance with red sign',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                santaMonica: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                venice: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                beverlyHills: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                usc: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                ucla: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                koreatown: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                pasadena: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ],
                longBeach: [
                    'Walk towards the main intersection',
                    'Cross at the pedestrian crossing',
                    'Continue straight on the sidewalk',
                    'Look for the Metro station entrance',
                    'Pass by the shopping center on your left',
                    'Turn left at the gas station',
                    'Walk past the library building',
                    'Cross the street at the crosswalk'
                ]
            };

            // Determine area based on route destination
            let area = 'downtown'; // default
            const destination = route.destination.toLowerCase();
            
            if (destination.includes('hollywood')) area = 'hollywood';
            else if (destination.includes('santa monica')) area = 'santaMonica';
            else if (destination.includes('venice')) area = 'venice';
            else if (destination.includes('beverly hills')) area = 'beverlyHills';
            else if (destination.includes('usc')) area = 'usc';
            else if (destination.includes('ucla')) area = 'ucla';
            else if (destination.includes('koreatown')) area = 'koreatown';
            else if (destination.includes('pasadena')) area = 'pasadena';
            else if (destination.includes('long beach')) area = 'longBeach';

            const areaLandmarks = laLandmarks[area] || laLandmarks.downtown;
            return areaLandmarks[stepIndex % areaLandmarks.length];
        }

        // Enhanced landmarks function with step-appropriate landmarks
        function getLandmarksForStep(step, stepIndex) {
            // Get the current route from global variable
            const route = window.currentRoute;
            
            if (step.type === 'metro') {
                const metroLandmarks = [
                    'Look for the red Metro sign and escalator entrance',
                    'Enter through the glass doors - TAP card ready',
                    'Take escalator down to platform level',
                    'Wait at the marked platform area',
                    'Board when train arrives - check destination signs',
                    'Find a seat or hold the handrail',
                    'Listen for station announcements',
                    'Prepare to exit at your destination'
                ];
                return metroLandmarks[stepIndex % metroLandmarks.length];
            } else if (step.type === 'bus') {
                const busLandmarks = [
                    'Look for the blue Metro bus shelter',
                    'Check the bus route number on the sign',
                    'Signal the bus by raising your hand',
                    'Have exact fare or TAP card ready',
                    'Board through the front door',
                    'Pay fare and find a seat',
                    'Press the stop button when approaching destination',
                    'Exit through the rear door'
                ];
                return busLandmarks[stepIndex % busLandmarks.length];
            } else if (step.type === 'rideshare') {
                const rideshareLandmarks = [
                    'Open your ride-sharing app (Uber/Lyft/Waymo)',
                    'Enter your destination address',
                    'Select your preferred vehicle type',
                    'Confirm pickup location on the map',
                    'Wait for driver/vehicle to arrive',
                    'Check vehicle details and license plate',
                    'Enter the vehicle when it arrives',
                    'Enjoy your ride to destination'
                ];
                return rideshareLandmarks[stepIndex % rideshareLandmarks.length];
            } else {
                // For walking steps, use area-specific landmarks
                if (route) {
                    return getSpecificLandmarks(step, stepIndex, route);
                } else {
                    const walkLandmarks = [
                        'Walk towards the main intersection',
                        'Cross at the pedestrian crossing',
                        'Continue straight on the sidewalk',
                        'Look for the Metro station entrance',
                        'Pass by the shopping center on your left',
                        'Turn left at the gas station',
                        'Walk past the library building',
                        'Cross the street at the crosswalk'
                    ];
                    return walkLandmarks[stepIndex % walkLandmarks.length];
                }
            }
        }

        // Get detailed step description - IMPROVED with specific instructions
        function getDetailedStepDescription(step, stepIndex) {
            if (step.type === 'metro') {
                const metroDescriptions = [
                    'Enter the Metro station through the main entrance. Use your TAP card at the fare gate.',
                    'Take the escalator or elevator down to the platform level. Follow the signs.',
                    'Wait at the marked platform area. Check the electronic display for arrival times.',
                    'When the train arrives, board through the doors. Check the destination signs on the train.',
                    'Find a seat or hold onto the handrail. The train will depart shortly.',
                    'Stay on the train and listen for station announcements. Check the route map.',
                    'Prepare to exit when approaching your destination. Move towards the doors.',
                    'Exit the train when it stops. Follow the signs to the station exit.'
                ];
                return metroDescriptions[stepIndex % metroDescriptions.length];
            } else if (step.type === 'bus') {
                const busDescriptions = [
                    'Wait at the bus stop. Check the schedule display for arrival times.',
                    'When you see your bus approaching, signal it to stop by raising your hand.',
                    'Have your exact fare ready or ensure your TAP card has sufficient balance.',
                    'Board the bus through the front door. Pay your fare to the driver.',
                    'Find an available seat or hold onto the handrails if standing.',
                    'Listen for stop announcements and watch for your destination.',
                    'Press the stop button when approaching your destination.',
                    'Exit through the rear door when the bus stops.'
                ];
                return busDescriptions[stepIndex % busDescriptions.length];
            } else if (step.type === 'rideshare') {
                const rideshareDescriptions = [
                    'Open your ride-sharing app and ensure your location services are enabled.',
                    'Enter your destination address in the app. Double-check the address for accuracy.',
                    'Select your preferred vehicle type and service level (standard, XL, premium).',
                    'Review the estimated fare and confirm your pickup location on the map.',
                    'Wait for your driver or autonomous vehicle to arrive. Track their progress in the app.',
                    'When the vehicle arrives, verify the driver details and license plate number.',
                    'Enter the vehicle and confirm your destination with the driver or system.',
                    'Enjoy your ride! The app will notify you when you reach your destination.'
                ];
                return rideshareDescriptions[stepIndex % rideshareDescriptions.length];
            } else {
                const walkDescriptions = [
                    'Start walking towards the main intersection ahead. Stay on the sidewalk.',
                    'Cross the street at the marked pedestrian crossing. Wait for the walk signal.',
                    'Turn right at the traffic light. Continue on the sidewalk.',
                    'Walk straight ahead, keeping to the right side of the sidewalk.',
                    'Look for the Metro station entrance on your left. It will have a red Metro sign.',
                    'Pass by the shopping center on your left. Continue straight ahead.',
                    'Turn left at the gas station. Cross the side street safely.',
                    'Walk past the library building. The station is just ahead.',
                    'Cross the street at the marked crosswalk. Wait for the walk signal.',
                    'Look for the blue bus stop shelter. Your bus will arrive shortly.'
                ];
                return walkDescriptions[stepIndex % walkDescriptions.length];
            }
        }

        // Get live information
        function getLiveInfo(step, stepIndex) {
            const now = new Date();
            const liveUpdates = [
                'üìç Starting your journey...',
                'üö∂ Walking to the station...',
                '‚è∞ Arriving at station in 2 minutes...',
                'üöá Boarding the Metro...',
                'üöå Waiting for bus...',
                'üéØ Approaching destination...',
                '‚úÖ Almost there...',
                'üèÅ Arrived at destination!'
            ];
            
            return liveUpdates[stepIndex % liveUpdates.length];
        }

        // Exit navigation
        function exitNavigation() {
            const overlay = document.getElementById('navigationOverlay');
            if (overlay) {
                overlay.remove();
            }
            // Show search panel again
            document.getElementById('searchPanel').style.display = 'flex';
        }

        // Real Transit API Configuration with actual API keys
        const TRANSIT_APIS = {
            // LA Metro API (Real)
            laMetro: {
                baseUrl: 'https://developer.metro.net/api/',
                apiKey: 'b565d854fa4038e9c2b9eb1e4dd0179d',
                agencyKey: 'lametro',
                endpoints: {
                    tripUpdates: 'https://api.goswift.ly/realtime/gtfs-rt/tripupdates',
                    vehiclePositions: 'https://api.goswift.ly/realtime/gtfs-rt/vehiclepositions',
                    serviceAlerts: 'https://api.goswift.ly/realtime/gtfs-rt/alerts',
                    stopTimes: 'https://api.goswift.ly/realtime/gtfs-rt/stop-times'
                }
            },
            // Metrolink API (Real)
            metrolink: {
                baseUrl: 'https://metrolinktrains.com/about/gtfs/gtfs-rt-access/',
                apiKey: 'cX6kCPOm5c2px9VY1Jns73KOlHplmItA52CxtcnO',
                endpoints: {
                    tripUpdates: 'https://api.metrolinktrains.com/gtfs-rt/tripupdates',
                    vehiclePositions: 'https://api.metrolinktrains.com/gtfs-rt/vehiclepositions',
                    serviceAlerts: 'https://api.metrolinktrains.com/gtfs-rt/alerts'
                }
            },
            // Regional Transit Network API
            regional: {
                baseUrl: 'https://api.metrocloudalliance.com/v2/transitnetwork/',
                apiKey: 'demo',
                endpoints: {
                    carriers: 'carriers',
                    routes: 'routes',
                    stops: 'stops',
                    departures: 'departures'
                }
            }
        };

        // Enhanced API simulation with real LA Metro data structure
        async function fetchRealTimeDepartures(stationId, routeId, agency = 'lametro') {
            try {
                // Simulate real API response using actual LA Metro data structure
                console.log(`Simulating real-time data for ${agency} station ${stationId}, route ${routeId}`);
                
                const now = new Date();
                const simulatedDepartures = [];
                
                // Generate realistic departure times based on real LA Metro schedules
                for (let i = 0; i < 3; i++) {
                    const departureTime = new Date(now.getTime() + (i * 15 * 60000) + (Math.random() * 10 * 60000));
                    const minutesFromNow = Math.round((departureTime - now) / 60000);
                    
                    simulatedDepartures.push({
                        departure_time: departureTime.toISOString(),
                        arrival_time: new Date(departureTime.getTime() + (30 * 60000)).toISOString(),
                        platform: Math.floor(Math.random() * 3) + 1,
                        status: ['On Time', 'Delayed 2 min', 'Delayed 5 min'][Math.floor(Math.random() * 3)],
                        vehicle_id: `LA${Math.floor(Math.random() * 1000)}`,
                        trip_id: `trip_${routeId}_${Date.now()}_${i}`,
                        route_id: routeId,
                        stop_id: stationId,
                        agency_key: agency
                    });
                }
                
                console.log('Simulated real-time departures:', simulatedDepartures);
                return simulatedDepartures;
                
            } catch (error) {
                console.log('API simulation error:', error);
                return null;
            }
        }

        async function fetchServiceStatus(routeId, agency = 'lametro') {
            try {
                // Simulate real service status
                const statuses = ['On Time', 'Minor Delays', 'Major Delays', 'Service Suspended'];
                const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                
                console.log(`Simulating service status for ${agency} route ${routeId}: ${randomStatus}`);
                return randomStatus;
                
            } catch (error) {
                console.log('Service status simulation error:', error);
                return 'On Time';
            }
        }

        async function fetchBusTracking(routeId, agency = 'lametro') {
            try {
                // Simulate real bus tracking data
                const now = new Date();
                const simulatedVehicles = [];
                
                // Generate 2-4 buses per route
                const numBuses = Math.floor(Math.random() * 3) + 2;
                
                for (let i = 0; i < numBuses; i++) {
                    const arrivalTime = new Date(now.getTime() + (i * 8 * 60000) + (Math.random() * 5 * 60000));
                    const minutesFromNow = Math.round((arrivalTime - now) / 60000);
                    
                    simulatedVehicles.push({
                        vehicle_id: `bus_${routeId}_${i}`,
                        route_id: routeId,
                        arrival_time: arrivalTime.toISOString(),
                        minutes_from_now: minutesFromNow,
                        status: ['In Service', 'Approaching', 'At Stop'][Math.floor(Math.random() * 3)],
                        direction: ['Northbound', 'Southbound', 'Eastbound', 'Westbound'][Math.floor(Math.random() * 4)],
                        capacity: Math.floor(Math.random() * 50) + 20,
                        agency_key: agency
                    });
                }
                
                console.log('Simulated bus tracking data:', simulatedVehicles);
                return simulatedVehicles;
                
            } catch (error) {
                console.log('Bus tracking simulation error:', error);
                return [];
            }
        }

        // Enhanced departure information with REALISTIC simulated data
        async function getDepartureInfo(step, stepIndex) {
            if (step.type === 'metro' || step.type === 'bus') {
                const now = new Date();
                
                if (step.type === 'metro') {
                    // Real Metro line information with realistic data
                    const metroLines = [
                        { name: 'Red Line', stations: ['North Hollywood', 'Universal City', 'Hollywood/Highland', 'Hollywood/Vine', 'Hollywood/Western', 'Vermont/Sunset', 'Vermont/Santa Monica', 'Westlake/MacArthur Park', '7th Street/Metro Center', 'Pershing Square', 'Civic Center/Grand Park', 'Union Station'] },
                        { name: 'Purple Line', stations: ['Wilshire/Western', 'Wilshire/Normandie', 'Wilshire/Vermont', 'Westlake/MacArthur Park', '7th Street/Metro Center', 'Pershing Square', 'Civic Center/Grand Park', 'Union Station'] },
                        { name: 'Blue Line', stations: ['7th Street/Metro Center', 'Pico', 'Grand/LATTC', 'San Pedro', 'Washington', 'Vernon', 'Slauson', 'Florence', 'Firestone', '103rd Street', 'Wardlow', 'Del Amo', 'Artesia', 'Compton', 'Willowbrook', 'Long Beach'] },
                        { name: 'Green Line', stations: ['Redondo Beach', 'Douglas', 'El Segundo', 'Mariposa', 'Aviation/LAX', 'Hawthorne/Lennox', 'Crenshaw', 'Vermont/Athens', 'Harbor Freeway', 'Avalon', 'Willowbrook', 'Long Beach'] },
                        { name: 'Gold Line', stations: ['Atlantic', 'East LA Civic Center', 'Maravilla', 'Indiana', 'Soto', 'Mariachi Plaza', 'Pico/Aliso', 'Little Tokyo/Arts District', 'Union Station', 'Chinatown', 'Lincoln Heights', 'Heritage Square', 'Southwest Museum', 'Highland Park', 'South Pasadena', 'Fillmore', 'Del Mar', 'Memorial Park', 'Lake', 'Allen', 'Sierra Madre Villa', 'Arcadia', 'Monrovia', 'Duarte', 'Irwindale', 'Azusa Downtown', 'APU/Citrus College', 'Glendora', 'San Dimas', 'La Verne', 'Pomona Downtown', 'Claremont'] }
                    ];
                    
                    const selectedLine = metroLines[stepIndex % metroLines.length];
                    const stationIndex = stepIndex % selectedLine.stations.length;
                    const stationName = selectedLine.stations[stationIndex];
                    const nextStation = selectedLine.stations[Math.min(stationIndex + 1, selectedLine.stations.length - 1)];
                    
                    // Use your real API keys to simulate realistic data
                    const stationId = STATION_IDS[stationName];
                    const routeId = ROUTE_IDS[selectedLine.name];
                    
                    console.log(`Using real API structure for ${selectedLine.name} at ${stationName} (ID: ${stationId}, Route: ${routeId})`);
                    
                    // Simulate real-time departures using your API structure
                    const simulatedDepartures = await fetchRealTimeDepartures(stationId, routeId, 'lametro');
                    if (simulatedDepartures && simulatedDepartures.length > 0) {
                        const nextDeparture = simulatedDepartures[0];
                        const departureTime = new Date(nextDeparture.departure_time);
                        const minutesFromNow = Math.round((departureTime - now) / 60000);
                        
                        // Simulate service status
                        const serviceStatus = await fetchServiceStatus(routeId, 'lametro');
                        
                        console.log('Realistic departure data:', { departureTime, minutesFromNow, serviceStatus });
                        
                        return `${selectedLine.name} ‚Ä¢ ${stationName} Station ‚Ä¢ Departure: ${departureTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${minutesFromNow} min) ‚Ä¢ Platform ${nextDeparture.platform} ‚Ä¢ Status: ${serviceStatus} ‚Ä¢ Next: ${nextStation} ‚Ä¢ üî¥ REALISTIC DATA (API: ${TRANSIT_APIS.laMetro.apiKey})`;
                    }
                    
                    // Fallback to basic simulated data
                    const minutesFromNow = 3 + (stepIndex * 5) + Math.floor(Math.random() * 4);
                    const departureTime = new Date(now.getTime() + (minutesFromNow * 60000));
                    
                    return `${selectedLine.name} ‚Ä¢ ${stationName} Station ‚Ä¢ Departure: ${departureTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${minutesFromNow} min) ‚Ä¢ Platform ${(stepIndex % 3) + 1} ‚Ä¢ Next: ${nextStation} ‚Ä¢ ‚ö™ Basic Simulated`;
                    
                } else if (step.type === 'bus') {
                    // Real Bus route information with realistic data
                    const busRoutes = [
                        { number: '2', name: 'Sunset Blvd', direction: 'Downtown LA' },
                        { number: '4', name: 'Santa Monica Blvd', direction: 'West LA' },
                        { number: '10', name: 'West 3rd St', direction: 'Mid-City' },
                        { number: '14', name: 'Olympic Blvd', direction: 'Downtown LA' },
                        { number: '16', name: '3rd St', direction: 'West LA' },
                        { number: '18', name: 'Century Blvd', direction: 'LAX' },
                        { number: '20', name: 'Wilshire Blvd', direction: 'Santa Monica' },
                        { number: '28', name: 'Pico Blvd', direction: 'West LA' },
                        { number: '33', name: 'Venice Blvd', direction: 'Venice Beach' },
                        { number: '37', name: 'Crenshaw Blvd', direction: 'South LA' },
                        { number: '40', name: 'La Cienega Blvd', direction: 'West LA' },
                        { number: '45', name: 'Vermont Ave', direction: 'South LA' },
                        { number: '55', name: 'Century Blvd', direction: 'LAX' },
                        { number: '60', name: 'Slauson Ave', direction: 'South LA' },
                        { number: '66', name: 'Hollywood Blvd', direction: 'Hollywood' },
                        { number: '70', name: 'Ventura Blvd', direction: 'Studio City' },
                        { number: '92', name: 'Burbank Blvd', direction: 'Burbank' },
                        { number: '94', name: 'Sherman Way', direction: 'Northridge' },
                        { number: '96', name: 'Reseda Blvd', direction: 'Northridge' },
                        { number: '150', name: 'Ventura Blvd Express', direction: 'Studio City' },
                        { number: '217', name: 'Topanga Canyon Blvd', direction: 'Woodland Hills' },
                        { number: '240', name: 'Van Nuys Blvd', direction: 'Van Nuys' },
                        { number: '244', name: 'Woodman Ave', direction: 'Sherman Oaks' },
                        { number: '302', name: 'Sunset Blvd Rapid', direction: 'Downtown LA' },
                        { number: '704', name: 'Santa Monica Blvd Rapid', direction: 'West LA' },
                        { number: '720', name: 'Wilshire Blvd Rapid', direction: 'Santa Monica' },
                        { number: '754', name: 'Ventura Blvd Rapid', direction: 'Studio City' },
                        { number: '761', name: 'Reseda Blvd Rapid', direction: 'Northridge' }
                    ];
                    
                    const selectedRoute = busRoutes[stepIndex % busRoutes.length];
                    const busStops = [
                        'Sunset & Vine', 'Hollywood & Highland', 'Wilshire & Western', 'Pico & La Brea',
                        'Olympic & La Cienega', 'Venice & La Brea', 'Century & Aviation', 'Ventura & Laurel Canyon',
                        'Sherman Way & Reseda', 'Van Nuys & Victory', 'Woodman & Ventura', 'Topanga & Ventura'
                    ];
                    
                    const stopName = busStops[stepIndex % busStops.length];
                    const nextStop = busStops[(stepIndex + 1) % busStops.length];
                    
                    // Use your real API structure
                    const routeId = ROUTE_IDS[`Bus ${selectedRoute.number}`];
                    
                    console.log(`Using real API structure for Bus ${selectedRoute.number} at ${stopName} (Route: ${routeId})`);
                    
                    // Simulate real-time bus tracking
                    const busVehicles = await fetchBusTracking(routeId, 'lametro');
                    if (busVehicles && busVehicles.length > 0) {
                        const nearestBus = busVehicles[0];
                        const arrivalTime = new Date(nearestBus.arrival_time);
                        const minutesFromNow = nearestBus.minutes_from_now;
                        
                        // Simulate service status
                        const serviceStatus = await fetchServiceStatus(routeId, 'lametro');
                        
                        console.log('Realistic bus data:', { arrivalTime, minutesFromNow, serviceStatus });
                        
                        return `Bus ${selectedRoute.number} (${selectedRoute.name}) ‚Ä¢ ${stopName} ‚Ä¢ Arrival: ${arrivalTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${minutesFromNow} min) ‚Ä¢ Direction: ${selectedRoute.direction} ‚Ä¢ Status: ${serviceStatus} ‚Ä¢ Next: ${nextStop} ‚Ä¢ üî¥ REALISTIC DATA (API: ${TRANSIT_APIS.laMetro.apiKey})`;
                    }
                    
                    // Fallback to basic simulated data
                    const minutesFromNow = 3 + (stepIndex * 7) + Math.floor(Math.random() * 4);
                    const departureTime = new Date(now.getTime() + (minutesFromNow * 60000));
                    
                    return `Bus ${selectedRoute.number} (${selectedRoute.name}) ‚Ä¢ ${stopName} ‚Ä¢ Departure: ${departureTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} (${minutesFromNow} min) ‚Ä¢ Direction: ${selectedRoute.direction} ‚Ä¢ Next: ${nextStop} ‚Ä¢ ‚ö™ Basic Simulated`;
                } else if (step.type === 'rideshare') {
                    const now = new Date();
                    const route = window.currentRoute;
                    
                    if (route && route.system) {
                        const waitTime = step.details ? step.details.waitTime : '2-5 min';
                        const vehicleType = step.details ? step.details.vehicleType : 'Standard vehicle';
                        const estimatedCost = step.details ? step.details.estimatedCost : '$15-25';
                        
                        return `${route.systemName} ‚Ä¢ Available Now ‚Ä¢ Wait: ${waitTime} ‚Ä¢ Vehicle: ${vehicleType} ‚Ä¢ Est. Cost: ${estimatedCost} ‚Ä¢ 24/7 Service`;
                    }
                    
                    return 'Ride-sharing ‚Ä¢ Available Now ‚Ä¢ 2-5 min wait ‚Ä¢ Standard vehicle ‚Ä¢ $15-25 estimated cost';
                }
            }
            return 'Walking to destination - no transit required';
        }

        // Station ID mapping for real API calls
        const STATION_IDS = {
            'North Hollywood': '80101',
            'Universal City': '80102',
            'Hollywood/Highland': '80103',
            'Hollywood/Vine': '80104',
            'Hollywood/Western': '80105',
            'Vermont/Sunset': '80106',
            'Vermont/Santa Monica': '80107',
            'Westlake/MacArthur Park': '80108',
            '7th Street/Metro Center': '80109',
            'Pershing Square': '80110',
            'Civic Center/Grand Park': '80111',
            'Union Station': '80112',
            'Wilshire/Western': '80201',
            'Wilshire/Normandie': '80202',
            'Wilshire/Vermont': '80203',
            'Pico': '80301',
            'Grand/LATTC': '80302',
            'San Pedro': '80303',
            'Washington': '80304',
            'Vernon': '80305',
            'Slauson': '80306',
            'Florence': '80307',
            'Firestone': '80308',
            '103rd Street': '80309',
            'Wardlow': '80310',
            'Del Amo': '80311',
            'Artesia': '80312',
            'Compton': '80313',
            'Willowbrook': '80314',
            'Long Beach': '80315'
        };

        // Route ID mapping for real API calls
        const ROUTE_IDS = {
            'Red Line': '801',
            'Purple Line': '802',
            'Blue Line': '803',
            'Green Line': '804',
            'Gold Line': '805',
            'Bus 2': '2',
            'Bus 4': '4',
            'Bus 10': '10',
            'Bus 14': '14',
            'Bus 16': '16',
            'Bus 18': '18',
            'Bus 20': '20',
            'Bus 28': '28',
            'Bus 33': '33',
            'Bus 37': '37',
            'Bus 40': '40',
            'Bus 45': '45',
            'Bus 55': '55',
            'Bus 60': '60',
            'Bus 66': '66',
            'Bus 70': '70',
            'Bus 92': '92',
            'Bus 94': '94',
            'Bus 96': '96',
            'Bus 150': '150',
            'Bus 217': '217',
            'Bus 240': '240',
            'Bus 244': '244',
            'Bus 302': '302',
            'Bus 704': '704',
            'Bus 720': '720',
            'Bus 754': '754',
            'Bus 761': '761'
        };

        // Location sharing variables
        let currentLocation = null;
        let selectedShareOption = null;
        let selectedDuration = 30; // Default 30 minutes
        let locationTrackingInterval = null;
        let sharingSessionId = null;

        // Toggle location sharing panel
        function toggleLocationShare() {
            const sharePanel = document.getElementById('locationSharePanel');
            if (sharePanel.style.display === 'none' || !sharePanel.style.display) {
                sharePanel.style.display = 'flex';
                getCurrentLocationForSharing();
            } else {
                sharePanel.style.display = 'none';
                stopLocationTracking();
            }
        }

        // Get current location for sharing with real-time geocoding
        async function getCurrentLocationForSharing() {
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = '<div>üìç Getting your location...</div>';
            statusDiv.className = 'location-status';
            
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) {
                    statusDiv.innerHTML = `
                        <div class="location-status error">
                            <div>‚ùå GPS not supported</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Please use a different browser</div>
                        </div>
                    `;
                    statusDiv.className = 'location-status error';
                    reject(new Error('Geolocation not supported'));
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const accuracy = position.coords.accuracy;
                        
                        try {
                            // Use the same robust geocoding as the chatbot
                            const address = await getBetterAddress(lat, lng, accuracy);
                            
                            // Set location
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                address: address,
                                accuracy: accuracy,
                                timestamp: new Date().toISOString()
                            };
                            
                            // Format display with coordinates and accuracy
                            const displayText = formatLocationDisplay(address, lat, lng, accuracy);
                            
                            // Add GPS accuracy tips if accuracy is poor
                            let statusMessage = `‚úÖ Location found!`;
                            if (accuracy && !isGPSAccuracyAcceptable(accuracy)) {
                                statusMessage = `‚ö†Ô∏è Location found (poor accuracy)`;
                            }
                            
                            // Update UI with location
                            statusDiv.innerHTML = `
                                <div class="location-status success">
                                    <div>${statusMessage}</div>
                                    <div style="font-size: 0.9rem; margin-top: 0.5rem; white-space: pre-line;">${displayText}</div>
                                    ${accuracy && !isGPSAccuracyAcceptable(accuracy) ? 
                                        `<div style="font-size: 0.8rem; margin-top: 0.5rem; color: #dc2626; white-space: pre-line;">${getGPSAccuracyTips(accuracy)}</div>` : 
                                        ''
                                    }
                                </div>
                            `;
                            statusDiv.className = 'location-status success';
                            
                            // Enable share button
                            document.getElementById('shareBtn').disabled = false;
                            
                            resolve({
                                lat: lat,
                                lng: lng,
                                address: address,
                                accuracy: accuracy
                            });
                        } catch (error) {
                            console.log('Geocoding failed, using coordinates');
                            
                            // Set location with coordinates
                            currentLocation = {
                                lat: lat,
                                lng: lng,
                                address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                accuracy: accuracy,
                                timestamp: new Date().toISOString()
                            };
                            
                            // Format display with coordinates and accuracy
                            const displayText = formatLocationDisplay(`${lat.toFixed(4)}, ${lng.toFixed(4)}`, lat, lng, accuracy);
                            
                            // Update UI with coordinates
                            statusDiv.innerHTML = `
                                <div class="location-status success">
                                    <div>‚úÖ Location found!</div>
                                    <div style="font-size: 0.9rem; margin-top: 0.5rem; white-space: pre-line;">${displayText}</div>
                                </div>
                            `;
                            statusDiv.className = 'location-status success';
                            
                            // Enable share button
                            document.getElementById('shareBtn').disabled = false;
                            
                            resolve({
                                lat: lat,
                                lng: lng,
                                address: `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                accuracy: accuracy
                            });
                        }
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        statusDiv.innerHTML = `
                            <div class="location-status error">
                                <div>‚ùå Could not get your location</div>
                                <div style="font-size: 0.9rem; margin-top: 0.5rem;">Please check your browser permissions</div>
                            </div>
                        `;
                        statusDiv.className = 'location-status error';
                        reject(error);
                    },
                    {
                        timeout: 15000, // 15 second timeout for GPS
                        enableHighAccuracy: true, // Request high accuracy to trigger permissions
                        maximumAge: 0 // Don't use cached location
                    }
                );
            });
        }

        // Select sharing option
        function selectShareOption(option) {
            selectedShareOption = option;
            
            // Update UI
            document.querySelectorAll('.share-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Select duration
        function selectDuration(minutes) {
            selectedDuration = minutes;
            
            // Update UI
            document.querySelectorAll('.duration-option').forEach(el => {
                el.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Share location
        function shareLocation() {
            if (!currentLocation || !selectedShareOption) {
                alert('Please select a sharing option and ensure location is available.');
                return;
            }
            
            const contact = document.getElementById('contactInput').value.trim();
            if (!contact) {
                alert('Please enter a contact (email, phone, or name).');
                return;
            }
            
            // Generate unique session ID
            sharingSessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Start location tracking
            startLocationTracking();
            
            // Share based on selected option
            switch (selectedShareOption) {
                case 'email':
                    shareViaEmail(contact);
                    break;
                case 'sms':
                    shareViaSMS(contact);
                    break;
                case 'whatsapp':
                    shareViaWhatsApp(contact);
                    break;
                case 'link':
                    shareViaLink(contact);
                    break;
            }
        }

        // Start location tracking
        function startLocationTracking() {
            // Store initial location
            const trackingData = {
                sessionId: sharingSessionId,
                startTime: new Date().toISOString(),
                endTime: new Date(Date.now() + selectedDuration * 60000).toISOString(),
                duration: selectedDuration,
                locations: [currentLocation]
            };
            
            localStorage.setItem(`location_tracking_${sharingSessionId}`, JSON.stringify(trackingData));
            
            // Update location every 30 seconds
            locationTrackingInterval = setInterval(() => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        async function(position) {
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            
                            try {
                                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                                const data = await response.json();
                                
                                const newLocation = {
                                    lat: lat,
                                    lng: lng,
                                    address: data.display_name || `${lat.toFixed(4)}, ${lng.toFixed(4)}`,
                                    timestamp: new Date().toISOString()
                                };
                                
                                // Update stored data
                                const storedData = JSON.parse(localStorage.getItem(`location_tracking_${sharingSessionId}`));
                                storedData.locations.push(newLocation);
                                localStorage.setItem(`location_tracking_${sharingSessionId}`, JSON.stringify(storedData));
                                
                                // Update current location
                                currentLocation = newLocation;
                                
                            } catch (error) {
                                console.error('Error updating location:', error);
                            }
                        },
                        function(error) {
                            console.error('Error getting updated location:', error);
                        }
                    );
                }
            }, 30000); // Update every 30 seconds
            
            // Auto-stop tracking after duration
            setTimeout(() => {
                stopLocationTracking();
            }, selectedDuration * 60000);
        }

        // Stop location tracking
        function stopLocationTracking() {
            if (locationTrackingInterval) {
                clearInterval(locationTrackingInterval);
                locationTrackingInterval = null;
            }
            
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = `
                <div class="location-status">
                    <div>üìç Location sharing stopped</div>
                </div>
            `;
            statusDiv.className = 'location-status';
        }

        // Share via email
        function shareViaEmail(contact) {
            const subject = 'Live Location Sharing';
            const body = `Hi ${contact},

I'm sharing my live location with you for the next ${selectedDuration} minutes.

üìç Current Location: ${currentLocation.address}
üîó Tracking Link: ${window.location.origin}${window.location.pathname}?track=${sharingSessionId}
‚è∞ Duration: ${selectedDuration} minutes
üïí Started: ${new Date().toLocaleString()}

You can track my location in real-time using the link above.

Best regards,
${prompt('Enter your name:', 'Your Name') || 'Your Name'}`;

            const mailtoLink = `mailto:${contact}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.open(mailtoLink);
            
            showSuccessMessage('Email draft opened! Please send the email manually.');
        }

        // Share via SMS
        function shareViaSMS(contact) {
            const message = `Hi ${contact}! I'm sharing my live location for ${selectedDuration} minutes. Track me here: ${window.location.origin}${window.location.pathname}?track=${sharingSessionId}`;
            
            const smsLink = `sms:${contact}?body=${encodeURIComponent(message)}`;
            window.open(smsLink);
            
            showSuccessMessage('SMS draft opened! Please send the message manually.');
        }

        // Share via WhatsApp
        function shareViaWhatsApp(contact) {
            const message = `Hi ${contact}! I'm sharing my live location for ${selectedDuration} minutes. Track me here: ${window.location.origin}${window.location.pathname}?track=${sharingSessionId}`;
            
            const whatsappLink = `https://wa.me/${contact.replace(/\D/g, '')}?text=${encodeURIComponent(message)}`;
            window.open(whatsappLink);
            
            showSuccessMessage('WhatsApp opened! Please send the message manually.');
        }

        // Share via link
        function shareViaLink(contact) {
            const trackingUrl = `${window.location.origin}${window.location.pathname}?track=${sharingSessionId}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(trackingUrl).then(() => {
                showSuccessMessage('Tracking link copied to clipboard!');
            }).catch(() => {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = trackingUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showSuccessMessage('Tracking link copied to clipboard!');
            });
        }

        // Show success message
        function showSuccessMessage(message) {
            const statusDiv = document.getElementById('locationStatus');
            statusDiv.innerHTML = `
                <div class="location-status success">
                    <div>‚úÖ ${message}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">Location tracking active for ${selectedDuration} minutes</div>
                </div>
            `;
            statusDiv.className = 'location-status success';
        }

        // Check for tracking parameter on page load
        function checkForTracking() {
            const urlParams = new URLSearchParams(window.location.search);
            const trackId = urlParams.get('track');
            
            if (trackId) {
                // Show tracking interface
                showTrackingInterface(trackId);
            }
        }

        // Show tracking interface
        function showTrackingInterface(trackId) {
            // Hide main content
            document.querySelector('.main-content').style.display = 'none';
            document.querySelector('.header').style.display = 'none';
            
            // Create tracking interface
            const trackingDiv = document.createElement('div');
            trackingDiv.id = 'trackingInterface';
            trackingDiv.innerHTML = `
                <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 2rem;">
                    <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">üìç Live Location Tracking</h1>
                    <div id="trackingStatus" style="font-size: 1.2rem; margin-bottom: 2rem;">Loading location data...</div>
                    <div id="trackingMap" style="width: 100%; height: 400px; border-radius: 16px; overflow: hidden; margin-bottom: 2rem;"></div>
                    <button onclick="window.location.href='${window.location.pathname}'" style="background: rgba(255,255,255,0.2); border: none; color: white; padding: 1rem 2rem; border-radius: 12px; cursor: pointer; font-size: 1.1rem;">‚Üê Back to App</button>
                </div>
            `;
            document.body.appendChild(trackingDiv);
            
            // Start tracking updates
            updateTrackingLocation(trackId);
        }

        // Update tracking location
        function updateTrackingLocation(trackId) {
            const storedData = localStorage.getItem(`location_tracking_${trackId}`);
            
            if (storedData) {
                const data = JSON.parse(storedData);
                const latestLocation = data.locations[data.locations.length - 1];
                
                const statusDiv = document.getElementById('trackingStatus');
                statusDiv.innerHTML = `
                    <div>üìç Current Location: ${latestLocation.address}</div>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem;">Last updated: ${new Date(latestLocation.timestamp).toLocaleString()}</div>
                `;
                
                // Update map if available
                if (window.trackingMap) {
                    window.trackingMap.setView([latestLocation.lat, latestLocation.lng], 15);
                    // Update marker position
                }
            } else {
                document.getElementById('trackingStatus').innerHTML = 'Location data not found or expired.';
            }
            
            // Update every 30 seconds
            setTimeout(() => updateTrackingLocation(trackId), 30000);
        }

        // Initialize tracking check on page load - REMOVED DUPLICATE
        // document.addEventListener('DOMContentLoaded', function() {
        //     if (!map) {
        //         initializeMap();
        //     }
        //     checkForTracking();
        //     initializeChatbot();
        // });

        // AI Chatbot Variables
        let chatbotMessages = [];
        let isChatbotOpen = false;
        let isTyping = false;
        let currentLanguage = null; // Track current language (en/es) - start with null to force language selection

        // Language detection function - NEW!
        function detectLanguage(message) {
            const spanishWords = [
                'hola', 'buenos', 'd√≠as', 'tardes', 'noches', 'gracias', 'por favor', 'c√≥mo', 'est√°s',
                'd√≥nde', 'cu√°ndo', 'qu√©', 'cu√°l', 'metro', 'autob√∫s', 'estaci√≥n', 'ruta', 'direcci√≥n',
                'precio', 'costo', 'dinero', 'tiempo', 'horario', 'ayuda', 'informaci√≥n', 'viaje',
                'destino', 'origen', 'cerca', 'lejos', 'r√°pido', 'lento', 'f√°cil', 'dif√≠cil'
            ];
            
            const lowerMessage = message.toLowerCase();
            let spanishCount = 0;
            
            spanishWords.forEach(word => {
                if (lowerMessage.includes(word)) {
                    spanishCount++;
                }
            });
            
            // If more than 2 Spanish words detected, switch to Spanish
            if (spanishCount >= 2) {
                currentLanguage = 'es';
                return 'es';
            }
            
            // Check for common Spanish greetings
            if (lowerMessage.includes('hola') || lowerMessage.includes('buenos') || 
                lowerMessage.includes('buenas') || lowerMessage.includes('adi√≥s')) {
                currentLanguage = 'es';
                return 'es';
            }
            
            return 'en'; // Default to English
        }

        // Bilingual response function - NEW!
        function getBilingualResponse(englishResponse, spanishResponse) {
            return currentLanguage === 'es' ? spanishResponse : englishResponse;
        }

        // Hugging Face API Configuration
        const HUGGING_FACE_CONFIG = {
            // Using a powerful text generation model for intelligent responses
            model: 'facebook/bart-large-mnli', // Reliable classification model
            apiUrl: 'https://api-inference.huggingface.co/models/facebook/bart-large-mnli',
            token: 'YOUR_HUGGING_FACE_TOKEN_HERE', // User's working token
            // Alternative models we can use:
            // 'gpt2': 'https://api-inference.huggingface.co/models/gpt2',
            // 'microsoft/DialoGPT-large': 'https://api-inference.huggingface.co/models/microsoft/DialoGPT-large',
            // 'facebook/blenderbot-400M-distill': 'https://api-inference.huggingface.co/models/facebook/blenderbot-400M-distill'
        };

        // Initialize chatbot
        function initializeChatbot() {
            // Add language selection message first
            addBotMessage(`Welcome! üëã ¬°Bienvenido!

Please choose your preferred language / Por favor elige tu idioma preferido:

üá∫üá∏ **English** - I'll help you navigate LA in English
üá™üá∏ **Espa√±ol** - Te ayudo a navegar LA en espa√±ol

Click one of the options below to get started! üòä`, [
                'üá∫üá∏ English',
                'üá™üá∏ Espa√±ol'
            ]);
        }

        // Toggle chatbot
        function toggleChatbot() {
            const panel = document.getElementById('chatbotPanel');
            const button = document.getElementById('chatbotButton');
            
            if (isChatbotOpen) {
                panel.style.display = 'none';
                button.innerHTML = 'ü§ñ';
                isChatbotOpen = false;
            } else {
                panel.style.display = 'flex';
                button.innerHTML = '‚úï';
                isChatbotOpen = true;
                document.getElementById('chatbotInput').focus();
            }
        }

        // Handle chatbot key press
        function handleChatbotKeyPress(event) {
            if (event.key === 'Enter') {
                sendChatbotMessage();
            }
        }

        // Send chatbot message - SIMPLIFIED and RELIABLE
        async function sendChatbotMessage(messageText = null) {
            const input = document.getElementById('chatbotInput');
            const message = messageText || input.value.trim();
            
            if (!message || isTyping) return;
            
            // Add user message
            addUserMessage(message);
            input.value = '';
            
            // Show typing indicator
            showTypingIndicator();
            
            try {
                // Use simple, reliable response system
                let response;
                
                // Try AI first, but fallback quickly if it fails
                if (window.aiAssistant) {
                    try {
                        const aiResponse = await Promise.race([
                            window.aiAssistant.getIntelligentResponse(message, {
                                currentMode: currentMode,
                                timeOfDay: new Date().getHours()
                            }),
                            new Promise((_, reject) => setTimeout(() => reject('timeout'), 3000))
                        ]);
                        
                        if (aiResponse && aiResponse.message) {
                            response = aiResponse;
                        } else {
                            throw new Error('Invalid AI response');
                        }
                        
                    } catch (aiError) {
                        console.log('AI response failed, using fallback:', aiError);
                        response = getFallbackResponse(message);
                    }
                } else {
                    response = getFallbackResponse(message);
                }
                
                hideTypingIndicator();
                
                // Add bot response
                if (response && response.message) {
                    addBotMessage(response.message, response.quickActions || []);
                } else {
                    addBotMessage("I'm here to help! What would you like to know about LA transit? üòä");
                }
                
                // Execute any actions
                if (response && response.action) {
                    executeChatbotAction(response.action);
                }
                
            } catch (error) {
                console.error('Chatbot error:', error);
                hideTypingIndicator();
                
                // Provide a helpful fallback response
                const fallbackResponse = getFallbackResponse(message);
                addBotMessage(fallbackResponse.message, fallbackResponse.quickActions);
            }
        }

        // Process user message with AI - ENHANCED for language selection first
        async function processUserMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Debug: Log current language state
            console.log('Processing message:', message, 'Current language:', currentLanguage);
            
            // Handle language selection first
            if (lowerMessage.includes('english') || lowerMessage.includes('üá∫üá∏') || lowerMessage.includes('ingl√©s')) {
                currentLanguage = 'en';
                console.log('Language set to English');
                return {
                    message: `Perfect! üá∫üá∏ I'll help you in English from now on!

I'm your friendly LA Transit assistant! I'm here to chat and help you navigate around LA. Feel free to ask me anything - whether it's about routes, places, or just say hi! üòä

Try asking me:
‚Ä¢ "Hi, how are you?"
‚Ä¢ "How do I get to Hollywood?"
‚Ä¢ "What's the best way to LAX?"
‚Ä¢ "Tell me about LA Metro"
‚Ä¢ "How much does it cost?"

What's on your mind today? üöÄ`,
                    quickActions: ['Hi there!', 'Plan a route', 'Find station', 'Tell me about LA', 'How much does it cost?']
                };
            }
            
            if (lowerMessage.includes('espa√±ol') || lowerMessage.includes('üá™üá∏') || lowerMessage.includes('spanish')) {
                currentLanguage = 'es';
                console.log('Language set to Spanish');
                return {
                    message: `¬°Perfecto! üá™üá∏ ¬°Te ayudo en espa√±ol de ahora en adelante!

¬°Soy tu asistente amigable de tr√°nsito de LA! Estoy aqu√≠ para charlar y ayudarte a navegar por LA. ¬°Preg√∫ntame lo que quieras sobre rutas, lugares o solo di hola! üòä

Preg√∫ntame:
‚Ä¢ "Hola, ¬øc√≥mo est√°s?"
‚Ä¢ "¬øC√≥mo llego a Hollywood?"
‚Ä¢ "¬øCu√°l es la mejor manera de llegar al LAX?"
‚Ä¢ "Cu√©ntame sobre el Metro de LA"
‚Ä¢ "¬øCu√°nto cuesta?"

¬øQu√© tienes en mente hoy? üöÄ`,
                    quickActions: ['¬°Hola!', 'Planear ruta', 'Encontrar estaci√≥n', 'Cu√©ntame sobre LA', '¬øCu√°nto cuesta?']
                };
            }
            
            // If no language is set yet, ask for language selection
            if (!currentLanguage) {
                console.log('No language set, asking for selection');
                return {
                    message: `Please choose your language first / Por favor elige tu idioma primero:

üá∫üá∏ **English** - I'll help you navigate LA in English
üá™üá∏ **Espa√±ol** - Te ayudo a navegar LA en espa√±ol

Click one of the options below! üòä`,
                    quickActions: ['üá∫üá∏ English', 'üá™üá∏ Espa√±ol']
                };
            }
            
            // Now handle conversations based on selected language
            // Handle casual greetings and conversation
            if (lowerMessage.includes('hi') || lowerMessage.includes('hello') || lowerMessage.includes('hey') ||
                lowerMessage.includes('hola') || lowerMessage.includes('buenos') || lowerMessage.includes('buenas')) {
                return handleGreetings(message);
            }
            
            // Handle "how are you" and similar personal questions
            if (lowerMessage.includes('how are you') || lowerMessage.includes('how\'re you') || 
                lowerMessage.includes('what\'s up') || lowerMessage.includes('whats up') ||
                lowerMessage.includes('c√≥mo est√°s') || lowerMessage.includes('qu√© tal') || 
                lowerMessage.includes('c√≥mo te va')) {
                return handlePersonalQuestions(message);
            }
            
            // Handle current location requests - ENHANCED INTELLIGENCE
            if (lowerMessage.includes('current location') || lowerMessage.includes('where am i') || 
                lowerMessage.includes('my location') || lowerMessage.includes('where i am') ||
                lowerMessage.includes('what\'s my location') || lowerMessage.includes('whats my location') ||
                lowerMessage.includes('show my location') || lowerMessage.includes('get my location') ||
                lowerMessage.includes('find my location') || lowerMessage.includes('locate me') ||
                lowerMessage.includes('my current position') || lowerMessage.includes('where am i now') ||
                lowerMessage.includes('what is my current location') || lowerMessage.includes('tell me where i am') ||
                lowerMessage.includes('ubicaci√≥n actual') || lowerMessage.includes('d√≥nde estoy') ||
                lowerMessage.includes('mi ubicaci√≥n') || lowerMessage.includes('d√≥nde me encuentro') ||
                lowerMessage.includes('cu√°l es mi ubicaci√≥n') || lowerMessage.includes('mu√©strame mi ubicaci√≥n') ||
                lowerMessage.includes('encuentra mi ubicaci√≥n') || lowerMessage.includes('local√≠zame')) {
                return handleCurrentLocationRequest(message);
            }
            
            // Handle nearest station requests - ENHANCED INTELLIGENCE
            if (lowerMessage.includes('nearest station') || lowerMessage.includes('closest station') ||
                lowerMessage.includes('nearby station') || lowerMessage.includes('station near me') ||
                lowerMessage.includes('metro near me') || lowerMessage.includes('bus stop near me') ||
                lowerMessage.includes('find station') || lowerMessage.includes('find metro') ||
                lowerMessage.includes('find bus') || lowerMessage.includes('station nearby') ||
                lowerMessage.includes('estaci√≥n m√°s cercana') || lowerMessage.includes('estaci√≥n cercana') ||
                lowerMessage.includes('metro cerca') || lowerMessage.includes('parada de autob√∫s cerca') ||
                lowerMessage.includes('encontrar estaci√≥n') || lowerMessage.includes('encontrar metro')) {
                return handleNearestStationRequest(message);
            }
            
            // Handle app information questions
            if (lowerMessage.includes('tell me about') || lowerMessage.includes('what is this app') || 
                lowerMessage.includes('what can you do') || lowerMessage.includes('features') ||
                lowerMessage.includes('cu√©ntame sobre') || lowerMessage.includes('qu√© puede hacer') ||
                lowerMessage.includes('funciones')) {
                return handleAppInfoQuestions(message);
            }
            
            // Handle casual conversation
            if (lowerMessage.includes('nice') || lowerMessage.includes('cool') || lowerMessage.includes('awesome') ||
                lowerMessage.includes('great') || lowerMessage.includes('thanks') || lowerMessage.includes('thank you') ||
                lowerMessage.includes('gracias') || lowerMessage.includes('genial') || lowerMessage.includes('excelente')) {
                return handlePositiveFeedback(message);
            }
            
            // Handle navigation back to main menu
            if (lowerMessage.includes('back to main menu') || lowerMessage.includes('main menu') ||
                lowerMessage.includes('men√∫ principal') || lowerMessage.includes('volver')) {
                return {
                    message: getBilingualResponse(
                        `Hey there! üëã I'm your friendly LA Transit assistant! 

I'm here to chat and help you navigate around LA. Feel free to ask me anything - whether it's about routes, places, or just say hi! üòä

What's on your mind today? üöÄ`,
                        `¬°Hola! üëã ¬°Soy tu asistente amigable de tr√°nsito de LA!

Estoy aqu√≠ para charlar y ayudarte a navegar por LA. ¬°Preg√∫ntame lo que quieras sobre rutas, lugares o solo di hola! üòä

¬øQu√© tienes en mente hoy? üöÄ`
                    ),
                    quickActions: getBilingualResponse(
                        ['Hi there!', 'Plan a route', 'Find station', 'Tell me about LA', 'How much does it cost?'],
                        ['¬°Hola!', 'Planear ruta', 'Encontrar estaci√≥n', 'Cu√©ntame sobre LA', '¬øCu√°nto cuesta?']
                    )
                };
            }
            
            // Route planning patterns
            if (lowerMessage.includes('plan') || lowerMessage.includes('route') || lowerMessage.includes('get to') || lowerMessage.includes('how to') || 
                (lowerMessage.includes('from') && lowerMessage.includes('to')) || lowerMessage.includes('custom route') ||
                lowerMessage.includes('planear') || lowerMessage.includes('ruta') || lowerMessage.includes('llegar') ||
                lowerMessage.includes('c√≥mo') || lowerMessage.includes('desde') || lowerMessage.includes('hasta')) {
                return {
                    message: getBilingualResponse(
                        "Great! I can help you plan a route. Choose from these popular LA routes, or plan a custom route: üòä",
                        "¬°Genial! Puedo ayudarte a planificar una ruta. Elige de estas rutas populares de LA, o planifica una ruta personalizada: üòä"
                    ),
                    quickActions: getBilingualResponse(
                        ['USC to Santa Monica', 'LAX to Downtown', 'Downtown to Hollywood', 'Beverly Hills to Venice', 'Pasadena to Downtown', 'Custom route'],
                        ['USC a Santa M√≥nica', 'LAX a Downtown', 'Downtown a Hollywood', 'Beverly Hills a Venice', 'Pasadena a Downtown', 'Ruta personalizada']
                    )
                };
            }
            
            // Location search patterns - ENHANCED INTELLIGENCE
            if (lowerMessage.includes('find') || lowerMessage.includes('where is') || lowerMessage.includes('nearest') || 
                lowerMessage.includes('station') || lowerMessage.includes('location') || lowerMessage.includes('place') ||
                lowerMessage.includes('encontrar') || lowerMessage.includes('d√≥nde est√°') || lowerMessage.includes('cerca') ||
                lowerMessage.includes('estaci√≥n') || lowerMessage.includes('ubicaci√≥n') || lowerMessage.includes('lugar')) {
                return await handleLocationSearch(message);
            }
            
            // Schedule patterns
            if (lowerMessage.includes('schedule') || lowerMessage.includes('time') || lowerMessage.includes('when') || 
                lowerMessage.includes('departure') || lowerMessage.includes('fare') || lowerMessage.includes('cost') ||
                lowerMessage.includes('horario') || lowerMessage.includes('tiempo') || lowerMessage.includes('cu√°ndo') ||
                lowerMessage.includes('salida') || lowerMessage.includes('precio') || lowerMessage.includes('costo')) {
                return await handleScheduleQuery(message);
            }
            
            // Navigation help
            if (lowerMessage.includes('navigate') || lowerMessage.includes('direction') || lowerMessage.includes('help') || 
                lowerMessage.includes('lost') || lowerMessage.includes('guide') ||
                lowerMessage.includes('navegar') || lowerMessage.includes('direcci√≥n') || lowerMessage.includes('ayuda') ||
                lowerMessage.includes('perdido') || lowerMessage.includes('gu√≠a')) {
                return await handleNavigationHelp(message);
            }
            
            // General questions
            if (lowerMessage.includes('what') || lowerMessage.includes('how') || lowerMessage.includes('why') || lowerMessage.includes('tell me') ||
                lowerMessage.includes('qu√©') || lowerMessage.includes('c√≥mo') || lowerMessage.includes('por qu√©') || lowerMessage.includes('cu√©ntame')) {
                return await handleGeneralQuestion(message);
            }
            
            // Default response with AI enhancement
            return await getAIEnhancedResponse(message);
        }

        // Handle greetings - BILINGUAL FUNCTION
        function handleGreetings(message) {
            const englishGreetings = [
                "Hi there! üëã I'm doing great and ready to help you explore LA! How are you doing today? üòä",
                "Hello! üåü Nice to meet you! I'm your LA transit buddy - excited to help you get around the city! What brings you here today?",
                "Hey! üëã Great to see you! I'm here and ready to make your LA journey smooth and easy. How can I help? üöÄ",
                "Hi! üòä I'm fantastic, thanks for asking! I love helping people discover the best ways to get around LA. What's your destination today?",
                "Hello there! üéâ I'm doing wonderful and I'm super excited to help you navigate LA! Are you planning a trip somewhere?"
            ];
            
            const spanishGreetings = [
                "¬°Hola! üëã ¬°Estoy muy bien y listo para ayudarte a explorar LA! ¬øC√≥mo est√°s hoy? üòä",
                "¬°Hola! üåü ¬°Encantado de conocerte! Soy tu compa√±ero de tr√°nsito de LA - ¬°emocionado de ayudarte a moverte por la ciudad! ¬øQu√© te trae por aqu√≠ hoy?",
                "¬°Hola! üëã ¬°Qu√© bueno verte! Estoy aqu√≠ y listo para hacer tu viaje por LA suave y f√°cil. ¬øC√≥mo puedo ayudarte? üöÄ",
                "¬°Hola! üòä ¬°Estoy fant√°stico, gracias por preguntar! Me encanta ayudar a la gente a descubrir las mejores maneras de moverse por LA. ¬øCu√°l es tu destino hoy?",
                "¬°Hola! üéâ ¬°Estoy maravilloso y s√∫per emocionado de ayudarte a navegar por LA! ¬øEst√°s planeando un viaje a alg√∫n lugar?"
            ];
            
            const greetings = currentLanguage === 'es' ? spanishGreetings : englishGreetings;
            const randomGreeting = greetings[Math.floor(Math.random() * greetings.length)];
            
            const englishActions = ['Plan a route', 'Find nearest station', 'Tell me about LA', 'How much does it cost?', 'What can you do?'];
            const spanishActions = ['Planear ruta', 'Encontrar estaci√≥n cercana', 'Cu√©ntame sobre LA', '¬øCu√°nto cuesta?', '¬øQu√© puedes hacer?'];
            const quickActions = currentLanguage === 'es' ? spanishActions : englishActions;
            
            return {
                message: randomGreeting,
                quickActions: quickActions
            };
        }

        // Handle personal questions - BILINGUAL FUNCTION
        function handlePersonalQuestions(message) {
            const englishResponses = [
                "I'm doing amazing, thank you for asking! üòä I love helping people navigate LA - it's such a vibrant city with so much to explore! I'm here 24/7 and always ready to chat. How are YOU doing?",
                "I'm fantastic! üåü Just been busy helping folks like you discover the best routes around LA. Every day I learn something new about this incredible city! What's going on with you today?",
                "I'm great, thanks! üòÑ I'm having a wonderful time being your LA transit assistant. I never get tired of helping people explore this amazing city! How has your day been?",
                "I'm doing super well! üöÄ I'm always energized when I get to chat with people and help them get around LA. There's so much to see and do here! What about you - how are you feeling today?",
                "I'm excellent, appreciate you asking! üòä I'm living my best digital life helping people navigate LA's transit system. It's so rewarding! How are things going for you?"
            ];
            
            const spanishResponses = [
                "¬°Estoy incre√≠ble, gracias por preguntar! üòä Me encanta ayudar a la gente a navegar por LA - ¬°es una ciudad tan vibrante con tanto que explorar! Estoy aqu√≠ 24/7 y siempre listo para charlar. ¬øC√≥mo est√°s T√ö?",
                "¬°Estoy fant√°stico! üåü Solo he estado ocupado ayudando a personas como t√∫ a descubrir las mejores rutas por LA. ¬°Cada d√≠a aprendo algo nuevo sobre esta ciudad incre√≠ble! ¬øQu√© est√° pasando contigo hoy?",
                "¬°Estoy genial, gracias! üòÑ Estoy pasando un tiempo maravilloso siendo tu asistente de tr√°nsito de LA. ¬°Nunca me canso de ayudar a la gente a explorar esta ciudad asombrosa! ¬øC√≥mo ha estado tu d√≠a?",
                "¬°Estoy s√∫per bien! üöÄ Siempre me energizo cuando puedo charlar con personas y ayudarlas a moverse por LA. ¬°Hay tanto que ver y hacer aqu√≠! ¬øY t√∫ - c√≥mo te sientes hoy?",
                "¬°Estoy excelente, aprecio que preguntes! üòä Estoy viviendo mi mejor vida digital ayudando a la gente a navegar por el sistema de tr√°nsito de LA. ¬°Es tan gratificante! ¬øC√≥mo van las cosas para ti?"
            ];
            
            const responses = currentLanguage === 'es' ? spanishResponses : englishResponses;
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const englishActions = ['Tell me about yourself', 'Plan a route', 'What\'s fun in LA?', 'Help me get around', 'Thanks!'];
            const spanishActions = ['Cu√©ntame sobre ti', 'Planear ruta', '¬øQu√© hay divertido en LA?', 'Ay√∫dame a moverme', '¬°Gracias!'];
            const quickActions = currentLanguage === 'es' ? spanishActions : englishActions;
            
            return {
                message: randomResponse,
                quickActions: quickActions
            };
        }

        // Handle app information questions - BILINGUAL FUNCTION
        function handleAppInfoQuestions(message) {
            const englishMessage = `I'm so glad you asked! üéâ This is your all-in-one LA Transit companion! Here's what I can do for you:

üöá **Route Planning** - I'll find the best routes using Metro, buses, walking, or ride-sharing
üó∫Ô∏è **Live Navigation** - Step-by-step directions with real landmarks and departure times
üìç **Location Sharing** - Share your live location with family/friends for safety
üí¨ **Friendly Chat** - Ask me anything about LA, transit, costs, or just chat!
üöó **Ride-Sharing** - Connect you directly to Uber, Lyft, and Waymo
‚è∞ **Real-Time Info** - Live departure times, delays, and service updates
üéØ **Smart Search** - Find stations, landmarks, and popular LA destinations

I'm basically your personal LA transit buddy who knows the city inside and out! What would you like to try first? üòä`;

            const spanishMessage = `¬°Me alegra que preguntes! üéâ ¬°Este es tu compa√±ero completo de tr√°nsito de LA! Esto es lo que puedo hacer por ti:

üöá **Planificaci√≥n de Rutas** - Encontrar√© las mejores rutas usando Metro, autobuses, caminando o ride-sharing
üó∫Ô∏è **Navegaci√≥n en Vivo** - Direcciones paso a paso con puntos de referencia reales y horarios de salida
üìç **Compartir Ubicaci√≥n** - Comparte tu ubicaci√≥n en vivo con familia/amigos por seguridad
üí¨ **Chat Amigable** - ¬°Preg√∫ntame cualquier cosa sobre LA, tr√°nsito, costos o solo charla!
üöó **Ride-Sharing** - Con√©ctate directamente a Uber, Lyft y Waymo
‚è∞ **Informaci√≥n en Tiempo Real** - Horarios de salida en vivo, retrasos y actualizaciones de servicio
üéØ **B√∫squeda Inteligente** - Encuentra estaciones, puntos de referencia y destinos populares de LA

¬°B√°sicamente soy tu compa√±ero personal de tr√°nsito de LA que conoce la ciudad de adentro hacia afuera! ¬øQu√© te gustar√≠a probar primero? üòä`;

            const englishActions = ['Plan my first route', 'Show me around LA', 'How much does transit cost?', 'Find nearest station', 'That\'s awesome!'];
            const spanishActions = ['Planear mi primera ruta', 'Mu√©strame LA', '¬øCu√°nto cuesta el tr√°nsito?', 'Encontrar estaci√≥n cercana', '¬°Eso es genial!'];

            return {
                message: getBilingualResponse(englishMessage, spanishMessage),
                quickActions: getBilingualResponse(englishActions, spanishActions)
            };
        }

        // Handle positive feedback - BILINGUAL FUNCTION
        function handlePositiveFeedback(message) {
            const englishResponses = [
                "Aww, thank you so much! üòä That really makes my day! I'm here whenever you need help getting around LA. What else can I do for you?",
                "You're so kind! üåü I love helping people explore LA - it's what I'm passionate about! Anything else I can assist you with today?",
                "Thank you! üòÑ Your positive energy is contagious! I'm always here to help make your LA adventures smooth and fun. What's next?",
                "You're absolutely welcome! üöÄ It's my pleasure to help! LA is such an amazing city and I love being part of your journey. How else can I help?",
                "That means the world to me! üíô I genuinely enjoy chatting and helping people navigate this incredible city. What would you like to explore next?"
            ];
            
            const spanishResponses = [
                "¬°Ay, muchas gracias! üòä ¬°Eso realmente me alegra el d√≠a! Estoy aqu√≠ siempre que necesites ayuda para moverte por LA. ¬øQu√© m√°s puedo hacer por ti?",
                "¬°Eres tan amable! üåü Me encanta ayudar a la gente a explorar LA - ¬°es lo que me apasiona! ¬øAlgo m√°s en lo que pueda ayudarte hoy?",
                "¬°Gracias! üòÑ ¬°Tu energ√≠a positiva es contagiosa! Siempre estoy aqu√≠ para ayudar a que tus aventuras en LA sean suaves y divertidas. ¬øQu√© sigue?",
                "¬°De nada! üöÄ ¬°Es un placer ayudar! LA es una ciudad tan asombrosa y me encanta ser parte de tu viaje. ¬øDe qu√© otra manera puedo ayudar?",
                "¬°Eso significa el mundo para m√≠! üíô Genuinamente disfruto charlar y ayudar a la gente a navegar por esta ciudad incre√≠ble. ¬øQu√© te gustar√≠a explorar despu√©s?"
            ];
            
            const responses = currentLanguage === 'es' ? spanishResponses : englishResponses;
            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
            
            const englishActions = ['Plan another route', 'Tell me something interesting', 'Find cool places in LA', 'Help a friend', 'You\'re the best!'];
            const spanishActions = ['Planear otra ruta', 'Cu√©ntame algo interesante', 'Encontrar lugares geniales en LA', 'Ayudar a un amigo', '¬°Eres el mejor!'];
            const quickActions = currentLanguage === 'es' ? spanishActions : englishActions;
            
            return {
                message: randomResponse,
                quickActions: quickActions
            };
        }

        // Handle route planning
        async function handleRoutePlanning(message) {
            const lowerMessage = message.toLowerCase();
            
            // Handle specific quick actions
            if (lowerMessage.includes('custom route')) {
                return {
                    message: `Perfect! Let me open the route planner for you to enter your custom route. üòä`,
                    quickActions: ['Downtown to Hollywood', 'USC to Santa Monica', 'LAX to Downtown', 'Back to main menu'],
                    action: {
                        type: 'openRoutePlanner',
                        origin: '',
                        destination: ''
                    }
                };
            }
            
            // Extract origin and destination using NLP
            const locations = extractLocationsFromMessage(message);
            
            if (locations.origin && locations.destination) {
                return {
                    message: `Perfect! I'll help you get from ${locations.origin} to ${locations.destination}. Let me open the route planner for you.`,
                    quickActions: ['Show fastest route', 'Show all options', 'Walking directions', 'Transit info'],
                    action: {
                        type: 'openRoutePlanner',
                        origin: locations.origin,
                        destination: locations.destination
                    }
                };
            } else {
                return {
                    message: `I'd be happy to help you plan a route! Just tell me where you want to go. For example: "How do I get from Downtown to Hollywood?" üòä`,
                    quickActions: ['Downtown to Hollywood', 'USC to Santa Monica', 'LAX to Downtown', 'Custom route']
                };
            }
        }

        // Handle location search
        async function handleLocationSearch(message) {
            const lowerMessage = message.toLowerCase();
            
            // Handle specific quick actions
            if (lowerMessage.includes('find station') || lowerMessage.includes('nearest station')) {
                return {
                    message: `I can help you find the nearest Metro station! What area are you in? Or would you like me to use your current location? üòä`,
                    quickActions: ['Use my location', 'Downtown area', 'Hollywood area', 'Santa Monica area'],
                    action: {
                        type: 'findNearestStation'
                    }
                };
            }
            
            const location = extractLocationFromMessage(message);
            
            if (location) {
                return {
                    message: `Great! I found information about ${location}. Here are some nearby transit options and landmarks.`,
                    quickActions: ['Show on map', 'Find routes', 'Nearby stations', 'Walking directions'],
                    action: {
                        type: 'searchLocation',
                        location: location
                    }
                };
            } else {
                return {
                    message: `I can help you find places! What are you looking for? For example: "Find the nearest Metro station" or "Where is Hollywood?" üòä`,
                    quickActions: ['Nearest station', 'Popular destinations', 'LA landmarks', 'Custom search']
                };
            }
        }

        // Handle schedule queries
        async function handleScheduleQuery(message) {
            return {
                message: `I can help with schedules! Metro trains come every 6-12 minutes, and buses every 10-20 minutes. Want specific schedule info for a particular route?`,
                quickActions: ['Red Line schedule', 'Bus schedules', 'Real-time updates', 'Service alerts'],
                action: {
                    type: 'showSchedules'
                }
            };
        }

        // Handle navigation help
        async function handleNavigationHelp(message) {
            return {
                message: `I'm here to help you navigate! I can give you step-by-step directions, real-time updates, and help you find the best routes. What specific help do you need? üòä`,
                quickActions: ['Step-by-step guide', 'Real-time navigation', 'Alternative routes', 'Emergency help'],
                action: {
                    type: 'showNavigationHelp'
                }
            };
        }

        // Handle general questions
        async function handleGeneralQuestion(message) {
            // Use AI to generate contextual response
            const aiResponse = await getAIResponse(message);
            
            return {
                message: aiResponse.message,
                quickActions: aiResponse.quickActions || ['More info', 'Related questions', 'Help', 'Back to routes']
            };
        }

        // Get AI enhanced response using Hugging Face
        async function getAIEnhancedResponse(message) {
            try {
                // Try to get AI response from Hugging Face with timeout
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('AI timeout')), 8000); // 8 second timeout
                });

                const aiResponsePromise = getAIResponse(message);
                const aiResponse = await Promise.race([aiResponsePromise, timeoutPromise]);
                
                return {
                    message: aiResponse.message,
                    quickActions: aiResponse.quickActions || ['Plan a route', 'Find location', 'Get help', 'Ask another question']
                };
                
            } catch (error) {
                console.log('AI API failed, using fallback:', error);
                // Fallback to intelligent pattern matching
                const fallback = getFallbackResponse(message);
                return {
                    message: fallback.message,
                    quickActions: fallback.quickActions || ['Plan a route', 'Find location', 'Get help', 'Ask another question']
                };
            }
        }

        // Get AI response from Hugging Face
        async function getAIResponse(message) {
            try {
                // Add timeout protection
                const timeoutPromise = new Promise((_, reject) => {
                    setTimeout(() => reject(new Error('API timeout')), 10000); // 10 second timeout
                });

                // First, try to classify the user's intent
                const classificationPromise = fetch(HUGGING_FACE_CONFIG.apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${HUGGING_FACE_CONFIG.token}`
                    },
                    body: JSON.stringify({
                        inputs: message,
                        parameters: {
                            candidate_labels: [
                                "route planning",
                                "location search", 
                                "schedule inquiry",
                                "fare information",
                                "general question",
                                "navigation help"
                            ]
                        }
                    })
                });

                // Race between timeout and API call
                const classificationResponse = await Promise.race([classificationPromise, timeoutPromise]);

                if (classificationResponse.ok) {
                    const data = await classificationResponse.json();
                    console.log('AI Classification:', data);
                    
                    // Get the most likely intent
                    const intent = data.labels[0];
                    const confidence = data.scores[0];
                    
                    // Generate response based on intent
                    let response = '';
                    let quickActions = [];
                    
                    switch (intent) {
                        case 'route planning':
                            response = `Great! I can help you plan your route (${(confidence * 100).toFixed(1)}% sure that's what you want). Just use the search form above to enter where you're going from and to, or tell me directly!`;
                            quickActions = ['Plan route', 'Find stations', 'Get directions'];
                            break;
                            
                        case 'location search':
                            response = `I can help you find places! (${(confidence * 100).toFixed(1)}% sure that's what you need). What are you looking for? I can help find Metro stations, landmarks, or any place in LA.`;
                            quickActions = ['Find station', 'Search location', 'Nearby places'];
                            break;
                            
                        case 'schedule inquiry':
                            response = `I can help with schedules! (${(confidence * 100).toFixed(1)}% sure that's what you're asking). Metro trains come every 6-12 minutes, and buses every 10-20 minutes. Want to plan a specific trip to see exact times?`;
                            quickActions = ['Plan trip', 'Check schedules', 'Real-time info'];
                            break;
                            
                        case 'fare information':
                            response = `I can help with costs! (${(confidence * 100).toFixed(1)}% sure that's what you want to know). Metro costs $1.75 per ride, $7 for a day pass, or $25 for a week. You'll need a TAP card too.`;
                            quickActions = ['Fare info', 'TAP card', 'Discounts'];
                            break;
                            
                        case 'navigation help':
                            response = `I can help you navigate! (${(confidence * 100).toFixed(1)}% sure you need navigation help). Once you plan a route, I'll give you step-by-step directions and real-time updates.`;
                            quickActions = ['Plan route', 'Get directions', 'Navigation help'];
                            break;
                            
                        default:
                            response = `I understand you're asking about LA transit (${(confidence * 100).toFixed(1)}% sure). I can help you plan routes, find places, check schedules, and answer questions about getting around LA. What would you like to know?`;
                            quickActions = ['Plan a route', 'Find location', 'Get help'];
                    }
                    
                    return {
                        message: response,
                        quickActions: quickActions,
                        intent: intent,
                        confidence: confidence
                    };
                    
                } else {
                    throw new Error('AI classification failed');
                }
                
            } catch (error) {
                console.log('AI API not available, using fallback:', error);
                return getFallbackResponse(message);
            }
        }

        // Fallback response system - RESPECTS CHOSEN LANGUAGE
        function getFallbackResponse(message) {
            const lowerMessage = message.toLowerCase();
            
            // If no language is set, ask for language selection
            if (!currentLanguage) {
                return {
                    message: `Please choose your language first / Por favor elige tu idioma primero:

üá∫üá∏ **English** - I'll help you navigate LA in English
üá™üá∏ **Espa√±ol** - Te ayudo a navegar LA en espa√±ol

Click one of the options below! üòä`,
                    quickActions: ['üá∫üá∏ English', 'üá™üá∏ Espa√±ol']
                };
            }
            
            // English responses
            if (currentLanguage === 'en') {
                // Greetings and casual conversation
                if (lowerMessage.includes('hello') || lowerMessage.includes('hi') || lowerMessage.includes('hey')) {
                    return {
                        message: 'Hey there! üëã Great to meet you! I\'m your friendly LA transit assistant, ready to chat and help you get around this amazing city! How are you doing today? üòä',
                        quickActions: ['I\'m doing great!', 'Plan a route', 'Tell me about LA', 'What can you do?']
                    };
                }
                
                // Personal questions
                if (lowerMessage.includes('how are you') || lowerMessage.includes('what\'s up')) {
                    return {
                        message: 'I\'m fantastic, thanks for asking! üòÑ I absolutely love helping people navigate LA - it\'s such an incredible city with so much to discover! I\'m here 24/7 and always excited to chat. How has your day been? üåü',
                        quickActions: ['Tell me about yourself', 'Plan a route', 'What\'s cool in LA?', 'Help me get around']
                    };
                }
                
                // Positive feedback
                if (lowerMessage.includes('thank') || lowerMessage.includes('awesome') || lowerMessage.includes('great') || lowerMessage.includes('cool')) {
                    return {
                        message: "You're so welcome! üòä Your kind words totally make my day! I genuinely love being your LA transit buddy. There's nothing better than helping people explore this amazing city! What else can I help you discover? üöÄ",
                        quickActions: ['Plan another route', 'Find cool places', 'Tell me more', 'You\'re amazing!']
                    };
                }
                
                // App features and capabilities
                if (lowerMessage.includes('what can you do') || lowerMessage.includes('features') || lowerMessage.includes('help')) {
                    return {
                        message: 'I\'m your complete LA transit companion! üéâ I can plan routes, give real-time navigation, help you find places, share locations with friends, connect you to Uber/Lyft/Waymo, and most importantly - have great conversations! I know LA inside and out and I\'m here to make your journey smooth and fun! What sounds interesting? üòä',
                        quickActions: ['Plan a route', 'Find places', 'Tell me about costs', 'Navigate somewhere', 'Chat more!']
                    };
                }
                
                // LA-specific questions
                if (lowerMessage.includes('la') || lowerMessage.includes('los angeles') || lowerMessage.includes('city')) {
                    return {
                        message: 'LA is absolutely incredible! üåü From Hollywood to Santa Monica, Downtown to Beverly Hills - there\'s so much to explore! The Metro system connects most major areas, buses fill in the gaps, and there are tons of cool neighborhoods to discover. I love helping people find the best ways to get around and discover hidden gems! Where are you thinking of going? üó∫Ô∏è',
                        quickActions: ['Show me Hollywood', 'Beach areas', 'Downtown LA', 'Plan a route', 'Cool neighborhoods']
                    };
                }
                
                // Cost and pricing questions
                if (lowerMessage.includes('cost') || lowerMessage.includes('price') || lowerMessage.includes('fare') || lowerMessage.includes('money')) {
                    return {
                        message: 'Great question! üí∞ LA Metro is super affordable - just $1.75 per ride, $7 for a day pass, or $25 for a week! You\'ll need a TAP card (like a metro card). Buses are the same price. Ride-sharing varies but typically $15-30 for most trips. Walking is free and often the most fun! Want me to plan a route and show you exact costs? üòä',
                        quickActions: ['Plan a route with costs', 'Tell me about TAP cards', 'Compare options', 'Find cheapest route']
                    };
                }
                
                // Metro/transit specific
                if (lowerMessage.includes('metro') || lowerMessage.includes('train') || lowerMessage.includes('subway') || lowerMessage.includes('rail')) {
                    return {
                        message: 'LA Metro is amazing! üöá We have 6 rail lines (Red, Purple, Blue, Green, Gold, Expo) that connect all the major areas. Trains come every 6-12 minutes and are super reliable. Plus the stations often have cool art! The system keeps growing too. I can help you find the perfect Metro route - where do you want to go? üåü',
                        quickActions: ['Red Line info', 'Plan Metro route', 'Find nearest station', 'Show all lines']
                    };
                }
                
                // Bus questions
                if (lowerMessage.includes('bus')) {
                    return {
                        message: 'LA buses are fantastic! üöå Over 100+ routes cover literally every corner of the city. They come every 10-20 minutes and cost the same as Metro ($1.75). Some routes are Rapid (faster with fewer stops). Buses are great for reaching places the Metro doesn\'t go! Want me to find you a good bus route? üòä',
                        quickActions: ['Find bus route', 'Rapid bus info', 'Bus vs Metro', 'Plan trip']
                    };
                }
                
                // Location and places
                if (lowerMessage.includes('where') || lowerMessage.includes('find') || lowerMessage.includes('location') || lowerMessage.includes('place')) {
                    return {
                        message: 'I\'m like a local LA expert! üó∫Ô∏è I can help you find anything - Metro stations, cool neighborhoods, landmarks, beaches, shopping, restaurants, you name it! I know the best ways to get everywhere and can share insider tips. What kind of place are you looking for? ‚ú®',
                        quickActions: ['Find stations', 'Cool neighborhoods', 'Tourist spots', 'Local favorites', 'Plan route there']
                    };
                }
                
                // Time and schedules
                if (lowerMessage.includes('time') || lowerMessage.includes('schedule') || lowerMessage.includes('when')) {
                    return {
                        message: 'Timing is everything! ‚è∞ Metro trains run every 6-12 minutes from about 5am to 12:30am (later on weekends). Buses every 10-20 minutes with similar hours. I can show you real-time departure info and help you plan the perfect timing for your trip! When are you looking to travel? üöÄ',
                        quickActions: ['Check real-time info', 'Plan for now', 'Schedule for later', 'Weekend hours']
                    };
                }
                
                // Navigation and directions
                if (lowerMessage.includes('navigate') || lowerMessage.includes('direction') || lowerMessage.includes('guide')) {
                    return {
                        message: 'I\'m your personal LA navigation guru! üß≠ Once you plan a route, I\'ll give you step-by-step directions with real landmarks, departure times, and live updates. I\'ll guide you every step of the way so you never get lost! Ready to navigate somewhere awesome? üòä',
                        quickActions: ['Start navigation', 'Plan route first', 'Find landmarks', 'Get directions']
                    };
                }
                
                // Default super friendly response
                return {
                    message: "I love chatting with you! üòä I'm your friendly LA transit assistant and I'm here for absolutely anything - route planning, finding cool places, answering questions about LA, or just having a great conversation! This city has so much to offer and I'm excited to help you explore it all. What's on your mind? üåü",
                    quickActions: ['Plan a route', 'Find cool places', 'Tell me about LA', 'Chat more!', 'Surprise me!']
                };
            }
            
            // Spanish responses
            else if (currentLanguage === 'es') {
                // Greetings and casual conversation
                if (lowerMessage.includes('hola') || lowerMessage.includes('buenos') || lowerMessage.includes('buenas')) {
                    return {
                        message: '¬°Hola! üëã ¬°Encantado de conocerte! Soy tu asistente amigable de tr√°nsito de LA, listo para charlar y ayudarte a moverte por esta ciudad incre√≠ble! ¬øC√≥mo est√°s hoy? üòä',
                        quickActions: ['¬°Estoy muy bien!', 'Planear ruta', 'Cu√©ntame sobre LA', '¬øQu√© puedes hacer?']
                    };
                }
                
                // Personal questions
                if (lowerMessage.includes('c√≥mo est√°s') || lowerMessage.includes('qu√© tal')) {
                    return {
                        message: '¬°Estoy fant√°stico, gracias por preguntar! üòÑ ¬°Me encanta ayudar a la gente a navegar por LA - es una ciudad tan incre√≠ble con tanto que descubrir! Estoy aqu√≠ 24/7 y siempre emocionado de charlar. ¬øC√≥mo ha estado tu d√≠a? üåü',
                        quickActions: ['Cu√©ntame sobre ti', 'Planear ruta', '¬øQu√© hay cool en LA?', 'Ay√∫dame a moverme']
                    };
                }
                
                // Positive feedback
                if (lowerMessage.includes('gracias') || lowerMessage.includes('genial') || lowerMessage.includes('excelente')) {
                    return {
                        message: "¬°De nada! üòä ¬°Tus palabras amables realmente me alegran el d√≠a! Genuinamente amo ser tu compa√±ero de tr√°nsito de LA. ¬°No hay nada mejor que ayudar a la gente a explorar esta ciudad incre√≠ble! ¬øQu√© m√°s puedo ayudarte a descubrir? üöÄ",
                        quickActions: ['Planear otra ruta', 'Encontrar lugares cool', 'Cu√©ntame m√°s', '¬°Eres incre√≠ble!']
                    };
                }
                
                // App features and capabilities
                if (lowerMessage.includes('qu√© puedes hacer') || lowerMessage.includes('funciones') || lowerMessage.includes('ayuda')) {
                    return {
                        message: '¬°Soy tu compa√±ero completo de tr√°nsito de LA! üéâ Puedo planificar rutas, dar navegaci√≥n en tiempo real, ayudarte a encontrar lugares, compartir ubicaciones con amigos, conectarte a Uber/Lyft/Waymo, y lo m√°s importante - ¬°tener grandes conversaciones! Conozco LA de adentro hacia afuera y estoy aqu√≠ para hacer tu viaje suave y divertido! ¬øQu√© te suena interesante? üòä',
                        quickActions: ['Planear ruta', 'Encontrar lugares', 'Cu√©ntame sobre costos', 'Navegar a alg√∫n lugar', '¬°Chatear m√°s!']
                    };
                }
                
                // LA-specific questions
                if (lowerMessage.includes('la') || lowerMessage.includes('los angeles') || lowerMessage.includes('ciudad')) {
                    return {
                        message: '¬°LA es absolutamente incre√≠ble! üåü Desde Hollywood hasta Santa M√≥nica, Downtown hasta Beverly Hills - ¬°hay tanto que explorar! El sistema Metro conecta la mayor√≠a de las √°reas principales, los autobuses llenan los espacios, y hay toneladas de barrios cool para descubrir. ¬°Me encanta ayudar a la gente a encontrar las mejores maneras de moverse y descubrir joyas ocultas! ¬øA d√≥nde est√°s pensando ir? üó∫Ô∏è',
                        quickActions: ['Mu√©strame Hollywood', '√Åreas de playa', 'Downtown LA', 'Planear ruta', 'Barrios cool']
                    };
                }
                
                // Cost and pricing questions
                if (lowerMessage.includes('costo') || lowerMessage.includes('precio') || lowerMessage.includes('tarifa') || lowerMessage.includes('dinero')) {
                    return {
                        message: '¬°Excelente pregunta! üí∞ El Metro de LA es s√∫per asequible - solo $1.75 por viaje, $7 por pase diario, o $25 por semana! Necesitar√°s una tarjeta TAP (como una tarjeta de metro). Los autobuses cuestan lo mismo. El ride-sharing var√≠a pero t√≠picamente $15-30 para la mayor√≠a de viajes. Caminar es gratis y a menudo lo m√°s divertido! ¬øQuieres que planifique una ruta y te muestre costos exactos? üòä',
                        quickActions: ['Planear ruta con costos', 'Cu√©ntame sobre tarjetas TAP', 'Comparar opciones', 'Encontrar ruta m√°s barata']
                    };
                }
                
                // Metro/transit specific
                if (lowerMessage.includes('metro') || lowerMessage.includes('tren') || lowerMessage.includes('subterr√°neo')) {
                    return {
                        message: '¬°El Metro de LA es incre√≠ble! üöá Tenemos 6 l√≠neas ferroviarias (Roja, P√∫rpura, Azul, Verde, Dorada, Expo) que conectan todas las √°reas principales. Los trenes vienen cada 6-12 minutos y son s√∫per confiables. ¬°Adem√°s las estaciones a menudo tienen arte cool! El sistema sigue creciendo tambi√©n. Puedo ayudarte a encontrar la ruta Metro perfecta - ¬øa d√≥nde quieres ir? üåü',
                        quickActions: ['Info L√≠nea Roja', 'Planear ruta Metro', 'Encontrar estaci√≥n cercana', 'Mostrar todas las l√≠neas']
                    };
                }
                
                // Bus questions
                if (lowerMessage.includes('autob√∫s')) {
                    return {
                        message: '¬°Los autobuses de LA son fant√°sticos! üöå M√°s de 100+ rutas cubren literalmente cada esquina de la ciudad. Vienen cada 10-20 minutos y cuestan lo mismo que el Metro ($1.75). Algunas rutas son R√°pidas (m√°s r√°pidas con menos paradas). ¬°Los autobuses son geniales para llegar a lugares donde no va el Metro! ¬øQuieres que te encuentre una buena ruta de autob√∫s? üòä',
                        quickActions: ['Encontrar ruta de autob√∫s', 'Info autob√∫s r√°pido', 'Autob√∫s vs Metro', 'Planear viaje']
                    };
                }
                
                // Location and places
                if (lowerMessage.includes('d√≥nde') || lowerMessage.includes('encontrar') || lowerMessage.includes('ubicaci√≥n') || lowerMessage.includes('lugar')) {
                    return {
                        message: '¬°Soy como un experto local de LA! üó∫Ô∏è Puedo ayudarte a encontrar cualquier cosa - estaciones Metro, barrios cool, puntos de referencia, playas, compras, restaurantes, ¬°lo que sea! Conozco las mejores maneras de llegar a todas partes y puedo compartir consejos de insider. ¬øQu√© tipo de lugar est√°s buscando? ‚ú®',
                        quickActions: ['Encontrar estaciones', 'Barrios cool', 'Lugares tur√≠sticos', 'Favoritos locales', 'Planear ruta all√≠']
                    };
                }
                
                // Time and schedules
                if (lowerMessage.includes('tiempo') || lowerMessage.includes('horario') || lowerMessage.includes('cu√°ndo')) {
                    return {
                        message: '¬°El tiempo es todo! ‚è∞ Los trenes Metro corren cada 6-12 minutos desde aproximadamente 5am hasta 12:30am (m√°s tarde los fines de semana). Autobuses cada 10-20 minutos con horarios similares. Puedo mostrarte informaci√≥n de salida en tiempo real y ayudarte a planificar el tiempo perfecto para tu viaje! ¬øCu√°ndo planeas viajar? üöÄ',
                        quickActions: ['Verificar info en tiempo real', 'Planear para ahora', 'Programar para despu√©s', 'Horarios de fin de semana']
                    };
                }
                
                // Navigation and directions
                if (lowerMessage.includes('navegar') || lowerMessage.includes('direcci√≥n') || lowerMessage.includes('gu√≠a')) {
                    return {
                        message: '¬°Soy tu gur√∫ de navegaci√≥n personal de LA! üß≠ Una vez que planifiques una ruta, te dar√© direcciones paso a paso con puntos de referencia reales, horarios de salida y actualizaciones en vivo. ¬°Te guiar√© cada paso del camino para que nunca te pierdas! ¬øListo para navegar a alg√∫n lugar incre√≠ble? üòä',
                        quickActions: ['Comenzar navegaci√≥n', 'Planear ruta primero', 'Encontrar puntos de referencia', 'Obtener direcciones']
                    };
                }
                
                // Default super friendly response
                return {
                    message: "¬°Me encanta charlar contigo! üòä Soy tu asistente amigable de tr√°nsito de LA y estoy aqu√≠ para absolutamente cualquier cosa - planificaci√≥n de rutas, encontrar lugares cool, responder preguntas sobre LA, o solo tener una gran conversaci√≥n! Esta ciudad tiene tanto que ofrecer y estoy emocionado de ayudarte a explorarlo todo. ¬øQu√© tienes en mente? üåü",
                    quickActions: ['Planear ruta', 'Encontrar lugares cool', 'Cu√©ntame sobre LA', '¬°Chatear m√°s!', '¬°Sorpr√©ndeme!']
                };
            }
        }

        // Extract locations from message using NLP
        function extractLocationsFromMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            // Common LA locations
            const locations = {
                'downtown': 'Downtown LA',
                'hollywood': 'Hollywood',
                'santa monica': 'Santa Monica',
                'venice': 'Venice Beach',
                'beverly hills': 'Beverly Hills',
                'usc': 'USC',
                'ucla': 'UCLA',
                'lax': 'LAX Airport',
                'koreatown': 'Koreatown',
                'pasadena': 'Pasadena',
                'long beach': 'Long Beach',
                'universal': 'Universal Studios',
                'disney': 'Disneyland',
                'griffith': 'Griffith Observatory',
                'getty': 'Getty Center'
            };
            
            let origin = null;
            let destination = null;
            
            // Look for "from X to Y" pattern
            const fromToMatch = message.match(/from\s+([^to]+)\s+to\s+([^.!?]+)/i);
            if (fromToMatch) {
                origin = fromToMatch[1].trim();
                destination = fromToMatch[2].trim();
            }
            
            // Look for location keywords
            for (const [key, value] of Object.entries(locations)) {
                if (lowerMessage.includes(key)) {
                    if (!origin) origin = value;
                    else if (!destination) destination = value;
                }
            }
            
            return { origin, destination };
        }

        // Extract single location from message
        function extractLocationFromMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            const locations = {
                'downtown': 'Downtown LA',
                'hollywood': 'Hollywood',
                'santa monica': 'Santa Monica',
                'venice': 'Venice Beach',
                'beverly hills': 'Beverly Hills',
                'usc': 'USC',
                'ucla': 'UCLA',
                'lax': 'LAX Airport',
                'koreatown': 'Koreatown',
                'pasadena': 'Pasadena',
                'long beach': 'Long Beach',
                'universal': 'Universal Studios',
                'disney': 'Disneyland',
                'griffith': 'Griffith Observatory',
                'getty': 'Getty Center'
            };
            
            for (const [key, value] of Object.entries(locations)) {
                if (lowerMessage.includes(key)) {
                    return value;
                }
            }
            
            return null;
        }

        // Execute chatbot actions
        function executeChatbotAction(action) {
            switch (action.type) {
                case 'openRoutePlanner':
                    toggleSearch();
                    setTimeout(() => {
                        document.getElementById('originInput').value = action.origin;
                        document.getElementById('destinationInput').value = action.destination;
                    }, 100);
                    break;
                    
                case 'searchLocation':
                    // Center map on location
                    if (locations[action.location.toLowerCase()]) {
                        const loc = locations[action.location.toLowerCase()];
                        map.setView([loc.lat, loc.lng], 15);
                    }
                    break;
                    
                case 'findNearestStation':
                    // Open route planner to find nearest station
                    toggleSearch();
                    setTimeout(() => {
                        document.getElementById('originInput').value = 'Current Location';
                        document.getElementById('destinationInput').value = 'Nearest Metro Station';
                    }, 100);
                    break;
                    
                case 'showSchedules':
                    addBotMessage('Here are the current Metro schedules:\n\nüöá Red Line: Every 6-12 minutes\nüöá Purple Line: Every 6-12 minutes\nüöá Blue Line: Every 6-12 minutes\nüöá Green Line: Every 6-12 minutes\nüöá Gold Line: Every 6-12 minutes\nüöå Buses: Every 10-20 minutes\n\nWant real-time updates for a specific route? üòä', [
                        'Red Line updates',
                        'Bus updates',
                        'Service alerts'
                    ]);
                    break;
                    
                case 'showNavigationHelp':
                    addBotMessage('Here\'s how to navigate LA transit:\n\n1Ô∏è‚É£ **Plan your route** using the search feature\n2Ô∏è‚É£ **Check real-time updates** for delays\n3Ô∏è‚É£ **Use TAP cards** for easy payment\n4Ô∏è‚É£ **Follow signs** at stations\n5Ô∏è‚É£ **Ask for help** if needed\n\nWant me to plan a specific route for you? üòä', [
                        'Plan a route',
                        'TAP card info',
                        'Station guide'
                    ]);
                    break;
            }
        }

        // Add user message to chat
        function addUserMessage(message) {
            chatbotMessages.push({ type: 'user', content: message });
            updateChatbotMessages();
        }

        // Add bot message to chat
        function addBotMessage(message, quickActions = []) {
            chatbotMessages.push({ type: 'bot', content: message, quickActions });
            updateChatbotMessages();
        }

        // Update chatbot messages display
        function updateChatbotMessages() {
            const messagesContainer = document.getElementById('chatbotMessages');
            messagesContainer.innerHTML = '';
            
            chatbotMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.type}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.textContent = msg.type === 'user' ? 'üë§' : 'ü§ñ';
                
                const content = document.createElement('div');
                content.className = 'message-content';
                content.innerHTML = msg.content.replace(/\n/g, '<br>');
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
                
                // Add quick actions for bot messages
                if (msg.type === 'bot' && msg.quickActions && msg.quickActions.length > 0) {
                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'quick-actions';
                    
                    msg.quickActions.forEach(action => {
                        const actionBtn = document.createElement('div');
                        actionBtn.className = 'quick-action';
                        actionBtn.textContent = action;
                        actionBtn.onclick = () => handleQuickAction(action);
                        actionsDiv.appendChild(actionBtn);
                    });
                    
                    content.appendChild(actionsDiv);
                }
                
                messagesContainer.appendChild(messageDiv);
            });
            
            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Handle quick actions
        function handleQuickAction(action) {
            // Add the action as a user message
            addUserMessage(action);
            
            // Process the action directly with immediate response
            processQuickAction(action);
        }

        // Process quick actions without async calls
        function processQuickAction(action) {
            const lowerAction = action.toLowerCase();
            
            // Show typing indicator briefly
            showTypingIndicator();
            
            setTimeout(() => {
                hideTypingIndicator();
                
                // Handle language selection first
                if (action.includes('üá™üá∏') || action.includes('Espa√±ol') || action.includes('spanish')) {
                    currentLanguage = 'es';
                    console.log('Language set to Spanish');
                    addBotMessage(`¬°Perfecto! üá™üá∏ ¬°Te ayudo en espa√±ol de ahora en adelante!

¬°Soy tu asistente amigable de tr√°nsito de LA! Estoy aqu√≠ para charlar y ayudarte a navegar por LA. ¬°Preg√∫ntame lo que quieras sobre rutas, lugares o solo di hola! üòä

Preg√∫ntame:
‚Ä¢ "Hola, ¬øc√≥mo est√°s?"
‚Ä¢ "¬øC√≥mo llego a Hollywood?"
‚Ä¢ "¬øCu√°l es la mejor manera de llegar al LAX?"
‚Ä¢ "Cu√©ntame sobre el Metro de LA"
‚Ä¢ "¬øCu√°nto cuesta?"

¬øQu√© tienes en mente hoy? üöÄ`, [
                        '¬°Hola!',
                        'Planear ruta',
                        'Encontrar estaci√≥n',
                        'Cu√©ntame sobre LA',
                        '¬øCu√°nto cuesta?'
                    ]);
                    return;
                }
                
                if (action.includes('üá∫üá∏') || action.includes('English') || action.includes('ingl√©s')) {
                    currentLanguage = 'en';
                    console.log('Language set to English');
                    addBotMessage(`Perfect! üá∫üá∏ I'll help you in English from now on!

I'm your friendly LA Transit assistant! I'm here to chat and help you navigate around LA. Feel free to ask me anything - whether it's about routes, places, or just say hi! üòä

Try asking me:
‚Ä¢ "Hi, how are you?"
‚Ä¢ "How do I get to Hollywood?"
‚Ä¢ "What's the best way to LAX?"
‚Ä¢ "Tell me about LA Metro"
‚Ä¢ "How much does it cost?"

What's on your mind today? üöÄ`, [
                        'Hi there!',
                        'Plan a route',
                        'Find station',
                        'Tell me about LA',
                        'How much does it cost?'
                    ]);
                    return;
                }
                
                // Handle specific quick actions
                if (lowerAction.includes('plan') && lowerAction.includes('route')) {
                    if (currentLanguage === 'es') {
                        addBotMessage("¬°Genial! Puedo ayudarte a planificar una ruta. Elige de estas rutas populares de LA, o planifica una ruta personalizada: üòä", [
                            'USC a Santa M√≥nica',
                            'LAX al Downtown', 
                            'Downtown a Hollywood',
                            'Beverly Hills a Venice',
                            'Pasadena al Downtown',
                            'Ruta personalizada'
                        ]);
                    } else {
                        addBotMessage("Great! I can help you plan a route. Choose from these popular LA routes, or plan a custom route: üòä", [
                            'USC to Santa Monica',
                            'LAX to Downtown', 
                            'Downtown to Hollywood',
                            'Beverly Hills to Venice',
                            'Pasadena to Downtown',
                            'Custom route'
                        ]);
                    }
                    
                } else if (lowerAction.includes('custom route') || lowerAction.includes('ruta personalizada')) {
                    if (currentLanguage === 'es') {
                        addBotMessage("¬°Perfecto! Abrir√© el planificador de rutas para que ingreses los detalles de tu ruta personalizada! üòä", []);
                    } else {
                        addBotMessage("Perfect! I'll open the route planner for you to enter your custom route details! üòä", []);
                    }
                    
                    // Open route planner
                    setTimeout(() => {
                        toggleSearch();
                    }, 500);
                    
                } else if (lowerAction.includes('downtown to hollywood')) {
                    // Actually populate the route planner
                    addBotMessage("Great choice! I'll set up a route from Downtown to Hollywood for you! üé¨", []);
                    
                    setTimeout(() => {
                        toggleSearch();
                        setTimeout(() => {
                            document.getElementById('originInput').value = 'Downtown';
                            document.getElementById('destinationInput').value = 'Hollywood';
                            // Automatically trigger search
                            handleSearch(new Event('submit'));
                        }, 300);
                    }, 500);
                    
                } else if (lowerAction.includes('usc to santa monica')) {
                    // Actually populate the route planner
                    addBotMessage("Perfect! I'll set up a route from USC to Santa Monica for you! üèñÔ∏è", []);
                    
                    setTimeout(() => {
                        toggleSearch();
                        setTimeout(() => {
                            document.getElementById('originInput').value = 'USC';
                            document.getElementById('destinationInput').value = 'Santa Monica';
                            // Automatically trigger search
                            handleSearch(new Event('submit'));
                        }, 300);
                    }, 500);
                    
                } else if (lowerAction.includes('lax to downtown')) {
                    // Actually populate the route planner
                    addBotMessage("Excellent! I'll set up a route from LAX to Downtown for you! ‚úàÔ∏è", []);
                    
                    setTimeout(() => {
                        toggleSearch();
                        setTimeout(() => {
                            document.getElementById('originInput').value = 'LAX';
                            document.getElementById('destinationInput').value = 'Downtown';
                            // Automatically trigger search
                            handleSearch(new Event('submit'));
                        }, 300);
                    }, 500);
                    
                } else if (lowerAction.includes('beverly hills to venice')) {
                    // Actually populate the route planner
                    addBotMessage("Awesome! I'll set up a route from Beverly Hills to Venice Beach for you! üèñÔ∏è", []);
                    
                    setTimeout(() => {
                        toggleSearch();
                        setTimeout(() => {
                            document.getElementById('originInput').value = 'Beverly Hills';
                            document.getElementById('destinationInput').value = 'Venice';
                            // Automatically trigger search
                            handleSearch(new Event('submit'));
                        }, 300);
                    }, 500);
                    
                } else if (lowerAction.includes('pasadena to downtown')) {
                    // Actually populate the route planner
                    addBotMessage("Perfect! I'll set up a route from Pasadena to Downtown for you! üèõÔ∏è", []);
                    
                    setTimeout(() => {
                        toggleSearch();
                        setTimeout(() => {
                            document.getElementById('originInput').value = 'Pasadena';
                            document.getElementById('destinationInput').value = 'Downtown';
                            // Automatically trigger search
                            handleSearch(new Event('submit'));
                        }, 300);
                    }, 500);
                    
                } else if (lowerAction.includes('use my current location') || lowerAction.includes('usar mi ubicaci√≥n actual')) {
                    // Handle current location request
                    addBotMessage("üìç Getting your current location...", []);
                    
                    setTimeout(async () => {
                        try {
                            const position = await new Promise((resolve, reject) => {
                                navigator.geolocation.getCurrentPosition(resolve, reject, {
                                    timeout: 15000,
                                    enableHighAccuracy: true,
                                    maximumAge: 0
                                });
                            });
                            
                            const lat = position.coords.latitude;
                            const lng = position.coords.longitude;
                            const accuracy = position.coords.accuracy;
                            
                            // Get better address formatting using the new robust method
                            const address = await getBetterAddress(lat, lng, accuracy);
                            const displayText = formatLocationDisplay(address, lat, lng, accuracy);
                            
                            addBotMessage(`‚úÖ Found! Your current location is:\n\n${displayText}\n\nWhat would you like to do from here?`, [
                                'Plan route from here',
                                'Find nearest station',
                                'Show on map',
                                'Share location'
                            ]);
                            
                        } catch (error) {
                            addBotMessage("‚ùå I couldn't get your current location. Please check your browser permissions or try entering your location manually.", [
                                'Find nearest station',
                                'Plan route manually',
                                'Check permissions',
                                'Help'
                            ]);
                        }
                    }, 1000);
                    
                } else if (lowerAction.includes('plan route from here') || lowerAction.includes('planear ruta desde aqu√≠')) {
                    addBotMessage("Great! I'll help you plan a route from your current location. Where would you like to go?", [
                        'To Hollywood',
                        'To Santa Monica',
                        'To Downtown',
                        'To LAX',
                        'Custom destination'
                    ]);
                    
                } else if (lowerAction.includes('find nearest station') || lowerAction.includes('encontrar estaci√≥n cercana')) {
                    addBotMessage("üöá I'll help you find the nearest Metro station. First, I need your location:", [
                        'Use my current location',
                        'Downtown LA',
                        'Hollywood',
                        'Santa Monica',
                        'Beverly Hills',
                        'Enter manually'
                    ]);
                    
                } else if (lowerAction.includes('show on map') || lowerAction.includes('mostrar en mapa')) {
                    addBotMessage("I'll show your location on the map! üó∫Ô∏è", []);
                    
                    setTimeout(() => {
                        // Center map on current location if available
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition((position) => {
                                if (map) {
                                    map.setView([position.coords.latitude, position.coords.longitude], 15);
                                    // Add a marker for current location
                                    L.marker([position.coords.latitude, position.coords.longitude])
                                        .addTo(map)
                                        .bindPopup('üìç Your Current Location')
                                        .openPopup();
                                }
                            });
                        }
                    }, 500);
                    
                } else if (lowerAction.includes('share location') || lowerAction.includes('compartir ubicaci√≥n')) {
                    addBotMessage("I'll help you share your location! üìç", []);
                    
                    setTimeout(() => {
                        toggleLocationShare();
                    }, 500);
                    
                } else if (lowerAction.includes('find') || lowerAction.includes('station')) {
                    addBotMessage("I can help you find Metro stations! What area are you looking for? Or would you like me to help you find the nearest station to your current location? üòä", [
                        'Use my current location',
                        'Downtown area',
                        'Hollywood area',
                        'Santa Monica area',
                        'Back to main menu'
                    ]);
                    
                } else if (lowerAction.includes('cost') || lowerAction.includes('price')) {
                    addBotMessage("Great question! üí∞ LA Metro is super affordable:\n\n‚Ä¢ Single ride: $1.75\n‚Ä¢ Day pass: $7.00\n‚Ä¢ Week pass: $25.00\n‚Ä¢ TAP card: $2.00 (one-time)\n\nBuses cost the same as Metro. Want me to plan a route and show you exact costs? üòä", [
                        'Plan route with costs',
                        'Tell me about TAP cards',
                        'Compare options',
                        'Back to main menu'
                    ]);
                    
                } else if (lowerAction.includes('metro') || lowerAction.includes('train')) {
                    addBotMessage("LA Metro is amazing! üöá We have 6 rail lines:\n\n‚Ä¢ Red Line: North Hollywood ‚Üî Union Station\n‚Ä¢ Purple Line: Wilshire/Western ‚Üî Union Station\n‚Ä¢ Blue Line: 7th Street ‚Üî Long Beach\n‚Ä¢ Green Line: Redondo Beach ‚Üî Norwalk\n‚Ä¢ Gold Line: Atlantic ‚Üî Azusa\n‚Ä¢ Expo Line: 7th Street ‚Üî Santa Monica\n\nTrains come every 6-12 minutes! Where do you want to go? üåü", [
                        'Plan Metro route',
                        'Find nearest station',
                        'Show all lines',
                        'Back to main menu'
                    ]);
                    
                } else if (lowerAction.includes('bus')) {
                    addBotMessage("LA buses are fantastic! üöå Over 100+ routes cover every corner of the city:\n\n‚Ä¢ Regular buses: Every 10-20 minutes\n‚Ä¢ Rapid buses: Faster with fewer stops\n‚Ä¢ Cost: Same as Metro ($1.75)\n‚Ä¢ Great for reaching places Metro doesn't go\n\nWant me to find you a good bus route? üòä", [
                        'Find bus route',
                        'Rapid bus info',
                        'Bus vs Metro',
                        'Back to main menu'
                    ]);
                    
                } else if (lowerAction.includes('back to main menu') || lowerAction.includes('main menu')) {
                    addBotMessage("Hey there! üëã I'm your friendly LA Transit assistant! I'm here to chat and help you navigate around LA. Feel free to ask me anything - whether it's about routes, places, or just say hi! üòä\n\nWhat's on your mind today? üöÄ", [
                        'Hi there!',
                        'Plan a route',
                        'Find station',
                        'Tell me about LA',
                        'How much does it cost?'
                    ]);
                    
                } else if (lowerAction.includes('hi') || lowerAction.includes('hello')) {
                    addBotMessage("Hi there! üëã I'm doing great and ready to help you explore LA! How are you doing today? üòä", [
                        'I\'m doing great!',
                        'Plan a route',
                        'Tell me about LA',
                        'What can you do?'
                    ]);
                    
                } else if (lowerAction.includes('tell me about la') || lowerAction.includes('about la')) {
                    addBotMessage("LA is absolutely incredible! üåü From Hollywood to Santa Monica, Downtown to Beverly Hills - there's so much to explore! The Metro system connects most major areas, buses fill in the gaps, and there are tons of cool neighborhoods to discover. I love helping people find the best ways to get around and discover hidden gems! Where are you thinking of going? üó∫Ô∏è", [
                        'Show me Hollywood',
                        'Beach areas',
                        'Downtown LA',
                        'Plan a route',
                        'Cool neighborhoods'
                    ]);
                    
                } else if (lowerAction.includes('what can you do') || lowerAction.includes('features')) {
                    addBotMessage("I'm your complete LA transit companion! üéâ I can plan routes, give real-time navigation, help you find places, share locations with friends, connect you to Uber/Lyft/Waymo, and most importantly - have great conversations! I know LA inside and out and I'm here to make your journey smooth and fun! What sounds interesting? üòä", [
                        'Plan a route',
                        'Find places',
                        'Tell me about costs',
                        'Navigate somewhere',
                        'Chat more!'
                    ]);
                    
                } else {
                    // Default response for unknown actions - RESPECTS CHOSEN LANGUAGE
                    if (currentLanguage === 'es') {
                        addBotMessage("¬°Me encantar√≠a ayudarte con eso! üòä ¬øQu√© espec√≠ficamente te gustar√≠a saber sobre el tr√°nsito de LA? Puedo ayudarte con rutas, horarios, costos, o simplemente charlar sobre la ciudad! üåü", [
                            'Planear ruta',
                            'Encontrar ubicaci√≥n',
                            'Obtener ayuda',
                            'Hacer otra pregunta'
                        ]);
                    } else {
                        addBotMessage("I'd be happy to help you with that! üòä What specifically would you like to know about LA transit? I can help with routes, schedules, costs, or just chat about the city! üåü", [
                            'Plan a route',
                            'Find location',
                            'Get help',
                            'Ask another question'
                        ]);
                    }
                }
            }, 300);
        }

        // Show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            const messagesContainer = document.getElementById('chatbotMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message bot';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = `
                <div class="typing-indicator">
                    AI is thinking
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(content);
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingIndicator = document.getElementById('typingIndicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Generate Ride-Sharing routes (Uber, Lyft, Waymo)
        async function generateRideSharingRoutes(origin, destination) {
            const routes = [];
            
            try {
                // Get coordinates once and reuse
                const originCoords = await getCoordinates(origin);
                const destCoords = await getCoordinates(destination);
                
                if (!originCoords || !destCoords) return routes;
                
                const distance = calculateDistance(originCoords, destCoords);
                const baseTime = Math.round(distance / SPEEDS.rideshare * 60);
                
                // Generate Uber routes
                const uberRoutes = await generateUberRoutes(origin, destination, distance, baseTime);
                routes.push(...uberRoutes);
                
                // Generate Lyft routes
                const lyftRoutes = await generateLyftRoutes(origin, destination, distance, baseTime);
                routes.push(...lyftRoutes);
                
                // Generate Waymo routes
                const waymoRoutes = await generateWaymoRoutes(origin, destination, distance, baseTime);
                routes.push(...waymoRoutes);
                
            } catch (error) {
                console.error('Generate ride-sharing routes error:', error);
            }
            
            return routes;
        }

        // Generate Uber routes
        async function generateUberRoutes(origin, destination, distance, baseTime) {
            const routes = [];
            
            // UberX (standard)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'uber',
                systemName: 'UberX',
                systemIcon: 'üöó',
                systemColor: '#000000',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()], // Available now
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request UberX ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'UberX',
                            waitTime: '2-5 min',
                            vehicleType: 'Standard sedan'
                        }
                    }
                ]
            });
            
            // UberXL (larger vehicle)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'uber',
                systemName: 'UberXL',
                systemIcon: 'üöê',
                systemColor: '#000000',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request UberXL ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'UberXL',
                            waitTime: '3-7 min',
                            vehicleType: 'SUV or minivan'
                        }
                    }
                ]
            });
            
            // Uber Black (premium)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'uber',
                systemName: 'Uber Black',
                systemIcon: 'üöô',
                systemColor: '#000000',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request Uber Black ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'Uber Black',
                            waitTime: '5-10 min',
                            vehicleType: 'Luxury sedan'
                        }
                    }
                ]
            });
            
            return routes;
        }

        // Generate Lyft routes
        async function generateLyftRoutes(origin, destination, distance, baseTime) {
            const routes = [];
            
            // Lyft (standard)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'lyft',
                systemName: 'Lyft',
                systemIcon: 'üöó',
                systemColor: '#FF00BF',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request Lyft ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'Lyft',
                            waitTime: '2-5 min',
                            vehicleType: 'Standard sedan'
                        }
                    }
                ]
            });
            
            // Lyft XL (larger vehicle)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'lyft',
                systemName: 'Lyft XL',
                systemIcon: 'üöê',
                systemColor: '#FF00BF',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request Lyft XL ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'Lyft XL',
                            waitTime: '3-7 min',
                            vehicleType: 'SUV or minivan'
                        }
                    }
                ]
            });
            
            // Lyft Lux (premium)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'lyft',
                systemName: 'Lyft Lux',
                systemIcon: 'üöô',
                systemColor: '#FF00BF',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request Lyft Lux ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'Lyft Lux',
                            waitTime: '5-10 min',
                            vehicleType: 'Luxury sedan'
                        }
                    }
                ]
            });
            
            return routes;
        }

        // Generate Waymo routes
        async function generateWaymoRoutes(origin, destination, distance, baseTime) {
            const routes = [];
            
            // Waymo (autonomous)
            routes.push({
                type: 'route',
                mode: 'rideshare',
                system: 'waymo',
                systemName: 'Waymo One',
                systemIcon: 'ü§ñ',
                systemColor: '#4285F4',
                origin: origin,
                destination: destination,
                totalDistance: distance,
                totalTime: baseTime,
                totalCost: 0, // Remove pricing
                departureTimes: [new Date()],
                steps: [
                    {
                        type: 'rideshare',
                        instruction: `Request Waymo autonomous ride`,
                        distance: distance,
                        time: baseTime,
                        details: {
                            service: 'Waymo One',
                            waitTime: '1-3 min',
                            vehicleType: 'Autonomous vehicle',
                            features: 'No driver, 24/7 service'
                        }
                    }
                ]
            });
            
            return routes;
        }

        // Cost calculation functions - UPDATED with current LA rates (2024)
        function calculateUberCost(distance, serviceType) {
            // Current LA Uber rates (as of 2024) - more realistic
            const baseFare = 2.55;
            const perMile = {
                'uberx': 1.85,      // Standard UberX
                'uberxl': 2.35,     // UberXL for groups
                'uberblack': 4.25   // Premium Uber Black
            };
            const perMinute = {
                'uberx': 0.40,      // $0.40 per minute
                'uberxl': 0.50,     // $0.50 per minute
                'uberblack': 0.75   // $0.75 per minute
            };
            
            // Calculate time based on average LA traffic (slower than freeway speed)
            const avgSpeed = 25; // mph in LA traffic
            const timeInMinutes = (distance / avgSpeed) * 60;
            
            // Base cost calculation
            let cost = baseFare + (distance * perMile[serviceType]) + (timeInMinutes * perMinute[serviceType]);
            
            // Add surge pricing for peak hours (simulate real conditions)
            const hour = new Date().getHours();
            const isPeakHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19);
            if (isPeakHour) {
                cost *= 1.3; // 30% surge during peak hours
            }
            
            // Add booking fee and service fee
            const bookingFee = 2.20;
            const serviceFee = cost * 0.15; // 15% service fee
            
            const totalCost = cost + bookingFee + serviceFee;
            
            // Ensure minimum fare
            const minFare = serviceType === 'uberblack' ? 15 : 8;
            return Math.max(Math.round(totalCost * 100) / 100, minFare);
        }

        function calculateLyftCost(distance, serviceType) {
            // Current LA Lyft rates (as of 2024) - more realistic
            const baseFare = 2.50;
            const perMile = {
                'lyft': 1.75,       // Standard Lyft
                'lyftxl': 2.25,     // Lyft XL for groups
                'lyftlux': 3.75     // Premium Lyft Lux
            };
            const perMinute = {
                'lyft': 0.38,       // $0.38 per minute
                'lyftxl': 0.48,     // $0.48 per minute
                'lyftlux': 0.68     // $0.68 per minute
            };
            
            // Calculate time based on average LA traffic
            const avgSpeed = 25; // mph in LA traffic
            const timeInMinutes = (distance / avgSpeed) * 60;
            
            // Base cost calculation
            let cost = baseFare + (distance * perMile[serviceType]) + (timeInMinutes * perMinute[serviceType]);
            
            // Add surge pricing for peak hours
            const hour = new Date().getHours();
            const isPeakHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19);
            if (isPeakHour) {
                cost *= 1.25; // 25% surge during peak hours
            }
            
            // Add booking fee and service fee
            const bookingFee = 2.00;
            const serviceFee = cost * 0.12; // 12% service fee
            
            const totalCost = cost + bookingFee + serviceFee;
            
            // Ensure minimum fare
            const minFare = serviceType === 'lyftlux' ? 14 : 7;
            return Math.max(Math.round(totalCost * 100) / 100, minFare);
        }

        function calculateWaymoCost(distance) {
            // Waymo pricing (autonomous rides in LA area) - more realistic
            const baseFare = 2.00;
            const perMile = 1.25;   // Slightly higher due to autonomous technology
            const perMinute = 0.35; // $0.35 per minute
            
            // Calculate time based on average LA traffic
            const avgSpeed = 25; // mph in LA traffic
            const timeInMinutes = (distance / avgSpeed) * 60;
            
            // Base cost calculation
            let cost = baseFare + (distance * perMile) + (timeInMinutes * perMinute);
            
            // Waymo has lower surge pricing due to autonomous fleet
            const hour = new Date().getHours();
            const isPeakHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19);
            if (isPeakHour) {
                cost *= 1.15; // 15% surge during peak hours
            }
            
            // Waymo has lower fees due to no driver costs
            const serviceFee = cost * 0.08; // 8% service fee
            
            const totalCost = cost + serviceFee;
            
            // Ensure minimum fare
            return Math.max(Math.round(totalCost * 100) / 100, 6);
        }

        // Open ride-sharing app with pre-filled details
        async function openRideSharingApp(service, origin, destination) {
            const serviceConfigs = {
                'uber': {
                    name: 'Uber',
                    url: 'https://m.uber.com',
                    fallbackUrl: `https://m.uber.com/ul/?action=setPickup&pickup[formatted_address]=${encodeURIComponent(origin)}&dropoff[formatted_address]=${encodeURIComponent(destination)}`
                },
                'lyft': {
                    name: 'Lyft',
                    url: 'https://www.lyft.com',
                    fallbackUrl: `https://www.lyft.com/ride?pickup=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`
                },
                'waymo': {
                    name: 'Waymo',
                    url: 'https://waymo.com/waymo-one/',
                    fallbackUrl: `https://waymo.com/waymo-one/?pickup=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`
                }
            };
            
            const config = serviceConfigs[service];
            if (!config) {
                alert('Service not supported');
                return;
            }
            
            try {
                // Try to get coordinates for better deep linking
                const originCoords = await getCoordinates(origin);
                const destCoords = await getCoordinates(destination);
                
                let deepLink = '';
                
                if (originCoords && destCoords) {
                    // Create deep link with coordinates
                    switch (service) {
                        case 'uber':
                            deepLink = `uber://?action=setPickup&pickup[latitude]=${originCoords.lat}&pickup[longitude]=${originCoords.lng}&dropoff[latitude]=${destCoords.lat}&dropoff[longitude]=${destCoords.lng}`;
                            break;
                        case 'lyft':
                            deepLink = `lyft://ridetype?id=lyft&pickup[latitude]=${originCoords.lat}&pickup[longitude]=${originCoords.lng}&destination[latitude]=${destCoords.lat}&destination[longitude]=${destCoords.lng}`;
                            break;
                        case 'waymo':
                            deepLink = `waymo://ride?pickup=${encodeURIComponent(origin)}&destination=${encodeURIComponent(destination)}`;
                            break;
                    }
                }
                
                // Try to open the app first
                if (deepLink) {
                    const link = document.createElement('a');
                    link.href = deepLink;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    
                    link.click();
                    document.body.removeChild(link);
                    
                    // Set a timeout to check if the app opened
                    setTimeout(() => {
                        // If we're still here, the app probably didn't open, so open the web version
                        window.open(config.fallbackUrl, '_blank');
                    }, 2000);
                } else {
                    // No coordinates available, open web version directly
                    window.open(config.fallbackUrl, '_blank');
                }
                
            } catch (error) {
                console.log('Deep link failed, opening web version:', error);
                window.open(config.fallbackUrl, '_blank');
            }
            
            // Show confirmation message
            alert(`Opening ${config.name} app to book your ride from ${origin} to ${destination}`);
        }

        // Voice Command Functionality
        let mediaRecorder;
        let audioChunks = [];

        async function startVoiceCommand() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                
                const voiceBtn = document.querySelector('.voice-command-btn');
                voiceBtn.textContent = 'üî¥ Recording...';
                voiceBtn.classList.add('recording');
                
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                    await processVoiceCommand(audioBlob);
                    
                    voiceBtn.textContent = 'üé§ Voice Command';
                    voiceBtn.classList.remove('recording');
                    audioChunks = [];
                };
                
                mediaRecorder.start();
                
                // Stop recording after 5 seconds
                setTimeout(() => {
                    if (mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        stream.getTracks().forEach(track => track.stop());
                    }
                }, 5000);
                
            } catch (error) {
                console.error('Voice command error:', error);
                alert('Voice command not supported. Please use text input.');
            }
        }

        async function processVoiceCommand(audioBlob) {
            try {
                // For now, we'll simulate voice processing
                // In a real app, you'd send this to a speech-to-text API
                const simulatedText = 'Plan route from Downtown to Hollywood';
                
                // Process the command
                document.getElementById('originInput').value = 'Downtown';
                document.getElementById('destinationInput').value = 'Hollywood';
                
                // Show AI processing
                const resultsContainer = document.getElementById('searchResults');
                resultsContainer.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        üé§ Voice Command: "${simulatedText}"<br>
                        ü§ñ AI is processing your request...
                    </div>
                `;
                resultsContainer.style.display = 'block';
                
                // Trigger search
                setTimeout(() => {
                    handleSearch(new Event('submit'));
                }, 1000);
                
            } catch (error) {
                console.error('Voice processing error:', error);
                alert('Voice processing failed. Please try again.');
            }
        }

        // Handle current location request - INTELLIGENT
        async function handleCurrentLocationRequest(message) {
            const isSpanish = currentLanguage === 'es';
            
            if (navigator.geolocation) {
                // Show getting location message
                const gettingMessage = isSpanish ? 
                    "üìç Obteniendo tu ubicaci√≥n actual..." : 
                    "üìç Getting your current location...";
                
                addBotMessage(gettingMessage, []);
                
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            timeout: 10000,
                            enableHighAccuracy: false,
                            maximumAge: 60000
                        });
                    });
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    // Try to get address
                    let address = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`);
                        if (response.ok) {
                            const data = await response.json();
                            address = data.display_name || address;
                        }
                    } catch (error) {
                        console.log('Geocoding failed, using coordinates');
                    }
                    
                    const successMessage = isSpanish ?
                        `‚úÖ ¬°Encontrado! Tu ubicaci√≥n actual es:\n\nüìç **${address}**\n\n¬øQu√© te gustar√≠a hacer desde aqu√≠?` :
                        `‚úÖ Found! Your current location is:\n\nüìç **${address}**\n\nWhat would you like to do from here?`;
                    
                    const quickActions = isSpanish ? [
                        'Planear ruta desde aqu√≠',
                        'Encontrar estaci√≥n cercana',
                        'Mostrar en mapa',
                        'Compartir ubicaci√≥n'
                    ] : [
                        'Plan route from here',
                        'Find nearest station',
                        'Show on map',
                        'Share location'
                    ];
                    
                    return {
                        message: successMessage,
                        quickActions: quickActions,
                        action: {
                            type: 'setCurrentLocation',
                            coordinates: { lat, lng },
                            address: address
                        }
                    };
                    
                } catch (error) {
                    const errorMessage = isSpanish ?
                        "‚ùå No pude obtener tu ubicaci√≥n actual. Por favor:\n\n‚Ä¢ Verifica que tu navegador tenga permisos de ubicaci√≥n\n‚Ä¢ Intenta usar 'Encontrar estaci√≥n cercana' en su lugar" :
                        "‚ùå I couldn't get your current location. Please:\n\n‚Ä¢ Check that your browser has location permissions\n‚Ä¢ Try using 'Find nearest station' instead";
                    
                    const quickActions = isSpanish ? [
                        'Encontrar estaci√≥n cercana',
                        'Planear ruta manual',
                        'Verificar permisos',
                        'Ayuda'
                    ] : [
                        'Find nearest station',
                        'Plan route manually',
                        'Check permissions',
                        'Help'
                    ];
                    
                    return {
                        message: errorMessage,
                        quickActions: quickActions
                    };
                }
            } else {
                const notSupportedMessage = isSpanish ?
                    "‚ùå Tu navegador no soporta geolocalizaci√≥n. Por favor ingresa tu ubicaci√≥n manualmente." :
                    "‚ùå Your browser doesn't support geolocation. Please enter your location manually.";
                
                const quickActions = isSpanish ? [
                    'Planear ruta manual',
                    'Encontrar estaci√≥n',
                    'Ayuda'
                ] : [
                    'Plan route manually',
                    'Find station',
                    'Help'
                ];
                
                return {
                    message: notSupportedMessage,
                    quickActions: quickActions
                };
            }
        }

        // Handle nearest station request - INTELLIGENT
        async function handleNearestStationRequest(message) {
            const isSpanish = currentLanguage === 'es';
            
            const responseMessage = isSpanish ?
                "üöá Te ayudo a encontrar la estaci√≥n m√°s cercana. Primero necesito tu ubicaci√≥n:" :
                "üöá I'll help you find the nearest station. First, I need your location:";
            
            const quickActions = isSpanish ? [
                'Usar mi ubicaci√≥n actual',
                'Downtown LA',
                'Hollywood',
                'Santa Monica',
                'Beverly Hills',
                'Ingresar manualmente'
            ] : [
                'Use my current location',
                'Downtown LA',
                'Hollywood',
                'Santa Monica',
                'Beverly Hills',
                'Enter manually'
            ];
            
            return {
                message: responseMessage,
                quickActions: quickActions
            };
        }

        // Helper function to get better address formatting - REAL-TIME like Google Maps
        async function getBetterAddress(lat, lng, accuracy = null) {
            // Check GPS accuracy first
            if (accuracy && !isGPSAccuracyAcceptable(accuracy)) {
                // If GPS accuracy is poor, return a warning with coordinates
                return `‚ö†Ô∏è Poor GPS accuracy (¬±${Math.round(accuracy)}m)\nüìç Coordinates: ${lat.toFixed(6)}, ${lng.toFixed(6)}\n\nPlease try:\n‚Ä¢ Moving to an open area\n‚Ä¢ Going outside\n‚Ä¢ Waiting a few seconds`;
            }

            const services = [
                // Primary: Nominatim with detailed parameters
                async () => {
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 4000); // 4 second timeout for this service
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=18&addressdetails=1&accept-language=en`, {
                            headers: {
                                'User-Agent': 'LA-Transit-App/1.0'
                            },
                            signal: controller.signal
                        });
                        clearTimeout(id);

                        if (response.ok) {
                            const data = await response.json();
                            if (data.display_name) {
                                // Try to extract a cleaner, more specific address
                                const address = data.address;
                                if (address) {
                                    if (address.house_number && address.road) {
                                        return `${address.house_number} ${address.road}, ${address.city || address.town || address.village || ''}, ${address.state || ''} ${address.postcode || ''}`.trim().replace(/, ,/g, ',').replace(/ ,/g, ',');
                                    } else if (address.road) {
                                        return `${address.road}, ${address.city || address.town || address.village || ''}, ${address.state || ''} ${address.postcode || ''}`.trim().replace(/, ,/g, ',').replace(/ ,/g, ',');
                                    } else if (address.neighbourhood && address.city) {
                                        return `${address.neighbourhood}, ${address.city}, ${address.state || ''} ${address.postcode || ''}`.trim().replace(/, ,/g, ',').replace(/ ,/g, ',');
                                    }
                                }
                                // Fallback to a more concise display_name if specific parts aren't found
                                const parts = data.display_name.split(', ');
                                if (parts.length > 3) {
                                    return parts.slice(0, 3).join(', ') + (parts[3] ? `, ${parts[3]}` : ''); // Keep first 3-4 parts for conciseness
                                }
                                return data.display_name;
                            }
                        }
                    } catch (error) {
                        console.warn('Nominatim detailed geocoding failed or timed out:', error);
                    }
                    return null;
                },
                // Fallback: Nominatim with less detailed parameters (might be faster/more reliable)
                async () => {
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 3000); // 3 second timeout
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10&accept-language=en`, {
                            headers: {
                                'User-Agent': 'LA-Transit-App/1.0'
                            },
                            signal: controller.signal
                        });
                        clearTimeout(id);

                        if (response.ok) {
                            const data = await response.json();
                            if (data.display_name) {
                                return data.display_name;
                            }
                        }
                    } catch (error) {
                        console.warn('Nominatim simple geocoding failed or timed out:', error);
                    }
                    return null;
                },
                // Additional fallback: Try with CORS proxy
                async () => {
                    try {
                        const controller = new AbortController();
                        const id = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                        const response = await fetch(`https://cors-anywhere.herokuapp.com/https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&zoom=10`, {
                            signal: controller.signal
                        });
                        clearTimeout(id);

                        if (response.ok) {
                            const data = await response.json();
                            if (data.display_name) {
                                return data.display_name;
                            }
                        }
                    } catch (error) {
                        console.warn('CORS proxy geocoding failed or timed out:', error);
                    }
                    return null;
                }
            ];

            for (const service of services) {
                const address = await service();
                if (address) {
                    return address;
                }
            }

            // Final fallback: Use area detection if all external services fail
            return getLAAreaContext(lat, lng);
        }

        // Helper function to get LA area context based on coordinates
        function getLAAreaContext(lat, lng) {
            // Define LA area boundaries and landmarks with larger radius for better coverage
            const laAreas = [
                { name: 'Downtown LA', lat: 34.0522, lng: -118.2437, radius: 0.08 },
                { name: 'Hollywood', lat: 34.0928, lng: -118.3287, radius: 0.08 },
                { name: 'Santa Monica', lat: 34.0195, lng: -118.4912, radius: 0.08 },
                { name: 'Beverly Hills', lat: 34.0736, lng: -118.4001, radius: 0.08 },
                { name: 'Venice Beach', lat: 34.0195, lng: -118.4912, radius: 0.08 },
                { name: 'USC', lat: 34.0224, lng: -118.2851, radius: 0.08 },
                { name: 'UCLA', lat: 34.0689, lng: -118.4452, radius: 0.08 },
                { name: 'Koreatown', lat: 34.0579, lng: -118.3009, radius: 0.08 },
                { name: 'Pasadena', lat: 34.1478, lng: -118.1445, radius: 0.08 },
                { name: 'Long Beach', lat: 33.7701, lng: -118.1937, radius: 0.08 },
                { name: 'Mid-Wilshire', lat: 34.0625, lng: -118.3550, radius: 0.08 },
                { name: 'West LA', lat: 34.0522, lng: -118.4452, radius: 0.08 },
                { name: 'Echo Park', lat: 34.0781, lng: -118.2600, radius: 0.08 },
                { name: 'Silver Lake', lat: 34.0928, lng: -118.2760, radius: 0.08 },
                { name: 'Los Feliz', lat: 34.0928, lng: -118.2900, radius: 0.08 },
                { name: 'Culver City', lat: 34.0211, lng: -118.3965, radius: 0.08 },
                { name: 'Marina del Rey', lat: 33.9803, lng: -118.4517, radius: 0.08 },
                { name: 'Manhattan Beach', lat: 33.8847, lng: -118.4109, radius: 0.08 },
                { name: 'Redondo Beach', lat: 33.8492, lng: -118.3884, radius: 0.08 },
                { name: 'Torrance', lat: 33.8358, lng: -118.3406, radius: 0.08 }
            ];
            
            // Find the closest area
            let closestArea = null;
            let minDistance = Infinity;
            
            for (const area of laAreas) {
                const distance = Math.sqrt(
                    Math.pow(lat - area.lat, 2) + Math.pow(lng - area.lng, 2)
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    closestArea = area;
                }
            }
            
            // If within reasonable distance of a known area, use that
            if (closestArea && minDistance < closestArea.radius) {
                return `${closestArea.name} area`;
            }
            
            // Otherwise, provide general LA area with coordinates
            return `Los Angeles area (${lat.toFixed(3)}, ${lng.toFixed(3)})`;
        }

        // Helper function to format location display with accuracy info
        function formatLocationDisplay(address, lat, lng, accuracy = null) {
            const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
            
            if (accuracy) {
                const accuracyMeters = Math.round(accuracy);
                if (accuracyMeters > 500) {
                    return `${address}\n\nüìç GPS: ${coords}\n‚ùå Very poor accuracy (¬±${accuracyMeters}m)\n‚ö†Ô∏è Location may be incorrect`;
                } else if (accuracyMeters > 200) {
                    return `${address}\n\nüìç GPS: ${coords}\n‚ö†Ô∏è Poor accuracy (¬±${accuracyMeters}m)\n‚ö†Ô∏è Location may be approximate`;
                } else if (accuracyMeters > 100) {
                    return `${address}\n\nüìç GPS: ${coords}\n‚ö†Ô∏è Low accuracy (¬±${accuracyMeters}m)`;
                } else if (accuracyMeters > 50) {
                    return `${address}\n\nüìç GPS: ${coords}\n‚ö†Ô∏è Medium accuracy (¬±${accuracyMeters}m)`;
                } else {
                    return `${address}\n\nüìç GPS: ${coords}\n‚úÖ High accuracy (¬±${accuracyMeters}m)`;
                }
            } else {
                return `${address}\n\nüìç GPS: ${coords}`;
            }
        }

        // Function to get realistic price range for ride-sharing
        function getPriceRange(basePrice) {
            // Add some variation to simulate real pricing fluctuations
            const variation = 0.15; // 15% variation
            const minPrice = Math.max(basePrice * (1 - variation), basePrice * 0.8);
            const maxPrice = basePrice * (1 + variation);
            
            if (maxPrice - minPrice < 2) {
                // If range is too small, show single price
                return `$${basePrice.toFixed(0)}`;
            } else {
                return `$${minPrice.toFixed(0)}-${maxPrice.toFixed(0)}`;
            }
        }

        // Function to get time-based pricing indicator
        function getPricingIndicator() {
            const hour = new Date().getHours();
            const isPeakHour = (hour >= 7 && hour <= 9) || (hour >= 16 && hour <= 19);
            const isLateNight = hour >= 22 || hour <= 5;
            
            if (isPeakHour) {
                return "üöó Peak pricing";
            } else if (isLateNight) {
                return "üåô Late night pricing";
            } else {
                return "üöó Standard pricing";
            }
        }

        // Helper function to check if GPS accuracy is acceptable
        function isGPSAccuracyAcceptable(accuracy) {
            if (!accuracy) return true; // If no accuracy data, assume it's okay
            return accuracy <= 200; // Acceptable if within 200 meters
        }

        // Function to get GPS accuracy improvement tips
        function getGPSAccuracyTips(accuracy) {
            if (!accuracy) return "GPS accuracy unknown";
            
            const accuracyMeters = Math.round(accuracy);
            if (accuracyMeters > 500) {
                return "‚ùå Very poor GPS accuracy (¬±" + accuracyMeters + "m)\n\nTo improve accuracy:\n‚Ä¢ Go outside or near a window\n‚Ä¢ Move to an open area\n‚Ä¢ Wait 10-30 seconds for GPS to settle\n‚Ä¢ Check if location services are enabled\n‚Ä¢ Try again in a few minutes";
            } else if (accuracyMeters > 200) {
                return "‚ö†Ô∏è Poor GPS accuracy (¬±" + accuracyMeters + "m)\n\nTo improve accuracy:\n‚Ä¢ Move closer to a window\n‚Ä¢ Go outside briefly\n‚Ä¢ Wait a few more seconds\n‚Ä¢ Check for tall buildings nearby";
            } else if (accuracyMeters > 100) {
                return "‚ö†Ô∏è Low GPS accuracy (¬±" + accuracyMeters + "m)\n\nThis should be okay for most purposes, but you can:\n‚Ä¢ Move to a more open area\n‚Ä¢ Wait a bit longer for better signal";
            } else {
                return "‚úÖ Good GPS accuracy (¬±" + accuracyMeters + "m)";
            }
        }
    </script>
</body>
</html>